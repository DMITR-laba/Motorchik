# Парсер автомобилей с aaa-motors.ru

## Описание

Реализован AI-парсер для автоматического сбора данных об автомобилях с сайта https://aaa-motors.ru.

**Доступны два режима парсинга:**
- **ИИ-парсер** (рекомендуется) - с NLP и ML компонентами для интеллектуального извлечения данных
- **Базовый парсер** - простой парсинг без ИИ-компонентов

Подробнее об ИИ-парсере: см. [AI_PARSER_SETUP.md](AI_PARSER_SETUP.md)

## Возможности

Парсер автоматически извлекает:
- ✅ **Марку** автомобиля
- ✅ **Модель** автомобиля
- ✅ **Город** расположения
- ✅ **Характеристики**:
  - Цена
  - Год выпуска
  - Тип кузова
  - Тип топлива
  - Тип коробки передач
  - Тип привода
  - Объем двигателя
  - Мощность
  - Цвет
  - Пробег (для подержанных)
  - Дополнительные характеристики (в JSON)
- ✅ **Фотографии** (до 20 фото на автомобиль)

## Структура базы данных

### Таблица `parsed_cars`
Основная таблица для хранения спарсенных автомобилей:
- `id` - уникальный идентификатор
- `source_url` - URL источника (уникальный)
- `mark`, `model`, `city` - основные поля
- Все характеристики автомобиля
- `characteristics` - JSON с дополнительными характеристиками
- `parsed_at`, `updated_at` - метаданные
- `is_active` - флаг активности

### Таблица `parsed_car_pictures`
Фотографии автомобилей:
- `id` - уникальный идентификатор
- `parsed_car_id` - связь с автомобилем
- `image_url` - URL фотографии
- `local_path` - путь к локально сохраненному файлу (опционально)
- `seqno` - порядковый номер фото

## API Endpoints

### Запуск парсинга
```http
POST /api/parser/start
Content-Type: application/json

{
  "base_url": "https://aaa-motors.ru",
  "max_pages": 10,        // Максимальное количество страниц (опционально)
  "max_cars": 100,         // Максимальное количество автомобилей (опционально)
  "delay": 1.0             // Задержка между запросами в секундах
}
```

### Статус парсинга
```http
GET /api/parser/status
```

### Остановка парсинга
```http
POST /api/parser/stop
```

### Получение списка автомобилей
```http
GET /api/parser/cars?skip=0&limit=100&mark=BMW&model=X5&city=Москва
```

### Получение одного автомобиля
```http
GET /api/parser/cars/{car_id}
```

### Удаление автомобиля
```http
DELETE /api/parser/cars/{car_id}
```

### Статистика
```http
GET /api/parser/stats
```

## Использование

### 1. Установка зависимостей

Убедитесь, что установлены необходимые библиотеки:
```bash
pip install beautifulsoup4 httpx
```

### 2. Запуск парсера через API

```python
import requests

# Запуск парсинга
response = requests.post("http://localhost:8000/api/parser/start", json={
    "base_url": "https://aaa-motors.ru",
    "max_pages": 5,
    "max_cars": 50,
    "delay": 1.0
})

print(response.json())
```

### 3. Проверка статуса

```python
response = requests.get("http://localhost:8000/api/parser/status")
print(response.json())
```

### 4. Получение результатов

```python
# Получить все автомобили
response = requests.get("http://localhost:8000/api/parser/cars?limit=100")
cars = response.json()
print(f"Найдено {cars['total']} автомобилей")

# Фильтрация по марке
response = requests.get("http://localhost:8000/api/parser/cars?mark=BMW")
bmw_cars = response.json()
```

## Особенности реализации

### 1. Умный парсинг
- Автоматическое определение структуры страницы
- Поддержка различных форматов HTML
- Извлечение данных из таблиц, списков и других элементов

### 2. Обработка ошибок
- Автоматическое логирование ошибок
- Продолжение работы при ошибках на отдельных страницах
- Статистика успешных и неудачных парсингов

### 3. Защита от дубликатов
- Проверка по `source_url` перед сохранением
- Обновление существующих записей вместо создания дубликатов

### 4. Оптимизация
- Задержка между запросами (защита от блокировки)
- Ограничение количества страниц и автомобилей
- Фоновый запуск парсинга

## Настройка

### Параметры парсера

В `ParserStartRequest` можно настроить:
- `base_url` - базовый URL сайта (по умолчанию: https://aaa-motors.ru)
- `max_pages` - максимальное количество страниц каталога
- `max_cars` - максимальное количество автомобилей
- `delay` - задержка между запросами (секунды)

### Примеры использования

#### Минимальный запуск (парсинг всех страниц)
```json
{
  "base_url": "https://aaa-motors.ru"
}
```

#### Ограниченный парсинг (для тестирования)
```json
{
  "base_url": "https://aaa-motors.ru",
  "max_pages": 2,
  "max_cars": 10,
  "delay": 2.0
}
```

## Логирование

Все действия парсера логируются:
- Начало и завершение парсинга
- Ошибки при обработке страниц
- Статистика по обработанным автомобилям

Логи можно найти в консоли или в лог-файлах приложения.

## Ограничения

1. **Структура сайта**: Парсер адаптируется к структуре сайта, но может потребоваться доработка при изменении HTML-структуры
2. **Rate Limiting**: Используйте задержку (`delay`) для избежания блокировки
3. **Фотографии**: Фотографии сохраняются как URL. Для локального сохранения требуется дополнительная настройка

## Будущие улучшения

- [ ] Локальное сохранение фотографий
- [ ] Периодический автоматический парсинг
- [ ] Интеграция с SQL-агентом для поиска
- [ ] Индексация в Elasticsearch
- [ ] Уведомления о новых автомобилях
- [ ] Экспорт данных в различные форматы

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь, что сайт доступен
3. Проверьте структуру HTML-страниц (может измениться)

