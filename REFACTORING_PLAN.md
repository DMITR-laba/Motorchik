# –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-16  
**–û—Å–Ω–æ–≤–∞:** –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ `idea.md`

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è](#–∞–Ω–∞–ª–∏–∑-—Ç–µ–∫—É—â–µ–≥–æ-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
2. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã)
3. [–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–ø–ª–∞–Ω-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
4. [–≠—Ç–∞–ø—ã –º–∏–≥—Ä–∞—Ü–∏–∏](#—ç—Ç–∞–ø—ã-–º–∏–≥—Ä–∞—Ü–∏–∏)
5. [–î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#–¥–µ—Ç–∞–ª—å–Ω–∞—è-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

---

## üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å:

‚úÖ **LangGraph** - —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `langgraph_rag_service.py` (–æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ RAGService)  
‚úÖ **pgvector** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞  
‚úÖ **Elasticsearch** - –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫  
‚úÖ **Mem0 + Qdrant** - –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å  
‚úÖ **Redis** - –∫—ç—à –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ  
‚úÖ **SQL Agent** - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å  
‚úÖ **RAG Service** - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤  

### –ü—Ä–æ–±–ª–µ–º—ã:

‚ùå **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—É—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏** - –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ 4+ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞  
‚ùå **–ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â** - pgvector + Qdrant –¥–ª—è –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏  
‚ùå **–†–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞** - –Ω–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞  
‚ùå **–°–ª–æ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏** - Redis ‚Üí Mem0 ‚Üí Qdrant  
‚ùå **SQL Agent –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω** - –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫  
‚ùå **chat_id nullable** - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö  

---

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø–µ—Ä–µ—É—Å–ª–æ–∂–Ω–µ–Ω–Ω–æ—Å—Ç—å

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
```
–ó–∞–ø—Ä–æ—Å ‚Üí [–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä] ‚Üí [–û–¥–∏–Ω –∏–∑ 5 —Å–µ—Ä–≤–∏—Å–æ–≤] ‚Üí –û—Ç–≤–µ—Ç
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –¥–µ–±–∞–≥–∞
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
- –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### 2. –ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- PostgreSQL (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- Elasticsearch (–ø–æ–∏—Å–∫)
- pgvector (–≤–µ–∫—Ç–æ—Ä—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π)
- Qdrant (–≤–µ–∫—Ç–æ—Ä—ã –¥–ª—è Mem0)
- Redis (–∫—ç—à)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### 3. –†–∞–∑–º–∞–∑–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–∏–∞–ª–æ–≥–∞

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- `DialogStateService` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- `DialogueHistoryService` - –∏—Å—Ç–æ—Ä–∏—è
- `Mem0Service` - –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å
- `LangGraphRAGService` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–º
- `RAGService` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞
- –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏

---

## üéØ –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å **–µ–¥–∏–Ω—É—é, —Ü–µ–ª–æ—Å—Ç–Ω—É—é –¥–∏–∞–ª–æ–≥–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É** —Å –ø–∞–º—è—Ç—å—é, –≥–¥–µ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ.

### –ü—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ï–¥–∏–Ω–æ–µ —è–¥—Ä–æ** - LangGraph –∫–∞–∫ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
2. **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â** - –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
3. **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–º–µ—Å—Ç–æ —Å–µ—Ä–≤–∏—Å–æ–≤** - –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∞–≥–µ–Ω—Ç–∞
4. **–£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏** - –ø—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ pgvector
5. **–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** - –∞–≥–µ–Ω—Ç —Å–∞–º —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## üìÖ –≠—Ç–∞–ø—ã –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (1 –Ω–µ–¥–µ–ª—è)

#### 1.1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–∞–º—è—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `backend/migrations/add_user_memories_table.py`

```sql
CREATE TABLE user_memories (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    memory_type VARCHAR(50) NOT NULL,  -- 'preference', 'rejection', 'interest', 'criteria'
    memory_text TEXT NOT NULL,
    embedding VECTOR(1024),
    metadata JSONB DEFAULT '{}',
    confidence FLOAT DEFAULT 1.0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_user_memories_semantic 
ON user_memories 
USING ivfflat (embedding vector_cosine_ops) 
WHERE user_id IS NOT NULL;

CREATE INDEX idx_user_memories_user_type 
ON user_memories (user_id, memory_type);
```

#### 1.2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ ChatMessage

**–§–∞–π–ª:** `backend/models/database.py`

```python
class ChatMessage(Base):
    __tablename__ = "chat_messages"
    
    chat_id = Column(Integer, ForeignKey("chats.id", ondelete="CASCADE"), nullable=False, index=True)  # –£–ë–†–ê–¢–¨ nullable=True
```

**–ú–∏–≥—Ä–∞—Ü–∏—è:**
```sql
-- –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏ –±–µ–∑ chat_id
UPDATE chat_messages SET chat_id = (SELECT id FROM chats WHERE user_id = chat_messages.user_id LIMIT 1) WHERE chat_id IS NULL;

-- –£–±—Ä–∞—Ç—å nullable
ALTER TABLE chat_messages ALTER COLUMN chat_id SET NOT NULL;
```

#### 1.3. –°–æ–∑–¥–∞–Ω–∏–µ UnifiedMemoryService

**–§–∞–π–ª:** `backend/services/unified_memory_service.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `get_user_context(user_id, query)` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- `save_memory(user_id, memory_data)` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- `get_user_preferences(user_id, query)` - –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- `extract_entities(messages)` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- PostgreSQL + pgvector
- Embedding service (Mistral/Ollama)

---

### –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (2 –Ω–µ–¥–µ–ª–∏)

#### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ CarDealerAgent

**–§–∞–π–ª:** `backend/services/car_dealer_agent.py`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ AgentState:**
```python
class AgentState(TypedDict):
    # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_input: str
    user_id: str
    session_id: str
    
    # –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
    chat_history: List[dict]
    dialogue_context: dict
    user_preferences: List[dict]
    
    # –ü–æ–∏—Å–∫–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    search_criteria: dict
    search_results: list
    knowledge_results: list
    
    # –°–æ—Å—Ç–æ—è–Ω–∏–µ
    current_intent: str
    needs_clarification: bool
    clarification_questions: List[str]
    
    # –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    response: str
    suggested_actions: List[str]
    memory_updates: List[dict]
    used_tools: List[str]
```

**–ì—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π:**
```
analyze_intent ‚Üí [route_by_intent] ‚Üí 
    ‚îú‚îÄ‚Üí search_cars ‚Üí extract_preferences ‚Üí generate_response ‚Üí update_memory ‚Üí END
    ‚îú‚îÄ‚Üí search_knowledge ‚Üí extract_preferences ‚Üí generate_response ‚Üí update_memory ‚Üí END
    ‚îú‚îÄ‚Üí extract_parameters ‚Üí search_cars ‚Üí ...
    ‚îî‚îÄ‚Üí generate_response ‚Üí update_memory ‚Üí END
```

**–£–∑–ª—ã –≥—Ä–∞—Ñ–∞:**
1. `analyze_intent` - –∞–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. `extract_parameters` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ LLM
3. `search_cars` - –ø–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π (—á–µ—Ä–µ–∑ UnifiedSearchService)
4. `search_knowledge` - –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π (RAG)
5. `sql_query` - SQL –∑–∞–ø—Ä–æ—Å (–∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
6. `extract_preferences` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
7. `generate_response` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
8. `update_memory` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

#### 2.2. –°–æ–∑–¥–∞–Ω–∏–µ UnifiedSearchService

**–§–∞–π–ª:** `backend/services/unified_search_service.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `intelligent_search(query, user_context, filters)` - —É–º–Ω—ã–π –ø–æ–∏—Å–∫
- `_hybrid_car_search(query, filters, user_context)` - –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
- `_exact_search(query, criteria)` - —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ (Elasticsearch)
- `_semantic_search(query, criteria, user_context)` - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ (pgvector)
- `_merge_search_results(es_results, vector_results, user_context)` - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–õ–æ–≥–∏–∫–∞:**
1. –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–æ–∏—Å–∫–∞
2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ - Elasticsearch + pgvector
3. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ
4. Fallback - –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –º–∞–ª–æ, —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–∏

#### 2.3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SQL Agent –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞

**–§–∞–π–ª:** `backend/services/car_dealer_agent.py` (—É–∑–µ–ª `sql_query`)

**–õ–æ–≥–∏–∫–∞:**
- –ê–≥–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ SQL (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î)
- –í—ã–∑—ã–≤–∞–µ—Ç SQL Agent –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
- –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ `generate_response`

**–ü—Ä–∏–º–µ—Ä:**
```python
async def sql_query_node(self, state: AgentState) -> AgentState:
    """–£–∑–µ–ª –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤"""
    if state["current_intent"] != "structured_query":
        return state
    
    sql_agent = SQLAgentService()
    result = await sql_agent.process_question(
        state["user_input"],
        user_id=state["user_id"]
    )
    
    state["search_results"] = result.get("data", [])
    state["used_tools"].append("sql_agent")
    
    return state
```

---

### –≠—Ç–∞–ø 3: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (1 –Ω–µ–¥–µ–ª—è)

#### 3.1. –ú–∏–≥—Ä–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –∏–∑ Qdrant –≤ PostgreSQL

**–§–∞–π–ª:** `backend/scripts/migrate_memories_from_qdrant.py`

```python
async def migrate_memories():
    """–ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –ø–∞–º—è—Ç—å –∏–∑ Qdrant –≤ PostgreSQL"""
    from qdrant_client import QdrantClient
    from services.unified_memory_service import UnifiedMemoryService
    
    qdrant = QdrantClient(url=os.getenv("QDRANT_URL"))
    memory_service = UnifiedMemoryService(db_session, embedding_service)
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    collections = qdrant.get_collections().collections
    
    for collection in collections:
        if collection.name.startswith("user_"):
            user_id = collection.name.replace("user_", "").replace("_memories", "")
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            points = qdrant.scroll(
                collection_name=collection.name,
                limit=1000
            )[0]
            
            for point in points:
                await memory_service.save_memory(
                    user_id=user_id,
                    memory_data={
                        "memory_text": point.payload.get("memory", ""),
                        "metadata": point.payload.get("metadata", {}),
                        "embedding": point.vector,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≤–µ–∫—Ç–æ—Ä
                        "memory_type": point.payload.get("memory_type", "preference")
                    }
                )
    
    print(f"‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
```

#### 3.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π ChatMessage

**SQL —Å–∫—Ä–∏–ø—Ç:**
```sql
-- –°–æ–∑–¥–∞–µ–º —á–∞—Ç—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ chat_id
INSERT INTO chats (user_id, title, created_at)
SELECT DISTINCT user_id, '–ú–∏–≥—Ä–∞—Ü–∏—è', NOW()
FROM chat_messages
WHERE chat_id IS NULL
ON CONFLICT DO NOTHING;

-- –û–±–Ω–æ–≤–ª—è–µ–º chat_id
UPDATE chat_messages cm
SET chat_id = (
    SELECT id FROM chats c 
    WHERE c.user_id = cm.user_id 
    ORDER BY c.created_at DESC 
    LIMIT 1
)
WHERE cm.chat_id IS NULL;

-- –£–±–∏—Ä–∞–µ–º nullable
ALTER TABLE chat_messages ALTER COLUMN chat_id SET NOT NULL;
```

---

### –≠—Ç–∞–ø 4: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ API (1 –Ω–µ–¥–µ–ª—è)

#### 4.1. –£–ø—Ä–æ—â–µ–Ω–∏–µ endpoint `/api/chat/message`

**–§–∞–π–ª:** `backend/app/api/chat.py`

**–ë—ã–ª–æ:**
```python
@router.post("/message")
async def send_message(request: ChatMessageRequest, db: Session = Depends(get_db)):
    # –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞
    if use_langgraph and langgraph_service:
        result = await langgraph_service.generate_with_graph(...)
    elif use_sql_agent:
        result = await sql_agent.process_question(...)
    else:
        result = await rag_service.generate_response(...)
```

**–°—Ç–∞–ª–æ:**
```python
@router.post("/message")
async def send_message(request: ChatMessageRequest, db: Session = Depends(get_db)):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –∞–≥–µ–Ω—Ç"""
    from services.car_dealer_agent import CarDealerAgent
    
    agent = CarDealerAgent(db_session=db)
    
    result = await agent.process_message(
        user_input=request.message,
        user_id=request.user_id,
        session_id=request.session_id or _current_session_id(request.user_id),
        chat_id=request.chat_id
    )
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    chat_message = db_service.save_chat_message(
        user_id=request.user_id,
        message=request.message,
        response=result["response"],
        related_article_ids=result.get("related_articles", []),
        chat_id=result["chat_id"],
        sources_data=result.get("sources_data")
    )
    
    return ChatMessageResponse(
        response=result["response"],
        related_articles=result.get("related_articles", []),
        related_documents=result.get("related_documents", []),
        related_cars=result.get("related_cars", []),
        related_used_cars=result.get("related_used_cars", []),
        message_id=chat_message.id,
        chat_id=result["chat_id"]
    )
```

#### 4.2. –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö endpoints

**–£–¥–∞–ª–∏—Ç—å:**
- `/api/ai/sql-agent/query` - —Ç–µ–ø–µ—Ä—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–≥–µ–Ω—Ç–∞
- `/api/ai/car-dealer/query` - –∑–∞–º–µ–Ω–µ–Ω –µ–¥–∏–Ω—ã–º –∞–≥–µ–Ω—Ç–æ–º
- `/api/ai/intelligent-search` - –∑–∞–º–µ–Ω–µ–Ω UnifiedSearchService

**–û—Å—Ç–∞–≤–∏—Ç—å:**
- `/api/chat/message` - –æ—Å–Ω–æ–≤–Ω–æ–π endpoint
- `/api/ai/sql-agent/status` - –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- `/api/ai/sql-agent/toggle` - –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

### –≠—Ç–∞–ø 5: –£–ª—É—á—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π (2 –Ω–µ–¥–µ–ª–∏)

#### 5.1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ LLM

**–§–∞–π–ª:** `backend/services/parameter_extraction_service.py`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
class CarSearchCriteria(BaseModel):
    brands: Optional[List[str]] = None
    models: Optional[List[str]] = None
    min_price: Optional[float] = None
    max_price: Optional[float] = None
    min_year: Optional[int] = None
    max_year: Optional[int] = None
    body_types: Optional[List[str]] = None
    fuel_types: Optional[List[str]] = None
    gearbox_types: Optional[List[str]] = None
    drive_types: Optional[List[str]] = None
    min_power: Optional[int] = None
    max_power: Optional[int] = None
    cities: Optional[List[str]] = None
    must_have_features: Optional[List[str]] = None
    exclude_features: Optional[List[str]] = None
    urgency: Optional[str] = None
    budget_flexibility: Optional[str] = None
```

**–ú–µ—Ç–æ–¥—ã:**
- `extract_parameters(query, context)` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ LLM
- `_enrich_with_context(query, context)` - –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- `_merge_criteria(existing, new)` - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤

#### 5.2. –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

**–§–∞–π–ª:** `backend/services/proactive_suggestions_service.py`

**–õ–æ–≥–∏–∫–∞:**
- –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:**
- "–•–æ—Ç–∏—Ç–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–µ—Å—Ç-–¥—Ä–∞–π–≤?"
- "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∞–ª–æ–≥–∏ –ø–æ–¥–µ—à–µ–≤–ª–µ?"
- "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂?"
- "–ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤ –∫—Ä–µ–¥–∏—Ç?"

#### 5.3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ—Å–ª–µ –¥–∏–∞–ª–æ–≥–∞

**–§–∞–π–ª:** `backend/services/entity_extraction_service.py`

**–ú–µ—Ç–æ–¥—ã:**
- `extract_entities_from_dialog(messages)` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ LLM
- `save_extracted_entities(user_id, entities)` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å

**–ò–∑–≤–ª–µ–∫–∞–µ–º—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:**
- –ë—Ä–µ–Ω–¥—ã –∏ –º–æ–¥–µ–ª–∏
- –ë—é–¥–∂–µ—Ç (–º–∏–Ω/–º–∞–∫—Å)
- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (—Ç–∏–ø –∫—É–∑–æ–≤–∞, –ø—Ä–∏–≤–æ–¥, –∏ —Ç.–¥.)
- –û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
- –ò–Ω—Ç–µ—Ä–µ—Å—ã

---

## üîß –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. UnifiedMemoryService

**–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
class UnifiedMemoryService:
    def __init__(self, db_session, embedding_service):
        self.db = db_session
        self.embeddings = embedding_service
    
    async def get_user_context(self, user_id: str, current_query: str) -> dict:
        """–ü–æ–ª—É—á–∞–µ—Ç –í–°–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        # 1. –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
        history = await self._get_recent_history(user_id)
        
        # 2. –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏–∑ pgvector
        preferences = await self._get_user_preferences(user_id, current_query)
        
        # 3. –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞
        entities = await self._extract_entities(history + [current_query])
        
        return {
            "history": history,
            "preferences": preferences,
            "entities": entities,
            "inferred_criteria": self._infer_search_criteria(preferences, entities)
        }
    
    async def _get_user_preferences(self, user_id: str, query: str) -> List[dict]:
        """–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –≤ pgvector"""
        query_embedding = await self.embeddings.embed_query(query)
        
        results = await self.db.execute(
            """
            SELECT memory_text, metadata, 
                   1 - (embedding <=> :embedding) as similarity
            FROM user_memories 
            WHERE user_id = :user_id 
            AND embedding <=> :embedding < 0.3
            ORDER BY embedding <=> :embedding
            LIMIT 5
            """,
            {"user_id": user_id, "embedding": query_embedding}
        )
        return [dict(row) for row in results]
    
    async def save_memory(self, user_id: str, memory_data: dict):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        memory_text = self._format_memory(memory_data)
        embedding = await self.embeddings.embed_query(memory_text)
        
        await self.db.execute(
            """
            INSERT INTO user_memories (user_id, memory_type, memory_text, embedding, metadata)
            VALUES (:user_id, :memory_type, :memory_text, :embedding, :metadata)
            """,
            {
                "user_id": user_id,
                "memory_type": memory_data.get("memory_type", "preference"),
                "memory_text": memory_text,
                "embedding": embedding,
                "metadata": json.dumps(memory_data.get("metadata", {}))
            }
        )
```

### 2. UnifiedSearchService

**–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

```python
class UnifiedSearchService:
    def __init__(self, elasticsearch_service, vector_search_service):
        self.es = elasticsearch_service
        self.vector = vector_search_service
    
    async def intelligent_search(self, query: str, user_context: dict, filters: dict = None) -> dict:
        """–£–º–Ω—ã–π –ø–æ–∏—Å–∫, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å"""
        
        # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        intent_analysis = await self._analyze_query_intent(query, user_context)
        
        results = {}
        
        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
        if intent_analysis["needs_car_search"]:
            results["cars"] = await self._hybrid_car_search(query, filters, user_context)
        
        if intent_analysis["needs_knowledge"]:
            results["knowledge"] = await self._knowledge_search(query, user_context)
        
        return self._rank_and_merge_results(results, intent_analysis)
    
    async def _hybrid_car_search(self, query: str, filters: dict, user_context: dict) -> List[dict]:
        """–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
        
        # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
        es_future = self._exact_search(query, filters)
        vector_future = self._semantic_search(query, filters, user_context)
        
        es_results, vector_results = await asyncio.gather(es_future, vector_future)
        
        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ
        return await self._merge_search_results(es_results, vector_results, user_context)
    
    async def _exact_search(self, query: str, criteria: dict) -> List[dict]:
        """–ü–æ–∏—Å–∫ –ø–æ —Ç–æ—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º –≤ Elasticsearch"""
        return await self.es.search_cars(
            query=query,
            mark=criteria.get("brands", [None])[0] if criteria.get("brands") else None,
            min_price=criteria.get("min_price"),
            max_price=criteria.get("max_price"),
            min_year=criteria.get("min_year"),
            max_year=criteria.get("max_year"),
            limit=20
        )
    
    async def _semantic_search(self, query: str, criteria: dict, user_context: dict) -> List[dict]:
        """–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"""
        semantic_query = self._prepare_semantic_query(query, user_context)
        
        vector_results = await self.vector.similarity_search(
            semantic_query,
            filters=criteria,
            limit=20
        )
        
        return vector_results
```

### 3. CarDealerAgent

**–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞:**

```python
class CarDealerAgent:
    def __init__(self, db_session, memory_service, search_service, llm_service):
        self.db = db_session
        self.memory = memory_service
        self.search = search_service
        self.llm = llm_service
        self.graph = self._build_graph()
    
    def _build_graph(self):
        workflow = StateGraph(AgentState)
        
        # –£–∑–ª—ã
        workflow.add_node("analyze_intent", self.analyze_intent)
        workflow.add_node("extract_parameters", self.extract_parameters)
        workflow.add_node("search_cars", self.search_cars)
        workflow.add_node("search_knowledge", self.search_knowledge)
        workflow.add_node("sql_query", self.sql_query)
        workflow.add_node("extract_preferences", self.extract_preferences)
        workflow.add_node("generate_response", self.generate_response)
        workflow.add_node("update_memory", self.update_memory)
        
        # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
        workflow.set_entry_point("analyze_intent")
        
        workflow.add_conditional_edges(
            "analyze_intent",
            self.route_by_intent,
            {
                "car_search": "extract_parameters",
                "knowledge_query": "search_knowledge",
                "structured_query": "sql_query",
                "clarification": "generate_response"
            }
        )
        
        workflow.add_edge("extract_parameters", "search_cars")
        workflow.add_edge("search_cars", "extract_preferences")
        workflow.add_edge("search_knowledge", "extract_preferences")
        workflow.add_edge("sql_query", "extract_preferences")
        workflow.add_edge("extract_preferences", "generate_response")
        workflow.add_edge("generate_response", "update_memory")
        workflow.add_edge("update_memory", END)
        
        return workflow.compile()
    
    async def process_message(self, user_input: str, user_id: str, session_id: str, chat_id: int = None) -> dict:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_context = await self.memory.get_user_context(user_id, user_input)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        initial_state: AgentState = {
            "user_input": user_input,
            "user_id": user_id,
            "session_id": session_id,
            "chat_history": user_context["history"],
            "dialogue_context": user_context,
            "user_preferences": user_context["preferences"],
            "search_criteria": user_context["inferred_criteria"],
            "search_results": [],
            "knowledge_results": [],
            "current_intent": "",
            "needs_clarification": False,
            "clarification_questions": [],
            "response": "",
            "suggested_actions": [],
            "memory_updates": [],
            "used_tools": []
        }
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≥—Ä–∞—Ñ
        final_state = await self.graph.ainvoke(initial_state)
        
        return {
            "response": final_state["response"],
            "related_cars": final_state.get("search_results", []),
            "related_articles": final_state.get("knowledge_results", []),
            "suggested_actions": final_state.get("suggested_actions", []),
            "chat_id": chat_id
        }
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ú–µ—Ç—Ä–∏–∫–∞ | –°–µ–π—á–∞—Å | –ü–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ |
|---------|--------|-------------------|
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ | 2-5 —Å–µ–∫ | 1-3 —Å–µ–∫ |
| –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è |
| –ö–∞—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–∞ | –®–∞–±–ª–æ–Ω–Ω–æ–µ | –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö—Ä–∞–Ω–∏–ª–∏—â | 4 | 2.5 (Elasticsearch - —á–∏—Ç–∞—é—â–∞—è —Ä–µ–ø–ª–∏–∫–∞) |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–æ–≤ | 10+ | 3-4 (–∞–≥–µ–Ω—Ç + –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã) |

---

## üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-2 –Ω–µ–¥–µ–ª–∏)

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `user_memories`
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ `ChatMessage` (chat_id NOT NULL)
3. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ `UnifiedMemoryService`
4. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ `UnifiedSearchService`
5. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ `CarDealerAgent`

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (2-3 –Ω–µ–¥–µ–ª–∏)

6. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –∏–∑ Qdrant
7. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SQL Agent –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
8. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ API endpoint
9. ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ LLM

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-2 –Ω–µ–¥–µ–ª–∏)

10. ‚úÖ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
11. ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ—Å–ª–µ –¥–∏–∞–ª–æ–≥–∞
12. ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (Mem0, Qdrant)

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –ü–æ–ª–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
- –ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞

### –†–∏—Å–∫ 2: –°–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ (feature flags)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

### –†–∏—Å–∫ 3: –†–µ–≥—Ä–µ—Å—Å–∏–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìù –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è `user_memories`
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å `ChatMessage`
- [ ] –°–æ–∑–¥–∞—Ç—å `UnifiedMemoryService`
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è `UnifiedMemoryService`

### –≠—Ç–∞–ø 2: –ï–¥–∏–Ω—ã–π –∞–≥–µ–Ω—Ç
- [ ] –°–æ–∑–¥–∞—Ç—å `CarDealerAgent` —Å –±–∞–∑–æ–≤—ã–º –≥—Ä–∞—Ñ–æ–º
- [ ] –°–æ–∑–¥–∞—Ç—å `UnifiedSearchService`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å SQL Agent –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è –∞–≥–µ–Ω—Ç–∞

### –≠—Ç–∞–ø 3: –ú–∏–≥—Ä–∞—Ü–∏—è
- [ ] –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏ –∏–∑ Qdrant
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö ChatMessage
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### –≠—Ç–∞–ø 4: API
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `/api/chat/message`
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö endpoints
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –≠—Ç–∞–ø 5: –£–ª—É—á—à–µ–Ω–∏—è
- [ ] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ LLM
- [ ] –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- [ ] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ Mem0 –∏ Qdrant

---

## üéØ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–µ–∫

1. **–Ø–¥—Ä–æ:** LangGraph + CarDealerAgent
2. **–•—Ä–∞–Ω–∏–ª–∏—â–∞:** PostgreSQL + pgvector (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ), Elasticsearch (–ø–æ–∏—Å–∫), Redis (—Å–µ—Å—Å–∏–∏)
3. **–ü–æ–∏—Å–∫:** UnifiedSearchService —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
4. **–ü–∞–º—è—Ç—å:** UnifiedMemoryService —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
5. **–î–∏–∞–ª–æ–≥:** Proactive agent —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏

---

**–°—Ç–∞—Ç—É—Å:** üìã –ü–ª–∞–Ω –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—á–∞—Ç—å —Å –≠—Ç–∞–ø–∞ 1 - –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

