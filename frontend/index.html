<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
        <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8' fill='%233b82f6'/%3E%3Cpath d='M4 8l2.2 2.2L12 4.4' stroke='%23fff' stroke-width='2' fill='none'/%3E%3C/svg%3E" />
        <!-- Syntax highlighting & Markdown -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        .chat-bubble-ai {
            background-color: #f3f4f6;
            color: #111827;
            border-radius: 18px 18px 18px 4px;
        }
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        .language-switcher.active {
            background-color: #3b82f6;
            color: white;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Фикс-шейка: чистым CSS внутри скролл-контейнера таблицы */
        #articlesTable thead th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 1;
        }
        /* Code block styling and copy button */
        pre {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            overflow: auto;
        }
        .code-block-wrapper {
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #374151;
            color: #fff;
            border: none;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.85;
        }
        .copy-button:hover { opacity: 1; }
        /* Custom scrollbar styles for search results */
        #sourcesList::-webkit-scrollbar,
        #sourcesModalList::-webkit-scrollbar {
            width: 10px;
        }
        #sourcesList::-webkit-scrollbar-track,
        #sourcesModalList::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 5px;
        }
        #sourcesList::-webkit-scrollbar-thumb,
        #sourcesModalList::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 5px;
            min-height: 30px;
        }
        #sourcesList::-webkit-scrollbar-thumb:hover,
        #sourcesModalList::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-md" data-aos="zoom-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Sign In</h2>
                <button onclick="toggleLanguage()" class="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-300">
                    <span id="languageLabel">EN</span>
                    <i data-feather="globe"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <button onclick="ssoLogin()" class="w-full flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition">
                    <i data-feather="key"></i>
                    <span id="ssoText">Sign in with Corporate SSO</span>
                </button>
                
                <div class="relative flex items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-500" id="orText">OR</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1" id="emailLabel">Email</label>
                        <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1" id="passwordLabel">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button onclick="emailLogin()" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 px-4 rounded-lg transition">
                        <span id="signInText">Sign In</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chatInterface" class="hidden h-screen flex flex-col" style="position: relative;">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 py-4 px-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-semibold text-gray-800">AI Assistant</h1>
                <div id="currentModelDisplay" class="hidden">
                    <span class="text-sm text-gray-500">Модель:</span>
                    <span id="currentModelName" class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        Загрузка...
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleLanguage()" class="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-300">
                    <span id="chatLanguageLabel">EN</span>
                    <i data-feather="globe"></i>
                </button>
                <button onclick="newChatUI()" class="px-3 py-2 rounded-full border border-gray-300 hover:bg-gray-100">
                    New Chat
                </button>
                <button onclick="showAdminPanel()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="settings"></i>
                </button>
                <button onclick="logout()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="log-out"></i>
                </button>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Sidebar - Chat History -->
            <div class="w-80 bg-gray-50 border-r border-gray-200 flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-gray-700">Chat History</h3>
                        <button onclick="newChatUI()" class="px-3 py-2 rounded-full border border-gray-300 hover:bg-gray-100 text-sm">
                            New Chat
                        </button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="chatHistory">
                    <div class="space-y-2">
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Recent Chats</div>
                        <!-- Список чатов загружается динамически -->
                    </div>
                </div>
            </div>
            
            <!-- Center - Chat Messages -->
            <div class="flex-1 flex flex-col">
                <!-- Chat Title Header -->
                <div class="border-b border-gray-200 bg-white" style="flex: 0 0 auto; z-index: 12;">
                    <div style="flex: 1 1 0%; min-width: 0px; display: flex; place-content: center; padding: 12px 16px;">
                        <div id="chatTitleDisplay" class="text-sm font-medium text-gray-900 cursor-pointer hover:text-blue-600 transition-colors px-3 py-1 rounded hover:bg-gray-50" 
                             onclick="editCurrentChatTitle()" 
                             style="outline: none; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <span id="chatTitleText">Новый чат</span>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Area -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chatArea">
                    <!-- Messages will appear here -->
                    <div class="text-center py-8 text-gray-500" id="emptyState">
                        <i data-feather="message-square" class="w-12 h-12 mx-auto text-gray-300"></i>
                        <p class="mt-4" id="welcomeMessage">Start a conversation with the AI assistant</p>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="border-t border-gray-200 p-4 bg-white">
                    <div class="relative">
                        <textarea id="messageInput" rows="2" class="w-full px-4 py-3 pr-32 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="Type your message..."></textarea>
                        <div class="absolute right-3 bottom-3 flex gap-2">
                            <button id="intelligentSearchButton" onclick="toggleIntelligentSearch()" 
                                    class="ds-atom-button f79352dc ds-toggle-button ds-toggle-button--md p-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors"
                                    title="Интеллектуальный поиск"
                                    role="button" aria-disabled="false" tabindex="0">
                                <div class="ds-icon ds-atom-button__icon flex items-center justify-center" style="font-size: 14px; width: 14px; height: 14px; color: var(--dsw-alias-brand-text, #374151); margin-right: 0px;">
                                    <i data-feather="search"></i>
                                </div>
                                <span class="text-xs ml-1 hidden sm:inline">Умный поиск</span>
                            </button>
                            <button id="deepThinkingButton" onclick="toggleDeepThinking()" 
                                    class="ds-atom-button f79352dc ds-toggle-button ds-toggle-button--md p-2 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors"
                                    title="Глубокое мышление"
                                    role="button" aria-disabled="false" tabindex="0">
                                <div class="ds-icon ds-atom-button__icon flex items-center justify-center" style="font-size: 14px; width: 14px; height: 14px; color: var(--dsw-alias-brand-text, #374151); margin-right: 0px;">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M7.06431 5.93342C7.68763 5.93342 8.19307 6.43904 8.19322 7.06233C8.19322 7.68573 7.68772 8.19123 7.06431 8.19123C6.44099 8.19113 5.9354 7.68567 5.9354 7.06233C5.93555 6.43911 6.44108 5.93353 7.06431 5.93342Z" fill="currentColor"></path>
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M8.6815 0.963693C10.1169 0.447019 11.6266 0.374829 12.5633 1.31135C13.5 2.24805 13.4277 3.75776 12.911 5.19319C12.7126 5.74431 12.4386 6.31796 12.0965 6.89729C12.4969 7.54638 12.8141 8.19018 13.036 8.80647C13.5527 10.2419 13.6251 11.7516 12.6883 12.6883C11.7516 13.625 10.242 13.5527 8.8065 13.036C8.19022 12.8141 7.54641 12.4969 6.89732 12.0965C6.31797 12.4386 5.74435 12.7125 5.19322 12.911C3.75777 13.4276 2.2481 13.5 1.31138 12.5633C0.374859 11.6266 0.447049 10.1168 0.963724 8.68147C1.17185 8.10338 1.46321 7.50063 1.82896 6.8924C1.52182 6.35711 1.27235 5.82825 1.08872 5.31819C0.572068 3.88278 0.499714 2.37306 1.43638 1.43635C2.37308 0.499655 3.8828 0.572044 5.31822 1.08869C5.82828 1.27232 6.35715 1.5218 6.89243 1.82893C7.50066 1.46318 8.10341 1.17181 8.6815 0.963693ZM11.3573 8.01154C10.9083 8.62253 10.3901 9.22873 9.80943 9.8094C9.22877 10.3901 8.62255 10.9083 8.01158 11.3572C8.4257 11.5841 8.8287 11.7688 9.21275 11.9071C10.5456 12.3868 11.4246 12.2547 11.8397 11.8397C12.2548 11.4246 12.3869 10.5456 11.9071 9.21272C11.7688 8.82866 11.5841 8.42568 11.3573 8.01154ZM2.56529 8.02912C2.37344 8.39322 2.21495 8.74796 2.09263 9.08772C1.61291 10.4204 1.74512 11.2995 2.16001 11.7147C2.57505 12.1297 3.45415 12.2618 4.78697 11.7821C5.11057 11.6656 5.44786 11.5164 5.7938 11.3367C5.249 10.9223 4.70922 10.4533 4.19029 9.9344C3.57578 9.31987 3.03169 8.67633 2.56529 8.02912ZM6.90708 3.2469C6.24065 3.70479 5.5646 4.26321 4.91392 4.91389C4.26325 5.56456 3.70482 6.24063 3.24693 6.90705C3.72674 7.63325 4.32777 8.37459 5.03892 9.08576C5.64943 9.69627 6.28183 10.2265 6.90806 10.6678C7.59368 10.2025 8.2908 9.63076 8.96079 8.96076C9.6308 8.29075 10.2025 7.59366 10.6678 6.90803C10.2265 6.2818 9.69631 5.6494 9.08579 5.03889C8.37462 4.32773 7.63328 3.72672 6.90708 3.2469ZM11.7147 2.15998C11.2996 1.74509 10.4204 1.61288 9.08775 2.0926C8.74835 2.21479 8.39382 2.37271 8.03013 2.56428C8.67728 3.03065 9.31995 3.5758 9.93443 4.19026C10.4534 4.7092 10.9223 5.24896 11.3368 5.79377C11.5164 5.44785 11.6656 5.11052 11.7821 4.78694C12.2618 3.45416 12.1297 2.57502 11.7147 2.15998ZM4.91197 2.2176C3.57922 1.73788 2.70004 1.86995 2.28501 2.28498C1.87001 2.70003 1.73791 3.5792 2.21763 4.91194C2.31709 5.18822 2.44112 5.47427 2.58677 5.7674C3.01931 5.1887 3.51474 4.6158 4.06529 4.06526C4.61584 3.5147 5.18872 3.01928 5.76743 2.58674C5.47431 2.4411 5.18824 2.31706 4.91197 2.2176Z" fill="currentColor"></path>
                                    </svg>
                                </div>
                                <span class="text-xs ml-1 hidden sm:inline">Глубокое мышление</span>
                            </button>
                            <button id="voiceButton" onclick="toggleVoiceRecording()" 
                                    class="p-2 rounded-full bg-gray-600 text-white hover:bg-gray-700 hidden"
                                    title="Голосовой ввод">
                                <i data-feather="mic"></i>
                            </button>
                            <button id="sendButton" onclick="sendMessage()" class="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700">
                                <i data-feather="send"></i>
                            </button>
                        </div>
                        <div id="voiceRecordingIndicator" class="absolute top-2 right-3 hidden">
                            <div class="flex items-center gap-2 px-3 py-1 bg-red-100 border border-red-300 rounded-full">
                                <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></div>
                                <span class="text-xs text-red-700 font-medium">Запись...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-white z-50 overflow-y-auto">
        <div class="max-w-7xl mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Admin Panel</h2>
                <button onclick="hideAdminPanel()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <!-- Табы для переключения между авто и документами -->
            <div class="mb-6">
                <div class="flex border-b border-gray-200">
                    <button id="carsTab" onclick="showCarsTab()" class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                        Авто
                    </button>
                    <button id="documentsTab" onclick="showDocumentsTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Документы
                    </button>
                    <button id="aiTab" onclick="showAiTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        AI
                    </button>
                    <button id="usersTab" onclick="showUsersTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Пользователи
                    </button>
                    <button id="parserTab" onclick="showParserTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Парсинг
                    </button>
                    <button id="voiceTab" onclick="showVoiceTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Распознавание речи
                    </button>
                    <button id="importTab" onclick="showImportTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Импорт
                    </button>
                    <button id="domainTab" onclick="showDomainTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Настройка домена
                    </button>
                    <button id="metricsTab" onclick="showMetricsTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Метрики качества
                    </button>
                    <button id="modelsTab" onclick="showModelsTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Управление моделями
                    </button>
                </div>
            </div>

            <!-- Секция авто -->
            <div id="carsSection" class="mb-6 relative">
                <!-- Выбор таблицы -->
                <div class="mb-4 flex gap-2 border-b border-gray-200">
                    <button id="newCarsBtn" onclick="showCarsTable('new')" class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                        Новые
                    </button>
                    <button id="usedCarsBtn" onclick="showCarsTable('used')" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Подержанные
                    </button>
                    <button id="optionsBtn" onclick="showCarsTable('options')" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Опции
                    </button>
                </div>
                
                <!-- Контейнер для таблиц -->
                <div id="carsContainer" class="mt-4 overflow-auto" style="max-height: calc(100vh - 320px);">
                    <!-- Таблица новых автомобилей -->
                    <table id="newCarsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Марка</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Модель</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Год</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цена</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Город</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VIN</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="newCarsTableBody">
                            <!-- Новые автомобили будут загружены сюда -->
                        </tbody>
                    </table>
                    
                    <!-- Таблица подержанных автомобилей -->
                    <table id="usedCarsTable" class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Марка</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Модель</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Год</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цена</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пробег</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Город</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VIN</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="usedCarsTableBody">
                            <!-- Подержанные автомобили будут загружены сюда -->
                        </tbody>
                    </table>
                    
                    <!-- Таблица опций -->
                    <table id="optionsTable" class="min-w-full divide-y divide-gray-200 hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Car ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Код</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Описание</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Группа</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="optionsTableBody">
                            <!-- Опции будут загружены сюда -->
                        </tbody>
                    </table>
                </div>
                <!-- Fixed header clone and bottom scroll mirror for wide tables -->
                <div id="adminHeaderClone" class="hidden z-50" style="position: fixed; top: 0; left: 0; right: 0; background: #f9fafb; border-bottom: 1px solid #e5e7eb; pointer-events: none;">
                    <div id="adminHeaderScroller" style="overflow: hidden; width: 100%;">
                        <!-- cloned table head will be inserted here -->
                    </div>
                </div>
                <div id="adminScrollMirror" class="hidden h-3 overflow-x-auto z-40" style="background: rgba(249,250,251,0.85); position: fixed; left: 0; right: 0; bottom: 0; border-top: 1px solid #e5e7eb;">
                    <div id="adminScrollSpacer" style="height:1px; width:0;"></div>
                </div>
            </div>

            <!-- Секция статей (скрыта) -->
            <div id="articlesSection" class="mb-6 relative hidden">
                <div class="flex justify_between items-center">
                    <h3 class="text-lg font-semibold">Knowledge Base Articles</h3>
                    <div class="flex gap-2">
                        <button onclick="showCreateArticleModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-feather="plus"></i>
                            <span>Create Article</span>
                        </button>
                        <button onclick="showImportModal()" class="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">
                            <i data-feather="upload"></i>
                            <span>Import JSON</span>
                        </button>
                        <button onclick="reindex()" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i data-feather="refresh-cw"></i>
                            <span>Reindex</span>
                        </button>
                        <button onclick="generateMetaSelected()" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            <i data-feather="zap"></i>
                            <span>Generate Tags & Category</span>
                        </button>
                    </div>
                </div>
                
                <div id="articlesContainer" class="mt-4 overflow-auto" style="max-height: calc(100vh - 260px);">
                    <table id="articlesTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="articlesTableBody">
                            <!-- Articles will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <!-- Fixed header clone and bottom scroll mirror for wide tables -->
                <div id="adminHeaderClone" class="hidden z-50" style="position: fixed; top: 0; left: 0; right: 0; background: #f9fafb; border-bottom: 1px solid #e5e7eb; pointer-events: none;">
                    <div id="adminHeaderScroller" style="overflow: hidden; width: 100%;">
                        <!-- cloned table head will be inserted here -->
                    </div>
                </div>
                <div id="adminScrollMirror" class="hidden h-3 overflow-x-auto z-40" style="background: rgba(249,250,251,0.85); position: fixed; left: 0; right: 0; bottom: 0; border-top: 1px solid #e5e7eb;">
                    <div id="adminScrollSpacer" style="height:1px; width:0;"></div>
                </div>
            </div>

            <!-- Секция документов -->
            <div id="documentsSection" class="mb-6 relative hidden">
                <div class="flex justify_between items-center">
                    <h3 class="text-lg font-semibold">Документы</h3>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showUploadDocumentModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-feather="upload"></i>
                            <span>Загрузить документ</span>
                        </button>
                        <button onclick="processAllDocuments()" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i data-feather="refresh-cw"></i>
                            <span>Обработать все</span>
                        </button>
                        <button onclick="generateCategoriesForSelected()" class="flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            <i data-feather="tag"></i>
                            <span>Генерировать категории</span>
                        </button>
                        <button onclick="generateTagsForSelected()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            <i data-feather="hash"></i>
                            <span>Генерировать теги</span>
                        </button>
                        <button onclick="generateAllMetaForSelected()" class="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                            <i data-feather="zap"></i>
                            <span>Генерировать все метаданные</span>
                        </button>
                        <button onclick="deleteSelectedDocuments()" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            <i data-feather="trash-2"></i>
                            <span>Удалить выбранные</span>
                        </button>
                    </div>
                </div>
                
                <div id="documentsContainer" class="mt-4 overflow-auto" style="max-height: calc(100vh - 260px);">
                    <table id="documentsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllDocuments" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="toggleAllDocuments()">
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Файл</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Тема</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Путь</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Теги</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Загружен</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="documentsTableBody">
                            <!-- Документы будут загружены здесь -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Секция AI -->
            <div id="aiSection" class="mb-6 relative hidden">
                <div class="space-y-6">
                    <!-- Текущие настройки -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4">Текущие настройки</h3>
                        <div id="currentSettings" class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-700">Модель для ответов:</span>
                                <span id="currentResponseModel" class="text-sm text-gray-600">Не выбрана</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-700">Модель для эмбеддингов:</span>
                                <span id="currentEmbeddingModel" class="text-sm text-gray-600">Не выбрана</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-700">API сервис:</span>
                                <span id="currentApiService" class="text-sm text-gray-600">Не настроен</span>
                            </div>
                        </div>
                    </div>

                    <!-- API ключи -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">API ключи</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Сервис</label>
                                <select id="apiService" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="mistral">Mistral AI</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="google">Google AI</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API ключ</label>
                                <div class="flex gap-2">
                                    <input type="password" id="apiKey" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Введите API ключ">
                                    <button onclick="toggleApiKeyVisibility()" class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                                        <i data-feather="eye" id="apiKeyToggleIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <button onclick="saveApiKey()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Сохранить ключ
                                </button>
                                <button onclick="testApiConnection()" class="ml-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    Тестировать подключение
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Локальные модели -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Локальные модели (Ollama)</h3>
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <button onclick="loadOllamaModels()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>
                                    Загрузить модели
                                </button>
                                <button onclick="checkOllamaStatus()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                    <i data-feather="activity" class="w-4 h-4 mr-2"></i>
                                    Проверить статус
                                </button>
                            </div>
                            <div id="ollamaModelsList" class="space-y-2">
                                <!-- Модели будут загружены здесь -->
                            </div>
                        </div>
                    </div>

                    <!-- Настройки моделей -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Настройки моделей</h3>
                        
                        <!-- Переключатель провайдера -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Предпочитаемый провайдер:</label>
                            <div class="flex gap-2">
                                <button onclick="setPreferredProvider('ollama')" id="prefProviderOllama" 
                                        class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                                    <i data-feather="server" class="w-4 h-4 inline mr-2"></i>
                                    Ollama (локальные)
                                </button>
                                <button onclick="setPreferredProvider('api')" id="prefProviderApi" 
                                        class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors">
                                    <i data-feather="cloud" class="w-4 h-4 inline mr-2"></i>
                                    API (Mistral/OpenAI/Anthropic)
                                </button>
                            </div>
                            <p class="mt-2 text-xs text-gray-500">Выбранный провайдер будет использоваться по умолчанию для новых задач</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Модель для ответов</label>
                                <select id="responseModel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Выберите модель</option>
                                </select>
                                <div class="mt-1 flex items-center gap-2">
                                    <button onclick="testModel('response')" class="text-xs text-blue-600 hover:text-blue-800">
                                        Тестировать модель
                                    </button>
                                    <span id="responseModelProvider" class="text-xs text-gray-500"></span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Модель для эмбеддингов</label>
                                <select id="embeddingModel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Выберите модель</option>
                                </select>
                                <div class="mt-1 flex items-center gap-2">
                                    <button onclick="testModel('embedding')" class="text-xs text-blue-600 hover:text-blue-800">
                                        Тестировать модель
                                    </button>
                                    <span id="embeddingModelProvider" class="text-xs text-gray-500"></span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="saveModelSettings()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                Сохранить настройки
                            </button>
                            <button onclick="loadCurrentSettings()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                Загрузить текущие
                            </button>
                        </div>
                    </div>

                    <!-- Настройки модели размышления -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Модель для режима размышления</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            Модель, которая будет использоваться когда пользователь включает кнопку "Глубокое мышление" в чате.
                        </p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Модель для размышления</label>
                                <select id="deepThinkingModel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Не выбрана (будет использована обычная модель)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Рекомендуется: DeepSeek R1 для глубокого анализа</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API ключ DeepSeek (если используется DeepSeek)</label>
                                <div class="flex gap-2">
                                    <input type="password" id="deepseekApiKey" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Введите API ключ DeepSeek">
                                    <button onclick="toggleDeepseekApiKeyVisibility()" class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                                        <i data-feather="eye" id="deepseekApiKeyToggleIcon"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Требуется только если выбран DeepSeek в качестве модели размышления</p>
                            </div>
                            <div class="mt-4">
                                <button onclick="saveDeepThinkingSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Сохранить настройки размышления
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Статус подключения -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Статус подключения</h3>
                        <div id="connectionStatus" class="space-y-2">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full" id="apiStatusIndicator"></div>
                                <span id="apiStatusText">API: Не подключен</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full" id="ollamaStatusIndicator"></div>
                                <span id="ollamaStatusText">Ollama: Не подключен</span>
                            </div>
                        </div>
                    </div>

                    <!-- SQL-Агент -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">SQL-Агент</h3>
                        <p class="text-sm text-gray-600 mb-4">
                            ИИ-агент для работы с базой данных. Позволяет задавать вопросы на естественном языке и получать SQL-запросы с результатами.
                        </p>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Статус SQL-агента</label>
                                    <p class="text-xs text-gray-500">Используйте SQL-агента для запросов к базе данных через естественный язык</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="sqlAgentToggle" class="sr-only peer" onchange="toggleSQLAgent()">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    <span class="ml-3 text-sm font-medium text-gray-700" id="sqlAgentStatusText">Выключен</span>
                                </label>
                            </div>
                            <div id="sqlAgentInfo" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <strong>SQL-агент включен!</strong> Теперь вы можете задавать вопросы к базе данных в чате. 
                                    Например: "Сколько пользователей в системе?", "Покажи все автомобили марки Toyota" и т.д.
                                </p>
                            </div>
                            
                            <!-- Модель для SQL агента -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="text-md font-semibold text-gray-800 mb-3">Модель для SQL агента</h4>
                                <p class="text-xs text-gray-500 mb-4">
                                    Выберите модель для генерации SQL запросов. Если не выбрана, будет использована модель из настроек AI.
                                </p>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Модель для генерации SQL</label>
                                        <select id="sqlAgentModelSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" onchange="updateSQLAgentModel()">
                                            <option value="">Использовать модель из настроек AI</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Модель для генерации SQL запросов из естественного языка</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fallback на Elasticsearch -->
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <h4 class="text-md font-semibold text-gray-800 mb-3">Fallback на Elasticsearch</h4>
                                <p class="text-xs text-gray-500 mb-4">
                                    Если SQL-агент не справится с запросом, будет использован поиск через Elasticsearch по тем же полям и таблицам.
                                </p>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Включить fallback</label>
                                            <p class="text-xs text-gray-500">Автоматически использовать Elasticsearch при ошибках SQL-агента</p>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="esFallbackToggle" class="sr-only peer" onchange="toggleESFallback()">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            <span class="ml-3 text-sm font-medium text-gray-700" id="esFallbackStatusText">Выключен</span>
                                        </label>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Модель Elasticsearch</label>
                                        <select id="esModelSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" onchange="updateESModel()">
                                            <option value="bert_spacy">BERT + spaCy (локально)</option>
                                            <option value="ollama">Ollama</option>
                                            <option value="mistral">Mistral AI</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Модель для семантического поиска в Elasticsearch</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция пользователей -->
            <div id="usersSection" class="mb-6 relative hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Пользователи</h3>
                    <div class="flex gap-2">
                        <button onclick="showCreateUserModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-feather="user-plus"></i>
                            <span>Создать пользователя</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Роль</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Создан</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="usersTableBody">
                            <!-- Пользователи будут загружены здесь -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Секция парсинга -->
            <div id="parserSection" class="mb-6 relative hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Парсинг автомобилей с aaa-motors.ru</h3>
                </div>

                <!-- Панель управления парсингом -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h4 class="text-md font-semibold mb-4">Настройки парсинга</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Максимальное количество страниц
                            </label>
                            <input type="number" id="parserMaxPages" value="5" min="1" max="100" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Максимальное количество автомобилей
                            </label>
                            <input type="number" id="parserMaxCars" value="50" min="1" max="1000" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Задержка между запросами (секунды)
                            </label>
                            <input type="number" id="parserDelay" value="1.0" min="0.5" max="10" step="0.1" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Базовый URL
                            </label>
                            <input type="text" id="parserBaseUrl" value="https://aaa-motors.ru" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Настройки метода парсинга -->
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h5 class="text-sm font-semibold mb-3">Метод парсинга</h5>
                        
                        <div class="space-y-4">
                            <!-- Выбор типа парсера -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Тип парсера</label>
                                <div class="space-y-2">
                                    <label class="flex items-start p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="parserType" value="basic" 
                                               class="mt-1 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                                               onchange="updateParserType()">
                                        <div class="ml-3 flex-1">
                                            <div class="text-sm font-medium text-gray-900">Базовый парсер</div>
                                            <div class="text-xs text-gray-500">Быстрый парсинг без ИИ. Использует только HTML структуру.</div>
                                        </div>
                                    </label>
                                    
                                    <label class="flex items-start p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="parserType" value="ai" checked
                                               class="mt-1 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                                               onchange="updateParserType()">
                                        <div class="ml-3 flex-1">
                                            <div class="text-sm font-medium text-gray-900">ИИ-парсер (NLP + ML)</div>
                                            <div class="text-xs text-gray-500">Использует NLP для извлечения сущностей и ML для анализа тональности.</div>
                                        </div>
                                    </label>
                                    
                                    <label class="flex items-start p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="parserType" value="ai_ollama" 
                                               class="mt-1 w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                                               onchange="updateParserType()">
                                        <div class="ml-3 flex-1">
                                            <div class="text-sm font-medium text-gray-900">ИИ-парсер с Ollama</div>
                                            <div class="text-xs text-gray-500">NLP + ML + Ollama для максимально точного извлечения данных.</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Настройки ИИ (показываются только для ИИ-парсеров) -->
                            <div id="aiParserOptions" class="space-y-3">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i data-feather="info" class="w-4 h-4 text-blue-600"></i>
                                        <span class="text-sm font-medium text-blue-900">ИИ компоненты</span>
                                    </div>
                                    <div class="text-xs text-blue-800 space-y-1">
                                        <div>• <strong>NLP (spaCy):</strong> Извлечение сущностей (марка, модель, город, год, цена)</div>
                                        <div>• <strong>ML (Transformers):</strong> Анализ тональности и классификация текста</div>
                                        <div id="ollamaInfo" class="hidden">• <strong>Ollama:</strong> Структурированное извлечение данных через LLM</div>
                                    </div>
                                </div>
                                
                                <div id="ollamaOptions" class="space-y-3">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="parserUseOllama" 
                                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                               onchange="toggleOllamaOptions()">
                                        <span class="ml-2 text-sm text-gray-700">Дополнительно использовать Ollama</span>
                                    </label>
                                    
                                    <div id="ollamaModelSelector" class="ml-6 hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Модель Ollama
                                        </label>
                                        <select id="parserOllamaModel" 
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">По умолчанию (из настроек)</option>
                                            <option value="llama3:8b" selected>llama3:8b (рекомендуется)</option>
                                            <option value="llama3">llama3</option>
                                            <option value="mistral">mistral</option>
                                            <option value="qwen2:7b">qwen2:7b</option>
                                            <option value="qwen2">qwen2</option>
                                        </select>
                                        <p class="mt-1 text-xs text-gray-500">Убедитесь, что Ollama запущен и модель загружена</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Статус парсинга -->
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <div id="parserStatus" class="mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-medium text-gray-700">Статус:</span>
                                <span id="parserStatusText" class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">Не запущен</span>
                            </div>
                            <div id="parserStats" class="text-sm text-gray-600 space-y-1">
                                <div>Обработано: <span id="parserTotalParsed">0</span></div>
                                <div>Ошибок: <span id="parserTotalErrors">0</span></div>
                                <div id="parserNlpStats" class="hidden">NLP извлечений: <span id="parserNlpExtractions">0</span></div>
                                <div id="parserOllamaStats" class="hidden">Ollama извлечений: <span id="parserOllamaExtractions">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки управления -->
                    <div class="flex gap-2 mt-4">
                        <button onclick="startParser()" id="startParserBtn" 
                                class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            <i data-feather="play"></i>
                            <span>Запустить парсинг</span>
                        </button>
                        <button onclick="stopParser()" id="stopParserBtn" 
                                class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed hidden">
                            <i data-feather="square"></i>
                            <span>Остановить</span>
                        </button>
                        <button onclick="refreshParserStatus()" 
                                class="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            <i data-feather="refresh-cw"></i>
                            <span>Обновить статус</span>
                        </button>
                    </div>
                </div>

                <!-- Таблица спарсенных автомобилей -->
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <div class="flex justify-between items-center p-4 border-b border-gray-200">
                        <h4 class="text-md font-semibold">Спарсенные автомобили</h4>
                        <div class="flex gap-2">
                            <input type="text" id="parserSearchInput" placeholder="Поиск по марке, модели, городу..." 
                                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                   onkeyup="loadParsedCars()">
                            <button onclick="loadParsedCars()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                <i data-feather="search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Марка</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Модель</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Город</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цена</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Год</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пробег</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Фото</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Спарсено</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="parsedCarsTableBody">
                                <!-- Спарсенные автомобили будут загружены здесь -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-4 border-t border-gray-200 flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            Всего: <span id="parsedCarsTotal">0</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="loadParsedCars(0)" id="parserPrevBtn" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:bg-gray-100 disabled:cursor-not-allowed">
                                Назад
                            </button>
                            <button onclick="loadParsedCarsNext()" id="parserNextBtn" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:bg-gray-100 disabled:cursor-not-allowed">
                                Вперед
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция распознавания речи -->
            <div id="voiceSection" class="mb-6 relative hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Распознавание речи (Voice Recognition)</h3>
                </div>

                <!-- Настройки голосового ввода -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <h4 class="text-md font-semibold mb-4">Настройки голосового ввода</h4>
                    
                    <div class="space-y-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="voiceInputEnabled" 
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                   onchange="toggleVoiceInput()">
                            <span class="ml-2 text-sm text-gray-700">Включить голосовой ввод в чате</span>
                        </label>

                        <div id="voiceSettings" class="ml-6 space-y-4 border-t border-gray-200 pt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Модель Whisper
                                </label>
                                <select id="whisperModel" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="tiny">Tiny (быстрая, менее точная)</option>
                                    <option value="base" selected>Base (рекомендуется)</option>
                                    <option value="small">Small (более точная)</option>
                                    <option value="medium">Medium (высокая точность)</option>
                                    <option value="large">Large (максимальная точность)</option>
                                </select>
                                <p class="mt-1 text-xs text-gray-500">Больше модель = лучше точность, но медленнее обработка</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Автоопределение языка
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="autoDetectLanguage" checked
                                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Автоматически определять язык речи</span>
                                </label>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Язык (если автоопределение выключено)
                                </label>
                                <select id="voiceLanguage" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="ru">Русский</option>
                                    <option value="en">English</option>
                                    <option value="uk">Українська</option>
                                    <option value="de">Deutsch</option>
                                    <option value="fr">Français</option>
                                    <option value="es">Español</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Порог тишины (для определения конца речи)
                                </label>
                                <input type="range" id="silenceThreshold" min="0" max="1000" value="500" step="50"
                                       class="w-full">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>Чувствительный</span>
                                    <span id="silenceThresholdValue">500</span>
                                    <span>Менее чувствительный</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Минимальная длительность речи (секунды)
                                </label>
                                <input type="number" id="minSpeechDuration" value="1.0" min="0.5" max="5.0" step="0.1"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <p class="mt-1 text-xs text-gray-500">Минимальная длительность речи для обработки</p>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки управления -->
                    <div class="flex gap-2 mt-6 pt-4 border-t border-gray-200">
                        <button onclick="saveVoiceSettings()" 
                                class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-feather="save"></i>
                            <span>Сохранить настройки</span>
                        </button>
                        <button onclick="testMicrophone()" 
                                class="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            <i data-feather="mic"></i>
                            <span>Проверить микрофон</span>
                        </button>
                    </div>

                    <!-- Статус микрофона -->
                    <div id="microphoneStatus" class="mt-4 hidden">
                        <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg">
                            <div id="micStatusIndicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                            <span id="micStatusText" class="text-sm text-gray-700">Микрофон не проверен</span>
                        </div>
                    </div>
                </div>

                <!-- Информация -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h5 class="text-sm font-semibold text-blue-900 mb-2">Как использовать:</h5>
                    <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
                        <li>Включите голосовой ввод в настройках выше</li>
                        <li>В чате появится кнопка микрофона рядом с кнопкой отправки</li>
                        <li>Нажмите на микрофон и говорите</li>
                        <li>Отпустите микрофон или подождите окончания речи</li>
                        <li>Распознанный текст автоматически появится в поле ввода</li>
                    </ul>
                </div>
            </div>

            <!-- Секция импорта -->
            <div id="importSection" class="mb-6 relative hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Импорт автомобилей из JSON/XML</h3>
                </div>

                <!-- Кнопки управления -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                    <div class="flex gap-4 mb-4">
                        <button onclick="openImportModal()" 
                                class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-feather="upload"></i>
                            <span>Импортировать</span>
                        </button>
                        <button onclick="migrateImportData()" 
                                class="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i data-feather="arrow-right"></i>
                            <span>Мигрировать</span>
                        </button>
                        <button onclick="deleteSelectedImportRecords()" 
                                class="flex items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            <i data-feather="trash-2"></i>
                            <span>Удалить выбранные</span>
                        </button>
                        <button onclick="deleteAllImportRecords()" 
                                class="flex items-center gap-2 px-6 py-3 bg-red-700 text-white rounded-lg hover:bg-red-800">
                            <i data-feather="trash"></i>
                            <span>Удалить все</span>
                        </button>
                        <button onclick="loadImportList()" 
                                class="flex items-center gap-2 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            <i data-feather="refresh-cw"></i>
                            <span>Обновить</span>
                        </button>
                    </div>
                </div>

                <!-- Таблицы импортированных данных -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Таблица новых автомобилей -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="text-md font-semibold mb-4">Импортированные новые автомобили</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <input type="checkbox" id="selectAllNewCars" onchange="toggleSelectAllNewCars(this)" 
                                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Марка</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Модель</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цена</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Город</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                    </tr>
                                </thead>
                                <tbody id="importCarsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Заполняется динамически -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Таблица подержанных автомобилей -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="text-md font-semibold mb-4">Импортированные подержанные автомобили</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <input type="checkbox" id="selectAllUsedCars" onchange="toggleSelectAllUsedCars(this)" 
                                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Марка</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Модель</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цена</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пробег</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                    </tr>
                                </thead>
                                <tbody id="importUsedCarsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Заполняется динамически -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция настройки домена -->
            <div id="domainSection" class="mb-6 relative hidden">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Настройка доменного имени</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Доменное имя
                            </label>
                            <input type="text" 
                                   id="domainNameInput" 
                                   placeholder="app.domain" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-sm text-gray-500">
                                Введите доменное имя для вашего приложения (например: app.domain, myapp.com)
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Текущий домен
                            </label>
                            <div id="currentDomainDisplay" class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg">
                                <span class="text-gray-500">Загрузка...</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <button onclick="saveDomainSettings()" 
                                    class="flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i data-feather="save"></i>
                                <span>Сохранить домен</span>
                            </button>
                            <button onclick="testDomainConnection()" 
                                    class="flex items-center gap-2 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i data-feather="check-circle"></i>
                                <span>Проверить подключение</span>
                            </button>
                            <button onclick="reloadNginx()" 
                                    class="flex items-center gap-2 px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                <i data-feather="refresh-cw"></i>
                                <span>Перезагрузить Nginx</span>
                            </button>
                        </div>

                        <div id="domainStatusMessage" class="hidden mt-4 p-4 rounded-lg"></div>

                        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="text-sm font-semibold text-blue-800 mb-2">Информация</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>• После сохранения домен будет применен к конфигурации Nginx</li>
                                <li>• Убедитесь, что DNS запись указывает на IP вашего сервера</li>
                                <li>• Для применения изменений может потребоваться перезагрузка Nginx</li>
                                <li>• SSL сертификаты будут автоматически обновлены для нового домена</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция метрик качества -->
            <div id="metricsSection" class="mb-6 relative hidden">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Метрики качества системы</h3>
                        <div class="flex gap-2">
                            <button onclick="loadQualityMetrics()" 
                                    class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i data-feather="refresh-cw"></i>
                                <span>Обновить</span>
                            </button>
                            <button onclick="clearQualityMetrics()" 
                                    class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                <i data-feather="trash-2"></i>
                                <span>Очистить метрики</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="metricsContent" class="space-y-6">
                        <div class="text-center py-8 text-gray-500">
                            <i data-feather="bar-chart-2" class="w-12 h-12 mx-auto text-gray-300 mb-2"></i>
                            <p>Загрузка метрик...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция управления моделями -->
            <div id="modelsSection" class="mb-6 relative hidden">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Управление моделями AI</h3>
                        <div class="flex gap-2">
                            <button onclick="loadModelsData()" 
                                    class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i data-feather="refresh-cw"></i>
                                <span>Обновить</span>
                            </button>
                            <button onclick="switchAllToMistral()" 
                                    class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                <i data-feather="zap"></i>
                                <span>Переключить все на Mistral</span>
                            </button>
                            <button onclick="reloadOrchestratorConfig()" 
                                    class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i data-feather="rotate-cw"></i>
                                <span>Перезагрузить конфигурацию</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="modelsContent" class="space-y-6">
                        <div class="text-center py-8 text-gray-500">
                            <i data-feather="cpu" class="w-12 h-12 mx-auto text-gray-300 mb-2"></i>
                            <p>Загрузка данных моделей...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Модальное окно для импорта -->
            <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Импорт данных</h3>
                        <button onclick="closeImportModal()" class="text-gray-500 hover:text-gray-700">
                            <i data-feather="x"></i>
                        </button>
                    </div>

                    <!-- Шаг 1: Загрузка файла -->
                    <div id="importStep1">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Выберите файл (JSON или XML)
                            </label>
                            <input type="file" id="importFile" accept=".json,.xml" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                   onchange="handleFileSelect(event)">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Тип автомобилей
                            </label>
                            <select id="importCarType" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="new">Новые</option>
                                <option value="used">Подержанные</option>
                            </select>
                        </div>
                        <button onclick="analyzeImportFile()" 
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Анализировать файл
                        </button>
                    </div>

                    <!-- Шаг 2: Сопоставление полей -->
                    <div id="importStep2" class="hidden">
                        <div class="mb-4">
                            <h4 class="text-md font-semibold mb-2">Сопоставление полей</h4>
                            <p class="text-sm text-gray-600 mb-4">
                                Сопоставьте поля из файла с полями в базе данных. 
                                Поля без сопоставления не будут импортированы.
                            </p>
                            <div id="fieldMappingContainer" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Заполняется динамически -->
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="saveImport()" 
                                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                Сохранить импорт
                            </button>
                            <button onclick="backToStep1()" 
                                    class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                Назад
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Article Modal -->
    <div id="createArticleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Create New Article</h2>
                <button onclick="hideCreateArticleModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="articleTitle" class="block text_sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="articleTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="articleCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="articleCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select a category</option>
                        <!-- Categories will be loaded here -->
                    </select>
                </div>
                
                <div>
                    <label for="articleTags" class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <div class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded-lg" id="tagsContainer">
                        <!-- Tags will be added here -->
                    </div>
                    <div class="mt-1 flex">
                        <input type="text" id="newTagInput" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Add new tag">
                        <button onclick="addTag()" class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700">Add</button>
                    </div>
                </div>
                
                <div>
                    <label for="articleContent" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                    <textarea id="articleContent" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="hideCreateArticleModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button onclick="saveArticle()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Article</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Upload Document Modal -->
    <div id="uploadDocumentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Загрузить документ</h2>
                <button onclick="hideUploadDocumentModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="documentFile" class="block text-sm font-medium text-gray-700 mb-1">Файл документа</label>
                    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.txt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Поддерживаемые форматы: PDF, DOC, DOCX, TXT (максимум 50MB)</p>
                </div>
                
                <div>
                    <label for="documentLanguage" class="block text-sm font-medium text-gray-700 mb-1">Язык документа</label>
                    <select id="documentLanguage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="ru">Русский</option>
                        <option value="en">English</option>
                    </select>
                </div>
                
                <div>
                    <label for="documentPath" class="block text-sm font-medium text-gray-700 mb-1">Путь к файлу (необязательно)</label>
                    <input type="text" id="documentPath" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Например: /documents/manuals/office2016/">
                    <p class="text-xs text-gray-500 mt-1">Укажите путь для контекста поиска (будет включен в эмбеддинги)</p>
                </div>
                
                <div>
                    <label for="documentCategory" class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
                    <select id="documentCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Выберите категорию</option>
                        <!-- Категории будут загружены здесь -->
                    </select>
                </div>
                
                <div>
                    <label for="documentTags" class="block text-sm font-medium text-gray-700 mb-1">Теги</label>
                    <div class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded-lg" id="documentTagsContainer">
                        <!-- Теги будут добавлены здесь -->
                    </div>
                    <div class="mt-1 flex">
                        <input type="text" id="newDocumentTagInput" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Добавить тег">
                        <button onclick="addDocumentTag()" class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700">Добавить</button>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="hideUploadDocumentModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Отмена</button>
                    <button onclick="uploadDocument()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Загрузить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Создать пользователя</h2>
                <button onclick="hideCreateUserModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="userEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="user@example.com">
                </div>
                
                <div>
                    <label for="userFullName" class="block text-sm font-medium text-gray-700 mb-1">Полное имя</label>
                    <input type="text" id="userFullName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Иван Иванов">
                </div>
                
                <div>
                    <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Пароль</label>
                    <input type="password" id="userPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Минимум 6 символов">
                </div>
                
                <div>
                    <label for="userRole" class="block text-sm font-medium text-gray-700 mb-1">Роль</label>
                    <select id="userRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="user">Пользователь</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="hideCreateUserModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Отмена</button>
                    <button onclick="createUser()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Создать пользователя</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sources side panel (fixed outside chat on the right) -->
    <div id="sourcesPanel" class="hidden fixed bg-white shadow-xl border border-gray-200 rounded-lg" style="z-index: 10000; width: 400px; top: 80px; right: 20px; height: calc(100vh - 100px);">
        <div class="flex items-center justify-between p-3 border-b border-gray-200" style="flex-shrink: 0; flex-grow: 0; min-height: 48px; height: 48px;">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                <div role="heading" class="font-semibold text-gray-800">Search results</div>
            </div>
            <button onclick="hideSourcesPanel()" class="p-1 rounded-full hover:bg-gray-100 transition-colors">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14.1167 13.197L13.1969 14.1168L1.88324 2.80309L2.80303 1.8833L14.1167 13.197Z" fill="currentColor"></path>
                    <path d="M13.1969 1.88331L14.1167 2.8031L2.80303 14.1168L1.88324 13.197L13.1969 1.88331Z" fill="currentColor"></path>
                </svg>
            </button>
        </div>
        <div id="sourcesList" class="p-3 space-y-3" style="flex: 1 1 0%; min-height: 0; height: calc(100% - 48px); overflow-y: scroll; overflow-x: hidden; scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc; position: relative;">
            <!-- Results will be loaded here -->
        </div>
    </div>

    <!-- Chunks Modal -->
    <div id="chunksModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Чанки документа</h2>
                <button onclick="hideChunksModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div id="chunksList" class="space-y-4">
                <!-- Чанки будут загружены здесь -->
            </div>
        </div>
    </div>

    <!-- Edit Document Modal -->
    <div id="editDocumentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Редактировать документ</h2>
                <button onclick="hideEditDocumentModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="editDocumentTitle" class="block text-sm font-medium text-gray-700 mb-1">Заголовок</label>
                    <input type="text" id="editDocumentTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="editDocumentTopic" class="block text-sm font-medium text-gray-700 mb-1">Тема</label>
                    <input type="text" id="editDocumentTopic" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="editDocumentPath" class="block text-sm font-medium text-gray-700 mb-1">Путь к файлу</label>
                    <input type="text" id="editDocumentPath" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Например: /documents/manuals/office2016/">
                    <p class="text-xs text-gray-500 mt-1">Путь для контекста поиска</p>
                </div>
                
                <div>
                    <label for="editDocumentSummary" class="block text-sm font-medium text-gray-700 mb-1">Краткое содержание</label>
                    <textarea id="editDocumentSummary" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="hideEditDocumentModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Отмена
                    </button>
                    <button onclick="saveDocumentChanges()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Сохранить изменения
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Articles Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Импорт статей из JSON</h2>
                <button onclick="hideImportModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Шаг 1: Загрузка файла -->
                <div id="importStep1" class="space-y-4">
                    <h3 class="text-lg font-semibold">Шаг 1: Загрузка JSON файла</h3>
                    <div>
                        <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1">JSON файл</label>
                        <input type="file" id="importFile" accept=".json" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Выберите JSON файл с массивом объектов</p>
                    </div>
                    <button onclick="analyzeImportFile()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Анализировать файл
                    </button>
                </div>
                
                <!-- Шаг 2: Настройка сопоставления полей -->
                <div id="importStep2" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">Шаг 2: Сопоставление полей</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-4">Найдено записей: <span id="importRecordCount">0</span></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="fieldMappingContainer">
                            <!-- Сопоставления полей будут загружены здесь -->
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="showImportStep1()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Назад
                        </button>
                        <button onclick="startImport()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Начать импорт
                        </button>
                    </div>
                </div>
                
                <!-- Шаг 3: Результат импорта -->
                <div id="importStep3" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">Шаг 3: Результат импорта</h3>
                    <div id="importResults" class="bg-gray-50 p-4 rounded-lg">
                        <!-- Результаты импорта будут показаны здесь -->
                    </div>
                    <button onclick="hideImportModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize libraries
        AOS.init();
        feather.replace();
        
        // Language state (true for English, false for Russian)
        let isEnglish = true;
        
        // Инициализация изоляции скролла для панели результатов поиска
        function initSourcesPanelScrollIsolation() {
            const panel = document.getElementById('sourcesPanel');
            const list = document.getElementById('sourcesList');
            
            if (!panel || !list) return;
            
            // Удаляем старые обработчики перед добавлением новых (избегаем дублирования)
            const oldHandler = panel._scrollHandler;
            if (oldHandler) {
                panel.removeEventListener('wheel', oldHandler, { capture: true });
                list.removeEventListener('wheel', oldHandler, { capture: true });
            }
            
            // Обработчик только для остановки всплытия - не блокируем сам скролл
            const stopPropagationOnly = (e) => {
                // Просто останавливаем всплытие события, чтобы оно не дошло до чата
                // НЕ используем preventDefault() - пусть браузер обрабатывает скролл естественным образом
                e.stopPropagation();
            };
            
            // Обработчик для списка - останавливаем всплытие, но позволяем скроллу работать
            const handleListWheel = (e) => {
                // Останавливаем всплытие, чтобы событие не дошло до чата
                e.stopPropagation();
                // НЕ вызываем preventDefault() - скролл должен работать естественным образом
            };
            
            // Сохраняем ссылки на обработчики для возможности удаления
            panel._scrollHandler = stopPropagationOnly;
            list._scrollHandler = handleListWheel;
            
            // Удаляем старые обработчики перед добавлением новых
            if (panel._oldScrollHandler) {
                panel.removeEventListener('wheel', panel._oldScrollHandler, { capture: true });
            }
            if (list._oldScrollHandler) {
                list.removeEventListener('wheel', list._oldScrollHandler, { capture: true });
            }
            
            // Добавляем обработчики с capture для перехвата событий до их всплытия
            // Используем passive: true для лучшей производительности (браузер может обрабатывать скролл параллельно)
            panel.addEventListener('wheel', stopPropagationOnly, { passive: true, capture: true });
            list.addEventListener('wheel', handleListWheel, { passive: true, capture: true });
            
            // Сохраняем ссылки для последующего удаления
            panel._oldScrollHandler = stopPropagationOnly;
            list._oldScrollHandler = handleListWheel;
            
            // Обрабатываем события мыши для уверенности, что панель активна
            panel.addEventListener('mouseenter', () => {
                panel.style.pointerEvents = 'auto';
            });
            
            list.addEventListener('mouseenter', () => {
                panel.style.pointerEvents = 'auto';
            });
        }
        
        // Инициализируем изоляцию скролла после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSourcesPanelScrollIsolation);
        } else {
            initSourcesPanelScrollIsolation();
        }

        // API base
        // API_BASE использует относительный путь для работы через Nginx
        // В production можно использовать абсолютный URL
        const API_BASE = window.location.origin; // Использует текущий домен (http://localhost или https://localhost)
        
        // Current user info
        let currentUser = null;
        
        // Chat management
        let currentChatId = null;
        let currentChatTitle = null;
        let currentChatIsSession = false;
        
        // Получаем user_id из currentUser или используем значение по умолчанию
        function getCurrentUserId() {
            if (currentUser && currentUser.email) {
                return currentUser.email; // Используем email как user_id
            }
            return 'web-user'; // Fallback для неавторизованных пользователей
        }
        
        // UI Texts
        const uiTexts = {
            en: {
                ssoText: "Sign in with Corporate SSO",
                orText: "OR",
                emailLabel: "Email",
                passwordLabel: "Password",
                signInText: "Sign In",
                welcomeMessage: "Start a conversation with the AI assistant",
                typing: "AI is typing...",
                feedbackPlaceholder: "What was wrong with this response?",
                submitFeedback: "Submit",
                cancelFeedback: "Cancel",
                adminPanelTitle: "Admin Panel",
                createArticle: "Create Article",
                importJson: "Import JSON",
                reindex: "Reindex",
                articleTitle: "Title",
                articleCategory: "Category",
                articleTags: "Tags",
                articleContent: "Content",
                addTag: "Add",
                cancel: "Cancel",
                saveArticle: "Save Article",
                importFile: "JSON File",
                importMode: "Import Mode",
                addNewOnly: "Add new articles only",
                updateAndAdd: "Update existing and add new",
                replaceAll: "Replace all articles",
                processImport: "Import"
            },
            ru: {
                ssoText: "Войти через корпоративный SSO",
                orText: "ИЛИ",
                emailLabel: "Электронная почта",
                passwordLabel: "Пароль",
                signInText: "Войти",
                welcomeMessage: "Начните диалог с AI ассистентом",
                typing: "AI печатает...",
                feedbackPlaceholder: "Что не так с этим ответом?",
                submitFeedback: "Отправить",
                cancelFeedback: "Отмена",
                adminPanelTitle: "Административная панель",
                createArticle: "Создать статью",
                importJson: "Импорт JSON",
                reindex: "Переиндексировать",
                articleTitle: "Заголовок",
                articleCategory: "Категория",
                articleTags: "Теги",
                articleContent: "Содержание",
                addTag: "Добавить",
                cancel: "Отмена",
                saveArticle: "Сохранить статью",
                importFile: "JSON файл",
                importMode: "Режим импорта",
                addNewOnly: "Только новые статьи",
                updateAndAdd: "Обновить существующие и добавить новые",
                replaceAll: "Заменить все статьи",
                processImport: "Импортировать"
            }
        };
        
        // Update UI language
        function updateUILanguage() {
            const lang = isEnglish ? 'en' : 'ru';
            const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
            setText('languageLabel', isEnglish ? 'EN' : 'RU');
            setText('chatLanguageLabel', isEnglish ? 'EN' : 'RU');
            setText('ssoText', uiTexts[lang].ssoText);
            setText('orText', uiTexts[lang].orText);
            setText('emailLabel', uiTexts[lang].emailLabel);
            setText('passwordLabel', uiTexts[lang].passwordLabel);
            setText('signInText', uiTexts[lang].signInText);
            setText('welcomeMessage', uiTexts[lang].welcomeMessage);
        }
        
        // Toggle language
        // Функция переключения режима размышления
        function toggleIntelligentSearch() {
            const button = document.getElementById('intelligentSearchButton');
            const currentState = localStorage.getItem('intelligentSearchEnabled') === 'true';
            const newState = !currentState;
            
            localStorage.setItem('intelligentSearchEnabled', newState.toString());
            
            // Обновляем визуальное состояние кнопки
            if (newState) {
                button.classList.add('ds-toggle-button--selected', 'bg-blue-100', 'border-blue-500');
                button.classList.remove('border-gray-300');
                const icon = button.querySelector('.ds-icon');
                if (icon) icon.style.color = '#2563eb';
            } else {
                button.classList.remove('ds-toggle-button--selected', 'bg-blue-100', 'border-blue-500');
                button.classList.add('border-gray-300');
                const icon = button.querySelector('.ds-icon');
                if (icon) icon.style.color = '#374151';
            }
        }
        
        function toggleDeepThinking() {
            const button = document.getElementById('deepThinkingButton');
            const currentState = localStorage.getItem('deepThinkingEnabled') === 'true';
            const newState = !currentState;
            
            localStorage.setItem('deepThinkingEnabled', newState.toString());
            
            // Обновляем визуальное состояние кнопки
            if (newState) {
                button.classList.add('ds-toggle-button--selected', 'bg-blue-100', 'border-blue-500');
                button.classList.remove('border-gray-300');
                button.querySelector('.ds-icon').style.color = '#2563eb';
            } else {
                button.classList.remove('ds-toggle-button--selected', 'bg-blue-100', 'border-blue-500');
                button.classList.add('border-gray-300');
                button.querySelector('.ds-icon').style.color = '#374151';
            }
        }
        
        // Инициализация состояния кнопки интеллектуального поиска при загрузке
        function initIntelligentSearchButton() {
            const button = document.getElementById('intelligentSearchButton');
            if (!button) return;
            
            const isEnabled = localStorage.getItem('intelligentSearchEnabled') === 'true';
            if (isEnabled) {
                button.classList.add('ds-toggle-button--selected', 'bg-blue-100', 'border-blue-500');
                button.classList.remove('border-gray-300');
                const icon = button.querySelector('.ds-icon');
                if (icon) icon.style.color = '#2563eb';
            } else {
                button.classList.remove('ds-toggle-button--selected', 'bg-blue-100', 'border-blue-500');
                button.classList.add('border-gray-300');
                const icon = button.querySelector('.ds-icon');
                if (icon) icon.style.color = '#374151';
            }
        }
        
        // Инициализация состояния кнопки размышления при загрузке
        function initDeepThinkingButton() {
            const button = document.getElementById('deepThinkingButton');
            if (!button) return;
            
            const isEnabled = localStorage.getItem('deepThinkingEnabled') === 'true';
            if (isEnabled) {
                button.classList.add('ds-toggle-button--selected', 'bg-blue-100', 'border-blue-500');
                button.classList.remove('border-gray-300');
                button.querySelector('.ds-icon').style.color = '#2563eb';
            } else {
                button.classList.remove('ds-toggle-button--selected', 'bg-blue-100', 'border-blue-500');
                button.classList.add('border-gray-300');
                button.querySelector('.ds-icon').style.color = '#374151';
            }
        }
        
        function toggleLanguage() {
            isEnglish = !isEnglish;
            updateUILanguage();
        }
        
        // Simulate login
        function ssoLogin() {
            // In a real app, this would redirect to SSO provider
            simulateLogin();
        }
        
        async function emailLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert(isEnglish ? "Please enter email and password" : "Пожалуйста, введите email и пароль");
                return;
            }
            try {
                const form = new URLSearchParams();
                form.append('username', email);
                form.append('password', password);
                form.append('grant_type', 'password');

                const res = await fetch(API_BASE + '/api/auth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: form
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('Ошибка авторизации:', res.status, errorText);
                    let errorMessage = isEnglish ? 'Invalid credentials' : 'Неверные учетные данные';
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } catch (e) {
                        // Если не удалось распарсить JSON, используем стандартное сообщение
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await res.json();
                if (!data.access_token) {
                    throw new Error(isEnglish ? 'Token not received' : 'Токен не получен');
                }
                
                window.localStorage.setItem('token', data.access_token);
                await loadCurrentUser(); // Загружаем информацию о пользователе
                // Убеждаемся, что пользователь загружен перед инициализацией чатов
                simulateLogin();
                // Дополнительно загружаем чаты после логина, чтобы убедиться что они загружены
                await loadChats();
            } catch (e) {
                console.error('Ошибка входа:', e);
                alert(e.message || (isEnglish ? 'Invalid credentials' : 'Неверные учетные данные'));
            }
        }
        
        function simulateLogin() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            
            // Загружаем текущую модель
            loadCurrentModel();
            
            // Чаты уже загружаются после simulateLogin() в emailLogin()
            // initChats() больше не нужен здесь
        }
        
        // Загрузка списка чатов (из новой системы БД и старой системы Redis)
        async function loadChats() {
            try {
                // Ждем, пока пользователь загрузится, если он еще не загружен
                if (!currentUser) {
                    await loadCurrentUser();
                }
                
                const userId = getCurrentUserId();
                console.log('🔍 Загрузка чатов для user_id:', userId);
                
                // Загружаем чаты из новой системы (БД)
                const dbResponse = await fetch(API_BASE + `/api/chat/chats?user_id=${userId}&skip=0&limit=50`, {
                    headers: authHeader()
                });
                
                let dbChats = [];
                if (dbResponse.ok) {
                    const dbData = await dbResponse.json();
                    dbChats = dbData.chats || [];
                    console.log('🔍 Загружено чатов из БД:', dbChats.length);
                }
                
                // Загружаем sessions из старой системы (Redis)
                // Пробуем загрузить с текущим user_id и со старым 'web-user' (для совместимости)
                const userIdsToTry = [userId, 'web-user'];
                let allSessions = new Set();
                let sessionChats = [];
                
                for (const tryUserId of userIdsToTry) {
                    try {
                        const historyResponse = await fetch(API_BASE + `/api/chat/history?user_id=${tryUserId}`, {
                            headers: authHeader()
                        });
                        
                        if (historyResponse.ok) {
                            const historyData = await historyResponse.json();
                            console.log(`🔍 Полный ответ от /api/chat/history для ${tryUserId}:`, historyData);
                            const sessions = historyData.sessions || [];
                            console.log(`🔍 Sessions массив для ${tryUserId}:`, sessions);
                            
                            // Добавляем все sessions в общий набор (Set автоматически уберет дубликаты)
                            sessions.forEach(sid => allSessions.add(sid));
                        }
                    } catch (e) {
                        console.error(`❌ Ошибка при загрузке sessions для ${tryUserId}:`, e);
                    }
                }
                
                console.log('🔍 Все уникальные sessions (объединенные):', Array.from(allSessions));
                console.log('🔍 Всего уникальных sessions:', allSessions.size);
                
                // Проверяем удаленные sessions из localStorage
                const deletedSessions = JSON.parse(localStorage.getItem('deleted_sessions') || '[]');
                
                // Конвертируем sessions в формат chats
                // Сортируем по убыванию (новые сверху)
                sessionChats = Array.from(allSessions)
                    .filter(sessionId => !deletedSessions.includes(sessionId)) // Убираем удаленные
                    .map(sessionId => {
                        // Проверяем сохраненное название в localStorage
                        const sessionTitleKey = `session_title_${sessionId}`;
                        const savedTitle = localStorage.getItem(sessionTitleKey);
                        
                        return {
                            id: sessionId,
                            title: savedTitle || `Chat #${sessionId}`,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString(),
                            message_count: 0,
                            is_session: true // Помечаем как старую сессию
                        };
                    })
                    .sort((a, b) => b.id - a.id); // Сортируем по ID в порядке убывания
                
                console.log('🔍 Конвертировано session чатов:', sessionChats.length);
                
                // Объединяем чаты: сначала новые из БД, потом старые sessions
                // Убираем дубликаты (если session_id совпадает с chat_id)
                const dbChatIds = new Set(dbChats.map(c => c.id));
                const uniqueSessionChats = sessionChats.filter(s => !dbChatIds.has(s.id));
                
                console.log('🔍 DB Chat IDs:', Array.from(dbChatIds));
                console.log('🔍 Session Chat IDs:', sessionChats.map(s => s.id));
                console.log('🔍 Unique Session Chat IDs (после фильтрации):', uniqueSessionChats.map(s => s.id));
                
                const allChats = [...dbChats, ...uniqueSessionChats];
                
                console.log('🔍 Всего чатов (БД + Sessions):', allChats.length);
                console.log('🔍 БД чатов:', dbChats.length, 'Session чатов до фильтрации:', sessionChats.length, 'после фильтрации:', uniqueSessionChats.length);
                console.log('🔍 Все ID чатов:', allChats.map(c => c.id));
                
                // Сразу отображаем чаты
                renderChatsList(allChats);
                
                // НЕ загружаем автоматически чат при загрузке списка
                // Пользователь сам выберет, какой чат открыть
                
                // Возвращаем данные для использования в других функциях
                return { chats: allChats, total: allChats.length };
            } catch (e) {
                console.error('❌ Ошибка при загрузке чатов:', e);
                // Показываем пустой список при ошибке
                renderChatsList([]);
            }
            return { chats: [], total: 0 };
        }
        
        // Выбор session чата (только для просмотра, не устанавливает currentChatId)
        async function selectSessionChat(sessionId) {
            console.log(`🔍 Выбор session чата ${sessionId}`);
            // Сохраняем выбранный session для визуального выделения
            window.__selectedSessionId = sessionId;
            currentChatId = null; // Очищаем currentChatId, чтобы при отправке создался новый чат в БД
            currentChatIsSession = true;
            await loadHistoryFromSession(sessionId);
            // Обновляем выделение в списке и заголовок
            updateChatSelection();
            updateChatTitleDisplay();
        }
        
        // Выбор обычного чата (устанавливает currentChatId для сохранения сообщений)
        async function selectChat(chatId) {
            console.log(`🔍 Выбор чата ${chatId}`);
            currentChatId = chatId;
            window.__selectedSessionId = null; // Очищаем выбранный session
            currentChatIsSession = false;
            await loadHistory(chatId);
            // Обновляем выделение в списке и заголовок
            updateChatSelection();
            updateChatTitleDisplay();
        }
        
        // Обновление выделения в списке чатов
        function updateChatSelection() {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            const allChatItems = chatHistory.querySelectorAll('.flex.items-center.gap-2');
            allChatItems.forEach(item => {
                const button = item.querySelector('button[data-chat-id]');
                if (!button) return;
                
                const chatId = parseInt(button.getAttribute('data-chat-id'));
                const isSession = button.getAttribute('data-is-session') === 'true';
                const isSelected = isSession 
                    ? (window.__selectedSessionId === chatId)
                    : (chatId === currentChatId);
                
                if (isSelected) {
                    item.classList.remove('bg-white', 'border-gray-200');
                    item.classList.add('bg-blue-50', 'border-blue-200');
                    const titleSpan = item.querySelector('.text-sm.font-medium');
                    if (titleSpan) {
                        titleSpan.classList.remove('text-gray-900');
                        titleSpan.classList.add('text-blue-700');
                    }
                } else {
                    item.classList.remove('bg-blue-50', 'border-blue-200');
                    item.classList.add('bg-white', 'border-gray-200');
                    const titleSpan = item.querySelector('.text-sm.font-medium');
                    if (titleSpan) {
                        titleSpan.classList.remove('text-blue-700');
                        titleSpan.classList.add('text-gray-900');
                    }
                }
            });
        }
        
        // Загрузка истории из старой системы (sessions)
        async function loadHistoryFromSession(sessionId) {
            try {
                console.log(`🔍 Загрузка истории для session ${sessionId}`);
                const userId = getCurrentUserId();
                // Пробуем загрузить с текущим user_id и со старым 'web-user'
                const userIdsToTry = [userId, 'web-user'];
                let historyData = null;
                
                for (const tryUserId of userIdsToTry) {
                    try {
                        console.log(`🔍 Пробую загрузить session ${sessionId} для user_id: ${tryUserId}`);
                        const response = await fetch(API_BASE + `/api/chat/history?user_id=${tryUserId}&session_id=${sessionId}`, {
                            headers: authHeader()
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`🔍 Ответ для session ${sessionId}:`, data);
                            // Проверяем, что это правильная сессия
                            if (data.current_session === sessionId || (data.history !== undefined && parseInt(sessionId) === parseInt(data.current_session || sessionId))) {
                                historyData = data;
                                console.log(`✅ Найдена история для session ${sessionId}`);
                                break; // Нашли историю, выходим из цикла
                            }
                        }
                    } catch (e) {
                        console.error(`Ошибка при загрузке истории сессии ${sessionId} для ${tryUserId}:`, e);
                    }
                }
                
                const chatArea = document.getElementById('chatArea');
                if (chatArea) {
                    chatArea.innerHTML = '';
                    
                    if (historyData && historyData.history && historyData.history.length > 0) {
                        console.log(`📋 Загружаю ${historyData.history.length} сообщений для session ${sessionId}`);
                        (historyData.history || []).forEach(item => {
                            addUserMessage(escapeHtml(item.q || ''));
                            addAIMessage(escapeHtml(item.a || ''));
                        });
                        chatArea.scrollTop = chatArea.scrollHeight;
                    } else {
                        console.log(`⚠️ История для session ${sessionId} пуста или не найдена`);
                        chatArea.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <p>История чата пуста</p>
                            </div>
                        `;
                    }
                    // Обновляем заголовок
                    updateChatTitleDisplay();
                }
            } catch (e) {
                console.error('Ошибка при загрузке истории сессии:', e);
            }
        }
        
        // Инициализация чатов
        async function initChats() {
            // Просто загружаем чаты, не создаем новые автоматически
            await loadChats();
        }
        
        // Рендеринг списка чатов
        function renderChatsList(chats) {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            if (chats.length === 0) {
                chatHistory.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-square w-8 h-8 mx-auto text-gray-300"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        <p class="mt-2 text-sm">No chat history</p>
                    </div>
                `;
                if (window.feather) window.feather.replace();
                return;
            }
            
            chatHistory.innerHTML = `
                <div class="space-y-2">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Recent Chats</div>
                        ${chats.length > 0 ? `
                            <button onclick="deleteAllChats()" 
                                    class="text-xs text-red-600 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50" 
                                    title="${isEnglish ? 'Delete all chats' : 'Удалить все чаты'}">
                                ${isEnglish ? 'Clear All' : 'Очистить все'}
                            </button>
                        ` : ''}
                    </div>
                    ${chats.map(chat => {
                        const isSelected = chat.is_session 
                            ? (window.__selectedSessionId === chat.id)
                            : (chat.id === currentChatId);
                        return `
                        <div class="flex items-center gap-2 w-full p-3 rounded-lg border transition-colors ${
                            isSelected
                                ? 'bg-blue-50 border-blue-200' 
                                : 'bg-white border-gray-200 hover:bg-gray-50'
                        }">
                            <button onclick="${chat.is_session ? `selectSessionChat(${chat.id})` : `selectChat(${chat.id})`}" 
                                    class="flex-1 text-left flex items-center justify-between pr-2">
                                <span class="text-sm font-medium flex-1 truncate ${isSelected ? 'text-blue-700' : 'text-gray-900'}">
                                    ${escapeHtml(chat.title || `Chat #${chat.id}`)}
                                </span>
                                ${isSelected ? `
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-blue-600 ml-2 flex-shrink-0">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                ` : ''}
                            </button>
                            <div class="flex items-center gap-1 flex-shrink-0 ml-auto">
                                <button data-chat-id="${chat.id}" data-is-session="${chat.is_session ? 'true' : 'false'}" data-chat-title="${(chat.title || '').replace(/"/g, '&quot;')}" 
                                        onclick="handleEditChat(event)" 
                                        class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-blue-600 transition-colors" 
                                        title="${isEnglish ? 'Edit' : 'Редактировать'}"
                                        style="display: inline-flex; align-items: center; justify-content: center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button data-chat-id="${chat.id}" data-is-session="${chat.is_session ? 'true' : 'false'}"
                                        onclick="handleDeleteChat(event)" 
                                        class="p-1.5 rounded hover:bg-gray-200 text-gray-600 hover:text-red-600 transition-colors" 
                                        title="${isEnglish ? 'Delete' : 'Удалить'}"
                                        style="display: inline-flex; align-items: center; justify-content: center;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;
            if (window.feather) window.feather.replace();
        }
        
        // Обновление отображения заголовка чата
        function updateChatTitleDisplay() {
            const titleElement = document.getElementById('chatTitleText');
            if (!titleElement) return;
            
            let displayTitle = isEnglish ? 'New Chat' : 'Новый чат';
            
            if (currentChatId && !currentChatIsSession) {
                // Для чатов из БД используем сохраненное название
                displayTitle = currentChatTitle || `Chat #${currentChatId}`;
            } else if (window.__selectedSessionId && currentChatIsSession) {
                // Для sessions используем сохраненное название из localStorage
                const sessionTitleKey = `session_title_${window.__selectedSessionId}`;
                const savedTitle = localStorage.getItem(sessionTitleKey);
                displayTitle = savedTitle || `Session #${window.__selectedSessionId}`;
            }
            
            titleElement.textContent = displayTitle;
        }
        
        // Редактирование названия текущего чата из заголовка
        async function editCurrentChatTitle() {
            if (!currentChatId && !window.__selectedSessionId) {
                return; // Нет активного чата
            }
            
            const currentTitle = currentChatTitle || (window.__selectedSessionId ? localStorage.getItem(`session_title_${window.__selectedSessionId}`) : null) || '';
            const newTitle = prompt(isEnglish ? 'Enter new chat title:' : 'Введите новое название чата:', currentTitle || '');
            if (newTitle === null || newTitle === currentTitle) return; // Отмена или без изменений
            
            if (currentChatIsSession || window.__selectedSessionId) {
                // Редактирование session
                await editSessionTitle(window.__selectedSessionId || currentChatId, newTitle);
            } else {
                // Редактирование чата из БД
                await editChatTitle(currentChatId, newTitle);
            }
            
            // Обновляем отображение
            updateChatTitleDisplay();
        }
        
        // Редактирование названия чата
        async function editChatTitle(chatId, currentTitle) {
            const newTitle = prompt(isEnglish ? 'Enter new chat title:' : 'Введите новое название чата:', currentTitle || '');
            if (newTitle === null || newTitle === currentTitle) return; // Отмена или без изменений
            
            try {
                const userId = getCurrentUserId();
                const response = await fetch(API_BASE + `/api/chat/chats/${chatId}?user_id=${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    body: JSON.stringify({ title: newTitle.trim() || null })
                });
                
                if (response.ok) {
                    currentChatTitle = newTitle.trim() || null;
                    await loadChats(); // Обновляем список чатов
                    updateChatTitleDisplay(); // Обновляем заголовок
                } else {
                    const error = await response.json();
                    alert(error.detail || (isEnglish ? 'Failed to update chat' : 'Не удалось обновить чат'));
                }
            } catch (e) {
                console.error('Ошибка при обновлении чата:', e);
                alert(isEnglish ? 'Error updating chat' : 'Ошибка при обновлении чата');
            }
        }
        
        // Обработчик редактирования чата (используется в onclick)
        async function handleEditChat(event) {
            event.stopPropagation();
            event.preventDefault();
            const button = event.currentTarget;
            const chatId = parseInt(button.getAttribute('data-chat-id'));
            const isSession = button.getAttribute('data-is-session') === 'true';
            let currentTitle = button.getAttribute('data-chat-title') || '';
            // Декодируем HTML entities
            currentTitle = currentTitle.replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&amp;/g, '&');
            
            console.log('🔍 Редактирование чата:', { chatId, isSession, currentTitle });
            
            if (isSession) {
                await editSessionTitle(chatId, currentTitle);
            } else {
                await editChatTitle(chatId, currentTitle);
            }
        }
        
        // Обработчик удаления чата (используется в onclick)
        async function handleDeleteChat(event) {
            event.stopPropagation();
            event.preventDefault();
            const button = event.currentTarget;
            const chatId = parseInt(button.getAttribute('data-chat-id'));
            const isSession = button.getAttribute('data-is-session') === 'true';
            
            if (isSession) {
                await deleteSession(chatId);
            } else {
                await deleteChat(chatId);
            }
        }
        
        // Редактирование названия session (локальное обновление в списке)
        async function editSessionTitle(sessionId, currentTitle) {
            const newTitle = prompt(isEnglish ? 'Enter new chat title:' : 'Введите новое название чата:', currentTitle || `Chat #${sessionId}`);
            if (newTitle === null || newTitle === currentTitle) return; // Отмена или без изменений
            
            // Сохраняем название в localStorage для отображения
            const sessionTitleKey = `session_title_${sessionId}`;
            localStorage.setItem(sessionTitleKey, newTitle.trim() || `Chat #${sessionId}`);
            
            // Обновляем заголовок если это текущий session
            if (window.__selectedSessionId === sessionId) {
                updateChatTitleDisplay();
            }
            
            // Обновляем список чатов
            await loadChats();
        }
        
        // Удаление session
        async function deleteSession(sessionId) {
            if (!confirm(isEnglish ? 'Are you sure you want to delete this chat?' : 'Вы уверены, что хотите удалить этот чат?')) {
                return;
            }
            
            try {
                // Удаляем session из localStorage (если есть сохраненное название)
                const sessionTitleKey = `session_title_${sessionId}`;
                localStorage.removeItem(sessionTitleKey);
                
                // Помечаем session как удаленный в localStorage
                const deletedSessions = JSON.parse(localStorage.getItem('deleted_sessions') || '[]');
                if (!deletedSessions.includes(sessionId)) {
                    deletedSessions.push(sessionId);
                    localStorage.setItem('deleted_sessions', JSON.stringify(deletedSessions));
                }
                
                // Если это был выбранный session, очищаем
                if (window.__selectedSessionId === sessionId) {
                    window.__selectedSessionId = null;
                    currentChatId = null;
                    currentChatTitle = null;
                    currentChatIsSession = false;
                    const chatArea = document.getElementById('chatArea');
                    if (chatArea) {
                        chatArea.innerHTML = `
                            <div class="text-center py-8 text-gray-500" id="emptyState">
                                <i data-feather="message-square" class="w-12 h-12 mx-auto text-gray-300"></i>
                                <p class="mt-4" id="welcomeMessage">${isEnglish ? 'Start a conversation with the AI assistant' : 'Начните разговор с AI помощником'}</p>
                            </div>
                        `;
                    }
                    updateChatTitleDisplay();
                }
                
                // Обновляем список чатов
                await loadChats();
            } catch (e) {
                console.error('Ошибка при удалении session:', e);
                alert(isEnglish ? 'Error deleting chat' : 'Ошибка при удалении чата');
            }
        }
        
        // Удаление всех чатов
        async function deleteAllChats() {
            if (!confirm(isEnglish ? 'Are you sure you want to delete ALL chats? This action cannot be undone.' : 'Вы уверены, что хотите удалить ВСЕ чаты? Это действие нельзя отменить.')) {
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                
                // Получаем все чаты (используем большой лимит)
                let allChats = [];
                let skip = 0;
                const limit = 100;
                
                while (true) {
                    const response = await fetch(API_BASE + `/api/chat/chats?user_id=${userId}&skip=${skip}&limit=${limit}`, {
                        headers: authHeader()
                    });
                    
                    if (!response.ok) break;
                    
                    const data = await response.json();
                    const chats = data.chats || [];
                    if (chats.length === 0) break;
                    
                    allChats = allChats.concat(chats);
                    
                    if (chats.length < limit) break; // Больше чатов нет
                    skip += limit;
                }
                
                // Удаляем все чаты
                const deletePromises = allChats.map(chat => 
                    fetch(API_BASE + `/api/chat/chats/${chat.id}?user_id=${userId}`, {
                        method: 'DELETE',
                        headers: authHeader()
                    })
                );
                
                await Promise.all(deletePromises);
                
                // Очищаем текущий чат
                currentChatId = null;
                currentChatTitle = null;
                currentChatIsSession = false;
                window.__selectedSessionId = null;
                const chatArea = document.getElementById('chatArea');
                if (chatArea) {
                    chatArea.innerHTML = `
                        <div class="text-center py-8 text-gray-500" id="emptyState">
                            <i data-feather="message-square" class="w-12 h-12 mx-auto text-gray-300"></i>
                            <p class="mt-4" id="welcomeMessage">${isEnglish ? 'Start a conversation with the AI assistant' : 'Начните разговор с AI помощником'}</p>
                        </div>
                    `;
                }
                
                // Обновляем заголовок и список чатов
                updateChatTitleDisplay();
                await loadChats();
            } catch (e) {
                console.error('Ошибка при удалении всех чатов:', e);
                alert(isEnglish ? 'Error deleting all chats' : 'Ошибка при удалении всех чатов');
            }
        }
        
        // Удаление чата
        async function deleteChat(chatId) {
            if (!confirm(isEnglish ? 'Are you sure you want to delete this chat?' : 'Вы уверены, что хотите удалить этот чат?')) {
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                const response = await fetch(API_BASE + `/api/chat/chats/${chatId}?user_id=${userId}`, {
                    method: 'DELETE',
                    headers: authHeader()
                });
                
                if (response.ok) {
                    // Если удаляемый чат был текущим, очищаем интерфейс
                    if (currentChatId === chatId) {
                        currentChatId = null;
                        currentChatTitle = null;
                        currentChatIsSession = false;
                        const chatArea = document.getElementById('chatArea');
                        if (chatArea) {
                            chatArea.innerHTML = `
                                <div class="text-center py-8 text-gray-500" id="emptyState">
                                    <i data-feather="message-square" class="w-12 h-12 mx-auto text-gray-300"></i>
                                    <p class="mt-4" id="welcomeMessage">${isEnglish ? 'Start a conversation with the AI assistant' : 'Начните разговор с AI помощником'}</p>
                                </div>
                            `;
                        }
                        updateChatTitleDisplay();
                    }
                    await loadChats(); // Обновляем список чатов
                } else {
                    const error = await response.json();
                    alert(error.detail || (isEnglish ? 'Failed to delete chat' : 'Не удалось удалить чат'));
                }
            } catch (e) {
                console.error('Ошибка при удалении чата:', e);
                alert(isEnglish ? 'Error deleting chat' : 'Ошибка при удалении чата');
            }
        }
        
        // Создание нового чата
        async function newChatUI() {
            try {
                const userId = getCurrentUserId();
                const response = await fetch(API_BASE + '/api/chat/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    body: JSON.stringify({ user_id: userId, title: null })
                });
                
                if (response.ok) {
                    const chat = await response.json();
                    currentChatId = chat.id;
                    currentChatTitle = chat.title || null;
                    currentChatIsSession = false;
                    window.__selectedSessionId = null;
                    
                    // Очищаем область чата
                    const chatArea = document.getElementById('chatArea');
                    if (chatArea) {
                        chatArea.innerHTML = `
                            <div class="text-center py-8 text-gray-500" id="emptyState">
                                <i data-feather="message-square" class="w-12 h-12 mx-auto text-gray-300"></i>
                                <p class="mt-4" id="welcomeMessage">${isEnglish ? 'Start a conversation with the AI assistant' : 'Начните разговор с AI помощником'}</p>
                            </div>
                        `;
                    }
                    
                    // Очищаем sources
                    window.__lastSources = [];
                    localStorage.removeItem('lastSources');
                    localStorage.removeItem('lastSourcesCount');
                    localStorage.removeItem('lastSourcesIcons');
                    
                    // Обновляем заголовок и список чатов
                    updateChatTitleDisplay();
                    await loadChats();
                    
                    return chat;
                } else {
                    const errorText = await response.text();
                    console.error('Ошибка при создании чата, статус:', response.status, errorText);
                    throw new Error('Не удалось создать чат');
                }
            } catch (e) {
                console.error('Ошибка при создании чата:', e);
                throw e;
            }
        }
        
        // Загрузка истории чата из БД
        async function loadHistory(chatId) {
            try {
                console.log(`🔍 Загрузка истории для чата ${chatId} из БД`);
                currentChatId = chatId;
                const userId = getCurrentUserId();
                
                // Сначала получаем информацию о чате для названия
                try {
                    const chatInfoResponse = await fetch(API_BASE + `/api/chat/chats/${chatId}?user_id=${userId}`, {
                        headers: authHeader()
                    });
                    if (chatInfoResponse.ok) {
                        const chatInfo = await chatInfoResponse.json();
                        currentChatTitle = chatInfo.title || null;
                    }
                } catch (e) {
                    console.warn('Не удалось загрузить информацию о чате:', e);
                }
                
                const response = await fetch(API_BASE + `/api/chat/chats/${chatId}/messages?user_id=${userId}&skip=0&limit=100`, {
                    headers: authHeader()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`🔍 Загружено сообщений для чата ${chatId}:`, data.messages?.length || 0);
                    const chatArea = document.getElementById('chatArea');
                    if (chatArea) {
                        chatArea.innerHTML = '';
                        // Очищаем sources перед загрузкой
                        window.__lastSources = [];
                        localStorage.removeItem('lastSources');
                        localStorage.removeItem('lastSourcesCount');
                        localStorage.removeItem('lastSourcesIcons');
                        
                        if (data.messages && data.messages.length > 0) {
                            data.messages.forEach((msg, idx) => {
                                addUserMessage(msg.message, `user-msg-${msg.id}`);
                                if (msg.response) {
                                    // Десериализуем sources_data если она есть
                                    let sourcesData = null;
                                    if (msg.sources_data) {
                                        if (typeof msg.sources_data === 'string') {
                                            try {
                                                sourcesData = JSON.parse(msg.sources_data);
                                                console.log(`📋 Восстановлены sources для сообщения ${msg.id}:`, {
                                                    cars: sourcesData.cars?.length || 0,
                                                    articles: sourcesData.articles?.length || 0,
                                                    documents: sourcesData.documents?.length || 0
                                                });
                                            } catch (e) {
                                                console.error('Ошибка при парсинге sources_data:', e);
                                            }
                                        } else {
                                            sourcesData = msg.sources_data;
                                        }
                                    }
                                    addAIMessage(msg.response, `ai-msg-${msg.id}`, sourcesData);
                                }
                            });
                        } else {
                            chatArea.innerHTML = `
                                <div class="text-center py-8 text-gray-500">
                                    <p>История чата пуста</p>
                                </div>
                            `;
                        }
                        
                        chatArea.scrollTop = chatArea.scrollHeight;
                    }
                    // Обновляем заголовок
                    updateChatTitleDisplay();
                    // Обновляем список чатов для выделения текущего (без перезагрузки истории)
                    const chatHistory = document.getElementById('chatHistory');
                    if (chatHistory) {
                        // Просто обновляем выделение, не перезагружая весь список
                        const allButtons = chatHistory.querySelectorAll('button[data-chat-id]');
                        allButtons.forEach(btn => {
                            const btnChatId = parseInt(btn.getAttribute('data-chat-id'));
                            const btnIsSession = btn.getAttribute('data-is-session') === 'true';
                            const parent = btn.closest('.flex.items-center');
                            if (parent) {
                                if (!btnIsSession && btnChatId === chatId) {
                                    parent.classList.remove('bg-white', 'border-gray-200');
                                    parent.classList.add('bg-blue-50', 'border-blue-200');
                                } else if (!btnIsSession) {
                                    parent.classList.remove('bg-blue-50', 'border-blue-200');
                                    parent.classList.add('bg-white', 'border-gray-200');
                                }
                            }
                        });
                    }
                } else {
                    console.error(`❌ Ошибка при загрузке истории чата ${chatId}, статус:`, response.status);
                }
            } catch (e) {
                console.error('Ошибка при загрузке истории:', e);
            }
        }
        
        async function autoLogin() {
            // Автологин только для демо - можно закомментировать или удалить
            // try {
            //     const formData = new URLSearchParams();
            //     formData.append('username', 'admin@example.com');
            //     formData.append('password', 'admin');
            //     
            //     const res = await fetch(API_BASE + '/api/auth/token', {
            //         method: 'POST',
            //         headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            //         body: formData
            //     });
            //     
            //     if (res.ok) {
            //         const data = await res.json();
            //         window.localStorage.setItem('token', data.access_token);
            //         await loadCurrentUser();
            //         document.getElementById('authModal').classList.add('hidden');
            //         document.getElementById('chatInterface').classList.remove('hidden');
            //         loadCurrentModel();
            //         await loadChats();
            //     }
            // } catch (e) {
            //     console.log('Ошибка автоматической аутентификации:', e);
            // }
        }
        
        function logout() {
            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            currentUser = null; // Очищаем информацию о пользователе
            document.getElementById('chatArea').innerHTML = `
                <div class="text-center py-8 text-gray-500" id="emptyState">
                    <i data-feather="message-square" class="w-12 h-12 mx-auto text-gray-300"></i>
                    <p class="mt-4">${isEnglish ? uiTexts.en.welcomeMessage : uiTexts.ru.welcomeMessage}</p>
                </div>
            `;
            feather.replace();
        }
        
        // Chat functions
        function authHeader(){
            const t = window.localStorage.getItem('token');
            console.log('Токен аутентификации:', t ? 'найден' : 'не найден');
            return t ? { 'Authorization': 'Bearer ' + t } : {};
        }

        // User management functions
        async function loadCurrentUser() {
            try {
                const res = await fetch(API_BASE + '/api/auth/me', { 
                    headers: { ...authHeader() } 
                });
                if (res.ok) {
                    currentUser = await res.json();
                    console.log('Текущий пользователь:', currentUser);
                    updateUIForUserRole();
                } else {
                    currentUser = null;
                }
            } catch (e) {
                console.error('Ошибка загрузки пользователя:', e);
                currentUser = null;
            }
        }

        function isAdmin() {
            return currentUser && currentUser.role === 'admin';
        }

        function updateUIForUserRole() {
            const adminButton = document.querySelector('button[onclick="showAdminPanel()"]');
            if (adminButton) {
                if (isAdmin()) {
                    adminButton.style.display = 'block';
                } else {
                    adminButton.style.display = 'none';
                }
            }
        }

        // Безопасная экранизация HTML
        function escapeHtml(value) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return String(value || '').replace(/[&<>"']/g, (m) => map[m]);
        }
        
        // Форматирование цены
        function formatPrice(price) {
            if (!price) return '0';
            const num = typeof price === 'string' ? parseFloat(price.replace(/[^\d.,]/g, '').replace(',', '.')) : price;
            if (isNaN(num)) return '0';
            return new Intl.NumberFormat('ru-RU', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(num);
        }
        
        // Обработка клика по уточняющему вопросу
        function askQuestion(question) {
            const input = document.getElementById('messageInput');
            if (input && question) {
                input.value = question;
                input.focus();
                // Автоматически отправляем вопрос
                sendMessage();
            }
        }
        
        // Обработка проактивного предложения
        function handleProactiveSuggestion(text, type) {
            const input = document.getElementById('messageInput');
            if (input && text) {
                // Формируем запрос в зависимости от типа предложения
                let query = text;
                
                if (type === 'finance') {
                    query = `Расскажи о кредитовании и лизинге`;
                } else if (type === 'test_drive') {
                    query = `Как записаться на тест-драйв?`;
                } else if (type === 'trade_in') {
                    query = `Расскажи о программе trade-in`;
                } else {
                    query = text;
                }
                
                input.value = query;
                input.focus();
                sendMessage();
            }
        }
        
        // Показать финансовый калькулятор
        function showFinanceCalculator() {
            // Создаем модальное окно с калькулятором
            const modal = document.createElement('div');
            modal.id = 'financeCalculatorModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">💰 Расчет финансирования</h3>
                        <button onclick="closeFinanceCalculator()" class="text-gray-500 hover:text-gray-700">
                            <i data-feather="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <form id="financeCalculatorForm" onsubmit="calculateFinance(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Цена автомобиля (₽)</label>
                                <input type="number" id="financeCarPrice" required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Например: 2500000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Первоначальный взнос (%)</label>
                                <input type="number" id="financeDownPayment" value="20" min="0" max="100" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Срок (месяцев)</label>
                                <input type="number" id="financeLoanTerm" value="60" min="12" max="84" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Тип расчета</label>
                                <select id="financeCalculationType" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="loan">Кредит</option>
                                    <option value="lease">Лизинг</option>
                                    <option value="compare">Сравнить кредит и лизинг</option>
                                </select>
                            </div>
                            <button type="submit" 
                                    class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                                Рассчитать
                            </button>
                        </div>
                    </form>
                    <div id="financeResult" class="mt-4 hidden"></div>
                </div>
            `;
            document.body.appendChild(modal);
            feather.replace();
        }
        
        // Закрыть финансовый калькулятор
        function closeFinanceCalculator() {
            const modal = document.getElementById('financeCalculatorModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Расчет финансирования
        async function calculateFinance(event) {
            if (event) event.preventDefault();
            
            const carPrice = parseFloat(document.getElementById('financeCarPrice').value);
            const downPaymentPercent = parseFloat(document.getElementById('financeDownPayment').value);
            const loanTerm = parseInt(document.getElementById('financeLoanTerm').value);
            const calculationType = document.getElementById('financeCalculationType').value;
            
            if (!carPrice || carPrice <= 0) {
                alert('Введите корректную цену автомобиля');
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/api/ai/finance/calculate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        car_price: carPrice,
                        down_payment_percent: downPaymentPercent,
                        loan_term: loanTerm,
                        calculation_type: calculationType
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Ошибка расчета финансирования');
                }
                
                const result = await response.json();
                displayFinanceResults(result);
                
            } catch (error) {
                console.error('Ошибка расчета финансирования:', error);
                alert('Ошибка расчета: ' + error.message);
            }
        }
        
        // Отображение результатов финансового расчета
        function displayFinanceResults(result) {
            const resultDiv = document.getElementById('financeResult');
            if (!resultDiv) return;
            
            let html = '<div class="mt-4 p-4 bg-gray-50 rounded-lg">';
            
            if (result.loan_calculation) {
                html += `
                    <div class="mb-4 p-3 bg-white rounded border border-green-200">
                        <h4 class="font-semibold text-gray-800 mb-2">💰 Кредит</h4>
                        <div class="space-y-1 text-sm">
                            ${result.loan_calculation.monthly_payment ? `
                                <p>Ежемесячный платеж: <span class="font-bold text-green-700">${formatPrice(result.loan_calculation.monthly_payment)} ₽</span></p>
                            ` : ''}
                            ${result.loan_calculation.total_payment ? `
                                <p>Общая сумма выплат: <span class="text-gray-700">${formatPrice(result.loan_calculation.total_payment)} ₽</span></p>
                            ` : ''}
                            ${result.loan_calculation.total_interest ? `
                                <p>Переплата: <span class="text-gray-600">${formatPrice(result.loan_calculation.total_interest)} ₽</span></p>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            if (result.lease_calculation) {
                html += `
                    <div class="mb-4 p-3 bg-white rounded border border-blue-200">
                        <h4 class="font-semibold text-gray-800 mb-2">🚗 Лизинг</h4>
                        <div class="space-y-1 text-sm">
                            ${result.lease_calculation.monthly_payment ? `
                                <p>Ежемесячный платеж: <span class="font-bold text-blue-700">${formatPrice(result.lease_calculation.monthly_payment)} ₽</span></p>
                            ` : ''}
                            ${result.lease_calculation.total_payment ? `
                                <p>Общая сумма выплат: <span class="text-gray-700">${formatPrice(result.lease_calculation.total_payment)} ₽</span></p>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            if (result.comparison) {
                html += `
                    <div class="p-3 bg-white rounded border border-gray-200">
                        <h4 class="font-semibold text-gray-800 mb-2">📊 Сравнение</h4>
                        <p class="text-sm text-gray-700">${result.comparison.recommendation || ''}</p>
                    </div>
                `;
            }
            
            html += '</div>';
            resultDiv.innerHTML = html;
            resultDiv.classList.remove('hidden');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                // Получаем chat area
                const chat = document.getElementById('chatArea');
                
                // Очищаем старые мини-бары источников
                // НЕ удаляем мини-бары (refbar) - они привязаны к конкретным сообщениям
                // НЕ очищаем localStorage - источники хранятся для каждого сообщения отдельно
                // window.__lastSources используется только для передачи данных в новое сообщение
                
                addUserMessage(message);
                input.value = '';
                
                // Show typing indicator
                const typingId = 'typing-' + Date.now();
                document.getElementById('emptyState')?.remove();
                if (chat) chat.innerHTML += `
                    <div id="${typingId}" class="flex items-center gap-2 text-gray-500">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                        <span>${isEnglish ? uiTexts.en.typing : uiTexts.ru.typing}</span>
                    </div>
                `;
                if (chat) chat.scrollTop = chat.scrollHeight;
                try {
                    // Проверяем, включен ли SQL-агент и подходит ли запрос для SQL
                    let sqlAgentEnabled = false;
                    let sqlProcessed = false; // Флаг успешной обработки SQL-агентом
                    
                    try {
                        const statusRes = await fetch(API_BASE + '/api/ai/sql-agent/status', {
                            headers: { ...authHeader() }
                        });
                        if (statusRes.ok) {
                            const statusData = await statusRes.json();
                            sqlAgentEnabled = statusData.enabled || false;
                        }
                    } catch (e) {
                        console.log('Не удалось проверить статус SQL-агента:', e);
                    }
                    
                    // Если SQL-агент включен, пытаемся обработать через него
                    if (sqlAgentEnabled) {
                        try {
                            console.log('🔄 Пытаюсь обработать через SQL-агента:', message);
                            const sqlRes = await fetch(API_BASE + '/api/ai/sql-agent/query', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', ...authHeader() },
                                body: JSON.stringify({ question: message, generate_only: false })
                            });
                            const sqlData = await sqlRes.json();
                            
                            // Проверяем, требуется ли уточнение
                            if (sqlData.needs_clarification && sqlData.clarification_questions) {
                                const ti = document.getElementById(typingId);
                                if (ti) ti.remove();
                                
                                console.log('❓ Требуется уточнение запроса');
                                console.log('📋 Вопросы для уточнения:', sqlData.clarification_questions);
                                
                                // Формируем сообщение с вопросами для уточнения
                                let clarificationMessage = 'Для более точного поиска мне нужны уточнения:\n\n';
                                sqlData.clarification_questions.forEach((q, idx) => {
                                    clarificationMessage += `${idx + 1}. ${q}\n`;
                                });
                                clarificationMessage += '\nПожалуйста, ответьте на эти вопросы, и я смогу найти подходящие автомобили.';
                                
                                // Добавляем сообщение с вопросами
                                addAIMessage(clarificationMessage, {
                                    cars: [],
                                    articles: [],
                                    documents: []
                                });
                                
                                // Сохраняем контекст для последующего уточнения
                                // (можно добавить в localStorage или в состояние)
                                if (sqlData.query_analysis) {
                                    console.log('📊 Анализ запроса:', sqlData.query_analysis);
                                }
                                
                                sqlProcessed = true;
                                // Пропускаем дальнейшую обработку - уточнение обработано
                            } else {
                                // Проверяем, есть ли данные от fallback на Elasticsearch, даже если success=false
                                const hasFallbackData = sqlData.fallback_source === 'elasticsearch' && 
                                                       sqlData.data && 
                                                       sqlData.data.length > 0;
                                
                                // Если есть данные от fallback, считаем это успешным ответом
                                if (sqlData.success || hasFallbackData) {
                                const ti = document.getElementById(typingId);
                                if (ti) ti.remove();
                                console.log('✅ SQL-агент успешно обработал запрос');
                                // Проверяем источник данных (только для логирования)
                                if (sqlData.fallback_source === 'elasticsearch') {
                                    console.log('🔄 Данные найдены через Elasticsearch fallback');
                                } else {
                                    console.log('📊 Данные найдены через SQL-агент');
                                }
                                sqlProcessed = true;
                                
                                // Формируем финальный ответ (первые 5 записей уже обработаны AI)
                                let finalResponse = sqlData.answer || 'Запрос выполнен успешно.';
                                console.log(`📝 AI-сформированный ответ: ${finalResponse.length} символов`);
                                
                                // Объявляем carsForSources ДО блока if, чтобы она была доступна везде
                                let carsForSources = [];
                                
                                // Преобразуем данные в формат для renderSourcesBar (для SQL-агента и Elasticsearch fallback)
                                if (sqlData.row_count !== undefined && sqlData.row_count > 0 && sqlData.data && sqlData.columns) {
                                    const displayCount = sqlData.data.length; // Все данные (до 500)
                                    console.log(`📊 Найдено ${sqlData.row_count} записей, преобразую ${displayCount} для отображения в источниках`);
                                    
                                    // Логируем структуру данных для отладки
                                    console.log('🔍 sqlData.columns:', sqlData.columns);
                                    if (sqlData.data.length > 0) {
                                        console.log('🔍 Первая запись из sqlData.data:', sqlData.data[0]);
                                        console.log('🔍 Ключи в первой записи:', Object.keys(sqlData.data[0]));
                                        console.log('🔍 Значения в первой записи:', Object.entries(sqlData.data[0]));
                                    }
                                    
                                    // Преобразуем данные в формат для renderSourcesBar
                                    carsForSources = sqlData.data.map((row, idx) => {
                                        // Определяем тип автомобиля
                                        const carType = row.type || (row.mileage ? 'used_car' : 'car');
                                        
                                        // Извлекаем ID - может быть в разных форматах или ключах
                                        let carId = row.id;
                                        if (carId === null || carId === undefined || carId === '') {
                                            // Пробуем разные варианты ключей
                                            if (row.ID !== undefined) carId = row.ID;
                                            else if (row.Id !== undefined) carId = row.Id;
                                            else if (row['id'] !== undefined) carId = row['id'];
                                            // Если все еще нет, пробуем найти по названию колонки
                                            else if (sqlData.columns && sqlData.columns.includes('id')) {
                                                const idIndex = sqlData.columns.indexOf('id');
                                                if (idIndex >= 0 && Array.isArray(row)) {
                                                    carId = row[idIndex];
                                                }
                                            }
                                        }
                                        
                                        // Создаем объект автомобиля, используя данные из строки
                                        const car = {
                                            id: carId !== null && carId !== undefined ? Number(carId) : null,
                                            mark: row.mark || row.Mark || '',
                                            model: row.model || row.Model || '',
                                            manufacture_year: row.manufacture_year || row.model_year || row.manufactureYear || '',
                                            price: row.price || row.sale_price || row.Price || '',
                                            city: row.city || row.City || '',
                                            body_type: row.body_type || row.bodyType || '',
                                            mileage: row.mileage !== null && row.mileage !== undefined ? Number(row.mileage) : null,
                                            vin: row.vin || row.VIN || row.Vin || '',
                                            type: carType === 'used_car' ? 'used_car' : 'car',
                                            fuel_type: row.fuel_type || row.fuelType || '',
                                            gear_box_type: row.gear_box_type || row.gearBoxType || '',
                                            power: row.power || row.Power || '',
                                            color: row.color || row.Color || ''
                                        };
                                        
                                        // Логируем первую запись для отладки
                                        if (idx === 0) {
                                            console.log('🔍 Преобразованная первая запись:', car);
                                            console.log('🔍 ID в первой записи:', car.id, 'тип:', typeof car.id);
                                        }
                                        
                                        return car;
                                    }).filter((car, filterIdx) => {
                                        // Более мягкий фильтр - проверяем наличие хотя бы mark или model, или валидный ID
                                        const hasId = car.id !== null && car.id !== undefined && car.id !== 0 && !isNaN(car.id);
                                        const hasMarkOrModel = (car.mark && car.mark.trim() !== '') || (car.model && car.model.trim() !== '');
                                        const isValid = hasId || hasMarkOrModel;
                                        
                                        if (!isValid && filterIdx === 0) {
                                            console.log('⚠️ Первая запись отфильтрована:', car);
                                        }
                                        
                                        return isValid;
                                    });
                                    
                                    console.log('🚗 Преобразованные автомобили для источников:', carsForSources);
                                    console.log('📊 Количество после фильтрации:', carsForSources.length);
                                    
                                    // Если все отфильтровались, пробуем более мягкий подход
                                    if (carsForSources.length === 0 && sqlData.data.length > 0) {
                                        console.log('⚠️ Все записи отфильтрованы, пробую более мягкий подход...');
                                        const allCars = sqlData.data.map((row, idx) => {
                                            return {
                                                id: row.id || idx + 1, // Используем индекс как fallback
                                                mark: row.mark || '',
                                                model: row.model || '',
                                                manufacture_year: row.manufacture_year || row.model_year || '',
                                                price: row.price || row.sale_price || '',
                                                city: row.city || '',
                                                body_type: row.body_type || '',
                                                mileage: row.mileage || null,
                                                vin: row.vin || '',
                                                type: row.type || (row.mileage ? 'used_car' : 'car'),
                                                fuel_type: row.fuel_type || '',
                                                gear_box_type: row.gear_box_type || '',
                                                power: row.power || '',
                                                color: row.color || ''
                                            };
                                        });
                                        carsForSources.push(...allCars);
                                        console.log('🚗 Автомобили после мягкого подхода:', carsForSources.length);
                                    }
                                    
                                    // НЕ вызываем renderSourcesBar здесь - sources будут отображаться через кнопку "Search found"
                                    // для каждого конкретного сообщения
                                    console.log(`✅ Подготовлено ${carsForSources.length} автомобилей для сохранения в sources_data`);
                                } else if (sqlData.row_count === 0) {
                                    finalResponse += '\n\n*Результатов не найдено.*';
                                }
                                
                                // Подготавливаем sources_data для сохранения
                                const sourcesData = {
                                    cars: carsForSources || [],
                                    articles: [],
                                    documents: []
                                };
                                
                                console.log('📊 Подготовлены sources_data для сохранения:', {
                                    carsCount: sourcesData.cars.length,
                                    totalCarsForSources: carsForSources?.length || 0,
                                    firstCar: sourcesData.cars[0] || null
                                });
                                
                                // Сохраняем ответ через chat/message для сохранения в истории
                                console.log('📤 Отправляю ответ в /api/chat/message для сохранения в истории');
                                try {
                                    // Получаем состояние размышления
                                    const deepThinkingEnabled = localStorage.getItem('deepThinkingEnabled') === 'true';
                                    
                                    const chatRes = await fetch(API_BASE + '/api/chat/message', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                                        body: JSON.stringify({ 
                                            message: message, 
                                            user_id: getCurrentUserId(),
                                            chat_id: currentChatId,
                                            deep_thinking_enabled: deepThinkingEnabled,
                                            sql_agent_response: finalResponse,  // Отправляем готовый ответ (работает для SQL-агента и Elasticsearch fallback)
                                            sources_data: sourcesData  // Сохраняем sources для этого сообщения
                                        })
                                    });
                                    
                                    if (chatRes.ok) {
                                        const chatData = await chatRes.json();
                                        console.log('📥 Получен ответ от chat/message:', {
                                            hasResponse: !!chatData.response,
                                            responseLength: chatData.response?.length || 0,
                                            messageId: chatData.message_id,
                                            chatId: chatData.chat_id,
                                            sourcesDataCount: {
                                                cars: sourcesData.cars?.length || 0,
                                                articles: sourcesData.articles?.length || 0,
                                                documents: sourcesData.documents?.length || 0
                                            }
                                        });
                                        
                                        // Обновляем currentChatId если он был создан
                                        if (chatData.chat_id) {
                                            currentChatId = chatData.chat_id;
                                            currentChatTitle = chatData.chat_title || null;
                                            currentChatIsSession = false;
                                            window.__selectedSessionId = null;
                                            updateChatTitleDisplay();
                                        }
                                        
                                        // Выводим AI-сформированный ответ с sources_data
                                        const responseText = chatData.response || finalResponse;
                                        console.log('📝 Вызываю addAIMessage с:', {
                                            responseLength: responseText.length,
                                            messageId: chatData.message_id,
                                            sourcesCount: sourcesData.cars?.length || 0
                                        });
                                        
                                        addAIMessage(responseText, chatData.message_id, sourcesData);
                                        console.log('✅ addAIMessage вызван');
                                        
                                        // Обновляем список чатов
                                        await loadChats();
                                    } else {
                                        console.error('❌ Ошибка при сохранении в chat/message:', chatRes.status, chatRes.statusText);
                                        // Fallback: выводим напрямую если chat/message не доступен
                                        addAIMessage(finalResponse, null, sourcesData);
                                    }
                                } catch (chatError) {
                                    console.error('Ошибка при отправке через chat/message:', chatError);
                                    // Fallback: выводим напрямую если сохранение не удалось
                                    addAIMessage(finalResponse, null, sourcesData);
                                }
                                
                                // Прерываем выполнение - не вызываем Elasticsearch и другие сервисы
                                return;
                            } else {
                                // Если SQL-агент не смог обработать, проверяем наличие fallback данных
                                const ti = document.getElementById(typingId);
                                if (ti) ti.remove();
                                
                                // Если fallback на Elasticsearch нашел данные, обрабатываем их как успешный ответ
                                if (sqlData.fallback_source === 'elasticsearch' && sqlData.data && sqlData.data.length > 0) {
                                    console.log('✅ Fallback на Elasticsearch нашел данные, обрабатываю как успешный ответ');
                                    
                                    // Обрабатываем данные от fallback так же, как успешный ответ SQL-агента
                                    sqlProcessed = true;
                                    
                                    // Формируем финальный ответ
                                    let finalResponse = sqlData.answer || `Найдено ${sqlData.row_count || 0} автомобилей через Elasticsearch.`;
                                    
                                    // Преобразуем данные в формат для sources
                                    let carsForSources = [];
                                    if (sqlData.row_count !== undefined && sqlData.row_count > 0 && sqlData.data && sqlData.columns) {
                                        carsForSources = sqlData.data.map((row) => {
                                            const carType = row.type || (row.mileage ? 'used_car' : 'car');
                                            return {
                                                id: row.id || null,
                                                mark: row.mark || '',
                                                model: row.model || '',
                                                manufacture_year: row.manufacture_year || row.model_year || '',
                                                price: row.price || row.sale_price || '',
                                                city: row.city || '',
                                                body_type: row.body_type || '',
                                                mileage: row.mileage !== null && row.mileage !== undefined ? Number(row.mileage) : null,
                                                vin: row.vin || '',
                                                type: carType === 'used_car' ? 'used_car' : 'car',
                                                fuel_type: row.fuel_type || '',
                                                gear_box_type: row.gear_box_type || '',
                                                power: row.power || '',
                                                color: row.color || ''
                                            };
                                        }).filter(c => c.id);
                                    }
                                    
                                    const sourcesData = {
                                        cars: carsForSources || [],
                                        articles: [],
                                        documents: []
                                    };
                                    
                                    // Сохраняем ответ через chat/message
                                    try {
                                        const deepThinkingEnabled = localStorage.getItem('deepThinkingEnabled') === 'true';
                                        const chatRes = await fetch(API_BASE + '/api/chat/message', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json', ...authHeader() },
                                            body: JSON.stringify({ 
                                                message: message, 
                                                user_id: getCurrentUserId(),
                                                chat_id: currentChatId,
                                                deep_thinking_enabled: deepThinkingEnabled,
                                                sql_agent_response: finalResponse,
                                                sources_data: sourcesData
                                            })
                                        });
                                        
                                        if (chatRes.ok) {
                                            const chatData = await chatRes.json();
                                            if (chatData.chat_id) {
                                                currentChatId = chatData.chat_id;
                                                currentChatTitle = chatData.chat_title || null;
                                                currentChatIsSession = false;
                                                window.__selectedSessionId = null;
                                                updateChatTitleDisplay();
                                            }
                                            addAIMessage(chatData.response || finalResponse, chatData.message_id, sourcesData);
                                            await loadChats();
                                        } else {
                                            addAIMessage(finalResponse, null, sourcesData);
                                        }
                                    } catch (chatError) {
                                        console.error('Ошибка при отправке через chat/message:', chatError);
                                        addAIMessage(finalResponse, null, sourcesData);
                                    }
                                    
                                    return;
                                }
                                
                                // Если нет данных от fallback, показываем ошибку и продолжаем обычный чат
                                console.log('⚠️ SQL-агент не смог обработать запрос:', sqlData.error);
                                console.log('🔄 Продолжаю обработку через обычный чат...');
                                }
                            } // Конец else блока (если не требуется уточнение)
                        } catch (sqlError) {
                            console.error('❌ Ошибка SQL-агента:', sqlError);
                            console.log('🔄 Продолжаю обработку через обычный чат...');
                        }
                    }
                    
                    // Только если SQL-агент не обработал запрос, используем обычный чат с Elasticsearch
                    if (!sqlProcessed) {
                        console.log('🔄 SQL-агент не обработал запрос, переключаюсь на обычный чат и Elasticsearch');
                        
                        // Ожидаем завершения поиска в ES по свободному тексту
                        await searchEsCars(message);

                        // Собираем sources_data из Elasticsearch результатов
                        const esCars = window.__lastSources || [];
                        console.log(`📊 Найдено автомобилей в ES: ${esCars.length}`);
                        
                        // Отправляем запрос на сервер с cars из ES
                        // articles и documents будут добавлены из ответа RAG сервиса на backend
                        // Получаем состояние размышления и интеллектуального поиска
                        const deepThinkingEnabled = localStorage.getItem('deepThinkingEnabled') === 'true';
                        const intelligentSearchEnabled = localStorage.getItem('intelligentSearchEnabled') === 'true';
                        
                        const res = await fetch(API_BASE + '/api/chat/message', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeader() },
                            body: JSON.stringify({ 
                                message, 
                                user_id: getCurrentUserId(),
                                chat_id: currentChatId,
                                deep_thinking_enabled: deepThinkingEnabled,
                                use_intelligent_search: intelligentSearchEnabled,
                                sources_data: {
                                    cars: esCars,
                                    articles: [],  // Будет заполнено из ответа RAG
                                    documents: []  // Будет заполнено из ответа RAG
                                }
                            })
                        });
                        
                        // Удаляем typing indicator только после получения ответа
                        const ti = document.getElementById(typingId);
                        if (ti) ti.remove();
                        
                        if (!res.ok) {
                            console.error('❌ Ошибка при отправке сообщения:', res.status, res.statusText);
                            try {
                                const errorText = await res.text();
                                console.error('Ошибка ответа:', errorText);
                            } catch (e) {
                                console.error('Не удалось прочитать текст ошибки:', e);
                            }
                            addAIMessage(escapeHtml(isEnglish ? 'Error. Try again.' : 'Ошибка. Повторите попытку.'), null, null);
                            return;
                        }
                        
                        let data;
                        try {
                            data = await res.json();
                            console.log('📥 Получен ответ от chat/message:', data);
                        } catch (e) {
                            console.error('❌ Ошибка при парсинге ответа:', e);
                            addAIMessage(escapeHtml(isEnglish ? 'Error parsing response. Try again.' : 'Ошибка при обработке ответа. Повторите попытку.'), null, null);
                            return;
                        }
                        
                        // Проверяем наличие ответа
                        if (!data || !data.response || data.response.trim() === '') {
                            console.error('❌ Пустой ответ от сервера:', data);
                            addAIMessage(escapeHtml(isEnglish ? 'No response received. Try again.' : 'Ответ не получен. Повторите попытку.'), null, null);
                            return;
                        }
                        
                        // Обновляем currentChatId если он был создан
                        if (data.chat_id) {
                            currentChatId = data.chat_id;
                            currentChatTitle = data.chat_title || null;
                            currentChatIsSession = false;
                            window.__selectedSessionId = null;
                            updateChatTitleDisplay();
                        }
                        
                        // Преобразуем автомобили из ответа сервера в формат для sources_data
                        const carsFromResponse = [];
                        
                        // Обрабатываем новые автомобили (related_cars)
                        if (Array.isArray(data.related_cars) && data.related_cars.length > 0) {
                            console.log('🚗 Найдено новых автомобилей в ответе:', data.related_cars.length);
                            carsFromResponse.push(...data.related_cars.map(car => ({
                                id: car.id || null,
                                mark: car.mark || '',
                                model: car.model || '',
                                manufacture_year: car.manufacture_year || car.model_year || '',
                                price: car.price || car.sale_price || '',
                                city: car.city || '',
                                body_type: car.body_type || '',
                                mileage: null, // Новые автомобили не имеют пробега
                                vin: car.vin || '',
                                type: 'car',
                                fuel_type: car.fuel_type || '',
                                gear_box_type: car.gear_box_type || '',
                                power: car.power || '',
                                color: car.color || ''
                            })));
                        }
                        
                        // Обрабатываем подержанные автомобили (related_used_cars)
                        if (Array.isArray(data.related_used_cars) && data.related_used_cars.length > 0) {
                            console.log('🚗 Найдено подержанных автомобилей в ответе:', data.related_used_cars.length);
                            carsFromResponse.push(...data.related_used_cars.map(car => ({
                                id: car.id || null,
                                mark: car.mark || '',
                                model: car.model || '',
                                manufacture_year: car.manufacture_year || car.model_year || '',
                                price: car.price || car.sale_price || '',
                                city: car.city || '',
                                body_type: car.body_type || '',
                                mileage: car.mileage !== null && car.mileage !== undefined ? Number(car.mileage) : null,
                                vin: car.vin || '',
                                type: 'used_car',
                                fuel_type: car.fuel_type || '',
                                gear_box_type: car.gear_box_type || '',
                                power: car.power || '',
                                color: car.color || ''
                            })));
                        }
                        
                        // Объединяем автомобили: сначала из ответа сервера, потом из ES (если есть)
                        // Убираем дубликаты по ID
                        const allCarsMap = new Map();
                        
                        // Сначала добавляем автомобили из ответа сервера (приоритет)
                        carsFromResponse.forEach(car => {
                            if (car.id) {
                                allCarsMap.set(car.id, car);
                            }
                        });
                        
                        // Затем добавляем автомобили из ES, если их еще нет
                        if (Array.isArray(esCars)) {
                            esCars.forEach(car => {
                                if (car.id && !allCarsMap.has(car.id)) {
                                    allCarsMap.set(car.id, car);
                                }
                            });
                        }
                        
                        const allCars = Array.from(allCarsMap.values());
                        
                        // Проверяем наличие информации об интеллектуальном поиске
                        let intelligentSearchInfo = null;
                        if (data.sources_data && data.sources_data.intelligent_search) {
                            intelligentSearchInfo = data.sources_data.intelligent_search;
                        }
                        
                        // Проверяем наличие рекомендаций
                        let recommendations = null;
                        if (data.sources_data && data.sources_data.recommendations) {
                            recommendations = data.sources_data.recommendations;
                        }
                        
                        // Подготавливаем полные sources_data для отображения и сохранения
                        // Включаем articles и documents из ответа сервера
                        const fullSourcesData = {
                            cars: allCars,
                            articles: Array.isArray(data.related_articles) ? data.related_articles : [],
                            documents: Array.isArray(data.related_documents) ? data.related_documents : [],
                            intelligent_search: intelligentSearchInfo,
                            recommendations: recommendations,
                            clarifying_questions: data.clarifying_questions || data.sources_data?.clarifying_questions || [],
                            proactive_suggestions: data.proactive_suggestions || data.sources_data?.proactive_suggestions || [],
                            finance_calculation: data.finance_calculation || data.sources_data?.finance_calculation || null
                        };
                        
                        console.log('📊 Полные sources_data для сохранения:', {
                            cars: fullSourcesData.cars.length,
                            carsFromResponse: carsFromResponse.length,
                            carsFromES: esCars.length,
                            articles: fullSourcesData.articles.length,
                            documents: fullSourcesData.documents.length
                        });
                        
                        // sources_data теперь включают articles и documents из ответа сервера
                        // Backend автоматически объединяет их при сохранении
                        
                        // Отладочная информация
                        console.log('Response data:', data);
                        console.log('Related cars:', data.related_cars?.length || 0);
                        console.log('Related used_cars:', data.related_used_cars?.length || 0);
                        console.log('Related articles:', data.related_articles?.length || 0);
                        console.log('Related documents:', data.related_documents?.length || 0);
                        
                        // Рендер мини-бара источников (статьи + документы)
                        const hasArticles = fullSourcesData.articles.length > 0;
                        const hasDocuments = fullSourcesData.documents.length > 0;
                        const hasCars = fullSourcesData.cars.length > 0;
                        
                        console.log('Has articles:', hasArticles, 'Has documents:', hasDocuments, 'Has cars:', hasCars);
                        
                        // Выводим ответ с полными sources_data
                        console.log('📝 Вызываю addAIMessage с response:', {
                            responseLength: data.response?.length || 0,
                            messageId: data.message_id,
                            hasSources: !!fullSourcesData
                        });
                        addAIMessage(data.response, data.message_id, fullSourcesData, data.model_info);
                        
                        // НЕ вызываем renderSourcesBar здесь автоматически
                        // Sources будут отображаться только при нажатии на кнопку "Search found" для конкретного сообщения
                        if (hasArticles || hasDocuments || hasCars) {
                            console.log('✅ Sources подготовлены для сообщения:', data.message_id, '-', fullSourcesData.articles.length, 'articles,', fullSourcesData.documents.length, 'documents,', fullSourcesData.cars.length, 'cars');
                        } else {
                            console.log('⚠️ No sources to display');
                        }
                        
                        // Обновляем список чатов
                        await loadChats();
                    }
                } catch (e) {
                    const ti = document.getElementById(typingId);
                    if (ti) ti.remove();
                    addAIMessage(escapeHtml(isEnglish ? 'Error. Try again.' : 'Ошибка. Повторите попытку.'));
                }
            }
        }

        // Поиск авто в ES и интеграция в источники
        async function searchEsCars(text) {
            try {
                console.log('🔍 Выполняю поиск автомобилей через Elasticsearch:', text);
                const qs = new URLSearchParams({ q: text, limit: '500' }); // Увеличиваем лимит до 500
                // Используем правильный путь через API (проксируется через nginx)
                const resp = await fetch(API_BASE + '/api/search/es/cars?' + qs.toString(), { headers: { ...authHeader() } });
                
                if (!resp.ok) {
                    console.error('❌ Ошибка при поиске в ES:', resp.status, resp.statusText);
                    window.__lastSources = [];
                    return;
                }
                
                const data = await resp.json();
                console.log('📊 Результаты поиска ES:', data);
                
                const hits = Array.isArray(data.hits) ? data.hits : [];
                const total = data.total || hits.length;
                
                console.log(`✅ Найдено автомобилей: ${total} (показано: ${hits.length})`);
                
                const cars = hits.map(h => {
                    const s = h._source || {};
                    // Определяем тип автомобиля по наличию mileage
                    const carType = s.type || (s.mileage ? 'used_car' : 'car');
                    
                    return {
                        id: s.id,
                        mark: s.mark || '',
                        model: s.model || '',
                        manufacture_year: s.manufacture_year || s.model_year || '',
                        price: s.price || s.sale_price || '',
                        city: s.city || '',
                        body_type: s.body_type || '',
                        fuel_type: s.fuel_type || '',
                        gear_box_type: s.gear_box_type || '',
                        power: s.power || '',
                        color: s.color || '',
                        mileage: s.mileage || null,
                        vin: s.vin || '',
                        type: carType === 'used_car' ? 'used_car' : 'car'
                    };
                }).filter(c => c.id);  // Фильтруем только валидные автомобили
                
                console.log('🚗 Обработанные автомобили для источников:', cars);
                
                // Сохраняем результаты для использования в sources_data
                window.__lastSources = cars;
                
                if (cars.length > 0) {
                    console.log(`✅ Сохранено ${cars.length} автомобилей в window.__lastSources`);
                } else {
                    console.log('⚠️ Автомобили не найдены или не отображены');
                }
            } catch (e) {
                console.error('❌ Ошибка поиска ES:', e);
                window.__lastSources = [];
            }
        }

        // Источники: мини-бар над ответом и панель с карточками
        function renderSourcesBar(articles, documents = [], cars = []) {
            console.log('📋 renderSourcesBar called with:', { 
                articles: articles?.length || 0, 
                documents: documents?.length || 0, 
                cars: cars?.length || 0 
            });
            
            const chat = document.getElementById('chatArea');
            if (!chat) {
                console.warn('⚠️ Chat area not found');
                return;
            }
            
            // Проверяем наличие источников
            const hasArticles = Array.isArray(articles) && articles.length > 0;
            const hasDocuments = Array.isArray(documents) && documents.length > 0;
            const hasCars = Array.isArray(cars) && cars.length > 0;
            
            if (!hasArticles && !hasDocuments && !hasCars) {
                console.log('⚠️ No sources to render');
                return;
            }
            
            console.log(`✅ Рендерим бар источников: ${hasArticles ? articles.length + ' статей' : ''} ${hasDocuments ? documents.length + ' документов' : ''} ${hasCars ? cars.length + ' автомобилей' : ''}`);
            
            const totalCount = (articles?.length || 0) + (documents?.length || 0) + (cars?.length || 0);
            const hostIcons = [];
            
            // Иконки для статей
            if (articles && articles.length > 0) {
                const articleIcons = articles.slice(0, 4).map((a, idx) => {
                    try {
                        const u = (a.url || '').startsWith('http') ? new URL(a.url) : null;
                        const host = u ? u.hostname : 'kb.local';
                        const icon = u ? `https://www.google.com/s2/favicons?sz=64&domain=${u.hostname}` : '';
                        const imgTag = icon ? `<img src="${icon}" alt="${host}" class="w-4 h-4 rounded-sm" onerror="this.style.display='none'">` : '';
                        return `<div class="flex items-center justify-center w-4 h-4">${imgTag}</div>`;
                    } catch { return ''; }
                });
                hostIcons.push(...articleIcons);
            }
            
            // Иконки для документов
            if (documents && documents.length > 0) {
                const docIcons = documents.slice(0, 4).map((doc, idx) => {
                    return `<div class="flex items-center justify-center w-4 h-4"><span class="text-xs text-blue-600">📄</span></div>`;
                });
                hostIcons.push(...docIcons);
            }
            // Иконки для автомобилей
            if (cars && cars.length > 0) {
                const carIcons = cars.slice(0, 4).map(() => `<div class=\"flex items-center justify-center w-4 h-4\"><span class=\"text-xs\">🚗</span></div>`);
                hostIcons.push(...carIcons);
            }

            // Проверяем, не существует ли уже refbar (чтобы избежать дублирования)
            const existingRefbar = chat.querySelector('[id^="refbar-"]');
            if (existingRefbar) {
                console.log('⚠️ Refbar уже существует, пропускаем создание нового');
                return; // Не создаем новый refbar, если уже есть
            }
            
            const barId = 'refbar-' + Date.now();
            
            // Формируем текст с детализацией по типам
            const sourcesText = (() => {
                const parts = [];
                if (hasArticles) parts.push(`${articles.length} ${isEnglish ? 'article' + (articles.length > 1 ? 's' : '') : 'статей'}`);
                if (hasDocuments) parts.push(`${documents.length} ${isEnglish ? 'document' + (documents.length > 1 ? 's' : '') : 'документ' + (documents.length === 1 ? '' : documents.length < 5 ? 'а' : 'ов')}`);
                if (hasCars) parts.push(`${cars.length} ${isEnglish ? 'car' + (cars.length > 1 ? 's' : '') : 'автомобил' + (cars.length === 1 ? '' : (cars.length < 5 ? 'я' : 'ей'))}`);
                return parts.join(', ');
            })();
            
            chat.innerHTML += `
                <div id="${barId}" class="flex items-center gap-2 text-xs text-gray-600 cursor-pointer select-none hover:text-blue-600 transition-colors p-2 rounded-lg hover:bg-blue-50" role="button" tabindex="0">
                    <div class="flex items-center justify-center w-4 h-4">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M0.300842 6.75896C0.300842 3.2391 3.15501 0.384938 6.67487 0.384938C6.98421 0.384956 7.28876 0.407574 7.58698 0.450368L7.49518 1.09392L7.4024 1.73748C7.16512 1.70342 6.92228 1.68574 6.67487 1.68572C3.87298 1.68572 1.60162 3.95707 1.60162 6.75896C1.60182 9.56068 3.8731 11.8322 6.67487 11.8322C9.0556 11.832 11.0549 10.1909 11.6006 7.97771L12.2315 8.13299L12.8624 8.28924C12.1767 11.0694 9.66758 13.1318 6.67487 13.132C3.15513 13.132 0.301038 10.2787 0.300842 6.75896Z" fill="currentColor"></path>
                            <path d="M15.6992 14.8074L14.7793 15.7274L11.3974 12.3455L12.3174 11.4256L15.6992 14.8074Z" fill="currentColor"></path>
                            <path d="M11.3473 6.59701C11.2764 6.81246 10.9716 6.81246 10.9008 6.59701L10.4901 5.34822C10.3035 4.78103 9.85867 4.33617 9.29148 4.14962L8.04269 3.73893C7.82724 3.66807 7.82724 3.36329 8.04269 3.29243L9.29148 2.88173C9.85867 2.69519 10.3035 2.25032 10.4901 1.68314L10.9008 0.434345C10.9716 0.218896 11.2764 0.218896 11.3473 0.434345L11.758 1.68314C11.9445 2.25032 12.3894 2.69519 12.9566 2.88173L14.2054 3.29243C14.4208 3.36329 14.4208 3.66807 14.2054 3.73893L12.9566 4.14962C12.3894 4.33617 11.9445 4.78103 11.758 5.34822L11.3473 6.59701Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <span class="font-medium">${isEnglish ? 'Search found' : 'Найдено'}: ${totalCount} ${sourcesText ? `(${sourcesText})` : (isEnglish ? 'sources' : 'источников')}</span>
                    <div class="flex items-center gap-1 ml-auto">${hostIcons.join('')}</div>
                </div>
            `;
            
            // Плавный скролл к концу
            setTimeout(() => {
                chat.scrollTo({
                    top: chat.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            // Сохраняем данные для панели источников
            const allSources = [];
            if (articles && articles.length > 0) {
                allSources.push(...articles.map(art => ({
                    type: 'article',
                    url: art.url || '',
                    title: (art.title || '').slice(0, 80),
                    snippet: (art.text || '').slice(0, 200),
                    id: art.id
                })));
            }
            if (documents && documents.length > 0) {
                allSources.push(...documents.map(doc => ({
                    type: 'document',
                    title: (doc.title || doc.original_filename || '').slice(0, 80),
                    snippet: (doc.topic || doc.summary || '').slice(0, 200),
                    path: doc.path || '',
                    id: doc.id
                })));
            }
            if (cars && cars.length > 0) {
                allSources.push(...cars.map(s => ({
                    type: s.type || (s.mileage ? 'used_car' : 'car'), // Сохраняем тип автомобиля
                    id: s.id,
                    mark: s.mark || '',
                    model: s.model || '',
                    year: s.manufacture_year || s.model_year || '',
                    manufacture_year: s.manufacture_year || s.model_year || '',
                    price: s.price || s.sale_price || '',
                    city: s.city || '',
                    body_type: s.body_type || '',
                    fuel_type: s.fuel_type || '',
                    gear_box_type: s.gear_box_type || '',
                    power: s.power || '',
                    color: s.color || '',
                    mileage: s.mileage || null,
                    vin: s.vin || ''
                })));
            }
            window.__lastSources = allSources;
            
            // Сохраняем данные в localStorage для восстановления при обновлении
            console.log('Saving to localStorage:', { allSources, totalCount, hostIcons });
            localStorage.setItem('lastSources', JSON.stringify(allSources));
            localStorage.setItem('lastSourcesCount', totalCount.toString());
            localStorage.setItem('lastSourcesIcons', JSON.stringify(hostIcons));
            
            // Обработчик клика на весь бар
            const barEl = document.getElementById(barId);
            if (barEl) {
                const handler = function(ev){
                    console.log('Sources bar clicked');
                    ev.preventDefault();
                    ev.stopPropagation();
                    // Открываем UI источников (панель справа или модалка)
                    showSourcesUI();
                };
                barEl.addEventListener('click', handler);
                barEl.addEventListener('keydown', function(ev){ 
                    if (ev.key === 'Enter' || ev.key === ' ') { 
                        handler(ev); 
                    } 
                });
            }
        }


        function positionSourcesPanel() {
            const panel = document.getElementById('sourcesPanel');
            if (!panel) return;
            
            // Panel is now fixed positioned on the right side
            // No need to calculate position dynamically
            panel.style.top = '80px';
            panel.style.right = '20px';
            panel.style.left = 'auto';
            panel.style.width = '400px';
            panel.style.height = 'calc(100vh - 100px)';
            panel.style.pointerEvents = 'auto';
            
            // Убеждаемся, что скроллируемый контейнер имеет правильную высоту
            const list = document.getElementById('sourcesList');
            if (list && panel) {
                const panelHeight = window.innerHeight - 100;
                const headerHeight = 48;
                panel.style.height = `${panelHeight}px`;
                panel.style.overflow = 'hidden';
                list.style.flex = '1 1 0%';
                list.style.minHeight = '0';
                list.style.height = `${panelHeight - headerHeight}px`;
                list.style.maxHeight = `${panelHeight - headerHeight}px`;
                list.style.overflowY = 'scroll';
                list.style.overflowX = 'hidden';
            }
        }

        function showSourcesPanel() {
            const panel = document.getElementById('sourcesPanel');
            const list = document.getElementById('sourcesList');
            if (!panel || !list) return;
            
            // Убеждаемся, что панель имеет правильную высоту и структуру
            const panelHeight = window.innerHeight - 100;
            panel.style.height = `${panelHeight}px`;
            panel.style.display = 'flex';
            panel.style.flexDirection = 'column';
            panel.style.overflow = 'hidden'; // Важно: панель сама не скроллится, только список внутри
            panel.style.pointerEvents = 'auto';
            panel.classList.remove('hidden'); // Убираем класс hidden ПЕРЕД установкой display
            
            // Критически важно для flexbox-скролла:
            // 1. flex: 1 1 0% (не просто 0, а 0%)
            // 2. min-height: 0 (обязательно!)
            // 3. height: calc(100% - высота_заголовка) - явное ограничение высоты
            // 4. overflow-y: scroll - всегда показываем скроллбар
            const headerHeight = 48; // Высота заголовка
            list.style.flex = '1 1 0%';
            list.style.minHeight = '0';
            list.style.height = `${panelHeight - headerHeight}px`; // Явная высота для списка
            list.style.maxHeight = `${panelHeight - headerHeight}px`;
            list.style.overflowY = 'scroll'; // Используем scroll вместо auto для гарантии появления скроллбара
            list.style.overflowX = 'hidden';
            list.style.position = 'relative';
            
            // Проверяем, что скролл должен работать
            setTimeout(() => {
                const scrollHeight = list.scrollHeight;
                const clientHeight = list.clientHeight;
                const canScroll = scrollHeight > clientHeight;
                console.log('📏 Размеры списка:', { 
                    scrollHeight, 
                    clientHeight, 
                    panelHeight,
                    listHeight: panelHeight - headerHeight,
                    canScroll 
                });
                
                if (canScroll) {
                    console.log('✅ Скролл должен работать');
                    // Принудительно убеждаемся, что скролл активен
                    list.style.overflowY = 'scroll';
                } else {
                    console.log('ℹ️ Контента недостаточно для скролла');
                }
            }, 200);
            
            // Переинициализируем изоляцию скролла при открытии панели
            initSourcesPanelScrollIsolation();
            
            const items = Array.isArray(window.__lastSources) ? window.__lastSources : [];
            if (items.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">No sources available</div>';
                panel.classList.remove('hidden');
                return;
            }
            
            list.innerHTML = items.map((it, idx) => {
                // Обработка документов
                if (it.type === 'document') {
                    const host = it.path || 'Документ';
                    const icon = '<span class="text-xs text-blue-600">📄</span>';
                    
                    // Если есть URL, используем его для перехода, иначе открываем просмотр
                    const hasUrl = it.url && it.url.startsWith('http');
                    const href = hasUrl ? it.url : '#';
                    const onclickAttr = hasUrl ? '' : `onclick="event.preventDefault(); viewDocument(${it.id});"`;
                    const targetAttr = hasUrl ? 'target="_blank" rel="noreferrer"' : '';
                    
                    return `
                        <a href="${href}" ${onclickAttr} ${targetAttr} class="block p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center">
                                    <div class="w-4 h-4 bg-blue-100 rounded flex items-center justify-center">
                                        ${icon}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs text-gray-500 font-medium">${escapeHtml(host)}</span>
                                        <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                    </div>
                                    <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${escapeHtml(it.title)}</div>
                                    <div class="text-xs text-gray-600 line-clamp-3">${escapeHtml(it.snippet)}</div>
                                </div>
                            </div>
                        </a>`;
                }
                
                // Обработка автомобилей (новые и подержанные)
                if (it.type === 'car' || it.type === 'used_car') {
                    const carTypeLabel = it.type === 'used_car' ? 'Авто (с пробегом)' : 'Авто';
                    const year = it.year || it.manufacture_year || '';
                    const line = `${escapeHtml(it.mark || '')} ${escapeHtml(it.model || '')} ${year ? escapeHtml(String(year)) : ''}`.trim();
                    const details = [
                        it.city ? `Город: ${escapeHtml(it.city)}` : '',
                        it.body_type ? `Кузов: ${escapeHtml(it.body_type)}` : '',
                        it.fuel_type ? `Топливо: ${escapeHtml(it.fuel_type)}` : '',
                        it.gear_box_type ? `КПП: ${escapeHtml(it.gear_box_type)}` : '',
                        it.mileage ? `Пробег: ${escapeHtml(String(it.mileage))} км` : '',
                        it.vin ? `VIN: ${escapeHtml(it.vin)}` : ''
                    ].filter(Boolean).join(' · ');
                    const price = it.price ? String(it.price).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : '';
                    return `
                        <div class="p-3 rounded-lg border border-gray-200 bg-white">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center">🚗</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs text-gray-500 font-medium">${carTypeLabel}</span>
                                        <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                    </div>
                                    <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${line || 'Автомобиль'}</div>
                                    ${details ? `<div class=\"text-xs text-gray-600 mb-1\">${details}</div>` : ''}
                                    ${price ? `<div class=\"text-sm text-blue-700 font-semibold\">${escapeHtml(price)} ₽</div>` : ''}
                                </div>
                            </div>
                        </div>`;
                }
                
                // Обработка статей
                const host = (() => { 
                    try { 
                        return it.url ? new URL(it.url).hostname : 'kb.local'; 
                    } catch { 
                        return 'kb.local'; 
                    } 
                })();
                const icon = (() => { 
                    try { 
                        return it.url ? `https://www.google.com/s2/favicons?sz=64&domain=${new URL(it.url).hostname}` : ''; 
                    } catch { 
                        return ''; 
                    } 
                })();
                const href = it.url && it.url.startsWith('http') ? it.url : '#';
                
                return `
                    <a href="${href}" target="_blank" rel="noreferrer" class="block p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center">
                                ${icon ? `<img src="${icon}" class="w-4 h-4 rounded-sm" onerror="this.style.display='none'">` : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs text-gray-500 font-medium">${escapeHtml(host)}</span>
                                    <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                </div>
                                <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${escapeHtml(it.title)}</div>
                                <div class="text-xs text-gray-600 line-clamp-3">${escapeHtml(it.snippet)}</div>
                            </div>
                        </div>
                    </a>`;
            }).join('');
            positionSourcesPanel();
            // panel.classList.remove('hidden') уже вызвано выше
            // panel.style.display уже установлен выше
            
            // Плавный скролл к началу панели источников
            setTimeout(() => {
                const scrollContainer = panel.querySelector('.h-\\[calc\\(100\\%-60px\\)\\]');
                if (scrollContainer) {
                    scrollContainer.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            }, 100);
            
            console.log('Sources panel shown with', items.length, 'items');
        }

        function hideSourcesPanel() {
            const panel = document.getElementById('sourcesPanel');
            if (panel) {
                panel.classList.add('hidden');
                panel.style.display = 'none'; // Явно скрываем панель
                console.log('Sources panel hidden');
            }
        }
        
        function toggleSourcesPanel() {
            const panel = document.getElementById('sourcesPanel');
            if (!panel) {
                console.error('Sources panel not found');
                return;
            }
            
            if (panel.classList.contains('hidden')) {
                showSourcesPanel();
            } else {
                hideSourcesPanel();
            }
        }

        // Источники: модальное окно как запасной вариант и для узких экранов
        function showSourcesModal() {
            let modal = document.getElementById('sourcesModal');
            if (!modal) {
                const wrapper = document.createElement('div');
                wrapper.id = 'sourcesModal';
                wrapper.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                wrapper.innerHTML = `
                    <div class="bg-white w-full max-w-md max-h-[80vh] rounded-lg shadow-xl overflow-hidden flex flex-col">
                        <div class="flex items-center justify-between p-3 border-b border-gray-200 flex-shrink-0">
                            <div class="font-semibold">Search results</div>
                            <button id="sourcesModalClose" class="p-1 rounded hover:bg-gray-100" aria-label="Close">✕</button>
                        </div>
                        <div class="flex-1 overflow-y-auto overscroll-contain p-3" id="sourcesModalList" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;"></div>
                    </div>`;
                document.body.appendChild(wrapper);
                document.getElementById('sourcesModalClose').onclick = hideSourcesModal;
                modal = wrapper;
            }

            const listEl = document.getElementById('sourcesModalList');
            const items = Array.isArray(window.__lastSources) ? window.__lastSources : [];
            listEl.innerHTML = items.length ? items.map((it, idx) => {
                // Обработка автомобилей (новые и подержанные)
                if (it.type === 'car' || it.type === 'used_car') {
                    const carTypeLabel = it.type === 'used_car' ? 'Авто (с пробегом)' : 'Авто';
                    const year = it.year || it.manufacture_year || '';
                    const line = `${escapeHtml(it.mark || '')} ${escapeHtml(it.model || '')} ${year ? escapeHtml(String(year)) : ''}`.trim();
                    const details = [
                        it.city ? `Город: ${escapeHtml(it.city)}` : '',
                        it.body_type ? `Кузов: ${escapeHtml(it.body_type)}` : '',
                        it.fuel_type ? `Топливо: ${escapeHtml(it.fuel_type)}` : '',
                        it.gear_box_type ? `КПП: ${escapeHtml(it.gear_box_type)}` : '',
                        it.mileage ? `Пробег: ${escapeHtml(String(it.mileage))} км` : '',
                        it.vin ? `VIN: ${escapeHtml(it.vin)}` : ''
                    ].filter(Boolean).join(' · ');
                    const price = it.price ? String(it.price).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') : '';
                    return `
                        <div class="p-3 rounded-lg border border-gray-200 bg-white mb-2">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center">🚗</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs text-gray-500 font-medium">${carTypeLabel}</span>
                                        <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                    </div>
                                    <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${line || 'Автомобиль'}</div>
                                    ${details ? `<div class="text-xs text-gray-600 mb-1">${details}</div>` : ''}
                                    ${price ? `<div class="text-sm text-blue-700 font-semibold">${escapeHtml(price)} ₽</div>` : ''}
                                </div>
                            </div>
                        </div>`;
                }
                
                // Обработка документов
                if (it.type === 'document') {
                    const host = it.path || 'Документ';
                    const icon = '<span class="text-xs text-blue-600">📄</span>';
                    const hasUrl = it.url && it.url.startsWith('http');
                    const href = hasUrl ? it.url : '#';
                    const onclickAttr = hasUrl ? '' : `onclick="event.preventDefault(); viewDocument(${it.id}); return false;"`;
                    const targetAttr = hasUrl ? 'target="_blank" rel="noreferrer"' : '';
                    
                    return `
                        <a href="${href}" ${onclickAttr} ${targetAttr} class="block p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all mb-2">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center">
                                    <div class="w-4 h-4 bg-blue-100 rounded flex items-center justify-center">
                                        ${icon}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs text-gray-500 font-medium">${escapeHtml(host)}</span>
                                        <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                    </div>
                                    <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${escapeHtml(it.title)}</div>
                                    <div class="text-xs text-gray-600 line-clamp-3">${escapeHtml(it.snippet)}</div>
                                </div>
                            </div>
                        </a>`;
                }
                
                // Обработка статей
                const host = (() => { try { return it.url ? new URL(it.url).hostname : 'kb.local'; } catch { return 'kb.local'; } })();
                const icon = (() => { try { return it.url ? `https://www.google.com/s2/favicons?sz=64&domain=${new URL(it.url).hostname}` : ''; } catch { return ''; } })();
                const href = it.url && it.url.startsWith('http') ? it.url : '#';
                return `
                    <a href="${href}" target="_blank" rel="noreferrer" class="block p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all mb-2">
                        <div class="flex items-start gap-3">
                            <div class="w-5 h-5 flex items-center justify-center">${icon ? `<img src="${icon}" class="w-4 h-4" onerror="this.style.display='none'">` : ''}</div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs text-gray-500 font-medium">${escapeHtml(host)}</span>
                                    <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                </div>
                                <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${escapeHtml(it.title)}</div>
                                <div class="text-xs text-gray-600 line-clamp-3">${escapeHtml(it.snippet)}</div>
                            </div>
                        </div>
                    </a>`;
            }).join('') : '<div class="text-center text-gray-500 py-8">No sources available</div>';

            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function hideSourcesModal() {
            const modal = document.getElementById('sourcesModal');
            if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
        }

        function showSourcesUI() {
            // Для узких экранов открываем модалку, иначе правую панель
            if (window.innerWidth < 1024) {
                hideSourcesPanel();
                showSourcesModal();
            } else {
                hideSourcesModal();
                showSourcesPanel();
                
                // Плавный скролл к панели источников
                setTimeout(() => {
                    const panel = document.getElementById('sourcesPanel');
                    if (panel) {
                        panel.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                            inline: 'nearest'
                        });
                    }
                }, 200);
            }
        }

        function addUserMessage(text, messageId = null) {
            document.getElementById('emptyState')?.remove();
            const msgId = messageId || 'user-msg-' + Date.now();
            document.getElementById('chatArea').innerHTML += `
                <div id="${msgId}" class="flex justify-end" data-message-id="${msgId}">
                    <div class="max-w-3/4 px-4 py-3 chat-bubble-user">
                        ${text}
                    </div>
                </div>
            `;
            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
            feather.replace();
        }
        
        function addAIMessage(text, messageId = null, sourcesData = null, modelInfo = null) {
            console.log('🎯 addAIMessage вызван:', {
                textLength: text?.length || 0,
                messageId: messageId,
                hasSourcesData: !!sourcesData,
                sourcesCarsCount: sourcesData?.cars?.length || 0
            });
            
            const msgId = messageId || 'ai-msg-' + Date.now();
            const chat = document.getElementById('chatArea');
            if (!chat) {
                console.error('❌ Chat area не найден!');
                return;
            }
            
            if (!text || text.trim() === '') {
                console.error('❌ Пустой текст для сообщения!');
                return;
            }
            
            const html = renderRichContent(text);
            
            // Сохраняем sources_data для этого сообщения
            if (sourcesData) {
                // Сохраняем полные sources_data для этого конкретного сообщения
                window[`__sources_${msgId}`] = sourcesData;
                console.log(`💾 Сохранены sources для сообщения ${msgId}:`, {
                    cars: sourcesData.cars?.length || 0,
                    articles: sourcesData.articles?.length || 0,
                    documents: sourcesData.documents?.length || 0
                });
            } else {
                console.log(`ℹ️ Нет sources для сообщения ${msgId}`);
            }
            
            // Создаем информацию о модели
            let modelInfoHtml = '';
            if (modelInfo && modelInfo.display_name) {
                const modelType = modelInfo.model_type || 'unknown';
                const modelName = modelInfo.display_name || 'Unknown Model';
                const typeColors = {
                    'mistral': 'bg-blue-100 text-blue-800',
                    'openai': 'bg-green-100 text-green-800',
                    'anthropic': 'bg-purple-100 text-purple-800',
                    'ollama': 'bg-orange-100 text-orange-800',
                    'unknown': 'bg-gray-100 text-gray-800'
                };
                const colorClass = typeColors[modelType] || typeColors['unknown'];
                
                modelInfoHtml = `
                    <div class="flex items-center gap-2 mt-2 pt-2 border-t border-gray-200">
                        <span class="text-xs text-gray-500">Модель:</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${colorClass}">
                            ${modelName}
                        </span>
                    </div>
                `;
            }
            
            // Проверяем наличие информации об интеллектуальном поиске и рекомендаций
            let relaxationHtml = '';
            let recommendationsHtml = '';
            let clarifyingQuestionsHtml = '';
            let proactiveSuggestionsHtml = '';
            let financeCalculatorHtml = '';
            
            if (sourcesData) {
                // Отображение ослабления фильтров
                if (sourcesData.intelligent_search && sourcesData.intelligent_search.relaxation_applied) {
                    const relaxed = sourcesData.intelligent_search.relaxed_params || {};
                    const original = sourcesData.intelligent_search.original_params || {};
                    const changes = [];
                    
                    if (relaxed.min_price !== original.min_price) {
                        changes.push(`Цена: ${original.min_price || 'не указана'} → ${relaxed.min_price || 'не указана'}`);
                    }
                    if (relaxed.max_price !== original.max_price) {
                        changes.push(`Макс. цена: ${original.max_price || 'не указана'} → ${relaxed.max_price || 'не указана'}`);
                    }
                    if (relaxed.min_year !== original.min_year) {
                        changes.push(`Год: ${original.min_year || 'не указан'} → ${relaxed.min_year || 'не указан'}`);
                    }
                    if (relaxed.mark !== original.mark) {
                        changes.push(`Марка: ${original.mark || 'не указана'} → ${relaxed.mark || 'не указана'}`);
                    }
                    
                    if (changes.length > 0) {
                        relaxationHtml = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-2 mb-2">
                                <div class="flex items-start gap-2">
                                    <span class="text-yellow-600">⚠️</span>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-yellow-900 mb-1">Фильтры были ослаблены для поиска:</p>
                                        <ul class="text-xs text-yellow-800 list-disc list-inside">
                                            ${changes.map(c => `<li>${c}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Отображение рекомендаций
                if (sourcesData.recommendations && Array.isArray(sourcesData.recommendations) && sourcesData.recommendations.length > 0) {
                    recommendationsHtml = `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-2 mb-2">
                            <div class="flex items-start gap-2">
                                <span class="text-blue-600">💡</span>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-blue-900 mb-2">Рекомендации:</p>
                                    <ul class="text-xs text-blue-800 list-disc list-inside space-y-1">
                                        ${sourcesData.recommendations.map(r => `<li>${r}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Отображение уточняющих вопросов
                if (sourcesData.clarifying_questions && Array.isArray(sourcesData.clarifying_questions) && sourcesData.clarifying_questions.length > 0) {
                    const questions = sourcesData.clarifying_questions.map(q => {
                        if (typeof q === 'string') return q;
                        return q.question || q.text || '';
                    }).filter(q => q && q.trim());
                    
                    if (questions.length > 0) {
                        clarifyingQuestionsHtml = `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3 mb-2">
                                <div class="flex items-start gap-2">
                                    <span class="text-blue-600 text-lg">❓</span>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-blue-900 mb-2">Для уточнения запроса:</p>
                                        <ul class="text-sm text-blue-800 space-y-1.5">
                                            ${questions.slice(0, 3).map(q => {
                                                const safeQ = escapeHtml(q).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                                return `
                                                <li class="cursor-pointer hover:text-blue-900 hover:font-medium transition-all px-2 py-1.5 rounded hover:bg-blue-100 border border-transparent hover:border-blue-300" 
                                                    onclick="askQuestion('${safeQ}')"
                                                    role="button"
                                                    tabindex="0"
                                                    onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();askQuestion('${safeQ}')}">
                                                    ${escapeHtml(q)}
                                                </li>
                                            `;
                                            }).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Отображение проактивных предложений
                if (sourcesData.proactive_suggestions && Array.isArray(sourcesData.proactive_suggestions) && sourcesData.proactive_suggestions.length > 0) {
                    const suggestions = sourcesData.proactive_suggestions.map(s => {
                        if (typeof s === 'string') return { text: s, type: 'general' };
                        return { text: s.text || s.suggestion || '', type: s.type || 'general' };
                    }).filter(s => s.text && s.text.trim());
                    
                    if (suggestions.length > 0) {
                        const suggestionColors = {
                            'finance': 'bg-green-500 hover:bg-green-600 text-white',
                            'test_drive': 'bg-purple-500 hover:bg-purple-600 text-white',
                            'trade_in': 'bg-orange-500 hover:bg-orange-600 text-white',
                            'similar': 'bg-indigo-500 hover:bg-indigo-600 text-white',
                            'related': 'bg-pink-500 hover:bg-pink-600 text-white',
                            'general': 'bg-blue-500 hover:bg-blue-600 text-white'
                        };
                        
                        proactiveSuggestionsHtml = `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mt-3 mb-2">
                                <div class="flex items-start gap-2">
                                    <span class="text-gray-600 text-lg">💡</span>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-900 mb-2">Также могу предложить:</p>
                                        <div class="flex flex-wrap gap-2">
                                            ${suggestions.slice(0, 4).map((s, idx) => {
                                                const safeText = escapeHtml(s.text).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                                return `
                                                <button onclick="handleProactiveSuggestion('${safeText}', '${s.type}')" 
                                                        class="px-3 py-1.5 text-xs rounded-lg transition-all shadow-sm hover:shadow-md ${suggestionColors[s.type] || suggestionColors.general}"
                                                        title="${escapeHtml(s.text)}">
                                                    ${escapeHtml(s.text)}
                                                </button>
                                            `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Отображение финансового калькулятора
                if (sourcesData.finance_calculation || sourcesData.finance_data) {
                    const financeData = sourcesData.finance_calculation || sourcesData.finance_data;
                    if (financeData && (financeData.loan_calculation || financeData.lease_calculation)) {
                        financeCalculatorHtml = `
                            <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mt-3 mb-2">
                                <div class="flex items-start gap-2">
                                    <span class="text-green-600 text-lg">💰</span>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-900 mb-3">Расчет финансирования:</p>
                                        ${financeData.loan_calculation ? `
                                            <div class="mb-3 p-3 bg-white rounded-lg border border-green-200 shadow-sm">
                                                <p class="text-xs font-semibold text-gray-700 mb-2">Кредит:</p>
                                                ${financeData.loan_calculation.monthly_payment ? `
                                                    <p class="text-sm text-gray-800 mb-1">Ежемесячный платеж: <span class="font-bold text-green-700">${formatPrice(financeData.loan_calculation.monthly_payment)} ₽</span></p>
                                                ` : ''}
                                                ${financeData.loan_calculation.total_payment ? `
                                                    <p class="text-xs text-gray-600">Общая сумма: ${formatPrice(financeData.loan_calculation.total_payment)} ₽</p>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                        ${financeData.lease_calculation ? `
                                            <div class="mb-3 p-3 bg-white rounded-lg border border-blue-200 shadow-sm">
                                                <p class="text-xs font-semibold text-gray-700 mb-2">Лизинг:</p>
                                                ${financeData.lease_calculation.monthly_payment ? `
                                                    <p class="text-sm text-gray-800 mb-1">Ежемесячный платеж: <span class="font-bold text-blue-700">${formatPrice(financeData.lease_calculation.monthly_payment)} ₽</span></p>
                                                ` : ''}
                                                ${financeData.lease_calculation.total_payment ? `
                                                    <p class="text-xs text-gray-600">Общая сумма: ${formatPrice(financeData.lease_calculation.total_payment)} ₽</p>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                        <button onclick="showFinanceCalculator()" 
                                                class="mt-2 px-4 py-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors shadow-sm hover:shadow-md">
                                            💰 Рассчитать финансирование
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // Создаем мини-бар источников ПЕРЕД сообщением, если есть sources
            let sourcesBarHtml = '';
            if (sourcesData) {
                const carsCount = sourcesData.cars?.length || 0;
                const articlesCount = sourcesData.articles?.length || 0;
                const documentsCount = sourcesData.documents?.length || 0;
                const totalCount = carsCount + articlesCount + documentsCount;
                
                console.log(`🔍 Проверка sources для мини-бара ${msgId}:`, {
                    carsCount,
                    articlesCount,
                    documentsCount,
                    totalCount
                });
                
                if (totalCount > 0) {
                    // Формируем иконки для автомобилей
                    const carIcons = carsCount > 0 ? 
                        Array.from({ length: Math.min(carsCount, 4) }, () => 
                            '<div class="flex items-center justify-center w-4 h-4"><span class="text-xs">🚗</span></div>'
                        ).join('') : '';
                    
                    // Формируем текст в формате "Найдено: 21 (21 автомобилей)"
                    const carsText = carsCount === 1 ? 'автомобиль' : (carsCount < 5 ? 'автомобиля' : 'автомобилей');
                    const sourcesText = carsCount > 0 ? `(${carsCount} ${carsText})` : '';
                    
                    const barId = `refbar-${msgId}`;
                    sourcesBarHtml = `
                        <div id="${barId}" class="flex items-center gap-2 text-xs text-gray-600 cursor-pointer select-none hover:text-blue-600 transition-colors p-2 rounded-lg hover:bg-blue-50" 
                             role="button" tabindex="0" data-message-id="${msgId}">
                            <div class="flex items-center justify-center w-4 h-4">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M0.300842 6.75896C0.300842 3.2391 3.15501 0.384938 6.67487 0.384938C6.98421 0.384956 7.28876 0.407574 7.58698 0.450368L7.49518 1.09392L7.4024 1.73748C7.16512 1.70342 6.92228 1.68574 6.67487 1.68572C3.87298 1.68572 1.60162 3.95707 1.60162 6.75896C1.60182 9.56068 3.8731 11.8322 6.67487 11.8322C9.0556 11.832 11.0549 10.1909 11.6006 7.97771L12.2315 8.13299L12.8624 8.28924C12.1767 11.0694 9.66758 13.1318 6.67487 13.132C3.15513 13.132 0.301038 10.2787 0.300842 6.75896Z" fill="currentColor"></path>
                                    <path d="M15.6992 14.8074L14.7793 15.7274L11.3974 12.3455L12.3174 11.4256L15.6992 14.8074Z" fill="currentColor"></path>
                                    <path d="M11.3473 6.59701C11.2764 6.81246 10.9716 6.81246 10.9008 6.59701L10.4901 5.34822C10.3035 4.78103 9.85867 4.33617 9.29148 4.14962L8.04269 3.73893C7.82724 3.66807 7.82724 3.36329 8.04269 3.29243L9.29148 2.88173C9.85867 2.69519 10.3035 2.25032 10.4901 1.68314L10.9008 0.434345C10.9716 0.218896 11.2764 0.218896 11.3473 0.434345L11.758 1.68314C11.9445 2.25032 12.3894 2.69519 12.9566 2.88173L14.2054 3.29243C14.4208 3.36329 14.4208 3.66807 14.2054 3.73893L12.9566 4.14962C12.3894 4.33617 11.9445 4.78103 11.758 5.34822L11.3473 6.59701Z" fill="currentColor"></path>
                                </svg>
                            </div>
                            <span class="font-medium">Найдено: ${totalCount} ${sourcesText}</span>
                            <div class="flex items-center gap-1 ml-auto">${carIcons}</div>
                        </div>
                    `;
                    console.log(`✅ Мини-бар источников добавлен для сообщения ${msgId}`);
                } else {
                    console.log(`⚠️ Sources пусты для сообщения ${msgId}, мини-бар не добавлен`);
                }
            } else {
                console.log(`ℹ️ Нет sourcesData для сообщения ${msgId}`);
            }
            
            // Добавляем мини-бар ПЕРЕД сообщением, затем само сообщение
            chat.innerHTML += `
                ${sourcesBarHtml}
                <div id="${msgId}" class="flex justify-start" data-message-id="${msgId}">
                    <div class="max-w-3/4 px-4 py-3 chat-bubble-ai">
                        ${html}
                        ${relaxationHtml}
                        ${recommendationsHtml}
                        ${clarifyingQuestionsHtml}
                        ${proactiveSuggestionsHtml}
                        ${financeCalculatorHtml}
                        <div class="flex justify-end mt-3 gap-2">
                            <button onclick="rateResponse('${msgId}', true)" class="p-1 rounded-full hover:bg-gray-200">
                                <i data-feather="thumbs-up" class="w-4 h-4"></i>
                            </button>
                            <button onclick="rateResponse('${msgId}', false)" class="p-1 rounded-full hover:bg-gray-200">
                                <i data-feather="thumbs-down" class="w-4 h-4"></i>
                            </button>
                        </div>
                        ${modelInfoHtml}
                    </div>
                </div>
            `;
            chat.scrollTop = chat.scrollHeight;
            feather.replace();
            // highlight code
            try { document.querySelectorAll('pre code').forEach(el => window.hljs && hljs.highlightElement(el)); } catch {}
            
            // Добавляем обработчик клика на мини-бар источников, если он есть
            if (sourcesBarHtml) {
                const barEl = document.getElementById(`refbar-${msgId}`);
                if (barEl) {
                    barEl.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log(`🔍 Клик по refbar для сообщения ${msgId}`);
                        showSourcesForMessage(msgId);
                    });
                    barEl.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log(`🔍 Клавиша на refbar для сообщения ${msgId}`);
                            showSourcesForMessage(msgId);
                        }
                    });
                }
            }
        }
        
        // Функция удалена - sources теперь сохраняются напрямую в addAIMessage
        
        // Показать sources для конкретного сообщения
        function showSourcesForMessage(messageId) {
            // Получаем sources для этого конкретного сообщения
            const sourcesData = window[`__sources_${messageId}`] || null;
            
            if (sourcesData) {
                const cars = sourcesData.cars || [];
                const articles = sourcesData.articles || [];
                const documents = sourcesData.documents || [];
                
                if (cars.length > 0 || articles.length > 0 || documents.length > 0) {
                    // НЕ вызываем renderSourcesBar - он создаст новый refbar
                    // Вместо этого напрямую заполняем панель источников
                    const allSources = [];
                    if (articles && articles.length > 0) {
                        allSources.push(...articles.map(art => ({
                            type: 'article',
                            url: art.url || '',
                            title: (art.title || '').slice(0, 80),
                            snippet: (art.text || art.snippet || '').slice(0, 200),
                            id: art.id
                        })));
                    }
                    if (documents && documents.length > 0) {
                        allSources.push(...documents.map(doc => ({
                            type: 'document',
                            title: (doc.title || doc.original_filename || '').slice(0, 80),
                            snippet: (doc.topic || doc.summary || '').slice(0, 200),
                            path: doc.path || '',
                            id: doc.id
                        })));
                    }
                    if (cars && cars.length > 0) {
                        allSources.push(...cars.map(s => ({
                            type: s.type || (s.mileage ? 'used_car' : 'car'),
                            id: s.id,
                            mark: s.mark || '',
                            model: s.model || '',
                            year: s.manufacture_year || s.model_year || '',
                            manufacture_year: s.manufacture_year || s.model_year || '',
                            price: s.price || s.sale_price || '',
                            city: s.city || '',
                            body_type: s.body_type || '',
                            fuel_type: s.fuel_type || '',
                            gear_box_type: s.gear_box_type || '',
                            power: s.power || '',
                            color: s.color || '',
                            mileage: s.mileage || null,
                            vin: s.vin || ''
                        })));
                    }
                    
                    // Сохраняем для панели источников
                    window.__lastSources = allSources;
                    
                    // Показываем панель источников
                    showSourcesPanel();
                    console.log(`📋 Показаны sources для сообщения ${messageId}:`, {
                        cars: cars.length,
                        articles: articles.length,
                        documents: documents.length
                    });
                } else {
                    console.log(`⚠️ Нет sources для сообщения ${messageId}`);
                }
            } else {
                console.log(`⚠️ Sources не найдены для сообщения ${messageId}`);
            }
        }
        
        function generateAIResponse(userMessage) {
            const lang = isEnglish ? 'en' : 'ru';
            if (userMessage.toLowerCase().includes('help') || userMessage.toLowerCase().includes('помощь')) {
                return lang === 'en' ? 
                    "I can help you with various topics. Try asking me about company policies, technical issues, or general information." : 
                    "Я могу помочь с различными вопросами. Спросите меня о политике компании, технических проблемах или общей информации.";
            } else if (userMessage.toLowerCase().includes('time') || userMessage.toLowerCase().includes('время')) {
                return lang === 'en' ? 
                    `The current time is ${new Date().toLocaleTimeString()}.` : 
                    `Текущее время: ${new Date().toLocaleTimeString()}.`;
            } else {
                return lang === 'en' ? 
                    "I understand you're asking about: " + userMessage + ". For more specific information, please provide additional details." : 
                    "Я понял, что вы спрашиваете о: " + userMessage + ". Для более конкретной информации, пожалуйста, уточните детали.";
            }
        }

        // Рендер Markdown/код-блоков: авто Markdown, JSON/код с подсветкой и кнопкой Copy
        function renderRichContent(text) {
            try {
                // если это потенциально markdown, парсим marked
                const md = window.marked ? marked.parse(text) : escapeHtml(text);
                // оборачиваем pre>code для кнопки копирования
                const temp = document.createElement('div');
                temp.innerHTML = md;
                temp.querySelectorAll('pre').forEach(pre => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-button';
                    copyBtn.textContent = 'Copy';
                    copyBtn.onclick = () => {
                        const codeEl = pre.querySelector('code') || pre;
                        navigator.clipboard.writeText(codeEl.innerText || codeEl.textContent || '')
                            .then(()=>{ copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200); });
                    };
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(copyBtn);
                    wrapper.appendChild(pre);
                });
                return temp.innerHTML;
            } catch (e) {
                return `<div>${escapeHtml(text)}</div>`;
            }
        }
        
        async function rateResponse(messageId, isPositive) {
            if (isPositive) {
                try {
                    await fetch(API_BASE + '/api/chat/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify({ message_id: Number(messageId.split('-').pop()), feedback: 1 })
                    });
                } catch {}
            } else {
                const messageDiv = document.getElementById(messageId);
                messageDiv.innerHTML += `
                    <div class="mt-3 p-3 bg-gray-100 rounded-lg">
                        <textarea class="w-full p-2 border border-gray-300 rounded mb-2" placeholder="${isEnglish ? uiTexts.en.feedbackPlaceholder : uiTexts.ru.feedbackPlaceholder}"></textarea>
                        <div class="flex justify-end gap-2">
                            <button onclick="cancelFeedback('${messageId}')" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-200">
                                ${isEnglish ? uiTexts.en.cancelFeedback : uiTexts.ru.cancelFeedback}
                            </button>
                            <button onclick="submitFeedback('${messageId}')" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                ${isEnglish ? uiTexts.en.submitFeedback : uiTexts.ru.submitFeedback}
                            </button>
                        </div>
                    </div>
                `;
                feather.replace();
            }
        }
        
        function cancelFeedback(messageId) {
            const messageDiv = document.getElementById(messageId);
            const bubble = messageDiv.querySelector('.chat-bubble-ai');
            bubble.innerHTML = bubble.innerHTML.split('<div class="mt-3 p-3 bg-gray-100 rounded-lg">')[0];
            feather.replace();
        }
        
        async function submitFeedback(messageId) {
            const messageDiv = document.getElementById(messageId);
            const textarea = messageDiv.querySelector('textarea');
            const feedback = textarea.value.trim();
            
            if (feedback) {
                try {
                    await fetch(API_BASE + '/api/chat/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify({ message_id: Number(messageId.split('-').pop()), feedback: -1, comment: feedback })
                    });
                } catch {}
                alert(isEnglish ? 'Thank you for your feedback!' : 'Спасибо за ваш отзыв!');
            }
            cancelFeedback(messageId);
        }
        
        // Admin panel functions
        function showAdminPanel() {
            if (!isAdmin()) {
                alert(isEnglish ? 'Admin privileges required' : 'Требуются права администратора');
                return;
            }
            document.getElementById('adminPanel').classList.remove('hidden');
            loadArticlesTable();
        }
        
        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }
        
        async function loadArticlesTable() {
            const tbody = document.getElementById('articlesTableBody');
            tbody.innerHTML = '';
            try {
                const all = await fetchAllArticles();
                all.forEach(article => {
                    const row = document.createElement('tr');
                    const cats = (article.categories || []).map(c => c.name);
                    const tags = (article.tags || []).map(t => t.name);
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${article.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${(article.title||'').slice(0,100)}${(article.title||'').length>100?'…':''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cats.join(', ')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-wrap gap-1">
                                ${tags.map(tag => `<span class=\"px-2 py-1 text-xs rounded-full bg-gray-100\">${tag}</span>`).join('')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${article.updated_at || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="editArticle(${article.id})">Edit</button>
                            <button class="text-purple-600 hover:text-purple-900 mr-3" onclick="generateMeta(${article.id})">Generate</button>
                            <button onclick="deleteArticle(${article.id})" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                feather.replace();
            } catch (e) {
                tbody.innerHTML = '<tr><td class="px-6 py-4 text-red-600">Failed to load articles</td></tr>';
            }
            setupAdminStickyHeaderAndScroll();
        }

        async function fetchAllArticles() {
            const headers = { ...authHeader() };
            const pageSize = 200;
            let skip = 0;
            const out = [];
            while (true) {
                const url = `${API_BASE}/api/admin/articles?skip=${skip}&limit=${pageSize}`;
                const res = await fetch(url, { headers });
                if (!res.ok) break;
                const data = await res.json();
                const chunk = data.articles || [];
                out.push(...chunk);
                if (chunk.length < pageSize) break;
                skip += pageSize;
            }
            return out;
        }

        // Закрепленные шапки и снизу — зеркало горизонтального скролла
        function setupAdminStickyHeaderAndScroll(){
            const container = document.getElementById('articlesContainer');
            const table = document.getElementById('articlesTable');
            const adminSection = document.getElementById('adminSection');
            const headerClone = document.getElementById('adminHeaderClone');
            const headerScroller = document.getElementById('adminHeaderScroller');
            const mirror = document.getElementById('adminScrollMirror');
            const spacer = document.getElementById('adminScrollSpacer');
            if (!container || !table || !mirror || !spacer || !headerClone || !headerScroller || !adminSection) return;

            // Показать зеркало только если таблица шире контейнера
            const needsScroll = table.scrollWidth > container.clientWidth;
            mirror.classList.toggle('hidden', !needsScroll);
            spacer.style.width = table.scrollWidth + 'px';

            // Клонируем thead для фиксированной шапки
            const thead = table.querySelector('thead');
            if (thead) {
                const cloneTable = document.createElement('table');
                cloneTable.className = table.className;
                const clonedHead = thead.cloneNode(true);
                cloneTable.appendChild(clonedHead);
                headerScroller.innerHTML = '';
                headerScroller.appendChild(cloneTable);
                // ширина клон-таблицы = ширина оригинала
                cloneTable.style.width = table.scrollWidth + 'px';
                headerScroller.style.width = container.clientWidth + 'px';
            }

            // Синхронизация скроллов
            let syncing = false;
            container.addEventListener('scroll', () => {
                if (syncing) return; syncing = true;
                mirror.scrollLeft = container.scrollLeft; syncing = false;
                // keep sticky header scroller aligned
                if (headerScroller) headerScroller.scrollLeft = container.scrollLeft;
                onScroll();
            });
            mirror.addEventListener('scroll', () => {
                if (syncing) return; syncing = true;
                container.scrollLeft = mirror.scrollLeft; syncing = false;
                if (headerScroller) headerScroller.scrollLeft = mirror.scrollLeft;
            });

            // Отображение/позиционирование фиксированной шапки и зеркала
            function onScroll(){
                if (!container || !adminSection) return;
                const rect = container.getBoundingClientRect();
                const sectionRect = adminSection.getBoundingClientRect();
                const viewportH = window.innerHeight || document.documentElement.clientHeight;

                // Показ только при необходимости
                if (!needsScroll) { mirror.style.display = 'none'; headerClone.style.display = 'none'; return; }

                // Фиксированная шапка: показывать при вертикальной прокрутке контейнера
                const showHeader = container.scrollTop > 0 && container.scrollTop < (container.scrollHeight - container.clientHeight);
                if (showHeader) {
                    headerClone.style.display = 'block';
                    // выравнивание ширин колонок
                    try {
                        const origCells = Array.from((table.querySelector('thead tr') || table.querySelector('tr')).children);
                        const cloneCells = Array.from((headerScroller.querySelector('thead tr') || headerScroller.querySelector('tr')).children);
                        const widths = origCells.map(td => td.getBoundingClientRect().width);
                        cloneCells.forEach((td, i) => { td.style.width = (widths[i] || 0) + 'px'; });
                        // позиция и ширина (привязка к контейнеру с таблицей)
                        headerClone.style.left = sectionRect.left + 'px';
                        headerClone.style.right = (window.innerWidth - sectionRect.right) + 'px';
                        headerClone.style.top = '0px';
                        headerScroller.style.width = container.clientWidth + 'px';
                        const cloneTableEl = headerScroller.querySelector('table');
                        if (cloneTableEl) cloneTableEl.style.width = table.scrollWidth + 'px';
                        if (headerScroller) headerScroller.scrollLeft = container.scrollLeft;
                    } catch {}
                } else {
                    headerClone.style.display = 'none';
                }

                // Когда низ таблицы достиг низа окна, докуем зеркало к низу таблицы (absolute внутри секции)
                const mirrorH = mirror.offsetHeight || 12;
                const shouldDock = rect.bottom <= viewportH;
                if (shouldDock) {
                    mirror.style.position = 'absolute';
                    mirror.style.left = sectionRect.left + 'px';
                    mirror.style.right = (window.innerWidth - sectionRect.right) + 'px';
                    const bottomOffset = Math.max(0, sectionRect.bottom - viewportH);
                    mirror.style.bottom = bottomOffset + 'px';
                    mirror.style.display = 'block';
                } else {
                    // Иначе держим у низа вьюпорта (fixed)
                    mirror.style.position = 'fixed';
                    mirror.style.left = '0px';
                    mirror.style.right = '0px';
                    mirror.style.bottom = '0px';
                    mirror.style.display = (rect.top < viewportH && rect.bottom > 0) ? 'block' : 'none';
                }
            }
            window.addEventListener('scroll', onScroll);
            window.addEventListener('resize', () => { setupAdminStickyHeaderAndScroll(); });
            onScroll();
        }
        
        let currentEditId = null;

        async function loadCategoriesIntoSelect() {
            const select = document.getElementById('articleCategory');
            select.innerHTML = '<option value="">Select a category</option>';
            try {
                const res = await fetch(API_BASE + '/api/admin/categories', { headers: { ...authHeader() } });
                const cats = await res.json();
                cats.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = String(cat.id);
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (e) {
                // fallback пустой список
            }
        }

        async function showCreateArticleModal() {
            currentEditId = null;
            document.getElementById('createArticleModal').classList.remove('hidden');
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleContent').value = '';
            document.getElementById('tagsContainer').innerHTML = '';
            await loadCategoriesIntoSelect();
        }
        
        function hideCreateArticleModal() {
            document.getElementById('createArticleModal').classList.add('hidden');
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleContent').value = '';
            document.getElementById('tagsContainer').innerHTML = '';
            document.getElementById('newTagInput').value = '';
        }
        
        function addTag() {
            const input = document.getElementById('newTagInput');
            const tag = input.value.trim();
            
            if (tag) {
                const container = document.getElementById('tagsContainer');
                container.innerHTML += `
                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 flex items-center gap-1">
                        ${tag}
                        <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <i data-feather="x" class="w-3 h-3"></i>
                        </button>
                    </span>
                `;
                input.value = '';
                feather.replace();
            }
        }
        
        async function saveArticle() {
            const title = document.getElementById('articleTitle').value.trim();
            const categoryId = document.getElementById('articleCategory').value;
            const content = document.getElementById('articleContent').value.trim();
            const tagSpans = Array.from(document.querySelectorAll('#tagsContainer span'));
            const tag_names = tagSpans.map(s => s.firstChild?.textContent?.trim()).filter(Boolean);

            if (!title || !content) {
                alert(isEnglish ? "Please fill required fields" : "Пожалуйста, заполните обязательные поля");
                return;
            }

            const payload = {
                title,
                text: content,
                url: '',
                language: isEnglish ? 'en' : 'ru',
                category_ids: categoryId ? [Number(categoryId)] : [],
                tag_names
            };

            try {
                if (currentEditId) {
                    await fetch(API_BASE + `/api/admin/articles/${currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify(payload)
                    });
                } else {
                    await fetch(API_BASE + '/api/admin/articles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify(payload)
                    });
                }
                hideCreateArticleModal();
                loadArticlesTable();
            } catch (e) {
                alert(isEnglish ? 'Save failed' : 'Ошибка сохранения');
            }
        }
        
        async function editArticle(id) {
            try {
                const res = await fetch(API_BASE + `/api/admin/articles/${id}`, { headers: { ...authHeader() } });
                const article = await res.json();
                currentEditId = id;
                document.getElementById('createArticleModal').classList.remove('hidden');
                document.getElementById('articleTitle').value = article.title || '';
                document.getElementById('articleContent').value = article.text || '';
                document.getElementById('tagsContainer').innerHTML = '';
                (article.tags || []).forEach(t => {
                    const span = document.createElement('span');
                    span.className = 'px-2 py-1 text-xs rounded-full bg-gray-100 flex items-center gap-1';
                    span.innerHTML = `${t.name}<button onclick=\"this.parentElement.remove()\" class=\"text-gray-500 hover:text-gray-700\"><i data-feather=\"x\" class=\"w-3 h-3\"></i></button>`;
                    document.getElementById('tagsContainer').appendChild(span);
                });
                await loadCategoriesIntoSelect();
                const select = document.getElementById('articleCategory');
                const firstCat = (article.categories || [])[0];
                if (firstCat) select.value = String(firstCat.id);
                feather.replace();
            } catch (e) {
                alert(isEnglish ? 'Failed to load article' : 'Ошибка загрузки статьи');
            }
        }
        
        async function deleteArticle(id) {
            if (!confirm(isEnglish ? `Delete article ${id}?` : `Удалить статью ${id}?`)) return;
            try {
                await fetch(API_BASE + `/api/admin/articles/${id}`, { method: 'DELETE', headers: { ...authHeader() } });
                loadArticlesTable();
            } catch (e) {
                alert(isEnglish ? 'Delete failed' : 'Ошибка удаления');
            }
        }
        
        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }
        
        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }
        
        
        async function reindex() {
            try {
                await fetch(API_BASE + '/api/admin/reindex', { method: 'POST', headers: { ...authHeader() } });
                alert(isEnglish ? 'Reindex finished' : 'Переиндексация завершена');
            } catch (e) {
                alert(isEnglish ? 'Reindex failed' : 'Ошибка переиндексации');
            }
        }

        async function generateMeta(id) {
            try {
                const res = await fetch(API_BASE + `/api/admin/articles/${id}/generate_meta`, { method: 'POST', headers: { ...authHeader() } });
                if (!res.ok) throw new Error('failed');
                const data = await res.json();
                alert((isEnglish ? 'Updated: ' : 'Обновлено: ') + `Tags: ${data.tags.join(', ')}; Category: ${(data.categories||[]).join(', ')}`);
                loadArticlesTable();
            } catch (e) {
                alert(isEnglish ? 'Generation failed' : 'Ошибка генерации');
            }
        }

        async function generateMetaSelected() {
            // Генерация для всех статей
            const btn = Array.from(document.querySelectorAll('button')).find(b => b.textContent && b.textContent.includes('Generate Tags & Category'));
            if (btn) { btn.disabled = true; btn.classList.add('opacity-60','cursor-not-allowed'); }
            const ids = Array.from(document.querySelectorAll('#articlesTableBody tr td:first-child')).map(td => Number(td.textContent));
            let processed = 0;
            for (const id of ids) {
                try { await generateMeta(id); } catch {}
                processed++;
                if (btn) btn.textContent = `Generating... ${processed}/${ids.length}`;
            }
            if (btn) { btn.disabled = false; btn.classList.remove('opacity-60','cursor-not-allowed'); btn.textContent = 'Generate Tags & Category'; }
            loadArticlesTable();
        }
        
        // Handle Enter key in message input
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Старая функция loadHistory для sessions (удалена, используется loadHistoryFromSession)

        async function newChat() {
            try {
                const res = await fetch(API_BASE + '/api/chat/new_chat?user_id=web-user', { method: 'POST', headers: { ...authHeader() } });
                const data = await res.json();
                loadHistory(data.session_id);
                const chat = document.getElementById('chatArea');
                if (chat) chat.innerHTML = `
                    <div class="text-center py-8 text-gray-500" id="emptyState">
                        <i data-feather="message-square" class="w-12 h-12 mx_auto text-gray-300"></i>
                        <p class="mt-4">${isEnglish ? uiTexts.en.welcomeMessage : uiTexts.ru.welcomeMessage}</p>
                    </div>
                `;
            } catch {}
        }

        function newChatUI() { newChat(); }

        function renderSessionSelector(sessions, current) {
            const historyContainer = document.getElementById('chatHistory');
            if (!historyContainer) return;
            
            if (sessions.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-feather="message-square" class="w-8 h-8 mx-auto text-gray-300"></i>
                        <p class="mt-2 text-sm">No chat history</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            historyContainer.innerHTML = `
                <div class="space-y-2">
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Recent Chats</div>
                    ${sessions.map(id => {
                        const active = (id === current);
                        return `
                            <button onclick="loadHistory(${id})" class="w-full text-left p-3 rounded-lg border transition-colors ${active ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-gray-200 hover:bg-gray-50'}">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Chat #${id}</span>
                                    ${active ? '<i data-feather="check" class="w-4 h-4 text-blue-600"></i>' : ''}
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            feather.replace();
        }


        // Функции для работы с документами
        function showCarsTab() {
            document.getElementById('metricsSection').classList.add('hidden');
            document.getElementById('modelsSection').classList.add('hidden');
            document.getElementById('carsSection').classList.remove('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('parserSection').classList.add('hidden');
            document.getElementById('voiceSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            
            document.getElementById('carsTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('carsTab').classList.remove('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            document.getElementById('parserTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.add('text-gray-500');
            document.getElementById('voiceTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.add('text-gray-500');
            document.getElementById('importTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('importTab').classList.add('text-gray-500');
            document.getElementById('domainTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('domainTab').classList.add('text-gray-500');
            document.getElementById('metricsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('metricsTab').classList.add('text-gray-500');
            document.getElementById('modelsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('modelsTab').classList.add('text-gray-500');
            
            showCarsTable('new');
        }
        
        function showCarsTable(type) {
            // Скрываем все таблицы
            document.getElementById('newCarsTable').classList.add('hidden');
            document.getElementById('usedCarsTable').classList.add('hidden');
            document.getElementById('optionsTable').classList.add('hidden');
            
            // Сбрасываем стили кнопок
            document.getElementById('newCarsBtn').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('newCarsBtn').classList.add('text-gray-500');
            document.getElementById('usedCarsBtn').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usedCarsBtn').classList.add('text-gray-500');
            document.getElementById('optionsBtn').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('optionsBtn').classList.add('text-gray-500');
            
            // Показываем нужную таблицу
            if (type === 'new') {
                document.getElementById('newCarsTable').classList.remove('hidden');
                document.getElementById('newCarsBtn').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                document.getElementById('newCarsBtn').classList.remove('text-gray-500');
                loadNewCarsTable();
            } else if (type === 'used') {
                document.getElementById('usedCarsTable').classList.remove('hidden');
                document.getElementById('usedCarsBtn').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                document.getElementById('usedCarsBtn').classList.remove('text-gray-500');
                loadUsedCarsTable();
            } else if (type === 'options') {
                document.getElementById('optionsTable').classList.remove('hidden');
                document.getElementById('optionsBtn').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                document.getElementById('optionsBtn').classList.remove('text-gray-500');
                loadOptionsTable();
            }
        }
        
        async function loadNewCarsTable() {
            const tbody = document.getElementById('newCarsTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Загрузка...</td></tr>';
            try {
                const headers = { ...authHeader() };
                const pageSize = 200;
                let skip = 0;
                const out = [];
                while (true) {
                    const url = `${API_BASE}/api/admin/cars?skip=${skip}&limit=${pageSize}`;
                    const res = await fetch(url, { headers });
                    if (!res.ok) break;
                    const data = await res.json();
                    const chunk = data.cars || [];
                    out.push(...chunk);
                    if (chunk.length < pageSize) break;
                    skip += pageSize;
                }
                tbody.innerHTML = '';
                out.forEach(car => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${car.mark || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.model || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.manufacture_year || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.price || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.city || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(car.vin || '').substring(0, 17)}</td>
                    `;
                    tbody.appendChild(row);
                });
                if (out.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Нет данных</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-red-600">Ошибка загрузки</td></tr>';
            }
        }
        
        async function loadUsedCarsTable() {
            const tbody = document.getElementById('usedCarsTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Загрузка...</td></tr>';
            try {
                const headers = { ...authHeader() };
                const pageSize = 200;
                let skip = 0;
                const out = [];
                while (true) {
                    const url = `${API_BASE}/api/admin/cars/used?skip=${skip}&limit=${pageSize}`;
                    const res = await fetch(url, { headers });
                    if (!res.ok) break;
                    const data = await res.json();
                    const chunk = data.used_cars || [];
                    out.push(...chunk);
                    if (chunk.length < pageSize) break;
                    skip += pageSize;
                }
                tbody.innerHTML = '';
                out.forEach(car => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${car.mark || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.model || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.manufacture_year || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.price || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.mileage || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${car.city || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(car.vin || '').substring(0, 17)}</td>
                    `;
                    tbody.appendChild(row);
                });
                if (out.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Нет данных</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-red-600">Ошибка загрузки</td></tr>';
            }
        }
        
        async function loadOptionsTable() {
            const tbody = document.getElementById('optionsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Загрузка...</td></tr>';
            try {
                const headers = { ...authHeader() };
                const pageSize = 200;
                let skip = 0;
                const out = [];
                while (true) {
                    const url = `${API_BASE}/api/admin/cars/options?skip=${skip}&limit=${pageSize}`;
                    const res = await fetch(url, { headers });
                    if (!res.ok) break;
                    const data = await res.json();
                    const chunk = Array.isArray(data) ? data : [];
                    out.push(...chunk);
                    if (chunk.length < pageSize) break;
                    skip += pageSize;
                }
                tbody.innerHTML = '';
                out.forEach(option => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${option.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${option.car_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${option.code || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${(option.description || '').substring(0, 100)}${(option.description || '').length > 100 ? '…' : ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${option.options_group_id || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
                if (out.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Нет данных</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-red-600">Ошибка загрузки</td></tr>';
            }
        }

        function showArticlesTab() {
            document.getElementById('articlesSection').classList.remove('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('parserSection').classList.add('hidden');
            document.getElementById('voiceSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            document.getElementById('articlesTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('articlesTab').classList.remove('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            document.getElementById('parserTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.add('text-gray-500');
            document.getElementById('voiceTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.add('text-gray-500');
        }

        function showDocumentsTab() {
            document.getElementById('carsSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.remove('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('parserSection').classList.add('hidden');
            document.getElementById('voiceSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            document.getElementById('metricsSection').classList.add('hidden');
            document.getElementById('modelsSection').classList.add('hidden');
            document.getElementById('documentsTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.remove('text-gray-500');
            document.getElementById('carsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('carsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            document.getElementById('parserTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.add('text-gray-500');
            document.getElementById('voiceTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.add('text-gray-500');
            document.getElementById('importTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('importTab').classList.add('text-gray-500');
            document.getElementById('domainTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('domainTab').classList.add('text-gray-500');
            document.getElementById('metricsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('metricsTab').classList.add('text-gray-500');
            document.getElementById('modelsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('modelsTab').classList.add('text-gray-500');
            loadDocumentsTable();
        }

        function showAiTab() {
            document.getElementById('carsSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.remove('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('parserSection').classList.add('hidden');
            document.getElementById('voiceSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            document.getElementById('metricsSection').classList.add('hidden');
            document.getElementById('modelsSection').classList.add('hidden');
            document.getElementById('aiTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.remove('text-gray-500');
            document.getElementById('carsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('carsTab').classList.add('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            document.getElementById('parserTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.add('text-gray-500');
            document.getElementById('voiceTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.add('text-gray-500');
            document.getElementById('importTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('importTab').classList.add('text-gray-500');
            document.getElementById('domainTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('domainTab').classList.add('text-gray-500');
            document.getElementById('metricsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('metricsTab').classList.add('text-gray-500');
            document.getElementById('modelsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('modelsTab').classList.add('text-gray-500');
            loadAiSettings();
            loadCurrentModel(); // Загружаем текущую модель при открытии вкладки
            loadSQLAgentStatus(); // Загружаем статус SQL-агента
            loadPreferredProvider(); // Загружаем предпочитаемый провайдер
        }

        function showUsersTab() {
            document.getElementById('carsSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.remove('hidden');
            document.getElementById('parserSection').classList.add('hidden');
            document.getElementById('voiceSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            document.getElementById('metricsSection').classList.add('hidden');
            document.getElementById('modelsSection').classList.add('hidden');
            document.getElementById('usersTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.remove('text-gray-500');
            document.getElementById('carsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('carsTab').classList.add('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('parserTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.add('text-gray-500');
            document.getElementById('voiceTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.add('text-gray-500');
            document.getElementById('importTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('importTab').classList.add('text-gray-500');
            document.getElementById('domainTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('domainTab').classList.add('text-gray-500');
            document.getElementById('metricsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('metricsTab').classList.add('text-gray-500');
            document.getElementById('modelsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('modelsTab').classList.add('text-gray-500');
            loadUsersTable();
        }

        function showParserTab() {
            document.getElementById('carsSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('parserSection').classList.remove('hidden');
            document.getElementById('voiceSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            document.getElementById('metricsSection').classList.add('hidden');
            document.getElementById('modelsSection').classList.add('hidden');
            document.getElementById('parserTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.remove('text-gray-500');
            document.getElementById('carsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('carsTab').classList.add('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            document.getElementById('voiceTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.add('text-gray-500');
            document.getElementById('importTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('importTab').classList.add('text-gray-500');
            document.getElementById('domainTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('domainTab').classList.add('text-gray-500');
            document.getElementById('metricsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('metricsTab').classList.add('text-gray-500');
            document.getElementById('modelsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('modelsTab').classList.add('text-gray-500');
            loadParsedCars();
            refreshParserStatus();
            // Инициализируем UI парсера
            updateParserType();
            if (window.feather) {
                feather.replace();
            }
        }

        function showVoiceTab() {
            document.getElementById('carsSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('parserSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            document.getElementById('metricsSection').classList.add('hidden');
            document.getElementById('modelsSection').classList.add('hidden');
            document.getElementById('voiceSection').classList.remove('hidden');
            document.getElementById('voiceTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.remove('text-gray-500');
            document.getElementById('carsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('carsTab').classList.add('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            document.getElementById('parserTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.add('text-gray-500');
            document.getElementById('importTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('importTab').classList.add('text-gray-500');
            document.getElementById('domainTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('domainTab').classList.add('text-gray-500');
            document.getElementById('metricsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('metricsTab').classList.add('text-gray-500');
            document.getElementById('modelsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('modelsTab').classList.add('text-gray-500');
            loadVoiceSettings();
        }

        function showImportTab() {
            document.getElementById('carsSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('parserSection').classList.add('hidden');
            document.getElementById('voiceSection').classList.add('hidden');
            document.getElementById('domainSection').classList.add('hidden');
            document.getElementById('metricsSection').classList.add('hidden');
            document.getElementById('modelsSection').classList.add('hidden');
            document.getElementById('importSection').classList.remove('hidden');
            document.getElementById('importTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('importTab').classList.remove('text-gray-500');
            document.getElementById('carsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('carsTab').classList.add('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            document.getElementById('parserTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.add('text-gray-500');
            document.getElementById('voiceTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.add('text-gray-500');
            document.getElementById('domainTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('domainTab').classList.add('text-gray-500');
            document.getElementById('metricsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('metricsTab').classList.add('text-gray-500');
            document.getElementById('modelsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('modelsTab').classList.add('text-gray-500');
            loadImportList();
        }

        function showMetricsTab() {
            // Скрываем все секции
            document.querySelectorAll('[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });
            // Скрываем все табы
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                tab.classList.add('text-gray-500');
            });
            // Показываем нужную секцию и таб
            document.getElementById('metricsSection').classList.remove('hidden');
            document.getElementById('metricsTab').classList.remove('text-gray-500');
            document.getElementById('metricsTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            // Загружаем данные
            loadQualityMetrics();
            feather.replace();
        }
        
        function showModelsTab() {
            // Скрываем все секции
            document.querySelectorAll('[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });
            // Скрываем все табы
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                tab.classList.add('text-gray-500');
            });
            // Показываем нужную секцию и таб
            document.getElementById('modelsSection').classList.remove('hidden');
            document.getElementById('modelsTab').classList.remove('text-gray-500');
            document.getElementById('modelsTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            // Загружаем данные
            loadModelsData();
            feather.replace();
        }
        
        function showDomainTab() {
            document.getElementById('carsSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('parserSection').classList.add('hidden');
            document.getElementById('voiceSection').classList.add('hidden');
            document.getElementById('importSection').classList.add('hidden');
            document.getElementById('metricsSection').classList.add('hidden');
            document.getElementById('modelsSection').classList.add('hidden');
            document.getElementById('domainSection').classList.remove('hidden');
            document.getElementById('domainTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('domainTab').classList.remove('text-gray-500');
            document.getElementById('carsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('carsTab').classList.add('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            document.getElementById('parserTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('parserTab').classList.add('text-gray-500');
            document.getElementById('voiceTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('voiceTab').classList.add('text-gray-500');
            document.getElementById('importTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('importTab').classList.add('text-gray-500');
            document.getElementById('metricsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('metricsTab').classList.add('text-gray-500');
            document.getElementById('modelsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('modelsTab').classList.add('text-gray-500');
            loadDomainSettings();
        }

        // Функции для метрик качества
        async function loadQualityMetrics() {
            const content = document.getElementById('metricsContent');
            if (!content) return;
            
            content.innerHTML = '<div class="text-center py-8 text-gray-500"><i data-feather="loader" class="w-8 h-8 mx-auto animate-spin"></i><p class="mt-2">Загрузка метрик...</p></div>';
            feather.replace();
            
            try {
                const response = await fetch(API_BASE + '/api/ai/quality/metrics', {
                    headers: { ...authHeader() }
                });
                
                if (!response.ok) {
                    throw new Error('Ошибка загрузки метрик');
                }
                
                const data = await response.json();
                const summary = data.performance_summary || {};
                
                let html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-blue-600 font-medium">Всего взаимодействий</p>
                                    <p class="text-2xl font-bold text-blue-900">${summary.total_interactions || 0}</p>
                                </div>
                                <i data-feather="message-circle" class="w-8 h-8 text-blue-400"></i>
                            </div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-green-600 font-medium">Среднее время ответа</p>
                                    <p class="text-2xl font-bold text-green-900">${(summary.avg_response_time || 0).toFixed(2)}с</p>
                                </div>
                                <i data-feather="clock" class="w-8 h-8 text-green-400"></i>
                            </div>
                        </div>
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-purple-600 font-medium">Успешность поиска</p>
                                    <p class="text-2xl font-bold text-purple-900">${((summary.search_success_rate || 0) * 100).toFixed(1)}%</p>
                                </div>
                                <i data-feather="search" class="w-8 h-8 text-purple-400"></i>
                            </div>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-orange-600 font-medium">Среднее вопросов</p>
                                    <p class="text-2xl font-bold text-orange-900">${(summary.avg_questions_per_interaction || 0).toFixed(1)}</p>
                                </div>
                                <i data-feather="help-circle" class="w-8 h-8 text-orange-400"></i>
                            </div>
                        </div>
                    </div>
                `;
                
                // Распределение типов связи
                const relationTypes = summary.relation_types_distribution || {};
                if (Object.keys(relationTypes).length > 0) {
                    html += `
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">Распределение типов связи</h4>
                            <div class="space-y-2">
                                ${Object.entries(relationTypes).map(([type, count]) => {
                                    const percentage = summary.total_interactions > 0 
                                        ? ((count / summary.total_interactions) * 100).toFixed(1) 
                                        : 0;
                                    return `
                                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                            <span class="text-sm font-medium text-gray-700">${type}</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                                </div>
                                                <span class="text-sm text-gray-600 w-16 text-right">${count} (${percentage}%)</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                content.innerHTML = html;
                feather.replace();
                
            } catch (error) {
                console.error('Ошибка загрузки метрик:', error);
                content.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i data-feather="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>Ошибка загрузки метрик: ${error.message}</p>
                    </div>
                `;
                feather.replace();
            }
        }
        
        async function clearQualityMetrics() {
            if (!confirm('Вы уверены, что хотите очистить все метрики качества? Это действие нельзя отменить.')) {
                return;
            }
            
            try {
                const response = await fetch(API_BASE + '/api/ai/quality/metrics', {
                    method: 'DELETE',
                    headers: { ...authHeader() }
                });
                
                if (response.ok) {
                    alert('Метрики успешно очищены');
                    loadQualityMetrics();
                } else {
                    const error = await response.json();
                    alert('Ошибка очистки метрик: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка очистки метрик:', error);
                alert('Ошибка очистки метрик: ' + error.message);
            }
        }
        
        // Функции для управления моделями
        async function loadModelsData() {
            const content = document.getElementById('modelsContent');
            if (!content) return;
            
            content.innerHTML = '<div class="text-center py-8 text-gray-500"><i data-feather="loader" class="w-8 h-8 mx-auto animate-spin"></i><p class="mt-2">Загрузка данных моделей...</p></div>';
            feather.replace();
            
            try {
                // Загружаем список моделей
                const modelsResponse = await fetch(API_BASE + '/api/ai/orchestrator/models', {
                    headers: { ...authHeader() }
                });
                
                // Загружаем метрики производительности
                const perfResponse = await fetch(API_BASE + '/api/ai/orchestrator/performance', {
                    headers: { ...authHeader() }
                });
                
                if (!modelsResponse.ok || !perfResponse.ok) {
                    throw new Error('Ошибка загрузки данных моделей');
                }
                
                const modelsData = await modelsResponse.json();
                const perfData = await perfResponse.json();
                
                const availableModels = modelsData.available_models || [];
                const taskMapping = modelsData.task_mapping || {};
                const metrics = perfData.metrics || {};
                
                // Разделяем модели по провайдерам
                const ollamaModels = availableModels.filter(m => m.startsWith('ollama:'));
                const apiModels = availableModels.filter(m => !m.startsWith('ollama:'));
                
                let html = `
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-800">Доступные модели</h4>
                            <div class="flex gap-2">
                                <button onclick="toggleModelProvider('all')" id="providerAll" 
                                        class="px-3 py-1 text-sm rounded-lg bg-blue-500 text-white">
                                    Все
                                </button>
                                <button onclick="toggleModelProvider('ollama')" id="providerOllama" 
                                        class="px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                                    Ollama
                                </button>
                                <button onclick="toggleModelProvider('api')" id="providerApi" 
                                        class="px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                                    API
                                </button>
                            </div>
                        </div>
                        
                        <!-- Ollama модели -->
                        <div id="ollamaModelsSection" class="mb-6">
                            <h5 class="text-md font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <i data-feather="server" class="w-4 h-4"></i>
                                Локальные модели (Ollama)
                            </h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${ollamaModels.map(model => {
                                    const modelKey = typeof model === 'string' ? model : model.name || model;
                                    const modelMetrics = metrics[modelKey] || {};
                                    const totalRequests = modelMetrics.total_requests || 0;
                                    const avgResponseTime = modelMetrics.avg_response_time || 0;
                                    
                                    return `
                                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between mb-2">
                                                <h5 class="font-semibold text-gray-800 text-sm">${modelKey.replace('ollama:', '')}</h5>
                                                <i data-feather="cpu" class="w-5 h-5 text-gray-400"></i>
                                            </div>
                                            <div class="space-y-1 text-xs text-gray-600">
                                                <p>Запросов: <span class="font-medium">${totalRequests}</span></p>
                                                ${avgResponseTime > 0 ? `<p>Среднее время: <span class="font-medium">${avgResponseTime.toFixed(2)}с</span></p>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- API модели -->
                        <div id="apiModelsSection" class="mb-6">
                            <h5 class="text-md font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <i data-feather="cloud" class="w-4 h-4"></i>
                                API модели (Mistral, OpenAI, Anthropic)
                            </h5>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${apiModels.map(model => {
                                    const modelKey = typeof model === 'string' ? model : model.name || model;
                                    const modelMetrics = metrics[modelKey] || {};
                                    const totalRequests = modelMetrics.total_requests || 0;
                                    const avgResponseTime = modelMetrics.avg_response_time || 0;
                                    
                                    const provider = modelKey.split(':')[0];
                                    const providerColors = {
                                        'mistral': 'bg-purple-100 text-purple-800',
                                        'openai': 'bg-green-100 text-green-800',
                                        'anthropic': 'bg-orange-100 text-orange-800',
                                        'deepseek': 'bg-blue-100 text-blue-800'
                                    };
                                    const colorClass = providerColors[provider] || 'bg-gray-100 text-gray-800';
                                    
                                    return `
                                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex-1">
                                                    <h5 class="font-semibold text-gray-800 text-sm">${modelKey.replace(provider + ':', '')}</h5>
                                                    <span class="text-xs px-2 py-0.5 rounded ${colorClass}">${provider.toUpperCase()}</span>
                                                </div>
                                                <i data-feather="cloud" class="w-5 h-5 text-gray-400"></i>
                                            </div>
                                            <div class="space-y-1 text-xs text-gray-600 mt-2">
                                                <p>Запросов: <span class="font-medium">${totalRequests}</span></p>
                                                ${avgResponseTime > 0 ? `<p>Среднее время: <span class="font-medium">${avgResponseTime.toFixed(2)}с</span></p>` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                // Пользовательские задачи (взаимодействие с пользователем)
                const userInteractionTasks = modelsData.user_interaction_tasks || {};
                if (Object.keys(userInteractionTasks).length > 0) {
                    html += `
                        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                            <div class="flex items-center gap-2 mb-4">
                                <i data-feather="user" class="w-5 h-5 text-blue-600"></i>
                                <h4 class="text-lg font-semibold text-gray-800">Задачи взаимодействия с пользователем</h4>
                                <span class="text-xs text-gray-500 bg-blue-50 px-2 py-1 rounded">Приоритет: выбор пользователя</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-blue-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Задача</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Модель</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Провайдер</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${Object.entries(userInteractionTasks).map(([task, taskInfo]) => {
                                            const modelName = taskInfo.model || '';
                                            const taskName = taskInfo.name || task;
                                            const provider = modelName.split(':')[0];
                                            const displayName = modelName.replace(provider + ':', '');
                                            const providerColors = {
                                                'ollama': 'bg-blue-100 text-blue-800',
                                                'mistral': 'bg-purple-100 text-purple-800',
                                                'openai': 'bg-green-100 text-green-800',
                                                'anthropic': 'bg-orange-100 text-orange-800',
                                                'deepseek': 'bg-indigo-100 text-indigo-800'
                                            };
                                            const colorClass = providerColors[provider] || 'bg-gray-100 text-gray-800';
                                            
                                            return `
                                                <tr class="hover:bg-blue-50">
                                                    <td class="px-4 py-3 text-sm text-gray-700">${taskName}</td>
                                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${displayName}</td>
                                                    <td class="px-4 py-3 text-sm">
                                                        <span class="px-2 py-1 rounded text-xs ${colorClass}">${provider.toUpperCase()}</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-sm">
                                                        <button onclick="selectModelForTask('${task}')" 
                                                                class="text-blue-600 hover:text-blue-800 font-medium">
                                                            Изменить
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // Внутренние задачи (обработка данных)
                const internalTasks = modelsData.internal_tasks || {};
                if (Object.keys(internalTasks).length > 0) {
                    html += `
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <div class="flex items-center gap-2 mb-4">
                                <i data-feather="settings" class="w-5 h-5 text-gray-600"></i>
                                <h4 class="text-lg font-semibold text-gray-800">Внутренние задачи обработки</h4>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Задача</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Модель</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Провайдер</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${Object.entries(internalTasks).map(([task, taskInfo]) => {
                                            const modelName = taskInfo.model || '';
                                            const taskName = taskInfo.name || task;
                                            const provider = modelName.split(':')[0];
                                            const displayName = modelName.replace(provider + ':', '');
                                            const providerColors = {
                                                'ollama': 'bg-blue-100 text-blue-800',
                                                'mistral': 'bg-purple-100 text-purple-800',
                                                'openai': 'bg-green-100 text-green-800',
                                                'anthropic': 'bg-orange-100 text-orange-800',
                                                'deepseek': 'bg-indigo-100 text-indigo-800'
                                            };
                                            const colorClass = providerColors[provider] || 'bg-gray-100 text-gray-800';
                                            
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-3 text-sm text-gray-700">${taskName}</td>
                                                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${displayName}</td>
                                                    <td class="px-4 py-3 text-sm">
                                                        <span class="px-2 py-1 rounded text-xs ${colorClass}">${provider.toUpperCase()}</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-sm">
                                                        <button onclick="selectModelForTask('${task}')" 
                                                                class="text-blue-600 hover:text-blue-800">
                                                            Изменить
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // Общая статистика
                html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Общая статистика</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p class="text-sm text-blue-600 font-medium">Всего запросов</p>
                                <p class="text-2xl font-bold text-blue-900">${perfData.total_requests || 0}</p>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <p class="text-sm text-green-600 font-medium">Используемых моделей</p>
                                <p class="text-2xl font-bold text-green-900">${(perfData.models_used || []).length}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
                feather.replace();
                
            } catch (error) {
                console.error('Ошибка загрузки данных моделей:', error);
                content.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i data-feather="alert-circle" class="w-12 h-12 mx-auto mb-2"></i>
                        <p>Ошибка загрузки данных моделей: ${error.message}</p>
                    </div>
                `;
                feather.replace();
            }
        }
        
        async function reloadOrchestratorConfig() {
            try {
                const response = await fetch(API_BASE + '/api/ai/orchestrator/reload-config', {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (response.ok) {
                    alert('Конфигурация оркестратора успешно перезагружена');
                    loadModelsData();
                } else {
                    const error = await response.json();
                    alert('Ошибка перезагрузки конфигурации: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка перезагрузки конфигурации:', error);
                alert('Ошибка перезагрузки конфигурации: ' + error.message);
            }
        }
        
        // Переключение провайдера моделей
        function toggleModelProvider(provider) {
            const ollamaSection = document.getElementById('ollamaModelsSection');
            const apiSection = document.getElementById('apiModelsSection');
            const allBtn = document.getElementById('providerAll');
            const ollamaBtn = document.getElementById('providerOllama');
            const apiBtn = document.getElementById('providerApi');
            
            // Сбрасываем стили всех кнопок
            [allBtn, ollamaBtn, apiBtn].forEach(btn => {
                if (btn) {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
            
            // Показываем/скрываем секции
            if (provider === 'all') {
                if (ollamaSection) ollamaSection.style.display = 'block';
                if (apiSection) apiSection.style.display = 'block';
                if (allBtn) {
                    allBtn.classList.remove('bg-gray-200', 'text-gray-700');
                    allBtn.classList.add('bg-blue-500', 'text-white');
                }
            } else if (provider === 'ollama') {
                if (ollamaSection) ollamaSection.style.display = 'block';
                if (apiSection) apiSection.style.display = 'none';
                if (ollamaBtn) {
                    ollamaBtn.classList.remove('bg-gray-200', 'text-gray-700');
                    ollamaBtn.classList.add('bg-blue-500', 'text-white');
                }
            } else if (provider === 'api') {
                if (ollamaSection) ollamaSection.style.display = 'none';
                if (apiSection) apiSection.style.display = 'block';
                if (apiBtn) {
                    apiBtn.classList.remove('bg-gray-200', 'text-gray-700');
                    apiBtn.classList.add('bg-blue-500', 'text-white');
                }
            }
        }
        
        async function selectModelForTask(taskType) {
            // Загружаем доступные модели
            try {
                const response = await fetch(API_BASE + '/api/ai/orchestrator/models', {
                    headers: { ...authHeader() }
                });
                
                if (!response.ok) {
                    throw new Error('Ошибка загрузки моделей');
                }
                
                const data = await response.json();
                const availableModels = data.available_models || [];
                
                // Разделяем модели по провайдерам
                const ollamaModels = availableModels.filter(m => m.startsWith('ollama:'));
                const apiModels = availableModels.filter(m => !m.startsWith('ollama:'));
                
                // Создаем модальное окно для выбора модели
                const modal = document.createElement('div');
                modal.id = 'selectModelModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Выбор модели для задачи "${taskType}"</h3>
                            <button onclick="closeSelectModelModal()" class="text-gray-500 hover:text-gray-700">
                                <i data-feather="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Провайдер:</label>
                            <select id="modelProviderSelect" onchange="filterModelsByProvider()" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">Все провайдеры</option>
                                <option value="ollama">Ollama (локальные)</option>
                                <option value="api">API (Mistral, OpenAI, Anthropic)</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Модель:</label>
                            <select id="modelSelect" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                ${availableModels.map(m => {
                                    const modelName = typeof m === 'string' ? m : m.name || m;
                                    const provider = modelName.split(':')[0];
                                    const displayName = modelName.replace(provider + ':', '');
                                    return `<option value="${modelName}" data-provider="${provider}">${provider.toUpperCase()}: ${displayName}</option>`;
                                }).join('')}
                            </select>
                        </div>
                        
                        <div class="flex justify-end gap-2">
                            <button onclick="closeSelectModelModal()" 
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                Отмена
                            </button>
                            <button onclick="confirmModelSelection('${taskType}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Выбрать
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                feather.replace();
                
            } catch (error) {
                console.error('Ошибка выбора модели:', error);
                alert('Ошибка выбора модели: ' + error.message);
            }
        }
        
        function filterModelsByProvider() {
            const providerSelect = document.getElementById('modelProviderSelect');
            const modelSelect = document.getElementById('modelSelect');
            const selectedProvider = providerSelect.value;
            
            // Показываем/скрываем опции в зависимости от провайдера
            Array.from(modelSelect.options).forEach(option => {
                if (selectedProvider === 'all') {
                    option.style.display = '';
                } else if (selectedProvider === 'ollama') {
                    option.style.display = option.dataset.provider === 'ollama' ? '' : 'none';
                } else if (selectedProvider === 'api') {
                    option.style.display = option.dataset.provider !== 'ollama' ? '' : 'none';
                }
            });
        }
        
        function closeSelectModelModal() {
            const modal = document.getElementById('selectModelModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function confirmModelSelection(taskType) {
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect.value;
            
            if (!selectedModel) {
                alert('Выберите модель');
                return;
            }
            
            try {
                // Отправляем запрос на выбор модели
                const selectResponse = await fetch(API_BASE + '/api/ai/orchestrator/select', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        task_type: taskType,
                        user_override: selectedModel
                    })
                });
                
                if (selectResponse.ok) {
                    alert(`Модель "${selectedModel}" успешно выбрана для задачи "${taskType}"`);
                    closeSelectModelModal();
                    loadModelsData();
                } else {
                    const error = await selectResponse.json();
                    alert('Ошибка выбора модели: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка выбора модели:', error);
                alert('Ошибка выбора модели: ' + error.message);
            }
        }
        
        async function switchAllToMistral() {
            if (!confirm('Вы уверены, что хотите переключить все задачи на модели Mistral? Это действие заменит текущие модели.')) {
                return;
            }
            
            try {
                // Маппинг задач на модели Mistral
                const mistralModels = {
                    'query_analysis': 'mistral:mistral-small-latest',
                    'fuzzy_interpretation': 'mistral:mistral-medium-latest',
                    'filter_relaxation': 'mistral:mistral-medium-latest',
                    'recommendation': 'mistral:mistral-large-latest',
                    'sql_generation': 'mistral:codestral-latest',
                    'response_generation': 'mistral:mistral-small-latest',
                    'search_intent_analysis': 'mistral:mistral-small-latest',
                    'query_refinement': 'mistral:mistral-medium-latest',
                    'result_processing': 'mistral:mistral-medium-latest',
                    'relation_analysis': 'mistral:mistral-small-latest',
                    'emotion_analysis': 'mistral:mistral-small-latest',
                    'question_generation': 'mistral:mistral-medium-latest',
                    'answer_generation': 'mistral:mistral-small-latest',
                    'proactive_suggestions': 'mistral:mistral-medium-latest'
                };
                
                const response = await fetch(API_BASE + '/api/ai/orchestrator/bulk-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        models: mistralModels
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`✅ Успешно переключено ${result.updated_tasks.length} задач на модели Mistral`);
                        loadModelsData(); // Обновляем данные
                    } else {
                        alert(`⚠️ Частично обновлено: ${result.updated_tasks.length} успешно, ${result.failed_tasks.length} ошибок`);
                        loadModelsData();
                    }
                } else {
                    const error = await response.json();
                    alert('Ошибка переключения моделей: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка переключения моделей:', error);
                alert('Ошибка переключения моделей: ' + error.message);
            }
        }
        
        async function loadDomainSettings() {
            try {
                const response = await fetch(API_BASE + '/api/domain/settings', {
                    headers: authHeader()
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки настроек домена');
                }

                const data = await response.json();
                document.getElementById('domainNameInput').value = data.domain || 'app.domain';
                document.getElementById('currentDomainDisplay').innerHTML = `
                    <span class="font-medium text-gray-800">${data.domain || 'Не настроен'}</span>
                    ${data.nginx_reloaded ? '<span class="ml-2 text-xs text-green-600">(Nginx перезагружен)</span>' : ''}
                `;
            } catch (error) {
                console.error('Ошибка загрузки настроек домена:', error);
                document.getElementById('currentDomainDisplay').innerHTML = 
                    '<span class="text-red-600">Ошибка загрузки</span>';
            }
        }

        async function saveDomainSettings() {
            const domainName = document.getElementById('domainNameInput').value.trim();
            
            if (!domainName) {
                showDomainMessage('Введите доменное имя', 'error');
                return;
            }

            // Валидация доменного имени
            const domainRegex = /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/;
            if (!domainRegex.test(domainName) && domainName !== 'localhost') {
                showDomainMessage('Некорректный формат доменного имени', 'error');
                return;
            }

            try {
                showDomainMessage('Сохранение домена...', 'info');
                
                const response = await fetch(API_BASE + '/api/domain/settings', {
                    method: 'POST',
                    headers: {
                        ...authHeader(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain: domainName })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка сохранения домена');
                }

                const result = await response.json();
                showDomainMessage(`Домен "${domainName}" успешно сохранен и применен!`, 'success');
                loadDomainSettings();
                
                // Обновляем иконки
                if (window.feather) {
                    feather.replace();
                }
            } catch (error) {
                console.error('Ошибка сохранения домена:', error);
                showDomainMessage('Ошибка сохранения: ' + error.message, 'error');
            }
        }

        async function testDomainConnection() {
            const domainName = document.getElementById('domainNameInput').value.trim() || 
                             document.getElementById('currentDomainDisplay').textContent.trim();
            
            if (!domainName || domainName === 'Не настроен') {
                showDomainMessage('Введите доменное имя для проверки', 'error');
                return;
            }

            try {
                showDomainMessage('Проверка подключения...', 'info');
                
                const response = await fetch(API_BASE + '/api/domain/test', {
                    method: 'POST',
                    headers: {
                        ...authHeader(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain: domainName })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка проверки');
                }

                const result = await response.json();
                if (result.accessible) {
                    // Для тестовых доменов показываем информационное сообщение
                    if (result.message && result.message.includes('тестовый домен')) {
                        showDomainMessage(`Домен "${domainName}": ${result.message}`, 'info');
                    } else {
                        showDomainMessage(`Домен "${domainName}" доступен! ${result.message || ''}`, 'success');
                    }
                } else {
                    // Для тестовых доменов показываем предупреждение вместо ошибки
                    const isTestDomain = ['localhost', 'app.domain', 'test.domain'].some(d => domainName.toLowerCase().includes(d.toLowerCase()));
                    if (isTestDomain) {
                        showDomainMessage(`Домен "${domainName}": ${result.message || 'Тестовый домен, DNS не требуется для локального использования'}`, 'info');
                    } else {
                        showDomainMessage(`Домен "${domainName}" недоступен: ${result.message}`, 'error');
                    }
                }
            } catch (error) {
                console.error('Ошибка проверки домена:', error);
                showDomainMessage('Ошибка проверки: ' + error.message, 'error');
            }
        }

        async function reloadNginx() {
            try {
                showDomainMessage('Перезагрузка Nginx...', 'info');
                
                const response = await fetch(API_BASE + '/api/domain/reload-nginx', {
                    method: 'POST',
                    headers: authHeader()
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка перезагрузки Nginx');
                }

                const result = await response.json();
                showDomainMessage('Nginx успешно перезагружен!', 'success');
                loadDomainSettings();
            } catch (error) {
                console.error('Ошибка перезагрузки Nginx:', error);
                showDomainMessage('Ошибка перезагрузки: ' + error.message, 'error');
            }
        }

        function showDomainMessage(message, type) {
            const messageDiv = document.getElementById('domainStatusMessage');
            messageDiv.classList.remove('hidden');
            
            const colors = {
                'success': 'bg-green-50 border-green-200 text-green-800',
                'error': 'bg-red-50 border-red-200 text-red-800',
                'info': 'bg-blue-50 border-blue-200 text-blue-800'
            };
            
            messageDiv.className = `mt-4 p-4 rounded-lg border ${colors[type] || colors.info}`;
            messageDiv.textContent = message;
            
            // Автоматически скрыть через 5 секунд
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        // Функции для работы с пользователями
        async function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            try {
                const res = await fetch(API_BASE + '/api/auth/users', { 
                    headers: { ...authHeader() } 
                });
                
                if (!res.ok) {
                    throw new Error('Failed to load users');
                }
                
                const users = await res.json();
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    const statusColor = user.is_active ? 'text-green-600' : 'text-red-600';
                    const statusText = user.is_active ? 'Активен' : 'Неактивен';
                    const roleColor = user.role === 'admin' ? 'text-red-600' : 'text-blue-600';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.full_name || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${roleColor} font-medium">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${statusText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-900 mr-3">Изменить</button>
                            ${user.id !== currentUser?.id ? `<button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900">Удалить</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (e) {
                console.error('Ошибка загрузки пользователей:', e);
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Ошибка загрузки пользователей</td></tr>';
            }
        }

        function showCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
            document.getElementById('userEmail').value = '';
            document.getElementById('userFullName').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'user';
        }

        function hideCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
        }

        async function createUser() {
            const email = document.getElementById('userEmail').value;
            const fullName = document.getElementById('userFullName').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            
            if (!email || !password) {
                alert('Пожалуйста, заполните email и пароль');
                return;
            }
            
            if (password.length < 6) {
                alert('Пароль должен содержать минимум 6 символов');
                return;
            }
            
            try {
                const userData = {
                    email: email,
                    full_name: fullName,
                    password: password,
                    role: role
                };
                
                const res = await fetch(API_BASE + '/api/auth/users', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        ...authHeader() 
                    },
                    body: JSON.stringify(userData)
                });
                
                if (res.ok) {
                    alert('Пользователь успешно создан');
                    hideCreateUserModal();
                    loadUsersTable();
                } else {
                    const error = await res.json();
                    alert(`Ошибка создания пользователя: ${error.detail}`);
                }
                
            } catch (e) {
                console.error('Ошибка создания пользователя:', e);
                alert('Ошибка создания пользователя');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                return;
            }
            
            try {
                const res = await fetch(API_BASE + `/api/auth/users/${userId}`, {
                    method: 'DELETE',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    alert('Пользователь успешно удален');
                    loadUsersTable();
                } else {
                    const error = await res.json();
                    alert(`Ошибка удаления пользователя: ${error.detail}`);
                }
                
            } catch (e) {
                console.error('Ошибка удаления пользователя:', e);
                alert('Ошибка удаления пользователя');
            }
        }

        function editUser(userId) {
            // Пока простое сообщение, можно расширить до полноценного редактирования
            alert('Функция редактирования пользователя будет добавлена в следующей версии');
        }

        function showUploadDocumentModal() {
            document.getElementById('uploadDocumentModal').classList.remove('hidden');
            document.getElementById('documentFile').value = '';
            document.getElementById('documentTagsContainer').innerHTML = '';
            loadCategoriesIntoDocumentSelect();
        }

        function hideUploadDocumentModal() {
            document.getElementById('uploadDocumentModal').classList.add('hidden');
            document.getElementById('documentFile').value = '';
            document.getElementById('documentPath').value = '';
            document.getElementById('documentTagsContainer').innerHTML = '';
        }

        async function loadDocumentsTable() {
            const tbody = document.getElementById('documentsTableBody');
            tbody.innerHTML = '';
            try {
                const res = await fetch(API_BASE + '/api/documents/', { headers: { ...authHeader() } });
                const data = await res.json();
                data.documents.forEach(doc => {
                    const row = document.createElement('tr');
                    const tags = (doc.tags || []).map(t => t.name);
                    const statusColor = {
                        'completed': 'text-green-600',
                        'processing': 'text-yellow-600',
                        'failed': 'text-red-600',
                        'pending': 'text-gray-600'
                    }[doc.processing_status] || 'text-gray-600';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="document-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="${doc.id}" onchange="updateSelectAllCheckbox()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${doc.original_filename}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.topic || 'Не определена'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.path || 'Не указан'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${doc.processing_status}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-wrap gap-1">
                                ${tags.map(tag => `<span class="px-2 py-1 text-xs rounded-full bg-gray-100">${tag}</span>`).join('')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(doc.uploaded_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewDocument(${doc.id})">Просмотр</button>
                            <button class="text-yellow-600 hover:text-yellow-900 mr-3" onclick="editDocument(${doc.id})">Редактировать</button>
                            <button class="text-green-600 hover:text-green-900 mr-3" onclick="processDocument(${doc.id})">Обработать</button>
                            <button class="text-cyan-600 hover:text-cyan-900 mr-3" onclick="viewChunks(${doc.id})">Чанки</button>
                            <button class="text-orange-600 hover:text-orange-900 mr-3" onclick="generateCategories(${doc.id})">Категории</button>
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="generateTags(${doc.id})">Теги</button>
                            <button class="text-teal-600 hover:text-teal-900 mr-3" onclick="generateAllMeta(${doc.id})">Все метаданные</button>
                            <button class="text-purple-600 hover:text-purple-900 mr-3" onclick="downloadDocument(${doc.id})">Скачать</button>
                            <button onclick="deleteDocument(${doc.id})" class="text-red-600 hover:text-red-900">Удалить</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                feather.replace();
            } catch (e) {
                tbody.innerHTML = '<tr><td class="px-6 py-4 text-red-600">Ошибка загрузки документов</td></tr>';
            }
        }

        async function loadCategoriesIntoDocumentSelect() {
            const select = document.getElementById('documentCategory');
            select.innerHTML = '<option value="">Выберите категорию</option>';
            try {
                const res = await fetch(API_BASE + '/api/admin/categories', { headers: { ...authHeader() } });
                const cats = await res.json();
                cats.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = String(cat.id);
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Ошибка загрузки категорий:', e);
            }
        }

        function addDocumentTag() {
            const input = document.getElementById('newDocumentTagInput');
            const tag = input.value.trim();
            
            if (tag) {
                const container = document.getElementById('documentTagsContainer');
                container.innerHTML += `
                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 flex items-center gap-1">
                        ${tag}
                        <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <i data-feather="x" class="w-3 h-3"></i>
                        </button>
                    </span>
                `;
                input.value = '';
                feather.replace();
            }
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('documentFile');
            const language = document.getElementById('documentLanguage').value;
            const path = document.getElementById('documentPath').value;
            const categoryId = document.getElementById('documentCategory').value;
            const tagSpans = Array.from(document.querySelectorAll('#documentTagsContainer span'));
            const tagNames = tagSpans.map(s => s.firstChild?.textContent?.trim()).filter(Boolean);

            if (!fileInput.files.length) {
                alert('Пожалуйста, выберите файл');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('language', language);
            if (path) {
                formData.append('path', path);
            }
            formData.append('category_ids', JSON.stringify(categoryId ? [Number(categoryId)] : []));
            formData.append('tag_names', JSON.stringify(tagNames));

            try {
                console.log('Отправка запроса на загрузку документа...');
                const res = await fetch(API_BASE + '/api/documents/upload', {
                    method: 'POST',
                    headers: { ...authHeader() },
                    body: formData
                });
                
                console.log('Ответ сервера:', res.status, res.statusText);
                
                if (res.ok) {
                    const data = await res.json();
                    console.log('Данные ответа:', data);
                    alert(`Документ загружен! ID: ${data.document_id}, Статус: ${data.processing_status}`);
                    hideUploadDocumentModal();
                    loadDocumentsTable();
                } else {
                    const error = await res.json();
                    console.error('Ошибка сервера:', error);
                    alert(`Ошибка загрузки: ${error.detail}`);
                }
            } catch (e) {
                console.error('Ошибка при загрузке документа:', e);
                alert('Ошибка при загрузке документа');
            }
        }

        async function viewDocument(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/text`, { headers: { ...authHeader() } });
                const data = await res.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-8 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Просмотр документа</h3>
                            <button onclick="this.closest('.fixed').remove()" class="p-2 rounded-full hover:bg-gray-100">
                                <i data-feather="x"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div><strong>Заголовок:</strong> ${data.title || 'Не указан'}</div>
                            <div><strong>Тема:</strong> ${data.topic || 'Не определена'}</div>
                            ${data.path ? `<div><strong>Путь:</strong> <span class="text-blue-600">${data.path}</span></div>` : ''}
                            <div><strong>Статус:</strong> ${data.processing_status}</div>
                            <div><strong>Краткое содержание:</strong></div>
                            <div class="p-3 bg-gray-100 rounded">${data.summary || 'Не создано'}</div>
                            <div><strong>Полный текст:</strong></div>
                            <div class="p-3 bg-gray-50 rounded max-h-96 overflow-y-auto">${data.extracted_text || 'Не извлечен'}</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                feather.replace();
            } catch (e) {
                alert('Ошибка при загрузке документа');
            }
        }

        async function processDocument(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/process`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    alert('Обработка документа запущена');
                    loadDocumentsTable();
                } else {
                    alert('Ошибка при запуске обработки');
                }
            } catch (e) {
                alert('Ошибка при обработке документа');
            }
        }

        async function generateCategories(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/generate-categories`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        alert(`✅ ${data.message}`);
                        loadDocumentsTable();
                    } else {
                        alert(`❌ ${data.message}`);
                    }
                } else {
                    alert('Ошибка при генерации категорий');
                }
            } catch (e) {
                alert('Ошибка при генерации категорий');
            }
        }

        async function generateTags(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/generate-tags`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        alert(`✅ ${data.message}`);
                        loadDocumentsTable();
                    } else {
                        alert(`❌ ${data.message}`);
                    }
                } else {
                    alert('Ошибка при генерации тегов');
                }
            } catch (e) {
                alert('Ошибка при генерации тегов');
            }
        }

        async function generateAllMeta(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/generate-meta`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        alert(`✅ ${data.message}`);
                        loadDocumentsTable();
                    } else {
                        alert(`❌ ${data.message}`);
                    }
                } else {
                    alert('Ошибка при генерации метаданных');
                }
            } catch (e) {
                alert('Ошибка при генерации метаданных');
            }
        }

        async function downloadDocument(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/download`, { headers: { ...authHeader() } });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `document_${id}`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Ошибка при скачивании документа');
                }
            } catch (e) {
                alert('Ошибка при скачивании документа');
            }
        }

        async function deleteDocument(id) {
            if (!confirm(`Удалить документ ${id}?`)) return;
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}`, {
                    method: 'DELETE',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    alert('Документ удален');
                    loadDocumentsTable();
                } else {
                    alert('Ошибка при удалении документа');
                }
            } catch (e) {
                alert('Ошибка при удалении документа');
            }
        }

        async function processAllDocuments() {
            if (!confirm('Обработать все документы? Это может занять некоторое время.')) return;
            
            try {
                // Получаем все документы
                const res = await fetch(API_BASE + '/api/documents/', { headers: { ...authHeader() } });
                const data = await res.json();
                const documentIds = data.documents.map(d => d.id);
                
                if (documentIds.length === 0) {
                    alert('Нет документов для обработки');
                    return;
                }
                
                // Запускаем пакетную обработку
                const batchRes = await fetch(API_BASE + '/api/documents/batch-process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    body: JSON.stringify(documentIds)
                });
                
                if (batchRes.ok) {
                    const result = await batchRes.json();
                    alert(`Обработка завершена. Результаты: ${result.results.length} документов`);
                    loadDocumentsTable();
                } else {
                    alert('Ошибка при пакетной обработке');
                }
            } catch (e) {
                alert('Ошибка при пакетной обработке документов');
            }
        }

        // Функции для работы с чекбоксами и массовыми операциями
        function toggleAllDocuments() {
            const selectAll = document.getElementById('selectAllDocuments');
            const checkboxes = document.querySelectorAll('.document-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('selectAllDocuments');
            const checkboxes = document.querySelectorAll('.document-checkbox');
            const checkedCount = document.querySelectorAll('.document-checkbox:checked').length;
            
            if (checkedCount === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        function getSelectedDocumentIds() {
            const checkboxes = document.querySelectorAll('.document-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        async function generateCategoriesForSelected() {
            const selectedIds = getSelectedDocumentIds();
            if (selectedIds.length === 0) {
                alert('Выберите документы для генерации категорий');
                return;
            }

            try {
                let successCount = 0;
                for (const id of selectedIds) {
                    const res = await fetch(API_BASE + `/api/documents/${id}/generate-categories`, {
                        method: 'POST',
                        headers: { ...authHeader() }
                    });
                    if (res.ok) {
                        successCount++;
                    }
                }
                alert(`✅ Категории сгенерированы для ${successCount} из ${selectedIds.length} документов`);
                loadDocumentsTable();
            } catch (e) {
                alert('Ошибка при генерации категорий');
            }
        }

        async function generateTagsForSelected() {
            const selectedIds = getSelectedDocumentIds();
            if (selectedIds.length === 0) {
                alert('Выберите документы для генерации тегов');
                return;
            }

            try {
                let successCount = 0;
                for (const id of selectedIds) {
                    const res = await fetch(API_BASE + `/api/documents/${id}/generate-tags`, {
                        method: 'POST',
                        headers: { ...authHeader() }
                    });
                    if (res.ok) {
                        successCount++;
                    }
                }
                alert(`✅ Теги сгенерированы для ${successCount} из ${selectedIds.length} документов`);
                loadDocumentsTable();
            } catch (e) {
                alert('Ошибка при генерации тегов');
            }
        }

        async function generateAllMetaForSelected() {
            const selectedIds = getSelectedDocumentIds();
            if (selectedIds.length === 0) {
                alert('Выберите документы для генерации метаданных');
                return;
            }

            try {
                let successCount = 0;
                for (const id of selectedIds) {
                    const res = await fetch(API_BASE + `/api/documents/${id}/generate-meta`, {
                        method: 'POST',
                        headers: { ...authHeader() }
                    });
                    if (res.ok) {
                        successCount++;
                    }
                }
                alert(`✅ Метаданные сгенерированы для ${successCount} из ${selectedIds.length} документов`);
                loadDocumentsTable();
            } catch (e) {
                alert('Ошибка при генерации метаданных');
            }
        }

        async function deleteSelectedDocuments() {
            const selectedIds = getSelectedDocumentIds();
            if (selectedIds.length === 0) {
                alert('Выберите документы для удаления');
                return;
            }

            if (!confirm(`Вы уверены, что хотите удалить ${selectedIds.length} документов?`)) {
                return;
            }

            try {
                let successCount = 0;
                for (const id of selectedIds) {
                    const res = await fetch(API_BASE + `/api/documents/${id}`, {
                        method: 'DELETE',
                        headers: { ...authHeader() }
                    });
                    if (res.ok) {
                        successCount++;
                    }
                }
                alert(`✅ Удалено ${successCount} из ${selectedIds.length} документов`);
                loadDocumentsTable();
            } catch (e) {
                alert('Ошибка при удалении документов');
            }
        }

        async function viewChunks(documentId) {
            try {
                const res = await fetch(API_BASE + `/api/chunks/document/${documentId}`, {
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showChunksModal(data.chunks, documentId);
                } else {
                    alert('Ошибка при загрузке чанков');
                }
            } catch (e) {
                alert('Ошибка при загрузке чанков');
            }
        }

        function showChunksModal(chunks, documentId) {
            const modal = document.getElementById('chunksModal');
            const chunksList = document.getElementById('chunksList');
            
            chunksList.innerHTML = '';
            
            chunks.forEach((chunk, index) => {
                const chunkDiv = document.createElement('div');
                chunkDiv.className = 'border rounded-lg p-4 mb-4 bg-gray-50';
                chunkDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-800">Чанк ${chunk.chunk_index + 1}</h4>
                        <span class="text-sm text-gray-500">${chunk.text.length} символов</span>
                    </div>
                    <div class="text-sm text-gray-700 mb-2">
                        ${chunk.text.substring(0, 200)}${chunk.text.length > 200 ? '...' : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="viewFullChunk(${chunk.id})" class="text-blue-600 hover:text-blue-900 text-sm">Полный текст</button>
                        ${chunk.embedding ? '<span class="text-green-600 text-sm">✓ Эмбеддинг</span>' : '<span class="text-red-600 text-sm">✗ Нет эмбеддинга</span>'}
                    </div>
                `;
                chunksList.appendChild(chunkDiv);
            });
            
            modal.classList.remove('hidden');
        }

        function hideChunksModal() {
            document.getElementById('chunksModal').classList.add('hidden');
        }

        async function viewFullChunk(chunkId) {
            // Здесь можно добавить функцию для просмотра полного текста чанка
            alert('Функция просмотра полного текста чанка будет добавлена');
        }

        let currentEditingDocumentId = null;

        async function editDocument(documentId) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${documentId}`, {
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const doc = await res.json();
                    currentEditingDocumentId = documentId;
                    
                    // Заполняем форму данными документа
                    document.getElementById('editDocumentTitle').value = doc.title || '';
                    document.getElementById('editDocumentTopic').value = doc.topic || '';
                    document.getElementById('editDocumentPath').value = doc.path || '';
                    document.getElementById('editDocumentSummary').value = doc.summary || '';
                    
                    // Показываем модальное окно
                    document.getElementById('editDocumentModal').classList.remove('hidden');
                } else {
                    alert('Ошибка при загрузке документа');
                }
            } catch (e) {
                alert('Ошибка при загрузке документа');
            }
        }

        function hideEditDocumentModal() {
            document.getElementById('editDocumentModal').classList.add('hidden');
            currentEditingDocumentId = null;
        }

        async function saveDocumentChanges() {
            if (!currentEditingDocumentId) {
                alert('Ошибка: не выбран документ для редактирования');
                return;
            }

            const title = document.getElementById('editDocumentTitle').value;
            const topic = document.getElementById('editDocumentTopic').value;
            const path = document.getElementById('editDocumentPath').value;
            const summary = document.getElementById('editDocumentSummary').value;

            try {
                const res = await fetch(API_BASE + `/api/documents/${currentEditingDocumentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        title: title,
                        topic: topic,
                        path: path,
                        summary: summary
                    })
                });

                if (res.ok) {
                    alert('✅ Документ успешно обновлен!');
                    hideEditDocumentModal();
                    loadDocumentsTable();
                } else {
                    const error = await res.json();
                    alert(`Ошибка при сохранении: ${error.detail}`);
                }
            } catch (e) {
                alert('Ошибка при сохранении документа');
            }
        }

        // Переменные для импорта
        let importData = null;
        let importPreview = null;

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            showImportStep1();
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            importData = null;
            importPreview = null;
        }

        function showImportStep1() {
            document.getElementById('importStep1').classList.remove('hidden');
            document.getElementById('importStep2').classList.add('hidden');
            document.getElementById('importStep3').classList.add('hidden');
        }

        function showImportStep2() {
            document.getElementById('importStep1').classList.add('hidden');
            document.getElementById('importStep2').classList.remove('hidden');
            document.getElementById('importStep3').classList.add('hidden');
        }

        function showImportStep3() {
            document.getElementById('importStep1').classList.add('hidden');
            document.getElementById('importStep2').classList.add('hidden');
            document.getElementById('importStep3').classList.remove('hidden');
        }

        async function analyzeImportFile() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                alert('Пожалуйста, выберите JSON файл');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const res = await fetch(API_BASE + '/api/import/analyze', {
                    method: 'POST',
                    headers: { ...authHeader() },
                    body: formData
                });

                if (res.ok) {
                    importPreview = await res.json();
                    displayFieldMappings();
                    showImportStep2();
                } else {
                    const error = await res.json();
                    alert(`Ошибка при анализе файла: ${error.detail}`);
                }
            } catch (e) {
                alert('Ошибка при анализе файла');
            }
        }

        function displayFieldMappings() {
            if (!importPreview) return;

            document.getElementById('importRecordCount').textContent = importPreview.total_records;
            
            const container = document.getElementById('fieldMappingContainer');
            container.innerHTML = '';

            // Обязательные поля
            const requiredFields = ['title', 'text', 'url'];
            
            requiredFields.forEach(field => {
                const mapping = importPreview.field_mappings.find(m => m.db_field === field);
                const div = document.createElement('div');
                div.className = 'space-y-2';
                
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">
                        ${field === 'title' ? 'Заголовок' : field === 'text' ? 'Текст' : 'URL'} 
                        ${requiredFields.includes(field) ? '*' : ''}
                    </label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                            data-db-field="${field}">
                        <option value="">-- Не сопоставлять --</option>
                        ${importPreview.available_fields.map(f => 
                            `<option value="${f}" ${mapping && mapping.json_field === f ? 'selected' : ''}>${f}</option>`
                        ).join('')}
                    </select>
                `;
                
                container.appendChild(div);
            });

            // Дополнительные поля
            const additionalFields = ['language'];
            additionalFields.forEach(field => {
                const mapping = importPreview.field_mappings.find(m => m.db_field === field);
                const div = document.createElement('div');
                div.className = 'space-y-2';
                
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">Язык</label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                            data-db-field="${field}">
                        <option value="">-- Не сопоставлять (будет использован русский) --</option>
                        ${importPreview.available_fields.map(f => 
                            `<option value="${f}" ${mapping && mapping.json_field === f ? 'selected' : ''}>${f}</option>`
                        ).join('')}
                    </select>
                `;
                
                container.appendChild(div);
            });
        }

        async function startImport() {
            if (!importPreview) return;

            // Собираем сопоставления полей
            const fieldMappings = [];
            const selects = document.querySelectorAll('#fieldMappingContainer select[data-db-field]');
            
            selects.forEach(select => {
                const dbField = select.getAttribute('data-db-field');
                const jsonField = select.value;
                
                if (jsonField) {
                    fieldMappings.push({
                        json_field: jsonField,
                        db_field: dbField,
                        required: ['title', 'text', 'url'].includes(dbField)
                    });
                }
            });

            // Проверяем обязательные поля
            const requiredFields = ['title', 'text'];
            const mappedFields = fieldMappings.map(m => m.db_field);
            
            for (const field of requiredFields) {
                if (!mappedFields.includes(field)) {
                    alert(`Обязательное поле "${field}" должно быть сопоставлено`);
                    return;
                }
            }

            try {
                const res = await fetch(API_BASE + '/api/import/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        json_data: importPreview.records || importPreview.sample_records, // Используем все записи или примеры, если все записи недоступны
                        field_mappings: fieldMappings,
                        default_language: 'ru'
                    })
                });

                if (res.ok) {
                    const result = await res.json();
                    displayImportResults(result);
                    showImportStep3();
                } else {
                    const error = await res.json();
                    alert(`Ошибка при импорте: ${error.detail}`);
                }
            } catch (e) {
                alert('Ошибка при импорте');
            }
        }

        function displayImportResults(result) {
            const container = document.getElementById('importResults');
            
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center gap-4">
                        <div class="text-green-600">
                            <i data-feather="check-circle" class="w-6 h-6"></i>
                        </div>
                        <span class="text-lg font-semibold">Успешно импортировано: ${result.success_count}</span>
                    </div>
                    
                    ${result.error_count > 0 ? `
                        <div class="flex items-center gap-4">
                            <div class="text-red-600">
                                <i data-feather="x-circle" class="w-6 h-6"></i>
                            </div>
                            <span class="text-lg font-semibold">Ошибок: ${result.error_count}</span>
                        </div>
                        
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-2">Ошибки:</h4>
                            <ul class="text-sm text-red-700 space-y-1">
                                ${result.errors.map(error => `<li>• ${error}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-blue-800">
                            Импортированные ID: ${result.imported_ids.join(', ')}
                        </p>
                    </div>
                </div>
            `;
            
            feather.replace();
        }

        // Initialize
        updateUILanguage();
        loadHistory();
        
        // Функция для восстановления мини-бара источников
        function restoreSourcesBar() {
            console.log('Attempting to restore sources bar...');
            try {
                // Проверяем, не существует ли уже мини-бар
                const chat = document.getElementById('chatArea');
                if (!chat) {
                    console.log('Chat area not found');
                    return;
                }
                
                const existingBar = chat.querySelector('[id^="refbar-"]');
                if (existingBar) {
                    console.log('Sources bar already exists, skipping restoration');
                    return;
                }
                
                // Проверяем, есть ли реальные сообщения в чате (не только приветствие)
                const messages = chat.querySelectorAll('.message');
                const userMessages = chat.querySelectorAll('.message.user');
                const aiMessages = chat.querySelectorAll('.message.ai');
                
                // Если есть только приветственное сообщение AI, не восстанавливаем мини-бар
                if (messages.length <= 1 && aiMessages.length === 1) {
                    console.log('Only welcome message found, clearing localStorage and skipping restoration');
                    // Очищаем localStorage если в чате только приветствие
                    localStorage.removeItem('lastSources');
                    localStorage.removeItem('lastSourcesCount');
                    localStorage.removeItem('lastSourcesIcons');
                    return;
                }
                
                // Если нет пользовательских сообщений, не восстанавливаем мини-бар
                if (userMessages.length === 0) {
                    console.log('No user messages found, skipping restoration');
                    return;
                }
                
                const lastSources = localStorage.getItem('lastSources');
                const lastSourcesCount = localStorage.getItem('lastSourcesCount');
                const lastSourcesIcons = localStorage.getItem('lastSourcesIcons');
                
                console.log('localStorage data:', { lastSources, lastSourcesCount, lastSourcesIcons });
                
                if (lastSources && lastSourcesCount && lastSourcesIcons) {
                    const sources = JSON.parse(lastSources);
                    const count = parseInt(lastSourcesCount);
                    const icons = JSON.parse(lastSourcesIcons);
                    
                    if (sources.length > 0) {
                        console.log('Restoring sources bar with data:', { sources, count, icons });
                        // Восстанавливаем данные в window
                        window.__lastSources = sources;
                        
                        // Создаем мини-бар
                        const chat = document.getElementById('chatArea');
                        if (chat) {
                            console.log('Creating sources bar in chat area');
                            const barId = 'refbar-' + Date.now();
                            chat.innerHTML += `
                                <div id="${barId}" class="flex items-center gap-2 text-xs text-gray-600 cursor-pointer select-none hover:text-blue-600 transition-colors p-2 rounded-lg hover:bg-blue-50" role="button" tabindex="0">
                                    <div class="flex items-center justify-center w-4 h-4">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M0.300842 6.75896C0.300842 3.2391 3.15501 0.384938 6.67487 0.384938C6.98421 0.384956 7.28876 0.407574 7.58698 0.450368L7.49518 1.09392L7.4024 1.73748C7.16512 1.70342 6.92228 1.68574 6.67487 1.68572C3.87298 1.68572 1.60162 3.95707 1.60162 6.75896C1.60182 9.56068 3.8731 11.8322 6.67487 11.8322C9.0556 11.832 11.0549 10.1909 11.6006 7.97771L12.2315 8.13299L12.8624 8.28924C12.1767 11.0694 9.66758 13.1318 6.67487 13.132C3.15513 13.132 0.301038 10.2787 0.300842 6.75896Z" fill="currentColor"></path>
                                            <path d="M15.6992 14.8074L14.7793 15.7274L11.3974 12.3455L12.3174 11.4256L15.6992 14.8074Z" fill="currentColor"></path>
                                            <path d="M11.3473 6.59701C11.2764 6.81246 10.9716 6.81246 10.9008 6.59701L10.4901 5.34822C10.3035 4.78103 9.85867 4.33617 9.29148 4.14962L8.04269 3.73893C7.82724 3.66807 7.82724 3.36329 8.04269 3.29243L9.29148 2.88173C9.85867 2.69519 10.3035 2.25032 10.4901 1.68314L10.9008 0.434345C10.9716 0.218896 11.2764 0.218896 11.3473 0.434345L11.758 1.68314C11.9445 2.25032 12.3894 2.69519 12.9566 2.88173L14.2054 3.29243C14.4208 3.36329 14.4208 3.66807 14.2054 3.73893L12.9566 4.14962C12.3894 4.33617 11.9445 4.78103 11.758 5.34822L11.3473 6.59701Z" fill="currentColor"></path>
                                        </svg>
                                    </div>
                                    <span class="font-medium">${isEnglish ? 'Found' : 'Найдено'} ${count} ${isEnglish ? 'sources' : 'источников'}</span>
                                    <div class="flex items-center gap-1 ml-auto">${icons.join('')}</div>
                                </div>
                            `;
                            
                            // Добавляем обработчик клика
                            const barEl = document.getElementById(barId);
                            if (barEl) {
                                const handler = function(ev){
                                    ev.preventDefault();
                                    ev.stopPropagation();
                                    showSourcesUI();
                                };
                                barEl.addEventListener('click', handler);
                                barEl.addEventListener('keydown', function(ev){ 
                                    if (ev.key === 'Enter' || ev.key === ' ') { 
                                        handler(ev); 
                                    } 
                                });
                            }
                        }
                    } else {
                        console.log('No sources to restore');
                    }
                } else {
                    console.log('No localStorage data found');
                }
            } catch (e) {
                console.error('Error restoring sources bar:', e);
            }
        }

        // Функции для работы с AI настройками
        function loadAiSettings() {
            // Загружаем сохраненные настройки
            loadSavedApiKeys();
            loadSavedModelSettings();
            loadCurrentSettings();
            checkConnectionStatus();
        }

        function loadSavedApiKeys() {
            // Загружаем сохраненные API ключи из localStorage
            const savedKeys = localStorage.getItem('aiApiKeys');
            if (savedKeys) {
                const keys = JSON.parse(savedKeys);
                document.getElementById('apiService').value = keys.service || 'mistral';
                document.getElementById('apiKey').value = keys.key || '';
            }

            // Добавляем опции для внешних API в селекты моделей
            addExternalApiOptions();
        }

        function addExternalApiOptions() {
            const responseSelect = document.getElementById('responseModel');
            const embeddingSelect = document.getElementById('embeddingModel');
            const deepThinkingSelect = document.getElementById('deepThinkingModel');
            
            // Очищаем существующие опции внешних API
            Array.from(responseSelect.options).forEach(option => {
                if (option.value.startsWith('mistral:') || option.value.startsWith('openai:') || option.value.startsWith('anthropic:') || option.value.startsWith('deepseek:')) {
                    option.remove();
                }
            });
            Array.from(embeddingSelect.options).forEach(option => {
                if (option.value.startsWith('mistral:') || option.value.startsWith('openai:') || option.value.startsWith('anthropic:') || option.value.startsWith('deepseek:')) {
                    option.remove();
                }
            });
            if (deepThinkingSelect) {
                Array.from(deepThinkingSelect.options).forEach(option => {
                    if (option.value.startsWith('mistral:') || option.value.startsWith('openai:') || option.value.startsWith('anthropic:') || option.value.startsWith('deepseek:')) {
                        option.remove();
                    }
                });
            }

            // Добавляем опции для внешних API
            const externalOptions = [
                { value: 'mistral:mistral-large-latest', text: 'Mistral: mistral-large-latest' },
                { value: 'mistral:mistral-medium-latest', text: 'Mistral: mistral-medium-latest' },
                { value: 'openai:gpt-4', text: 'OpenAI: GPT-4' },
                { value: 'openai:gpt-3.5-turbo', text: 'OpenAI: GPT-3.5 Turbo' },
                { value: 'anthropic:claude-3-opus', text: 'Anthropic: Claude 3 Opus' },
                { value: 'anthropic:claude-3-sonnet', text: 'Anthropic: Claude 3 Sonnet' },
                { value: 'deepseek:deepseek-chat', text: 'DeepSeek: DeepSeek Chat' },
                { value: 'deepseek:deepseek-reasoner', text: 'DeepSeek: DeepSeek R1 (Reasoner)' }
            ];

            externalOptions.forEach(option => {
                const responseOption = document.createElement('option');
                responseOption.value = option.value;
                responseOption.textContent = option.text;
                responseSelect.appendChild(responseOption);

                const embeddingOption = document.createElement('option');
                embeddingOption.value = option.value;
                embeddingOption.textContent = option.text;
                embeddingSelect.appendChild(embeddingOption);
                
                if (deepThinkingSelect) {
                    const deepThinkingOption = document.createElement('option');
                    deepThinkingOption.value = option.value;
                    deepThinkingOption.textContent = option.text;
                    deepThinkingSelect.appendChild(deepThinkingOption);
                }
            });
            
            // Добавляем обработчики изменения для отображения провайдера
            if (responseSelect) {
                responseSelect.addEventListener('change', updateModelProviderDisplay);
            }
            if (embeddingSelect) {
                embeddingSelect.addEventListener('change', updateModelProviderDisplay);
            }
        }

        function loadSavedModelSettings() {
            // Загружаем сохраненные настройки моделей
            const savedSettings = localStorage.getItem('aiModelSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('responseModel').value = settings.responseModel || '';
                document.getElementById('embeddingModel').value = settings.embeddingModel || '';
            }
        }

        function saveApiKey() {
            const service = document.getElementById('apiService').value;
            const key = document.getElementById('apiKey').value;
            
            if (!key.trim()) {
                alert('Введите API ключ');
                return;
            }

            // Сохраняем в localStorage
            const keys = { service, key };
            localStorage.setItem('aiApiKeys', JSON.stringify(keys));
            
            alert('API ключ сохранен');
            updateConnectionStatus('api', 'saved');
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            const icon = document.getElementById('apiKeyToggleIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-feather', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-feather', 'eye');
            }
            feather.replace();
        }

        async function testApiConnection() {
            const service = document.getElementById('apiService').value;
            const key = document.getElementById('apiKey').value;
            
            if (!key.trim()) {
                alert('Введите API ключ для тестирования');
                return;
            }

            try {
                updateConnectionStatus('api', 'testing');
                
                const res = await fetch(API_BASE + '/api/ai/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    body: JSON.stringify({ service, key })
                });

                if (res.ok) {
                    updateConnectionStatus('api', 'connected');
                    alert('Подключение успешно!');
                } else {
                    updateConnectionStatus('api', 'error');
                    alert('Ошибка подключения');
                }
            } catch (e) {
                updateConnectionStatus('api', 'error');
                alert('Ошибка подключения');
            }
        }

        async function loadOllamaModels() {
            try {
                updateConnectionStatus('ollama', 'testing');
                
                const res = await fetch(API_BASE + '/api/ai/ollama/models', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    displayOllamaModels(data.models);
                    updateConnectionStatus('ollama', 'connected');
                } else {
                    updateConnectionStatus('ollama', 'error');
                    alert('Ошибка загрузки моделей Ollama');
                }
            } catch (e) {
                updateConnectionStatus('ollama', 'error');
                alert('Ошибка подключения к Ollama');
            }
        }

        // Установка предпочитаемого провайдера
        function setPreferredProvider(provider) {
            localStorage.setItem('preferredModelProvider', provider);
            
            const ollamaBtn = document.getElementById('prefProviderOllama');
            const apiBtn = document.getElementById('prefProviderApi');
            
            if (provider === 'ollama') {
                ollamaBtn.classList.remove('bg-gray-200', 'text-gray-700');
                ollamaBtn.classList.add('bg-blue-500', 'text-white');
                apiBtn.classList.remove('bg-blue-500', 'text-white');
                apiBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                apiBtn.classList.remove('bg-gray-200', 'text-gray-700');
                apiBtn.classList.add('bg-blue-500', 'text-white');
                ollamaBtn.classList.remove('bg-blue-500', 'text-white');
                ollamaBtn.classList.add('bg-gray-200', 'text-gray-700');
            }
            
            // Обновляем отображение провайдера в селектах
            updateModelProviderDisplay();
        }
        
        function loadPreferredProvider() {
            const preferred = localStorage.getItem('preferredModelProvider') || 'ollama';
            setPreferredProvider(preferred);
        }
        
        function updateModelProviderDisplay() {
            const responseSelect = document.getElementById('responseModel');
            const embeddingSelect = document.getElementById('embeddingModel');
            const responseProvider = document.getElementById('responseModelProvider');
            const embeddingProvider = document.getElementById('embeddingModelProvider');
            
            if (responseSelect && responseProvider) {
                const selectedValue = responseSelect.value;
                if (selectedValue) {
                    const provider = selectedValue.split(':')[0];
                    responseProvider.textContent = `Провайдер: ${provider.toUpperCase()}`;
                } else {
                    responseProvider.textContent = '';
                }
            }
            
            if (embeddingSelect && embeddingProvider) {
                const selectedValue = embeddingSelect.value;
                if (selectedValue) {
                    const provider = selectedValue.split(':')[0];
                    embeddingProvider.textContent = `Провайдер: ${provider.toUpperCase()}`;
                } else {
                    embeddingProvider.textContent = '';
                }
            }
        }
        
        function displayOllamaModels(models) {
            const container = document.getElementById('ollamaModelsList');
            container.innerHTML = '';

            if (models.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Модели не найдены</p>';
                return;
            }

            // Заполняем селекты моделей
            const responseSelect = document.getElementById('responseModel');
            const embeddingSelect = document.getElementById('embeddingModel');
            const deepThinkingSelect = document.getElementById('deepThinkingModel');
            
            // Очищаем существующие опции Ollama
            Array.from(responseSelect.options).forEach(option => {
                if (option.value.startsWith('ollama:')) {
                    option.remove();
                }
            });
            Array.from(embeddingSelect.options).forEach(option => {
                if (option.value.startsWith('ollama:')) {
                    option.remove();
                }
            });
            if (deepThinkingSelect) {
                Array.from(deepThinkingSelect.options).forEach(option => {
                    if (option.value.startsWith('ollama:')) {
                        option.remove();
                    }
                });
            }

            models.forEach(model => {
                // Добавляем в список моделей
                const modelDiv = document.createElement('div');
                modelDiv.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg';
                modelDiv.innerHTML = `
                    <div>
                        <div class="font-medium">${model.name}</div>
                        <div class="text-sm text-gray-500">${model.size || 'Размер неизвестен'}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectModel('ollama:${model.name}', 'response')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                            Для ответов
                        </button>
                        <button onclick="selectModel('ollama:${model.name}', 'embedding')" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                            Для эмбеддингов
                        </button>
                    </div>
                `;
                container.appendChild(modelDiv);

                // Добавляем в селекты
                const responseOption = document.createElement('option');
                responseOption.value = `ollama:${model.name}`;
                responseOption.textContent = `Ollama: ${model.name}`;
                responseSelect.appendChild(responseOption);

                const embeddingOption = document.createElement('option');
                embeddingOption.value = `ollama:${model.name}`;
                embeddingOption.textContent = `Ollama: ${model.name}`;
                embeddingSelect.appendChild(embeddingOption);
                
                if (deepThinkingSelect) {
                    const deepThinkingOption = document.createElement('option');
                    deepThinkingOption.value = `ollama:${model.name}`;
                    deepThinkingOption.textContent = `Ollama: ${model.name}`;
                    deepThinkingSelect.appendChild(deepThinkingOption);
                }
            });
        }

        function selectModel(modelName, type) {
            if (type === 'response') {
                document.getElementById('responseModel').value = modelName;
            } else {
                document.getElementById('embeddingModel').value = modelName;
            }
        }

        async function saveModelSettings() {
            const responseModel = document.getElementById('responseModel').value;
            const embeddingModel = document.getElementById('embeddingModel').value;
            const apiService = document.getElementById('apiService').value;
            const apiKey = document.getElementById('apiKey').value;

            try {
                const settings = {
                    response_model: responseModel,
                    embedding_model: embeddingModel,
                    api_service: apiService,
                    api_key: apiKey
                };

                const res = await fetch(API_BASE + '/api/ai/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    const data = await res.json();
                    alert('Настройки AI сохранены успешно!');
                    
                    // Обновляем отображение текущих настроек
                    updateCurrentSettingsDisplay(data.settings);
                    
                    // Обновляем отображение текущей модели
                    updateCurrentModelDisplay(data.settings);
                    
                    // Сохраняем в localStorage для быстрого доступа
                    localStorage.setItem('aiModelSettings', JSON.stringify({
                        responseModel: responseModel,
                        embeddingModel: embeddingModel,
                        apiService: apiService,
                        apiKey: apiKey
                    }));
                } else {
                    const error = await res.json();
                    alert(`Ошибка сохранения настроек: ${error.detail}`);
                }
            } catch (e) {
                console.error('Ошибка сохранения настроек:', e);
                alert('Ошибка сохранения настроек');
            }
        }

        async function saveDeepThinkingSettings() {
            const deepThinkingModel = document.getElementById('deepThinkingModel').value;
            const deepseekApiKey = document.getElementById('deepseekApiKey').value;

            try {
                const settings = {
                    response_model: document.getElementById('responseModel').value || '',
                    embedding_model: document.getElementById('embeddingModel').value || '',
                    api_service: document.getElementById('apiService').value || '',
                    api_key: document.getElementById('apiKey').value || '',
                    deep_thinking_model: deepThinkingModel,
                    deepseek_api_key: deepseekApiKey
                };

                const res = await fetch(API_BASE + '/api/ai/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    alert('Настройки размышления сохранены успешно!');
                    await loadCurrentSettings(); // Перезагружаем настройки
                } else {
                    const error = await res.json();
                    alert(`Ошибка сохранения настроек размышления: ${error.detail}`);
                }
            } catch (e) {
                console.error('Ошибка сохранения настроек размышления:', e);
                alert('Ошибка сохранения настроек размышления');
            }
        }

        function toggleDeepseekApiKeyVisibility() {
            const input = document.getElementById('deepseekApiKey');
            const icon = document.getElementById('deepseekApiKeyToggleIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-feather', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-feather', 'eye');
            }
            feather.replace();
        }

        function updateConnectionStatus(type, status) {
            const indicator = document.getElementById(`${type}StatusIndicator`);
            const text = document.getElementById(`${type}StatusText`);
            
            const statusMap = {
                'saved': { color: 'bg-yellow-400', text: 'Сохранен' },
                'testing': { color: 'bg-yellow-400', text: 'Тестирование...' },
                'connected': { color: 'bg-green-400', text: 'Подключен' },
                'error': { color: 'bg-red-400', text: 'Ошибка' }
            };

            if (indicator && text && statusMap[status]) {
                indicator.className = `w-3 h-3 ${statusMap[status].color} rounded-full`;
                text.textContent = `${type.toUpperCase()}: ${statusMap[status].text}`;
            }
        }

        function checkConnectionStatus() {
            // Проверяем статус подключений при загрузке
            const savedKeys = localStorage.getItem('aiApiKeys');
            if (savedKeys) {
                updateConnectionStatus('api', 'saved');
            }
            
            // Проверяем Ollama
            loadOllamaModels();
        }

        // Новые функции для работы с настройками AI
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initDeepThinkingButton();
            initIntelligentSearchButton();
        });
        
        async function loadCurrentSettings() {
            try {
                const res = await fetch(API_BASE + '/api/ai/settings', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    const settings = data.settings;
                    
                    // Обновляем отображение текущих настроек
                    updateCurrentSettingsDisplay(settings);
                    
                    // Обновляем отображение текущей модели
                    updateCurrentModelDisplay(settings);
                    
                    // Заполняем формы
                    if (settings.response_model) {
                        document.getElementById('responseModel').value = settings.response_model;
                    }
                    if (settings.embedding_model) {
                        document.getElementById('embeddingModel').value = settings.embedding_model;
                    }
                    if (settings.api_service) {
                        document.getElementById('apiService').value = settings.api_service;
                    }
                    if (settings.api_key) {
                        document.getElementById('apiKey').value = settings.api_key;
                    }
                    if (settings.deep_thinking_model) {
                        document.getElementById('deepThinkingModel').value = settings.deep_thinking_model;
                    }
                    if (settings.deepseek_api_key) {
                        document.getElementById('deepseekApiKey').value = settings.deepseek_api_key;
                    }
                }
            } catch (e) {
                console.error('Ошибка загрузки настроек:', e);
            }
        }

        function updateCurrentSettingsDisplay(settings) {
            const responseModelEl = document.getElementById('currentResponseModel');
            const embeddingModelEl = document.getElementById('currentEmbeddingModel');
            const apiServiceEl = document.getElementById('currentApiService');

            if (responseModelEl) {
                responseModelEl.textContent = settings.response_model || 'Не выбрана';
            }
            if (embeddingModelEl) {
                embeddingModelEl.textContent = settings.embedding_model || 'Не выбрана';
            }
            if (apiServiceEl) {
                apiServiceEl.textContent = settings.api_service || 'Не настроен';
            }
        }

        // ============================================================================
        // SQL-АГЕНТ ФУНКЦИИ
        // ============================================================================
        
        async function loadSQLAgentStatus() {
            try {
                const res = await fetch(API_BASE + '/api/ai/sql-agent/status', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    const toggle = document.getElementById('sqlAgentToggle');
                    const statusText = document.getElementById('sqlAgentStatusText');
                    const infoDiv = document.getElementById('sqlAgentInfo');
                    
                    if (toggle) {
                        toggle.checked = data.enabled || false;
                    }
                    if (statusText) {
                        statusText.textContent = data.enabled ? 'Включен' : 'Выключен';
                    }
                    if (infoDiv) {
                        if (data.enabled) {
                            infoDiv.classList.remove('hidden');
                        } else {
                            infoDiv.classList.add('hidden');
                        }
                    }
                    
                    // Загружаем настройки fallback
                    const esFallbackToggle = document.getElementById('esFallbackToggle');
                    const esFallbackStatusText = document.getElementById('esFallbackStatusText');
                    const esModelSelect = document.getElementById('esModelSelect');
                    
                    if (esFallbackToggle) {
                        esFallbackToggle.checked = data.es_fallback_enabled || false;
                    }
                    if (esFallbackStatusText) {
                        esFallbackStatusText.textContent = data.es_fallback_enabled ? 'Включен' : 'Выключен';
                    }
                    if (esModelSelect) {
                        esModelSelect.value = data.es_model || 'bert_spacy';
                    }
                    
                    // Загружаем модель SQL агента
                    const sqlAgentModelSelect = document.getElementById('sqlAgentModelSelect');
                    if (sqlAgentModelSelect) {
                        // Загружаем список доступных моделей
                        await loadSQLAgentModelOptions();
                        // Устанавливаем выбранную модель
                        sqlAgentModelSelect.value = data.sql_model || '';
                    }
                }
            } catch (e) {
                console.error('Ошибка загрузки статуса SQL-агента:', e);
            }
        }
        
        async function loadSQLAgentModelOptions() {
            try {
                const sqlAgentModelSelect = document.getElementById('sqlAgentModelSelect');
                if (!sqlAgentModelSelect) return;
                
                // Загружаем список моделей из AI настроек
                const res = await fetch(API_BASE + '/api/ai/settings', {
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const settings = data.settings || {};
                    
                    // Очищаем опции (кроме первой - "Использовать модель из настроек AI")
                    sqlAgentModelSelect.innerHTML = '<option value="">Использовать модель из настроек AI</option>';
                    
                    // Добавляем модели из Ollama
                    const ollamaRes = await fetch(API_BASE + '/api/ai/ollama/models', {
                        headers: { ...authHeader() }
                    });
                    if (ollamaRes.ok) {
                        const ollamaData = await ollamaRes.json();
                        if (ollamaData.models && ollamaData.models.length > 0) {
                            ollamaData.models.forEach(model => {
                                const option = document.createElement('option');
                                option.value = `ollama:${model.name}`;
                                option.textContent = `Ollama: ${model.name}`;
                                sqlAgentModelSelect.appendChild(option);
                            });
                        }
                    }
                    
                    // Добавляем стандартные модели
                    const standardModels = [
                        { value: 'mistral:mistral-small', label: 'Mistral: mistral-small' },
                        { value: 'mistral:mistral-medium', label: 'Mistral: mistral-medium' },
                        { value: 'mistral:mistral-large', label: 'Mistral: mistral-large' },
                        { value: 'openai:gpt-4', label: 'OpenAI: GPT-4' },
                        { value: 'openai:gpt-3.5-turbo', label: 'OpenAI: GPT-3.5 Turbo' },
                        { value: 'anthropic:claude-3-opus', label: 'Anthropic: Claude 3 Opus' },
                        { value: 'anthropic:claude-3-sonnet', label: 'Anthropic: Claude 3 Sonnet' },
                        { value: 'anthropic:claude-3-haiku', label: 'Anthropic: Claude 3 Haiku' }
                    ];
                    
                    standardModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.value;
                        option.textContent = model.label;
                        sqlAgentModelSelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Ошибка загрузки опций модели SQL агента:', e);
            }
        }
        
        async function updateSQLAgentModel() {
            const select = document.getElementById('sqlAgentModelSelect');
            const model = select.value;
            
            try {
                const res = await fetch(API_BASE + '/api/ai/sql-agent/settings/fallback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        sql_model: model
                    })
                });
                
                if (res.ok) {
                    alert('Модель SQL агента обновлена');
                } else {
                    const error = await res.json();
                    alert('Ошибка обновления модели: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (e) {
                console.error('Ошибка обновления модели SQL агента:', e);
                alert('Ошибка обновления модели SQL агента');
            }
        }
        
        async function toggleESFallback() {
            const toggle = document.getElementById('esFallbackToggle');
            const statusText = document.getElementById('esFallbackStatusText');
            const enabled = toggle.checked;
            
            try {
                const res = await fetch(API_BASE + '/api/ai/sql-agent/settings/fallback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        es_fallback_enabled: enabled
                    })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (statusText) {
                        statusText.textContent = enabled ? 'Включен' : 'Выключен';
                    }
                    alert('Настройки fallback обновлены');
                } else {
                    // Откатываем переключатель при ошибке
                    toggle.checked = !enabled;
                    const error = await res.json();
                    alert('Ошибка обновления настроек: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (e) {
                console.error('Ошибка обновления fallback:', e);
                toggle.checked = !enabled;
                alert('Ошибка обновления настроек fallback');
            }
        }
        
        async function updateESModel() {
            const select = document.getElementById('esModelSelect');
            const model = select.value;
            
            try {
                const res = await fetch(API_BASE + '/api/ai/sql-agent/settings/fallback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        es_model: model
                    })
                });
                
                if (res.ok) {
                    alert('Модель Elasticsearch обновлена');
                } else {
                    const error = await res.json();
                    alert('Ошибка обновления модели: ' + (error.detail || 'Неизвестная ошибка'));
                }
            } catch (e) {
                console.error('Ошибка обновления модели:', e);
                alert('Ошибка обновления модели Elasticsearch');
            }
        }

        async function toggleSQLAgent() {
            const toggle = document.getElementById('sqlAgentToggle');
            const enabled = toggle ? toggle.checked : false;
            
            try {
                const res = await fetch(API_BASE + '/api/ai/sql-agent/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({ enabled })
                });

                if (res.ok) {
                    const data = await res.json();
                    const statusText = document.getElementById('sqlAgentStatusText');
                    const infoDiv = document.getElementById('sqlAgentInfo');
                    
                    if (statusText) {
                        statusText.textContent = data.enabled ? 'Включен' : 'Выключен';
                    }
                    if (infoDiv) {
                        if (data.enabled) {
                            infoDiv.classList.remove('hidden');
                        } else {
                            infoDiv.classList.add('hidden');
                        }
                    }
                    alert(data.message || (data.enabled ? 'SQL-агент включен' : 'SQL-агент выключен'));
                } else {
                    const error = await res.json();
                    alert(`Ошибка: ${error.detail || 'Не удалось изменить статус SQL-агента'}`);
                    // Возвращаем переключатель в исходное состояние
                    if (toggle) {
                        toggle.checked = !enabled;
                    }
                }
            } catch (e) {
                console.error('Ошибка переключения SQL-агента:', e);
                alert('Ошибка при изменении статуса SQL-агента');
                // Возвращаем переключатель в исходное состояние
                if (toggle) {
                    toggle.checked = !enabled;
                }
            }
        }

        async function testModel(type) {
            const modelSelect = type === 'response' ? 'responseModel' : 'embeddingModel';
            const modelName = document.getElementById(modelSelect).value;

            if (!modelName) {
                alert('Выберите модель для тестирования');
                return;
            }

            try {
                const res = await fetch(API_BASE + `/api/ai/test-model?model_name=${encodeURIComponent(modelName)}&model_type=${type}`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`✅ Модель ${modelName} работает корректно!\n\nТип: ${data.details.type}\nСтатус: ${data.details.status}`);
                } else {
                    const error = await res.json();
                    alert(`❌ Ошибка тестирования модели: ${error.detail}`);
                }
            } catch (e) {
                console.error('Ошибка тестирования модели:', e);
                alert('Ошибка тестирования модели');
            }
        }

        async function checkOllamaStatus() {
            try {
                updateConnectionStatus('ollama', 'testing');
                
                const res = await fetch(API_BASE + '/api/ai/ollama/status', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    updateConnectionStatus('ollama', 'connected');
                    alert(`✅ Ollama подключен!\n\nСтатус: ${data.status}`);
                } else {
                    updateConnectionStatus('ollama', 'error');
                    alert('❌ Ollama недоступен');
                }
            } catch (e) {
                updateConnectionStatus('ollama', 'error');
                alert('❌ Ошибка подключения к Ollama');
            }
        }

        // Функция для загрузки и отображения текущей модели
        async function loadCurrentModel() {
            try {
                const res = await fetch(API_BASE + '/api/ai/settings', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    const settings = data.settings;
                    updateCurrentModelDisplay(settings);
                }
            } catch (e) {
                console.error('Ошибка загрузки текущей модели:', e);
            }
        }

        function updateCurrentModelDisplay(settings) {
            const displayEl = document.getElementById('currentModelDisplay');
            const nameEl = document.getElementById('currentModelName');
            
            if (!displayEl || !nameEl) return;

            const responseModel = settings.response_model || '';
            
            if (!responseModel) {
                // Используем модель по умолчанию
                nameEl.textContent = 'Mistral (по умолчанию)';
                nameEl.className = 'px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
                displayEl.classList.remove('hidden');
                return;
            }

            let modelName = '';
            let colorClass = 'bg-gray-100 text-gray-800';

            if (responseModel.startsWith('ollama:')) {
                modelName = `Ollama: ${responseModel.replace('ollama:', '')}`;
                colorClass = 'bg-orange-100 text-orange-800';
            } else if (responseModel.startsWith('mistral:')) {
                modelName = `Mistral: ${responseModel.replace('mistral:', '')}`;
                colorClass = 'bg-blue-100 text-blue-800';
            } else if (responseModel.startsWith('openai:')) {
                modelName = `OpenAI: ${responseModel.replace('openai:', '')}`;
                colorClass = 'bg-green-100 text-green-800';
            } else if (responseModel.startsWith('anthropic:')) {
                modelName = `Anthropic: ${responseModel.replace('anthropic:', '')}`;
                colorClass = 'bg-purple-100 text-purple-800';
            } else {
                modelName = responseModel;
            }

            nameEl.textContent = modelName;
            nameEl.className = `px-2 py-1 rounded-full text-xs font-medium ${colorClass}`;
            displayEl.classList.remove('hidden');
        }

        // Автоматическая аутентификация для демо (отключена)
        // autoLogin();
        
        // Проверяем токен при загрузке страницы
        (async () => {
            const token = window.localStorage.getItem('token');
            if (token) {
                try {
                    await loadCurrentUser();
                    if (currentUser) {
                        // Пользователь авторизован - показываем интерфейс чата
                        document.getElementById('authModal').classList.add('hidden');
                        document.getElementById('chatInterface').classList.remove('hidden');
                        loadCurrentModel();
                        // Загружаем чаты сразу
                        await loadChats();
                    } else {
                        // Токен невалидный - показываем окно авторизации
                        window.localStorage.removeItem('token');
                        document.getElementById('authModal').classList.remove('hidden');
                        document.getElementById('chatInterface').classList.add('hidden');
                    }
                } catch (e) {
                    // Ошибка при загрузке пользователя - показываем окно авторизации
                    console.error('Ошибка при проверке авторизации:', e);
                    window.localStorage.removeItem('token');
                    document.getElementById('authModal').classList.remove('hidden');
                    document.getElementById('chatInterface').classList.add('hidden');
                }
            } else {
                // Нет токена - показываем окно авторизации
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('chatInterface').classList.add('hidden');
            }
        })();
        // Делегирование клика по мини-бару источников, чтобы не терять обработчики
        (function(){
            const chat = document.getElementById('chatArea');
            if (!chat) return;
            chat.addEventListener('click', function(e){
                const target = e.target.closest('[id^="refbar-"]');
                if (target) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Получаем messageId из data-атрибута или из id элемента
                    let messageId = target.getAttribute('data-message-id');
                    if (!messageId && target.id) {
                        // Извлекаем messageId из id вида "refbar-ai-msg-171" или "refbar-1762413706565"
                        const idMatch = target.id.match(/^refbar-(.+)$/);
                        if (idMatch) {
                            messageId = idMatch[1];
                        }
                    }
                    if (messageId) {
                        console.log(`🔍 Клик по refbar, messageId: ${messageId}`);
                        showSourcesForMessage(messageId);
                    } else {
                        console.log('⚠️ Не удалось извлечь messageId из refbar');
                        showSourcesUI();
                    }
                }
            });
            chat.addEventListener('keydown', function(e){
                const target = e.target.closest('[id^="refbar-"]');
                if (target && (e.key === 'Enter' || e.key === ' ')) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Получаем messageId из data-атрибута или из id элемента
                    let messageId = target.getAttribute('data-message-id');
                    if (!messageId && target.id) {
                        // Извлекаем messageId из id вида "refbar-ai-msg-171" или "refbar-1762413706565"
                        const idMatch = target.id.match(/^refbar-(.+)$/);
                        if (idMatch) {
                            messageId = idMatch[1];
                        }
                    }
                    if (messageId) {
                        console.log(`🔍 Клавиша на refbar, messageId: ${messageId}`);
                        showSourcesForMessage(messageId);
                    } else {
                        console.log('⚠️ Не удалось извлечь messageId из refbar');
                        showSourcesUI();
                    }
                }
            });
        })();
        
        // Восстанавливаем мини-бар источников после полной инициализации
        setTimeout(() => {
            restoreSourcesBar();
            initParserHandlers(); // Инициализируем обработчики парсера
        }, 1000);

        // ========== ФУНКЦИИ ДЛЯ ПАРСЕРА ==========
        
        let parserCurrentPage = 0;
        let parserStatusInterval = null;

        // Инициализация обработчиков после загрузки DOM
        function initParserHandlers() {
            const parserUseAI = document.getElementById('parserUseAI');
            const parserUseOllama = document.getElementById('parserUseOllama');
            
            if (parserUseAI) {
                parserUseAI.addEventListener('change', function() {
                    const aiOptions = document.getElementById('aiParserOptions');
                    if (this.checked) {
                        aiOptions.classList.remove('hidden');
                    } else {
                        aiOptions.classList.add('hidden');
                    }
                });
            }

            if (parserUseOllama) {
                parserUseOllama.addEventListener('change', function() {
                    const ollamaSelector = document.getElementById('ollamaModelSelector');
                    if (this.checked) {
                        ollamaSelector.classList.remove('hidden');
                    } else {
                        ollamaSelector.classList.add('hidden');
                    }
                });
            }
        }

        // Обновление типа парсера
        function updateParserType() {
            const parserType = document.querySelector('input[name="parserType"]:checked').value;
            const aiOptions = document.getElementById('aiParserOptions');
            const ollamaOptions = document.getElementById('ollamaOptions');
            const ollamaInfo = document.getElementById('ollamaInfo');
            
            if (parserType === 'basic') {
                aiOptions.classList.add('hidden');
            } else {
                aiOptions.classList.remove('hidden');
                
                if (parserType === 'ai_ollama') {
                    // Для ИИ+Ollama автоматически включаем Ollama
                    document.getElementById('parserUseOllama').checked = true;
                    toggleOllamaOptions();
                    ollamaInfo.classList.remove('hidden');
                } else {
                    ollamaInfo.classList.add('hidden');
                    document.getElementById('parserUseOllama').checked = false;
                    toggleOllamaOptions();
                }
            }
        }

        // Переключение опций Ollama
        function toggleOllamaOptions() {
            const useOllama = document.getElementById('parserUseOllama').checked;
            const ollamaSelector = document.getElementById('ollamaModelSelector');
            const ollamaInfo = document.getElementById('ollamaInfo');
            
            if (useOllama) {
                ollamaSelector.classList.remove('hidden');
                ollamaInfo.classList.remove('hidden');
            } else {
                ollamaSelector.classList.add('hidden');
                ollamaInfo.classList.add('hidden');
            }
        }

        // Запуск парсинга
        async function startParser() {
            const maxPages = parseInt(document.getElementById('parserMaxPages').value) || null;
            const maxCars = parseInt(document.getElementById('parserMaxCars').value) || null;
            const delay = parseFloat(document.getElementById('parserDelay').value) || 1.0;
            const baseUrl = document.getElementById('parserBaseUrl').value || 'https://aaa-motors.ru';
            
            // КРИТИЧЕСКИ ВАЖНО: Очистка данных перед парсингом (по умолчанию ВКЛЮЧЕНА)
            const clearBefore = true; // ВСЕГДА очищаем данные перед парсингом
            
            // Определяем тип парсера
            // ВАЖНО: По умолчанию используем ИИ-парсер (с NLP и ML)
            const parserTypeRadio = document.querySelector('input[name="parserType"]:checked');
            const parserType = parserTypeRadio ? parserTypeRadio.value : 'ai'; // По умолчанию 'ai'
            
            let useAI = true; // По умолчанию ИИ-парсер ВКЛЮЧЕН
            let useOllama = false;
            
            if (parserType === 'basic') {
                useAI = false; // Только для базового парсера выключаем ИИ
            } else if (parserType === 'ai' || parserType === 'ai_ollama') {
                useAI = true;
                useOllama = parserType === 'ai_ollama' || (parserType === 'ai' && document.getElementById('parserUseOllama') && document.getElementById('parserUseOllama').checked);
            }
            
            const ollamaModel = useOllama ? (document.getElementById('parserOllamaModel').value || null) : null;

            const requestData = {
                base_url: baseUrl,
                max_pages: maxPages,
                max_cars: maxCars,
                delay: delay,
                use_ai: useAI,
                use_ollama: useOllama,
                ollama_model: ollamaModel,
                clear_before: clearBefore  // КРИТИЧЕСКИ ВАЖНО: очистка данных перед парсингом
            };
            
            console.log('🚀 Запуск парсинга с параметрами:', requestData);
            console.log('✅ clear_before=', clearBefore, '- данные будут очищены перед парсингом');
            console.log('✅ use_ai=', useAI, '- ИИ-парсер', useAI ? 'ВКЛЮЧЕН' : 'ВЫКЛЮЧЕН');
            console.log('✅ use_ollama=', useOllama, '- Ollama', useOllama ? 'ВКЛЮЧЕН' : 'ВЫКЛЮЧЕН');
            console.log('✅ parserType=', parserType);

            try {
                const response = await fetch(API_BASE + '/api/parser/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка запуска парсинга');
                }

                const result = await response.json();
                updateParserStatus(result);
                
                // Начинаем отслеживание статуса
                startParserStatusPolling();
                
                // Обновляем UI
                document.getElementById('startParserBtn').disabled = true;
                document.getElementById('stopParserBtn').classList.remove('hidden');
                
                // Обновляем список автомобилей после запуска парсинга (чтобы увидеть очистку)
                setTimeout(() => {
                    loadParsedCars(0);
                }, 2000);
                
                alert('Парсинг запущен! Все старые данные будут удалены перед началом парсинга.');
            } catch (error) {
                console.error('Ошибка запуска парсинга:', error);
                alert('Ошибка запуска парсинга: ' + error.message);
            }
        }

        // Остановка парсинга
        async function stopParser() {
            try {
                const response = await fetch(API_BASE + '/api/parser/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка остановки парсинга');
                }

                stopParserStatusPolling();
                document.getElementById('startParserBtn').disabled = false;
                document.getElementById('stopParserBtn').classList.add('hidden');
                
                alert('Парсинг остановлен');
                refreshParserStatus();
            } catch (error) {
                console.error('Ошибка остановки парсинга:', error);
                alert('Ошибка остановки парсинга: ' + error.message);
            }
        }

        // Обновление статуса парсинга
        async function refreshParserStatus() {
            try {
                const response = await fetch(API_BASE + '/api/parser/status', {
                    headers: authHeader()
                });
                
                if (!response.ok) {
                    return;
                }

                const status = await response.json();
                updateParserStatus(status);
                
                // Если парсинг завершен, обновляем список автомобилей
                if (status.status === 'completed' || status.status === 'error') {
                    loadParsedCars(0);
                    stopParserStatusPolling();
                }
            } catch (error) {
                console.error('Ошибка получения статуса:', error);
            }
        }

        // Обновление UI статуса
        function updateParserStatus(status) {
            const statusText = document.getElementById('parserStatusText');
            const statusMap = {
                'running': { text: 'Запущен', class: 'bg-green-100 text-green-800' },
                'completed': { text: 'Завершен', class: 'bg-blue-100 text-blue-800' },
                'error': { text: 'Ошибка', class: 'bg-red-100 text-red-800' },
                'stopped': { text: 'Остановлен', class: 'bg-gray-100 text-gray-800' }
            };

            const statusInfo = statusMap[status.status] || statusMap['stopped'];
            statusText.textContent = statusInfo.text;
            statusText.className = `px-2 py-1 rounded text-xs font-medium ${statusInfo.class}`;

            document.getElementById('parserTotalParsed').textContent = status.total_parsed || 0;
            document.getElementById('parserTotalErrors').textContent = status.total_errors || 0;

            if (status.ollama_extractions !== undefined && status.ollama_extractions > 0) {
                document.getElementById('parserOllamaExtractions').textContent = status.ollama_extractions || 0;
                document.getElementById('parserOllamaStats').classList.remove('hidden');
            } else {
                document.getElementById('parserOllamaStats').classList.add('hidden');
            }
            
            // Обновляем статистику NLP
            if (status.nlp_extractions !== undefined) {
                const nlpStats = document.getElementById('parserNlpStats');
                if (nlpStats) {
                    document.getElementById('parserNlpExtractions').textContent = status.nlp_extractions || 0;
                    nlpStats.classList.remove('hidden');
                }
            }

            // Обновляем состояние кнопок
            if (status.status === 'running') {
                document.getElementById('startParserBtn').disabled = true;
                document.getElementById('stopParserBtn').classList.remove('hidden');
            } else {
                document.getElementById('startParserBtn').disabled = false;
                document.getElementById('stopParserBtn').classList.add('hidden');
                
                // Если парсинг завершен, обновляем список автомобилей
                if (status.status === 'completed' || status.status === 'error') {
                    setTimeout(() => {
                        loadParsedCars(0);
                    }, 1000);
                }
            }
        }

        // Периодическое обновление статуса
        function startParserStatusPolling() {
            if (parserStatusInterval) {
                clearInterval(parserStatusInterval);
            }
            parserStatusInterval = setInterval(refreshParserStatus, 3000); // Каждые 3 секунды
        }

        function stopParserStatusPolling() {
            if (parserStatusInterval) {
                clearInterval(parserStatusInterval);
                parserStatusInterval = null;
            }
        }

        // Загрузка списка спарсенных автомобилей
        async function loadParsedCars(skip = 0) {
            const tbody = document.getElementById('parsedCarsTableBody');
            tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Загрузка...</td></tr>';

            try {
                const searchQuery = document.getElementById('parserSearchInput').value;
                const params = new URLSearchParams({
                    skip: skip,
                    limit: 20
                });

                if (searchQuery) {
                    // Простой поиск по марке или модели
                    const searchParts = searchQuery.split(' ');
                    if (searchParts.length >= 2) {
                        params.append('mark', searchParts[0]);
                        params.append('model', searchParts.slice(1).join(' '));
                    } else {
                        params.append('mark', searchQuery);
                    }
                }

                const response = await fetch(API_BASE + '/api/parser/cars?' + params.toString(), {
                    headers: authHeader()
                });

                if (!response.ok) {
                    throw new Error('Ошибка загрузки автомобилей');
                }

                const data = await response.json();
                parserCurrentPage = skip;

                // Обновляем кнопки навигации
                document.getElementById('parserPrevBtn').disabled = skip === 0;
                document.getElementById('parserNextBtn').disabled = skip + 20 >= data.total;
                
                document.getElementById('parsedCarsTotal').textContent = data.total || 0;

                if (data.cars && data.cars.length > 0) {
                    tbody.innerHTML = data.cars.map(car => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${car.mark || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.model || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.city || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.price || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.manufacture_year || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.mileage ? car.mileage + ' км' : '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${car.pictures && car.pictures.length > 0 ? 
                                    `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${car.pictures.length}</span>` : 
                                    '-'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${new Date(car.parsed_at).toLocaleString('ru-RU')}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <a href="${car.source_url}" target="_blank" 
                                   class="text-blue-600 hover:text-blue-900 mr-2">Открыть</a>
                                <button onclick="deleteParsedCar(${car.id})" 
                                        class="text-red-600 hover:text-red-900">Удалить</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Нет спарсенных автомобилей</td></tr>';
                }

                // Инициализируем иконки
                if (window.feather) {
                    feather.replace();
                }
            } catch (error) {
                console.error('Ошибка загрузки автомобилей:', error);
                tbody.innerHTML = '<tr><td colspan="10" class="px-6 py-4 text-center text-red-600">Ошибка загрузки</td></tr>';
            }
        }

        function loadParsedCarsNext() {
            loadParsedCars(parserCurrentPage + 20);
        }

        // Удаление спарсенного автомобиля
        async function deleteParsedCar(carId) {
            if (!confirm('Удалить этот автомобиль?')) {
                return;
            }

            try {
                const response = await fetch(API_BASE + `/api/parser/cars/${carId}`, {
                    method: 'DELETE',
                    headers: authHeader()
                });

                if (!response.ok) {
                    throw new Error('Ошибка удаления');
                }

                loadParsedCars(parserCurrentPage);
                alert('Автомобиль удален');
            } catch (error) {
                console.error('Ошибка удаления автомобиля:', error);
                alert('Ошибка удаления: ' + error.message);
            }
        }

        // ========== ФУНКЦИИ ДЛЯ РАСПОЗНАВАНИЯ РЕЧИ ==========
        
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let silenceTimeout = null;
        let voiceSettings = {
            enabled: false,
            model: 'base',
            autoDetectLanguage: true,
            language: 'ru',
            silenceThreshold: 500,
            minSpeechDuration: 1.0
        };

        // Загрузка настроек голосового ввода
        async function loadVoiceSettings() {
            try {
                const response = await fetch(API_BASE + '/api/voice/settings', {
                    headers: authHeader()
                });

                if (response.ok) {
                    const settings = await response.json();
                    voiceSettings = { ...voiceSettings, ...settings };
                    
                    const enabledCheckbox = document.getElementById('voiceInputEnabled');
                    const modelSelect = document.getElementById('whisperModel');
                    const autoDetectCheckbox = document.getElementById('autoDetectLanguage');
                    const languageSelect = document.getElementById('voiceLanguage');
                    const thresholdSlider = document.getElementById('silenceThreshold');
                    const thresholdValue = document.getElementById('silenceThresholdValue');
                    const minDurationInput = document.getElementById('minSpeechDuration');
                    
                    if (enabledCheckbox) enabledCheckbox.checked = voiceSettings.enabled;
                    if (modelSelect) modelSelect.value = voiceSettings.model || 'base';
                    if (autoDetectCheckbox) autoDetectCheckbox.checked = voiceSettings.autoDetectLanguage !== false;
                    if (languageSelect) languageSelect.value = voiceSettings.language || 'ru';
                    if (thresholdSlider) thresholdSlider.value = voiceSettings.silenceThreshold || 500;
                    if (thresholdValue) thresholdValue.textContent = voiceSettings.silenceThreshold || 500;
                    if (minDurationInput) minDurationInput.value = voiceSettings.minSpeechDuration || 1.0;
                    
                    toggleVoiceInput();
                }
            } catch (error) {
                console.error('Ошибка загрузки настроек голосового ввода:', error);
            }

            // Обновление индикатора порога тишины
            const thresholdSlider = document.getElementById('silenceThreshold');
            if (thresholdSlider) {
                thresholdSlider.addEventListener('input', function() {
                    const thresholdValue = document.getElementById('silenceThresholdValue');
                    if (thresholdValue) {
                        thresholdValue.textContent = this.value;
                    }
                });
            }
        }

        // Сохранение настроек
        async function saveVoiceSettings() {
            const settings = {
                enabled: document.getElementById('voiceInputEnabled').checked,
                model: document.getElementById('whisperModel').value,
                autoDetectLanguage: document.getElementById('autoDetectLanguage').checked,
                language: document.getElementById('voiceLanguage').value,
                silenceThreshold: parseInt(document.getElementById('silenceThreshold').value),
                minSpeechDuration: parseFloat(document.getElementById('minSpeechDuration').value)
            };

            try {
                const response = await fetch(API_BASE + '/api/voice/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    voiceSettings = settings;
                    toggleVoiceInput();
                    alert('Настройки сохранены!');
                } else {
                    throw new Error('Ошибка сохранения настроек');
                }
            } catch (error) {
                console.error('Ошибка сохранения настроек:', error);
                alert('Ошибка сохранения настроек: ' + error.message);
            }
        }

        // Переключение видимости кнопки микрофона
        function toggleVoiceInput() {
            const enabled = document.getElementById('voiceInputEnabled').checked;
            const voiceButton = document.getElementById('voiceButton');
            
            if (enabled) {
                voiceButton.classList.remove('hidden');
            } else {
                voiceButton.classList.add('hidden');
                if (isRecording) {
                    stopVoiceRecording();
                }
            }
        }

        // Проверка микрофона
        async function testMicrophone() {
            const statusDiv = document.getElementById('microphoneStatus');
            const statusIndicator = document.getElementById('micStatusIndicator');
            const statusText = document.getElementById('micStatusText');
            
            statusDiv.classList.remove('hidden');
            statusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-400 animate-pulse';
            statusText.textContent = 'Проверка микрофона...';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                statusText.textContent = 'Микрофон работает!';
                
                // Останавливаем поток через 2 секунды
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                }, 2000);
            } catch (error) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = 'Ошибка доступа к микрофону: ' + error.message;
            }
        }

        // Начало записи
        async function startVoiceRecording() {
            if (isRecording) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                audioChunks = [];
                isRecording = true;

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendAudioForTranscription(audioBlob);
                    
                    // Останавливаем поток
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                
                // Обновляем UI
                const voiceButton = document.getElementById('voiceButton');
                voiceButton.classList.remove('bg-gray-600');
                voiceButton.classList.add('bg-red-600');
                document.getElementById('voiceRecordingIndicator').classList.remove('hidden');

            } catch (error) {
                console.error('Ошибка доступа к микрофону:', error);
                alert('Ошибка доступа к микрофону: ' + error.message);
                isRecording = false;
            }
        }

        // Остановка записи
        function stopVoiceRecording() {
            if (!isRecording || !mediaRecorder) return;

            if (mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            isRecording = false;

            // Обновляем UI
            const voiceButton = document.getElementById('voiceButton');
            voiceButton.classList.remove('bg-red-600');
            voiceButton.classList.add('bg-gray-600');
            document.getElementById('voiceRecordingIndicator').classList.add('hidden');

            if (silenceTimeout) {
                clearTimeout(silenceTimeout);
                silenceTimeout = null;
            }
        }

        // Переключение записи
        function toggleVoiceRecording() {
            if (isRecording) {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        // Отправка аудио на распознавание
        async function sendAudioForTranscription(audioBlob) {
            const input = document.getElementById('messageInput');
            
            // Показываем индикатор обработки
            input.placeholder = 'Обработка речи...';
            input.disabled = true;

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                
                const params = new URLSearchParams({
                    model: voiceSettings.model || 'base',
                    language: voiceSettings.autoDetectLanguage ? null : voiceSettings.language
                }).toString().replace(/=&|=$/g, '');

                const response = await fetch(API_BASE + `/api/voice/transcribe?${params}`, {
                    method: 'POST',
                    headers: authHeader(),
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Ошибка распознавания речи');
                }

                const result = await response.json();
                
                // Вставляем распознанный текст в поле ввода
                if (result.text && result.text.trim()) {
                    input.value = result.text.trim();
                    input.placeholder = 'Type your message...';
                    
                    // Опционально: автоматически отправляем сообщение
                    // sendMessage();
                } else {
                    input.placeholder = 'Речь не распознана, попробуйте еще раз';
                }

            } catch (error) {
                console.error('Ошибка распознавания речи:', error);
                input.placeholder = 'Ошибка распознавания: ' + error.message;
            } finally {
                input.disabled = false;
            }
        }
        // ====================================================================
        // ФУНКЦИИ ДЛЯ ИМПОРТА
        // ====================================================================
        
        let importAnalysisData = null;
        let importFileData = null;

        function openImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('importStep1').classList.remove('hidden');
            document.getElementById('importStep2').classList.add('hidden');
            document.getElementById('importFile').value = '';
            importAnalysisData = null;
            importFileData = null;
            if (window.feather) {
                feather.replace();
            }
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            importAnalysisData = null;
            importFileData = null;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                importFileData = file;
            }
        }

        async function analyzeImportFile() {
            if (!importFileData) {
                alert('Пожалуйста, выберите файл');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', importFileData);

                const response = await fetch(API_BASE + '/api/import/upload', {
                    method: 'POST',
                    headers: authHeader(),
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Ошибка при анализе файла');
                }

                importAnalysisData = await response.json();

                // Показываем шаг 2 с сопоставлением полей
                document.getElementById('importStep1').classList.add('hidden');
                document.getElementById('importStep2').classList.remove('hidden');

                // Заполняем контейнер сопоставления полей
                const container = document.getElementById('fieldMappingContainer');
                container.innerHTML = '';

                const allFields = [
                    'title', 'doc_num', 'stock_qty', 'mark', 'model', 'code_compl', 'vin',
                    'color', 'price', 'city', 'manufacture_year', 'fuel_type', 'power',
                    'body_type', 'gear_box_type', 'driving_gear_type', 'engine_vol',
                    'dealer_center', 'interior_color', 'engine', 'door_qty', 'pts_colour',
                    'model_year', 'fuel_consumption', 'max_torque', 'acceleration',
                    'max_speed', 'eco_class', 'dimensions', 'weight', 'cargo_volume',
                    'compl_level', 'interior_code', 'color_code', 'car_order_int_status',
                    'sale_price', 'max_additional_discount', 'max_discount_trade_in',
                    'max_discount_credit', 'max_discount_casko', 'max_discount_extra_gear',
                    'max_discount_life_insurance', 'mileage', 'date_begin', 'date_end',
                    'ad_status', 'allow_email', 'company_name', 'manager_name', 'contact_phone',
                    'category', 'region', 'car_type', 'accident', 'certification_number',
                    'allow_avtokod_report_link', 'doors', 'wheel_type', 'owners', 'street',
                    'sticker', 'generation_id', 'modification_id'
                ];

                for (const sourceField of importAnalysisData.available_fields) {
                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-4 p-3 bg-gray-50 rounded-lg';

                    const sourceLabel = document.createElement('label');
                    sourceLabel.className = 'flex-1 text-sm font-medium text-gray-700';
                    sourceLabel.textContent = sourceField;

                    const select = document.createElement('select');
                    select.className = 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500';
                    select.dataset.sourceField = sourceField;

                    // Добавляем опцию "Не импортировать"
                    const noneOption = document.createElement('option');
                    noneOption.value = '';
                    noneOption.textContent = 'Не импортировать';
                    select.appendChild(noneOption);

                    // Добавляем все доступные поля
                    for (const field of allFields) {
                        const option = document.createElement('option');
                        option.value = field;
                        option.textContent = field;
                        
                        // Автоматически выбираем сопоставленное поле
                        if (importAnalysisData.auto_mapping[sourceField] === field) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    }

                    row.appendChild(sourceLabel);
                    row.appendChild(select);
                    container.appendChild(row);
                }
            } catch (error) {
                console.error('Ошибка при анализе файла:', error);
                alert('Ошибка при анализе файла: ' + error.message);
            }
        }

        function backToStep1() {
            document.getElementById('importStep2').classList.add('hidden');
            document.getElementById('importStep1').classList.remove('hidden');
        }

        async function saveImport() {
            if (!importFileData || !importAnalysisData) {
                alert('Пожалуйста, сначала проанализируйте файл');
                return;
            }

            try {
                // Собираем сопоставление полей
                const fieldMapping = {};
                const selects = document.querySelectorAll('#fieldMappingContainer select');
                selects.forEach(select => {
                    const sourceField = select.dataset.sourceField;
                    const targetField = select.value || null;
                    fieldMapping[sourceField] = targetField;
                });

                const carType = document.getElementById('importCarType').value;

                // Создаем FormData для отправки файла и данных
                const formData = new FormData();
                formData.append('file', importFileData);
                formData.append('file_type', importAnalysisData.file_type);
                formData.append('car_type', carType);
                formData.append('field_mapping', JSON.stringify(fieldMapping));

                const response = await fetch(API_BASE + '/api/import/save', {
                    method: 'POST',
                    headers: authHeader(),  // Не добавляем Content-Type, браузер сам установит для FormData
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Ошибка при сохранении импорта');
                }

                const result = await response.json();

                alert(`Импорт завершен!\nИмпортировано автомобилей: ${result.imported_cars + result.imported_used_cars}\nИмпортировано фотографий: ${result.imported_pictures}\nИмпортировано опций: ${result.imported_options}`);
                
                closeImportModal();
                loadImportList();
            } catch (error) {
                console.error('Ошибка при сохранении импорта:', error);
                alert('Ошибка при сохранении импорта: ' + error.message);
            }
        }

        async function loadImportList() {
            try {
                const response = await fetch(API_BASE + '/api/import/list?limit=100', {
                    headers: authHeader()
                });

                if (!response.ok) {
                    throw new Error('Ошибка при загрузке списка импорта');
                }

                const data = await response.json();

                // Заполняем таблицу новых автомобилей
                const carsTbody = document.getElementById('importCarsTableBody');
                carsTbody.innerHTML = '';

                data.cars.forEach(car => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-car-id', car.id);
                    const statusClass = car.import_status === 'migrated' ? 'text-green-600' : 
                                       car.import_status === 'imported' ? 'text-blue-600' : 
                                       'text-red-600';
                    const statusText = car.import_status === 'migrated' ? 'Мигрирован' : 
                                     car.import_status === 'imported' ? 'Импортирован' : 
                                     'Ошибка';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="car-checkbox-new w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                                   value="${car.id}" onchange="updateSelectAllNewCars()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.mark || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.model || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.price || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.city || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                    `;
                    carsTbody.appendChild(row);
                });

                // Заполняем таблицу подержанных автомобилей
                const usedCarsTbody = document.getElementById('importUsedCarsTableBody');
                usedCarsTbody.innerHTML = '';

                data.used_cars.forEach(car => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-used-car-id', car.id);
                    const statusClass = car.import_status === 'migrated' ? 'text-green-600' : 
                                       car.import_status === 'imported' ? 'text-blue-600' : 
                                       'text-red-600';
                    const statusText = car.import_status === 'migrated' ? 'Мигрирован' : 
                                     car.import_status === 'imported' ? 'Импортирован' : 
                                     'Ошибка';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="car-checkbox-used w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" 
                                   value="${car.id}" onchange="updateSelectAllUsedCars()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.mark || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.model || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.price || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${car.mileage || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass}">${statusText}</td>
                    `;
                    usedCarsTbody.appendChild(row);
                });
            } catch (error) {
                console.error('Ошибка при загрузке списка импорта:', error);
                alert('Ошибка при загрузке списка импорта: ' + error.message);
            }
        }

        // Функции для работы с чекбоксами
        function toggleSelectAllNewCars(checkbox) {
            const checkboxes = document.querySelectorAll('.car-checkbox-new');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function updateSelectAllNewCars() {
            const checkboxes = document.querySelectorAll('.car-checkbox-new');
            const checked = document.querySelectorAll('.car-checkbox-new:checked');
            const selectAll = document.getElementById('selectAllNewCars');
            if (selectAll) {
                selectAll.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
            }
        }

        function toggleSelectAllUsedCars(checkbox) {
            const checkboxes = document.querySelectorAll('.car-checkbox-used');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function updateSelectAllUsedCars() {
            const checkboxes = document.querySelectorAll('.car-checkbox-used');
            const checked = document.querySelectorAll('.car-checkbox-used:checked');
            const selectAll = document.getElementById('selectAllUsedCars');
            if (selectAll) {
                selectAll.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
            }
        }

        // Удаление выбранных записей
        async function deleteSelectedImportRecords() {
            const selectedNewCars = Array.from(document.querySelectorAll('.car-checkbox-new:checked'))
                .map(cb => parseInt(cb.value));
            const selectedUsedCars = Array.from(document.querySelectorAll('.car-checkbox-used:checked'))
                .map(cb => parseInt(cb.value));

            if (selectedNewCars.length === 0 && selectedUsedCars.length === 0) {
                alert('Выберите записи для удаления');
                return;
            }

            if (!confirm(`Удалить выбранные записи? Новых: ${selectedNewCars.length}, Подержанных: ${selectedUsedCars.length}`)) {
                return;
            }

            try {
                const response = await fetch(API_BASE + '/api/import/delete', {
                    method: 'DELETE',
                    headers: {
                        ...authHeader(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        car_ids: selectedNewCars,
                        used_car_ids: selectedUsedCars
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка при удалении записей');
                }

                const data = await response.json();
                alert(data.message || 'Записи успешно удалены');
                loadImportList();
            } catch (error) {
                console.error('Ошибка при удалении записей:', error);
                alert('Ошибка при удалении записей');
            }
        }

        // Удаление всех записей
        async function deleteAllImportRecords() {
            if (!confirm('Вы уверены, что хотите удалить ВСЕ импортированные записи? Это действие нельзя отменить!')) {
                return;
            }

            try {
                const response = await fetch(API_BASE + '/api/import/delete', {
                    method: 'DELETE',
                    headers: {
                        ...authHeader(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        car_ids: [],
                        used_car_ids: []
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка при удалении всех записей');
                }

                const data = await response.json();
                alert(data.message || 'Все записи успешно удалены');
                loadImportList();
            } catch (error) {
                console.error('Ошибка при удалении всех записей:', error);
                alert('Ошибка при удалении всех записей');
            }
        }

        async function migrateImportData() {
            if (!confirm('Вы уверены, что хотите мигрировать данные? Это удалит все старые данные из основных таблиц и обновит индексы Elasticsearch.')) {
                return;
            }

            try {
                const response = await fetch(API_BASE + '/api/import/migrate', {
                    method: 'POST',
                    headers: {
                        ...authHeader(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        car_type: null,  // Мигрировать все
                        delete_old: true
                    })
                });

                if (!response.ok) {
                    throw new Error('Ошибка при миграции данных');
                }

                const result = await response.json();

                alert(`Миграция завершена!\nМигрировано новых автомобилей: ${result.migrated_cars}\nМигрировано подержанных: ${result.migrated_used_cars}\nМигрировано фотографий: ${result.migrated_pictures}\nМигрировано опций: ${result.migrated_options}\nУдалено старых: ${result.deleted_old_cars + result.deleted_old_used_cars}`);
                
                loadImportList();
            } catch (error) {
                console.error('Ошибка при миграции данных:', error);
                alert('Ошибка при миграции данных: ' + error.message);
            }
        }

    </script>
</body>
</html>
