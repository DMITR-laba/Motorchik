# Инструкция по импорту всех записей

## Проблема

При отправке данных на endpoint `/api/import/analyze` импортируются только 3 записи из `sample_records`, хотя всего записей 143.

## Решение

Вам нужно отправить **ВСЕ 143 записи** в теле запроса, а не только `sample_records`.

### Вариант 1: Отправить все записи в поле `records`

```json
{
  "total_records": 143,
  "records": [
    // ВСЕ 143 записи здесь
    {
      "text": "...",
      "url": "...",
      "title": "...",
      "language": "ru"
    },
    // ... остальные 142 записи
  ],
  "available_fields": ["url", "language", "title", "text"],
  "required_fields": ["title", "text", "url"],
  "field_mappings": [
    {"json_field": "title", "db_field": "title", "required": true},
    {"json_field": "text", "db_field": "text", "required": true},
    {"json_field": "url", "db_field": "url", "required": true},
    {"json_field": "language", "db_field": "language", "required": false}
  ]
}
```

### Вариант 2: Использовать тестовый скрипт

Я создал тестовый скрипт `test_import_all_records.py`, который можно использовать для импорта из JSON файла:

```bash
# Запустить с вашим JSON файлом
python test_import_all_records.py путь/к/вашему/файлу.json
```

### Вариант 3: Изменить клиентскую часть

Если вы отправляете данные из фронтенда, измените код так, чтобы отправлять все записи:

**Было (неправильно):**
```javascript
const data = {
  total_records: 143,
  sample_records: [/* только 3 записи */],
  // ...
};
```

**Стало (правильно):**
```javascript
const data = {
  total_records: allRecords.length,  // 143
  records: allRecords,  // ВСЕ 143 записи
  // ...
};
```

## Как получить все записи?

Если у вас есть API, который возвращает только sample_records, вам нужно:

1. **Найти endpoint**, который возвращает все записи (обычно с параметрами `limit` или `all=true`)
2. **Загрузить все записи** перед отправкой на импорт
3. **Отправить все записи** в поле `records`

### Пример на JavaScript/TypeScript:

```javascript
// 1. Получаем все записи из источника
const response = await fetch('ваш_api_endpoint?limit=1000');
const allData = await response.json();

// 2. Подготавливаем данные для импорта
const importData = {
  total_records: allData.length,
  records: allData,  // ВСЕ записи
  available_fields: ["url", "language", "title", "text"],
  required_fields: ["title", "text", "url"],
  field_mappings: [
    {json_field: "title", db_field: "title", required: true},
    {json_field: "text", db_field: "text", required: true},
    {json_field: "url", db_field: "url", required: true},
    {json_field: "language", db_field: "language", required: false}
  ]
};

// 3. Отправляем на импорт
const importResponse = await fetch('http://localhost:8000/api/import/analyze', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify(importData)
});

const result = await importResponse.json();
console.log(`Импортировано: ${result.imported_count} из ${result.total_records}`);
```

### Пример на Python:

```python
import requests

# 1. Получаем все записи
all_records_response = requests.get('ваш_api_endpoint?limit=1000')
all_records = all_records_response.json()

# 2. Отправляем на импорт
import_data = {
    "total_records": len(all_records),
    "records": all_records,  # ВСЕ записи
    "available_fields": ["url", "language", "title", "text"],
    "required_fields": ["title", "text", "url"],
    "field_mappings": [
        {"json_field": "title", "db_field": "title", "required": True},
        {"json_field": "text", "db_field": "text", "required": True},
        {"json_field": "url", "db_field": "url", "required": True},
        {"json_field": "language", "db_field": "language", "required": False}
    ]
}

response = requests.post(
    'http://localhost:8000/api/import/analyze',
    json=import_data,
    timeout=60
)

result = response.json()
print(f"Импортировано: {result['imported_count']} из {result['total_records']}")
```

## Что изменилось в коде

Я упростил логику в `backend/app/api/import_api.py`:

- **Раньше:** Код требовал строгого соответствия `total_records` и выбрасывал ошибку
- **Теперь:** Код импортирует все доступные записи из полей `records` или `sample_records`

## Проверка результата

После успешного импорта API вернет:

```json
{
  "success": true,
  "total_records": 143,
  "processed_records": 143,
  "imported_count": 143,
  "skipped_count": 0,
  "errors": null
}
```

## Устранение ошибки "[object Object]"

Эта ошибка возникает на клиентской стороне при попытке вывести объект ошибки как строку. Убедитесь, что на фронтенде обработка ошибок выглядит так:

```javascript
try {
  const response = await fetch(/* ... */);
  const data = await response.json();
  
  if (!response.ok) {
    // Правильно: извлекаем текст ошибки
    console.error('Ошибка:', data.detail || data.message || JSON.stringify(data));
    alert(`Ошибка: ${data.detail || data.message}`);
  } else {
    console.log('Успех:', data);
  }
} catch (error) {
  // Правильно: показываем читаемую ошибку
  console.error('Ошибка запроса:', error.message);
  alert(`Ошибка: ${error.message}`);
}
```

## Дополнительная помощь

Если у вас остались вопросы или нужна помощь в настройке клиентской части, дайте знать!


