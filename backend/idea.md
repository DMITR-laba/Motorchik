–ù—É–∂–Ω–æ —á—Ç–æ–±—ã –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —É–ø—Ä–∞–≤–ª—è–ª –≥–ª–∞–≤–Ω—ã–π –∏–∏ , –∫–æ—Ç–æ—Ä—ã–π –≤—ã–±–∏—Ä–∞–ª –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∏–∏ –º–æ–¥–µ–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π ollama –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—Ç–∞ –≥–∂–µ –æ–Ω —Ç—Ä–µ–±—É–µ—Ç—Å—è , –∫—Ä–æ–º–µ –º–µ—Å—Ç –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–∞–∑–Ω–∞—á–∞–µ—Ç –∏–∏ –º–æ–¥–µ–ª—å    


–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ–∞! –ü–µ—Ä–µ–¥–µ–ª–∞–µ–º —Å–∏—Å—Ç–µ–º—É –ø–æ–¥ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π. 

## üöó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Input Layer   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Context Manager ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Relation Analyzer‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Search Analyzer‚îÇ    ‚îÇ  Memory Manager  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Question Strategy‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Car DB Manager  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÇ Query Generator  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÇ Search Trigger   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Result Processor‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Response Builder ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Output Layer    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

```python
from langchain.chains import LLMChain
from langchain.prompts import PromptTemplate
from langchain.chat_models import ChatOpenAI
from langchain.schema import BaseOutputParser
from typing import List, Dict, Any, Tuple, Optional, Union
from dataclasses import dataclass
import os
import json
import re
from datetime import datetime
import time
import sqlite3
from abc import ABC, abstractmethod
import random

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à API-–∫–ª—é—á OpenAI
os.environ["OPENAI_API_KEY"] = "–≤–∞—à_api_–∫–ª—é—á"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)

### 1. üè¢ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

@dataclass
class CarDealerConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
    enabled: bool = True
    auto_search_threshold: float = 0.7
    max_results: int = 5
    search_domains: List[str] = None
    enable_finance_calculations: bool = True
    enable_trade_in: bool = True
    enable_test_drive: bool = True
    
    def __post_init__(self):
        if self.search_domains is None:
            self.search_domains = ["–ª–µ–≥–∫–æ–≤—ã–µ", "–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫–∏", "–ø—Ä–µ–º–∏—É–º", "—ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª–∏", "–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ"]

class Searchable(ABC):
    """–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
    
    @abstractmethod
    def search(self, query: Dict[str, Any]) -> List[Dict[str, Any]]:
        pass
    
    @abstractmethod
    def get_schema(self) -> Dict[str, Any]:
        pass

### 2. üóÉÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π

class CarDatabase(Searchable):
    """–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
    
    def __init__(self, db_path=":memory:"):
        self.conn = sqlite3.connect(db_path)
        self._initialize_database()
    
    def _initialize_database(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
        cursor = self.conn.cursor()
        
        # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS cars (
                id INTEGER PRIMARY KEY,
                brand TEXT NOT NULL,
                model TEXT NOT NULL,
                year INTEGER,
                price REAL,
                category TEXT,
                fuel_type TEXT,
                transmission TEXT,
                engine_volume REAL,
                power INTEGER,
                mileage INTEGER,
                color TEXT,
                features TEXT,
                available INTEGER,
                discount REAL,
                description TEXT
            )
        ''')
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        cars_data = [
            # –°–µ–¥–∞–Ω—ã
            (1, "Toyota", "Camry", 2023, 2500000, "—Å–µ–¥–∞–Ω", "–±–µ–Ω–∑–∏–Ω", "–∞–≤—Ç–æ–º–∞—Ç", 2.5, 249, 0, "–±–µ–ª—ã–π", "–∫–æ–∂–∞–Ω–Ω—ã–π —Å–∞–ª–æ–Ω, –∫–ª–∏–º–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å, –∫–∞–º–µ—Ä–∞ –∑–∞–¥–Ω–µ–≥–æ –≤–∏–¥–∞", 1, 0, "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–µ–¥–∞–Ω —Å –æ—Ç–ª–∏—á–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ—Å—Ç—å—é"),
            (2, "Hyundai", "Solaris", 2023, 1500000, "—Å–µ–¥–∞–Ω", "–±–µ–Ω–∑–∏–Ω", "–∞–≤—Ç–æ–º–∞—Ç", 1.6, 123, 0, "—á–µ—Ä–Ω—ã–π", "–º—É–ª—å—Ç–∏–º–µ–¥–∏–∞, –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä, –ø–æ–¥—É—à–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", 1, 5, "–ù–∞–¥–µ–∂–Ω—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π —Å–µ–¥–∞–Ω"),
            (3, "BMW", "3 Series", 2023, 3500000, "—Å–µ–¥–∞–Ω", "–±–µ–Ω–∑–∏–Ω", "–∞–≤—Ç–æ–º–∞—Ç", 2.0, 184, 0, "—Å–∏–Ω–∏–π", "–∫–æ–∂–∞, –ø–∞–Ω–æ—Ä–∞–º–Ω–∞—è –∫—Ä—ã—à–∞, –ø—Ä–µ–º–∏—É–º –∞—É–¥–∏–æ", 1, 0, "–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Å–µ–¥–∞–Ω –¥–ª—è –≤–∑—ã—Å–∫–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"),
            
            # –í–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫–∏
            (4, "Toyota", "RAV4", 2023, 2800000, "–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫", "–±–µ–Ω–∑–∏–Ω", "–∞–≤—Ç–æ–º–∞—Ç", 2.0, 150, 0, "—Å–µ—Ä—ã–π", "–ø–æ–ª–Ω—ã–π –ø—Ä–∏–≤–æ–¥, –∫–ª–∏–º–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å, –º—É–ª—å—Ç–∏–º–µ–¥–∏–∞", 1, 3, "–ü–æ–ø—É–ª—è—Ä–Ω—ã–π –∫—Ä–æ—Å—Å–æ–≤–µ—Ä –¥–ª—è –≥–æ—Ä–æ–¥–∞ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π"),
            (5, "Kia", "Sportage", 2023, 2200000, "–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫", "–¥–∏–∑–µ–ª—å", "–∞–≤—Ç–æ–º–∞—Ç", 2.0, 185, 0, "–∫—Ä–∞—Å–Ω—ã–π", "–ø–æ–ª–Ω—ã–π –ø—Ä–∏–≤–æ–¥, –ø–æ–¥–æ–≥—Ä–µ–≤ —Å–∏–¥–µ–Ω–∏–π, –∫–∞–º–µ—Ä–∞ 360", 1, 0, "–°—Ç–∏–ª—å–Ω—ã–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"),
            (6, "Land Rover", "Range Rover Evoque", 2023, 4500000, "–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫", "–±–µ–Ω–∑–∏–Ω", "–∞–≤—Ç–æ–º–∞—Ç", 2.0, 249, 0, "–±–µ–ª—ã–π", "–ø—Ä–µ–º–∏—É–º –æ—Ç–¥–µ–ª–∫–∞, –ø–æ–ª–Ω—ã–π –ø—Ä–∏–≤–æ–¥, –≤—Å–µ –æ–ø—Ü–∏–∏", 1, 7, "–†–æ—Å–∫–æ—à–Ω—ã–π –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"),
            
            # –•—ç—Ç—á–±–µ–∫–∏
            (7, "Volkswagen", "Golf", 2023, 1800000, "—Ö—ç—Ç—á–±–µ–∫", "–±–µ–Ω–∑–∏–Ω", "–º–µ—Ö–∞–Ω–∏–∫–∞", 1.4, 150, 0, "–∫—Ä–∞—Å–Ω—ã–π", "–∫—Ä—É–∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª—å, –º—É–ª—å—Ç–∏–º–µ–¥–∏–∞, –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä", 1, 0, "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ö—ç—Ç—á–±–µ–∫ —Å –æ—Ç–ª–∏—á–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–æ–π"),
            (8, "Kia", "Rio X", 2023, 1400000, "—Ö—ç—Ç—á–±–µ–∫", "–±–µ–Ω–∑–∏–Ω", "–∞–≤—Ç–æ–º–∞—Ç", 1.6, 123, 0, "–æ—Ä–∞–Ω–∂–µ–≤—ã–π", "–º—É–ª—å—Ç–∏–º–µ–¥–∏–∞, –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä, –¥–∞—Ç—á–∏–∫–∏ –ø–∞—Ä–∫–æ–≤–∫–∏", 1, 8, "–≠–∫–æ–Ω–æ–º–∏—á–Ω—ã–π –≥–æ—Ä–æ–¥—Å–∫–æ–π —Ö—ç—Ç—á–±–µ–∫"),
            
            # –≠–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª–∏
            (9, "Tesla", "Model 3", 2023, 3800000, "—Å–µ–¥–∞–Ω", "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", "–∞–≤—Ç–æ–º–∞—Ç", 0, 283, 0, "–±–µ–ª—ã–π", "–∞–≤—Ç–æ–ø–∏–ª–æ—Ç, –ø—Ä–µ–º–∏—É–º –∞—É–¥–∏–æ, —Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è –∫—Ä—ã—à–∞", 1, 0, "–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—å"),
            (10, "Nissan", "Leaf", 2023, 2200000, "—Ö—ç—Ç—á–±–µ–∫", "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", "–∞–≤—Ç–æ–º–∞—Ç", 0, 150, 0, "—Å–∏–Ω–∏–π", "–º—É–ª—å—Ç–∏–º–µ–¥–∏–∞, –∫–ª–∏–º–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å, –±—ã—Å—Ç—Ä–∞—è –∑–∞—Ä—è–¥–∫–∞", 1, 5, "–î–æ—Å—Ç—É–ø–Ω—ã–π —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—å –¥–ª—è –≥–æ—Ä–æ–¥–∞"),
            
            # –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ
            (11, "Volkswagen", "Transporter", 2023, 3200000, "—Ñ—É—Ä–≥–æ–Ω", "–¥–∏–∑–µ–ª—å", "–º–µ—Ö–∞–Ω–∏–∫–∞", 2.0, 150, 0, "–±–µ–ª—ã–π", "–∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä, –º—É–ª—å—Ç–∏–º–µ–¥–∏–∞, —É—Å–∏–ª–µ–Ω–Ω–∞—è –ø–æ–¥–≤–µ—Å–∫–∞", 1, 0, "–ù–∞–¥–µ–∂–Ω—ã–π –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π —Ñ—É—Ä–≥–æ–Ω"),
            (12, "Ford", "Transit", 2023, 2800000, "—Ñ—É—Ä–≥–æ–Ω", "–¥–∏–∑–µ–ª—å", "–∞–≤—Ç–æ–º–∞—Ç", 2.0, 170, 0, "—Å–µ—Ä—ã–π", "–∫—Ä—É–∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª—å, –∫–ª–∏–º–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å, –∫–∞–º–µ—Ä–∞", 1, 4, "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å"),
        ]
        
        cursor.executemany('''
            INSERT OR REPLACE INTO cars 
            (id, brand, model, year, price, category, fuel_type, transmission, 
             engine_volume, power, mileage, color, features, available, discount, description)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', cars_data)
        
        self.conn.commit()
    
    def search(self, query: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ü–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º"""
        try:
            conditions = []
            params = []
            
            if query.get("brand"):
                conditions.append("brand LIKE ?")
                params.append(f"%{query['brand']}%")
            
            if query.get("category"):
                conditions.append("category = ?")
                params.append(query["category"])
            
            if query.get("min_price"):
                conditions.append("price >= ?")
                params.append(query["min_price"])
            
            if query.get("max_price"):
                conditions.append("price <= ?")
                params.append(query["max_price"])
            
            if query.get("fuel_type"):
                conditions.append("fuel_type = ?")
                params.append(query["fuel_type"])
            
            if query.get("transmission"):
                conditions.append("transmission = ?")
                params.append(query["transmission"])
            
            if query.get("min_year"):
                conditions.append("year >= ?")
                params.append(query["min_year"])
            
            # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö
            if query.get("keywords"):
                keywords = query["keywords"].split(",")
                keyword_conditions = []
                for keyword in keywords:
                    keyword_conditions.append("(description LIKE ? OR features LIKE ? OR model LIKE ?)")
                    params.extend([f"%{keyword.strip()}%", f"%{keyword.strip()}%", f"%{keyword.strip()}%"])
                conditions.append(f"({' OR '.join(keyword_conditions)})")
            
            where_clause = " AND ".join(conditions) if conditions else "1=1"
            sql = f"SELECT * FROM cars WHERE {where_clause} AND available = 1 ORDER BY price ASC LIMIT 20"
            
            cursor = self.conn.cursor()
            cursor.execute(sql, params)
            results = cursor.fetchall()
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ª–æ–≤–∞—Ä–∏
            columns = [desc[0] for desc in cursor.description]
            cars = [dict(zip(columns, row)) for row in results]
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            for car in cars:
                if car.get('discount', 0) > 0:
                    car['original_price'] = car['price']
                    car['price'] = car['price'] * (1 - car['discount'] / 100)
                    car['price'] = round(car['price'], 2)
            
            return cars
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ –ë–î –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π: {e}")
            return []
    
    def get_schema(self) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        return {
            "table": "cars",
            "columns": [
                {"name": "brand", "type": "TEXT", "description": "–ú–∞—Ä–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"},
                {"name": "model", "type": "TEXT", "description": "–ú–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è"},
                {"name": "year", "type": "INTEGER", "description": "–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞"},
                {"name": "price", "type": "REAL", "description": "–¶–µ–Ω–∞ (—Ä—É–±–ª–∏)"},
                {"name": "category", "type": "TEXT", "description": "–¢–∏–ø –∫—É–∑–æ–≤–∞"},
                {"name": "fuel_type", "type": "TEXT", "description": "–¢–∏–ø —Ç–æ–ø–ª–∏–≤–∞"},
                {"name": "transmission", "type": "TEXT", "description": "–¢–∏–ø –ö–ü–ü"},
                {"name": "engine_volume", "type": "REAL", "description": "–û–±—ä–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª—è (–ª)"},
                {"name": "power", "type": "INTEGER", "description": "–ú–æ—â–Ω–æ—Å—Ç—å (–ª.—Å.)"},
                {"name": "color", "type": "TEXT", "description": "–¶–≤–µ—Ç"},
                {"name": "features", "type": "TEXT", "description": "–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è"},
                {"name": "discount", "type": "REAL", "description": "–°–∫–∏–¥–∫–∞ (%)"}
            ]
        }
    
    def get_available_brands(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä–æ–∫"""
        cursor = self.conn.cursor()
        cursor.execute("SELECT DISTINCT brand FROM cars WHERE available = 1 ORDER BY brand")
        return [row[0] for row in cursor.fetchall()]
    
    def get_available_categories(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π"""
        cursor = self.conn.cursor()
        cursor.execute("SELECT DISTINCT category FROM cars WHERE available = 1 ORDER BY category")
        return [row[0] for row in cursor.fetchall()]

class FinanceDatabase(Searchable):
    """–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"""
    
    def __init__(self):
        self.credit_offers = [
            {
                "id": 1, "bank": "–°–±–µ—Ä–±–∞–Ω–∫", "rate": 8.5, "min_down_payment": 15, 
                "max_period": 60, "special_conditions": "–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–≤–æ–¥ –æ—Ç 15%"
            },
            {
                "id": 2, "bank": "–í–¢–ë", "rate": 9.2, "min_down_payment": 10, 
                "max_period": 84, "special_conditions": "–°–∫–∏–¥–∫–∞ 0.5% –ø—Ä–∏ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–∏"
            },
            {
                "id": 3, "bank": "–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫", "rate": 8.9, "min_down_payment": 20, 
                "max_period": 60, "special_conditions": "–õ—å–≥–æ—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –¥–ª—è –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"
            },
            {
                "id": 4, "bank": "–¢–∏–Ω—å–∫–æ—Ñ—Ñ", "rate": 9.5, "min_down_payment": 0, 
                "max_period": 72, "special_conditions": "–û–Ω–ª–∞–π–Ω –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞ 5 –º–∏–Ω—É—Ç"
            }
        ]
    
    def search(self, query: Dict[str, Any]) -> List[Dict[str, Any]]:
        """–ü–æ–∏—Å–∫ –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"""
        results = self.credit_offers
        
        if query.get("max_rate"):
            results = [r for r in results if r["rate"] <= query["max_rate"]]
        
        if query.get("min_period"):
            results = [r for r in results if r["max_period"] >= query["min_period"]]
        
        if query.get("max_down_payment"):
            results = [r for r in results if r["min_down_payment"] <= query["max_down_payment"]]
        
        return sorted(results, key=lambda x: x["rate"])[:5]
    
    def get_schema(self) -> Dict[str, Any]:
        return {
            "table": "credit_offers",
            "columns": [
                {"name": "bank", "type": "TEXT", "description": "–ë–∞–Ω–∫"},
                {"name": "rate", "type": "REAL", "description": "–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (%)"},
                {"name": "min_down_payment", "type": "REAL", "description": "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å (%)"},
                {"name": "max_period", "type": "INTEGER", "description": "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ (–º–µ—Å—è—Ü–µ–≤)"},
                {"name": "special_conditions", "type": "TEXT", "description": "–û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è"}
            ]
        }

### 3. üîç –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

class CarSearchAnalyzer:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"""
    
    def __init__(self, dealer_config: CarDealerConfig):
        self.config = dealer_config
        self.search_intent_prompt = PromptTemplate(
            input_variables=["user_query", "dialogue_history", "current_topic"],
            template="""
            –í—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ:
            1. –ù—É–∂–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            2. –ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ–º–æ–±–∏–ª—è –º–æ–∂–Ω–æ –∏–∑–≤–ª–µ—á—å
            3. –ù—É–∂–Ω–∞ –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—é

            –î–û–°–¢–£–ü–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò: {categories}

            –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê:
            {dialogue_history}

            –¢–ï–ö–£–©–ê–Ø –¢–ï–ú–ê: {current_topic}

            –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}

            –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π:
            - "—Ö–æ—á—É –º–∞—à–∏–Ω—É", "–∏—â—É –∞–≤—Ç–æ–º–æ–±–∏–ª—å", "–ø–æ–¥–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ", "–ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ"
            - —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –º–∞—Ä–∫–∏, –º–æ–¥–µ–ª–∏, —Ç–∏–ø–∞ –∫—É–∑–æ–≤–∞
            - –±—é–¥–∂–µ—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º

            –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è:
            - "–∫—Ä–µ–¥–∏—Ç", "—Ä–∞—Å—Å—Ä–æ—á–∫–∞", "–ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å", "–ª–∏–∑–∏–Ω–≥"
            - "—Å–∫–æ–ª—å–∫–æ –≤ –º–µ—Å—è—Ü", "–ø–ª–∞—Ç–µ–∂–∏", "—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ"

            –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "search_required": true/false,
                "confidence": 0.85,
                "search_type": "–∞–≤—Ç–æ–º–æ–±–∏–ª–∏/—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ",
                "search_parameters": {{
                    "brand": "Toyota",
                    "category": "–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫", 
                    "max_price": 2000000,
                    "fuel_type": "–±–µ–Ω–∑–∏–Ω"
                }},
                "finance_required": true/false,
                "missing_parameters": ["–±—é–¥–∂–µ—Ç", "—Ç–∏–ø –∫—É–∑–æ–≤–∞"],
                "reasoning": "–ö–ª–∏–µ–Ω—Ç –∏—â–µ—Ç –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ Toyota –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 2 –º–ª–Ω —Ä—É–±–ª–µ–π"
            }}
            """
        )
        self.llm = llm
    
    def analyze_search_intent(self, user_query: str, dialogue_history: str, current_topic: str, available_categories: List[str]) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
        try:
            chain = LLMChain(llm=self.llm, prompt=self.search_intent_prompt)
            response = chain.run(
                user_query=user_query,
                dialogue_history=dialogue_history,
                current_topic=current_topic,
                categories=", ".join(available_categories)
            )
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group())
                return result
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –Ω–∞–º–µ—Ä–µ–Ω–∏—è: {e}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return {
            "search_required": False,
            "confidence": 0.0,
            "search_type": None,
            "search_parameters": {},
            "finance_required": False,
            "missing_parameters": [],
            "reasoning": "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å"
        }
    
    def should_perform_search(self, search_intent: Dict[str, Any]) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–∏—Å–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞"""
        if not search_intent["search_required"]:
            return False
        
        confidence = search_intent.get("confidence", 0)
        return confidence >= self.config.auto_search_threshold

### 4. üßÆ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä

class FinanceCalculator:
    """–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫—Ä–µ–¥–∏—Ç–æ–≤ –∏ –ø–ª–∞—Ç–µ–∂–µ–π"""
    
    def calculate_loan(self, car_price: float, down_payment: float, interest_rate: float, loan_term: int) -> Dict[str, Any]:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫—Ä–µ–¥–∏—Ç–∞"""
        try:
            loan_amount = car_price - down_payment
            if loan_amount <= 0:
                return {"error": "–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è"}
            
            monthly_rate = interest_rate / 100 / 12
            monthly_payment = loan_amount * (monthly_rate * (1 + monthly_rate) ** loan_term) / ((1 + monthly_rate) ** loan_term - 1)
            total_payment = monthly_payment * loan_term
            total_interest = total_payment - loan_amount
            
            return {
                "loan_amount": round(loan_amount, 2),
                "monthly_payment": round(monthly_payment, 2),
                "total_payment": round(total_payment, 2),
                "total_interest": round(total_interest, 2),
                "loan_term": loan_term,
                "interest_rate": interest_rate
            }
        except Exception as e:
            return {"error": f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞: {str(e)}"}
    
    def calculate_lease(self, car_price: float, residual_value: float, lease_term: int) -> Dict[str, Any]:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏–∑–∏–Ω–≥–∞"""
        try:
            monthly_lease = (car_price - residual_value) / lease_term
            return {
                "monthly_lease": round(monthly_lease, 2),
                "residual_value": residual_value,
                "lease_term": lease_term
            }
        except Exception as e:
            return {"error": f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ª–∏–∑–∏–Ω–≥–∞: {str(e)}"}

### 5. üóÉÔ∏è –ú–µ–Ω–µ–¥–∂–µ—Ä –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

class CarDealerDatabaseManager:
    """–£–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
    
    def __init__(self, dealer_config: CarDealerConfig):
        self.config = dealer_config
        self.databases = {}
        self.finance_calculator = FinanceCalculator()
        self._initialize_databases()
    
    def _initialize_databases(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
        if self.config.enabled:
            self.databases["–∞–≤—Ç–æ–º–æ–±–∏–ª–∏"] = CarDatabase()
            self.databases["—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ"] = FinanceDatabase()
    
    def search(self, domain: str, parameters: Dict[str, Any]) -> Dict[str, Any]:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
        if domain not in self.databases:
            return {
                "success": False,
                "error": f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ–º–µ–Ω–∞ '{domain}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
                "results": []
            }
        
        try:
            database = self.databases[domain]
            results = database.search(parameters)
            
            # –î–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if domain == "–∞–≤—Ç–æ–º–æ–±–∏–ª–∏" and parameters.get("calculate_finance"):
                for car in results:
                    if parameters.get("down_payment") and parameters.get("loan_term"):
                        car["finance_calculation"] = self.finance_calculator.calculate_loan(
                            car["price"], 
                            parameters["down_payment"], 
                            9.0,  # –°—Ä–µ–¥–Ω—è—è —Å—Ç–∞–≤–∫–∞
                            parameters["loan_term"]
                        )
            
            return {
                "success": True,
                "domain": domain,
                "parameters": parameters,
                "results": results[:self.config.max_results],
                "total_found": len(results),
                "returned": min(len(results), self.config.max_results)
            }
        except Exception as e:
            return {
                "success": False,
                "error": str(e),
                "results": []
            }
    
    def get_available_brands(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Ä–æ–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
        if "–∞–≤—Ç–æ–º–æ–±–∏–ª–∏" in self.databases:
            return self.databases["–∞–≤—Ç–æ–º–æ–±–∏–ª–∏"].get_available_brands()
        return []
    
    def get_available_categories(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
        if "–∞–≤—Ç–æ–º–æ–±–∏–ª–∏" in self.databases:
            return self.databases["–∞–≤—Ç–æ–º–æ–±–∏–ª–∏"].get_available_categories()
        return []
    
    def calculate_finance_for_car(self, car_price: float, down_payment_percent: float = 20, loan_term: int = 60) -> Dict[str, Any]:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è"""
        down_payment = car_price * down_payment_percent / 100
        return self.finance_calculator.calculate_loan(car_price, down_payment, 9.0, loan_term)

### 6. üéØ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

class CarQueryGenerator:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ —É—Ç–æ—á–Ω—è–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
    
    def __init__(self):
        self.query_refinement_prompt = PromptTemplate(
            input_variables=["initial_parameters", "dialogue_history", "missing_info", "available_brands", "available_categories"],
            template="""
            –í—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞. –ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤,
            —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É—Ç–æ—á–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è.

            –î–û–°–¢–£–ü–ù–´–ï –ú–ê–†–ö–ò: {available_brands}
            –î–û–°–¢–£–ü–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò: {available_categories}

            –ü–ï–†–í–û–ù–ê–ß–ê–õ–¨–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´: {initial_parameters}

            –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–ê –° –ö–õ–ò–ï–ù–¢–û–ú:
            {dialogue_history}

            –ù–ï–î–û–°–¢–ê–Æ–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø: {missing_info}

            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –∏ –∏–∑–≤–ª–µ–∫–∏—Ç–µ:
            - –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –º–∞—Ä–∫–µ –∏ –º–æ–¥–µ–ª–∏
            - –ë—é–¥–∂–µ—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
            - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–∏–ø—É –∫—É–∑–æ–≤–∞, —Ç–æ–ø–ª–∏–≤—É, –ö–ü–ü
            - –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
            - –°–µ–º–µ–π–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ—Ç–∏)

            –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø–æ–∏—Å–∫–∞:
            {{
                "brand": "–º–∞—Ä–∫–∞",
                "category": "—Ç–∏–ø –∫—É–∑–æ–≤–∞", 
                "min_price": —á–∏—Å–ª–æ,
                "max_price": —á–∏—Å–ª–æ,
                "fuel_type": "—Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞",
                "transmission": "—Ç–∏–ø –∫–ø–ø",
                "min_year": –≥–æ–¥,
                "keywords": "–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é",
                "customer_profile": "—Å–µ–º—å—è/–±–∏–∑–Ω–µ—Å/–º–æ–ª–æ–¥–µ–∂—å",
                "usage_type": "–≥–æ—Ä–æ–¥/–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è/—Ä–∞–±–æ—Ç–∞"
            }}
            """
        )
        self.llm = llm
    
    def refine_search_parameters(self, initial_params: Dict, dialogue_history: str, 
                               missing_info: List[str] = None, available_brands: List[str] = None,
                               available_categories: List[str] = None) -> Dict[str, Any]:
        """–£—Ç–æ—á–Ω—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            chain = LLMChain(llm=self.llm, prompt=self.query_refinement_prompt)
            response = chain.run(
                initial_parameters=json.dumps(initial_params, ensure_ascii=False),
                dialogue_history=dialogue_history,
                missing_info=", ".join(missing_info) if missing_info else "–ù–µ —É–∫–∞–∑–∞–Ω–æ",
                available_brands=", ".join(available_brands) if available_brands else "–í—Å–µ –º–∞—Ä–∫–∏",
                available_categories=", ".join(available_categories) if available_categories else "–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
            )
            
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                refined_params = json.loads(json_match.group())
                # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                return {**initial_params, **refined_params}
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞: {e}")
        
        return initial_params
    
    def identify_missing_parameters(self, search_type: str, current_params: Dict) -> List[str]:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞"""
        missing = []
        
        if search_type == "–∞–≤—Ç–æ–º–æ–±–∏–ª–∏":
            if not current_params.get("max_price"):
                missing.append("–±—é–¥–∂–µ—Ç")
            if not current_params.get("category"):
                missing.append("—Ç–∏–ø –∫—É–∑–æ–≤–∞")
            if not current_params.get("brand") and not current_params.get("keywords"):
                missing.append("–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –º–∞—Ä–∫–µ –∏–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º")
        
        elif search_type == "—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ":
            if not current_params.get("max_price"):
                missing.append("—Å—Ç–æ–∏–º–æ—Å—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—è")
            if not current_params.get("down_payment"):
                missing.append("–ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å")
        
        return missing

### 7. üìä –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

class CarResultProcessor:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
    
    def __init__(self):
        self.summarization_prompt = PromptTemplate(
            input_variables=["search_results", "search_parameters", "user_query"],
            template="""
            –í—ã - –ø—Ä–æ–¥–∞–≤–µ—Ü –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏ —Å–æ–∑–¥–∞–π—Ç–µ 
            –ø–æ–Ω—è—Ç–Ω—É—é —Å–≤–æ–¥–∫—É –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.

            –ü–ê–†–ê–ú–ï–¢–†–´ –ü–û–ò–°–ö–ê –ö–õ–ò–ï–ù–¢–ê: {search_parameters}
            –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}
            –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê: {search_results}

            –°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É, –∫–æ—Ç–æ—Ä–∞—è:
            1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
            2. –°–æ–æ–±—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            3. –í—ã–¥–µ–ª—è–µ—Ç 2-3 –ª—É—á—à–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å –∏—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏
            4. –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã

            –£—á–∏—Ç—ã–≤–∞–π—Ç–µ:
            - –ë—é–¥–∂–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞
            - –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
            - –°–µ–º–µ–π–Ω—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
            - –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

            –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
            {{
                "summary": "–¢–µ–∫—Å—Ç —Å–≤–æ–¥–∫–∏",
                "top_recommendations": [
                    {{
                        "brand": "–ú–∞—Ä–∫–∞",
                        "model": "–ú–æ–¥–µ–ª—å", 
                        "price": "–¶–µ–Ω–∞",
                        "key_features": ["–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å1", "–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å2"],
                        "advantages": "–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞",
                        "reason": "–ø–æ—á–µ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ"
                    }}
                ],
                "suggested_refinements": ["—É—Ç–æ—á–Ω–µ–Ω–∏–µ 1", "—É—Ç–æ—á–Ω–µ–Ω–∏–µ 2"],
                "next_questions": ["–≤–æ–ø—Ä–æ—Å 1", "–≤–æ–ø—Ä–æ—Å 2"],
                "finance_options": "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏ –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ"
            }}
            """
        )
        self.llm = llm
    
    def process_search_results(self, search_results: Dict, user_query: str) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ —Å—É–º–º–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
        if not search_results["success"] or not search_results["results"]:
            return self._handle_no_results(search_results, user_query)
        
        try:
            chain = LLMChain(llm=self.llm, prompt=self.summarization_prompt)
            response = chain.run(
                search_results=json.dumps(search_results["results"][:5], ensure_ascii=False),
                search_parameters=json.dumps(search_results["parameters"], ensure_ascii=False),
                user_query=user_query
            )
            
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                summary = json.loads(json_match.group())
                return {
                    "success": True,
                    "search_performed": True,
                    "results_summary": summary,
                    "raw_results": search_results["results"],
                    "total_found": search_results["total_found"]
                }
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {e}")
        
        # Fallback –æ–±—Ä–∞–±–æ—Ç–∫–∞
        return self._create_fallback_summary(search_results, user_query)
    
    def _handle_no_results(self, search_results: Dict, user_query: str) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"""
        error_msg = search_results.get("error", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
        
        return {
            "success": False,
            "search_performed": True,
            "results_summary": {
                "summary": f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. {error_msg}",
                "top_recommendations": [],
                "suggested_refinements": [
                    "–†–∞—Å—à–∏—Ä—å—Ç–µ –±—é–¥–∂–µ—Ç",
                    "–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –¥—Ä—É–≥–∏–µ –º–∞—Ä–∫–∏",
                    "–ò–∑–º–µ–Ω–∏—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–∏–ø—É –∫—É–∑–æ–≤–∞"
                ],
                "next_questions": [
                    "–ú–æ–∂–µ—Ç –±—ã—Ç—å, —É–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç?",
                    "–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π?"
                ],
                "finance_options": "–í–æ–∑–º–æ–∂–Ω–æ, –≤–∞–º –ø–æ–¥–æ–π–¥—É—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã trade-in –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"
            },
            "raw_results": [],
            "total_found": 0
        }
    
    def _create_fallback_summary(self, search_results: Dict, user_query: str) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é —Å–≤–æ–¥–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        results = search_results["results"]
        params = search_results["parameters"]
        
        summary = f"–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∞–π–¥–µ–Ω–æ {len(results)} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.\n\n"
        
        if results:
            summary += "–õ—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:\n"
            for i, car in enumerate(results[:3], 1):
                price_info = f"{car['price']:,.0f} —Ä—É–±.".replace(',', ' ')
                if car.get('original_price'):
                    original = f"{car['original_price']:,.0f} —Ä—É–±.".replace(',', ' ')
                    price_info = f"{price_info} (—Å–∫–∏–¥–∫–∞ {car['discount']}% —Å {original})"
                
                summary += f"{i}. {car['brand']} {car['model']} - {price_info}\n"
                summary += f"   {car['category']}, {car['fuel_type']}, {car['transmission']}\n"
                if car.get('description'):
                    summary += f"   {car['description']}\n"
                summary += "\n"
        
        return {
            "success": True,
            "search_performed": True,
            "results_summary": {
                "summary": summary,
                "top_recommendations": [],
                "suggested_refinements": ["–£—Ç–æ—á–Ω–∏—Ç—å –±—é–¥–∂–µ—Ç", "–í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –º–∞—Ä–∫—É", "–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è —Å —Ç–∏–ø–æ–º –∫—É–∑–æ–≤–∞"],
                "next_questions": ["–ö–∞–∫–æ–π –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤–∞—Å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª?", "–ù—É–∂–Ω–∞ –ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏—é?"],
                "finance_options": "–î–æ—Å—Ç—É–ø–Ω—ã –∫—Ä–µ–¥–∏—Ç–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ—Ç 8.5% –≥–æ–¥–æ–≤—ã—Ö"
            },
            "raw_results": results,
            "total_found": len(results)
        }

### 8. üöó –ì–ª–∞–≤–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

class CarDealerAssistant:
    """–ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
    
    def __init__(self, dealer_config: CarDealerConfig = None):
        self.config = dealer_config or CarDealerConfig()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.history = DialogueHistory()
        self.relation_analyzer = RelationAnalyzer()
        self.context_manager = ContextManager(AgentConfig())  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        
        # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞
        self.search_analyzer = CarSearchAnalyzer(self.config)
        self.database_manager = CarDealerDatabaseManager(self.config)
        self.query_generator = CarQueryGenerator()
        self.result_processor = CarResultProcessor()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ü–µ–ø–æ—á–µ–∫
        self.question_chains = self._initialize_question_chains()
        self.answer_chain = self._initialize_answer_chain()
        
        print("üöó –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
        print(f"   –î–æ—Å—Ç—É–ø–Ω–æ –º–∞—Ä–æ–∫: {len(self.database_manager.get_available_brands())}")
        print(f"   –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: {', '.join(self.database_manager.get_available_categories())}")
    
    def _initialize_question_chains(self) -> Dict[str, LLMChain]:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ü–µ–ø–æ—á–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
        prompts = {
            "car_search": PromptTemplate(
                input_variables=["user_query", "primary_context", "covered_topics", "current_topic", "search_context", "available_brands", "available_categories"],
                template="""
                –í—ã - –ø—Ä–æ–¥–∞–≤–µ—Ü –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.

                –î–û–°–¢–£–ü–ù–´–ï –ú–ê–†–ö–ò: {available_brands}
                –î–û–°–¢–£–ü–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò: {available_categories}

                –ö–û–ù–¢–ï–ö–°–¢: {primary_context}
                {search_context}

                –ü–†–ï–î–´–î–£–©–ò–ï –£–¢–û–ß–ù–ï–ù–ò–Ø: {covered_topics}

                –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}

                –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ 2-3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç:
                - –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±—é–¥–∂–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞
                - –í—ã—è—Å–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –º–∞—Ä–∫–µ –∏ –º–æ–¥–µ–ª–∏
                - –£—Ç–æ—á–Ω–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—é
                - –ü–æ–Ω—è—Ç—å —Ü–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

                –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):
                """
            ),
            "finance": PromptTemplate(
                input_variables=["user_query", "primary_context", "car_details"],
                template="""
                –í—ã - —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—é.

                –ö–û–ù–¢–ï–ö–°–¢: {primary_context}
                {car_details}

                –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}

                –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ 2-3 –≤–æ–ø—Ä–æ—Å–∞ –æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏:
                - –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å
                - –°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞
                - –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂
                - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏

                –í–æ–ø—Ä–æ—Å—ã –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—é (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):
                """
            )
        }
        
        return {key: LLMChain(llm=llm, prompt=prompt, output_parser=QuestionOutputParser()) 
                for key, prompt in prompts.items()}
    
    def _initialize_answer_chain(self) -> LLMChain:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ü–µ–ø–æ—á–∫—É –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
        answer_prompt = PromptTemplate(
            input_variables=["question", "context", "relation_type", "search_results", "car_context"],
            template="""
            –ö–∞–∫ –∫–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å.

            –ö–û–ù–¢–ï–ö–°–¢ –ê–í–¢–û–°–ê–õ–û–ù–ê: {car_context}
            {search_results}
            –í–û–ü–†–û–° –ü–†–û–î–ê–í–¶–ê: {question}

            –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ:
            - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤—ã–±–æ—Ä–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
            - –í—ã—Ä–∞–∂–∞—é—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏–ª–∏ —Å–æ–º–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
            - –Ø–≤–ª—è—é—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–º–∏

            –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.

            –û—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞:
            """
        )
        return LLMChain(llm=llm, prompt=answer_prompt, output_parser=AnswerOutputParser())
    
    def process_query(self, user_query: str) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
        start_time = time.time()
        
        print(f"\n{'='*70}")
        print(f"üöó –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}")
        print(f"{'='*70}")
        
        # –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–º—ã
        query_topic = self.history.detect_topic(user_query)
        print(f"üè∑Ô∏è  –¢–µ–º–∞: {query_topic}")
        
        # –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
        dialogue_context = self.history.get_recent_context()
        previous_topics = self.history.topics
        
        is_related, relation_type, confidence = self.relation_analyzer.analyze_relation(
            user_query, dialogue_context, previous_topics
        )
        
        print(f"üîó –°–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å: {is_related} (—Ç–∏–ø: {relation_type}, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence:.2f})")
        
        # –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
        available_brands = self.database_manager.get_available_brands()
        available_categories = self.database_manager.get_available_categories()
        
        search_intent = self.search_analyzer.analyze_search_intent(
            user_query, dialogue_context, self.history.current_topic or query_topic, available_categories
        )
        
        search_performed = False
        search_results = None
        search_context = ""
        car_context = f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä–∫–∏: {', '.join(available_brands)}\n–ö–∞—Ç–µ–≥–æ—Ä–∏–∏: {', '.join(available_categories)}"
        
        if search_intent["search_required"]:
            print(f"üîé –ü–æ–∏—Å–∫–æ–≤–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ: {search_intent['search_type']} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {search_intent['confidence']:.2f})")
            
            if self.search_analyzer.should_perform_search(search_intent):
                # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
                search_results = self._perform_search(search_intent, dialogue_context, available_brands, available_categories)
                search_performed = True
                
                if search_results and search_results.get("success"):
                    found_count = search_results['total_found']
                    domain = search_intent['search_type']
                    search_context = f"\n–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê: –ù–∞–π–¥–µ–Ω–æ {found_count} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '{domain}'\n"
                else:
                    search_context = "\n–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê: –ü–æ –∑–∞–¥–∞–Ω–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ\n"
        
        # –®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞
        questions = self._generate_questions(
            user_query, relation_type, dialogue_context, query_topic, 
            search_context, search_results, available_brands, available_categories
        )
        
        # –®–∞–≥ 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
        results = []
        for question in questions:
            answers = self.answer_chain.run(
                question=question,
                context=dialogue_context,
                relation_type=relation_type,
                search_results=search_context,
                car_context=car_context
            )
            results.append({
                "question": question,
                "hypothetical_answers": answers
            })
        
        # –®–∞–≥ 6: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        if not is_related or relation_type in ["new_topic", "topic_change"]:
            history_topic = query_topic
        else:
            history_topic = self.history.current_topic
        
        # –®–∞–≥ 7: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        self.history.add_message(
            "client", user_query, 
            topic=history_topic,
            search_data=search_intent if search_intent["search_required"] else None
        )
        
        assistant_content = f"–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ø–æ–¥–±–æ—Ä—É –∞–≤—Ç–æ"
        if search_performed:
            assistant_content += f" + –ø–æ–∏—Å–∫ –≤ {search_intent['search_type']}"
        
        self.history.add_message(
            "assistant", 
            assistant_content, 
            results, 
            topic=history_topic,
            search_results=search_results
        )
        
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        response_time = time.time() - start_time
        result = {
            "user_query": user_query,
            "query_topic": query_topic,
            "is_related": is_related,
            "relation_type": relation_type,
            "search_performed": search_performed,
            "search_intent": search_intent,
            "search_results": search_results,
            "clarifying_questions": results,
            "response_time": response_time,
            "history_length": len(self.history.history)
        }
        
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        self._display_car_dealer_interaction_result(result)
        
        return result
    
    def _perform_search(self, search_intent: Dict, dialogue_context: str, available_brands: List[str], available_categories: List[str]) -> Dict[str, Any]:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π"""
        search_type = search_intent["search_type"]
        initial_params = search_intent["search_parameters"]
        
        print(f"üóÉÔ∏è  –í—ã–ø–æ–ª–Ω—è—é –ø–æ–∏—Å–∫ –≤ {search_type} —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: {initial_params}")
        
        # –£—Ç–æ—á–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
        missing_params = self.query_generator.identify_missing_parameters(search_type, initial_params)
        
        refined_params = self.query_generator.refine_search_parameters(
            initial_params, dialogue_context, missing_params, available_brands, available_categories
        )
        
        print(f"üîß –£—Ç–æ—á–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞: {refined_params}")
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        search_results = self.database_manager.search(search_type, refined_params)
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        processed_results = self.result_processor.process_search_results(
            search_results, "–ü–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∫–ª–∏–µ–Ω—Ç–∞"
        )
        
        return processed_results
    
    def _generate_questions(self, user_query: str, relation_type: str, dialogue_context: str, 
                          query_topic: str, search_context: str, search_results: Dict,
                          available_brands: List[str], available_categories: List[str]) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ü–µ–ø–æ—á–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
        if "—Ñ–∏–Ω–∞–Ω—Å" in user_query.lower() or "–∫—Ä–µ–¥–∏—Ç" in user_query.lower():
            chain_key = "finance"
        else:
            chain_key = "car_search"
        
        chain = self.question_chains[chain_key]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫–∞ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
        enhanced_search_context = search_context
        if search_results and search_results.get("success") and search_results.get("results_summary"):
            summary = search_results["results_summary"]
            enhanced_search_context += f"–°–í–û–î–ö–ê –ü–û–ò–°–ö–ê: {summary['summary']}\n"
        
        chain_input = {
            "user_query": user_query,
            "primary_context": dialogue_context,
            "covered_topics": ", ".join(self.history.get_already_covered_topics()),
            "current_topic": self.history.current_topic or query_topic,
            "search_context": enhanced_search_context,
            "available_brands": ", ".join(available_brands),
            "available_categories": ", ".join(available_categories)
        }
        
        if chain_key == "finance" and search_results and search_results.get("raw_results"):
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            car_details = ""
            if search_results["raw_results"]:
                car = search_results["raw_results"][0]
                car_details = f"–ê–≤—Ç–æ–º–æ–±–∏–ª—å: {car['brand']} {car['model']} - {car['price']:,.0f} —Ä—É–±."
            chain_input["car_details"] = car_details
        
        questions = chain.run(**chain_input)
        return questions[:3]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
    
    def _display_car_dealer_interaction_result(self, result: Dict):
        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –≤ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–µ"""
        print(f"\nüéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò:")
        print(f"   ‚Ä¢ –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {result['response_time']:.2f}—Å")
        print(f"   ‚Ä¢ –ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω: {'–î–∞' if result['search_performed'] else '–ù–µ—Ç'}")
        
        if result['search_performed']:
            search_intent = result['search_intent']
            search_results = result['search_results']
            
            print(f"   ‚Ä¢ –¢–∏–ø –ø–æ–∏—Å–∫–∞: {search_intent['search_type']}")
            if search_results and search_results.get('success'):
                print(f"   ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: {search_results.get('total_found', 0)}")
                
                if search_results.get('results_summary'):
                    summary = search_results['results_summary']
                    print(f"\nüìä –°–í–û–î–ö–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô:")
                    print(f"   {summary['summary']}")
                    
                    if summary.get('top_recommendations'):
                        print(f"\nüèÜ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
                        for rec in summary['top_recommendations'][:2]:
                            print(f"   ‚Ä¢ {rec.get('brand', '')} {rec.get('model', '')} - {rec.get('price', '')}")
                            if rec.get('advantages'):
                                print(f"     {rec['advantages']}")
        
        print(f"\nü§î –£–¢–û–ß–ù–Ø–Æ–©–ò–ï –í–û–ü–†–û–°–´:")
        for i, item in enumerate(result["clarifying_questions"], 1):
            print(f"  {i}. {item['question']}")
            for j, answer in enumerate(item['hypothetical_answers'], 1):
                print(f"     {j}. {answer}")

### 9. üé≠ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

def demo_car_dealer_assistant():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞"""
    
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    dealer_config = CarDealerConfig(
        enabled=True,
        auto_search_threshold=0.6,
        max_results=5,
        enable_finance_calculations=True,
        enable_trade_in=True
    )
    
    assistant = CarDealerAssistant(dealer_config)
    
    # –°–∏–º—É–ª—è—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞
    scenarios = [
        "–•–æ—á—É –∫—É–ø–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è —Å–µ–º—å–∏",
        "–ú–æ–π –±—é–¥–∂–µ—Ç –¥–æ 2 –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Ä—É–±–ª–µ–π",  # –£—Ç–æ—á–Ω–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞
        "–ò–Ω—Ç–µ—Ä–µ—Å—É—é—Ç –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫–∏",  # –£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        "–ü–æ–∫–∞–∂–∏—Ç–µ Toyota",  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –º–∞—Ä–∫–∞
        "–ê –µ—Å—Ç—å —á—Ç–æ-—Ç–æ –ø–æ–¥–µ—à–µ–≤–ª–µ?",  # –£—Ç–æ—á–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
        "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏–µ",  # –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
        "–ö–∞–∫–æ–π –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å –Ω—É–∂–µ–Ω?",  # –£—Ç–æ—á–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è
        "–ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç Kia Sportage –≤ –∫—Ä–µ–¥–∏—Ç",  # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    ]
    
    print("üöó –ó–ê–ü–£–°–ö –ê–°–°–ò–°–¢–ï–ù–¢–ê –ê–í–¢–û–°–ê–õ–û–ù–ê")
    print("=" * 80)
    
    for i, query in enumerate(scenarios, 1):
        print(f"\n{'>>>'*10} –≠–¢–ê–ü {i} {'<<<'*10}")
        result = assistant.process_query(query)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –ø–æ–∏—Å–∫–∞
        if result.get("search_performed") and result["search_results"] and result["search_results"].get("success"):
            search_data = result["search_results"]
            if search_data.get("raw_results"):
                print(f"\nüìã –î–û–°–¢–£–ü–ù–´–ï –ê–í–¢–û–ú–û–ë–ò–õ–ò ({len(search_data['raw_results'])}):")
                for j, car in enumerate(search_data["raw_results"][:3], 1):
                    price = f"{car['price']:,.0f} —Ä—É–±.".replace(',', ' ')
                    print(f"   {j}. {car['brand']} {car['model']} - {price}")
                    print(f"      {car['category']}, {car['fuel_type']}, {car['transmission']}")
                    if car.get('finance_calculation'):
                        payment = f"{car['finance_calculation']['monthly_payment']:,.0f} —Ä—É–±./–º–µ—Å".replace(',', ' ')
                        print(f"      üí∞ –ö—Ä–µ–¥–∏—Ç: {payment}")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–∞–Ω—Å–∞
    print(f"\n{'üìä'*20} –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ï–ê–ù–°–ê {'üìä'*20}")
    total_searches = sum(1 for msg in assistant.history.history 
                        if msg.get("role") == "assistant" and msg.get("search_results"))
    finance_queries = sum(1 for msg in assistant.history.history 
                         if msg.get("role") == "client" and "–∫—Ä–µ–¥–∏—Ç" in msg.get("content", "").lower())
    
    print(f"   ‚Ä¢ –í—Å–µ–≥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π: {len(assistant.history.history)//2}")
    print(f"   ‚Ä¢ –ü–æ–∏—Å–∫–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π: {total_searches}")
    print(f"   ‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: {finance_queries}")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç–µ–º
    print(f"\nüéØ –ò–°–¢–û–†–ò–Ø –¢–ï–ú –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò:")
    topics = {}
    for msg in assistant.history.history:
        topic = msg.get('topic')
        if topic:
            if topic not in topics:
                topics[topic] = 0
            topics[topic] += 1
    
    for topic, count in topics.items():
        print(f"   ‚Ä¢ {topic}: {count} —Å–æ–æ–±—â–µ–Ω–∏–π")

if __name__ == "__main__":
    demo_car_dealer_assistant()
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

### 1. **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π**
- 12+ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –º–∞—Ä–∫–∞, –º–æ–¥–µ–ª—å, —Ü–µ–Ω–∞, —Ç–∏–ø –∫—É–∑–æ–≤–∞, —Ç–æ–ø–ª–∏–≤–æ, –ö–ü–ü
- –°–∏—Å—Ç–µ–º–∞ —Å–∫–∏–¥–æ–∫ –∏ –∞–∫—Ü–∏–π
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –º–Ω–æ–∂–µ—Å—Ç–≤—É –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### 2. **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–¥–±–æ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π**
- –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∫–ª–∏–µ–Ω—Ç–∞ (—Å–µ–º—å—è, –±–∏–∑–Ω–µ—Å, –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è)
- –£—á–µ—Ç –±—é–¥–∂–µ—Ç–∞ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 3. **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –º–æ–¥—É–ª—å**
- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫—Ä–µ–¥–∏—Ç–æ–≤ –∏ –ª–∏–∑–∏–Ω–≥–∞
- –ë–∞–∑–∞ –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –±–∞–Ω–∫–æ–≤
- –†–∞—Å—á–µ—Ç –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

### 4. **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–∑–∞–≤–∏—Å–∏–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã**
- –£—Ç–æ—á–Ω–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
- –í–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–ª—è—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è
- –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### 5. **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è**
- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –∫–∞–∫ —É –æ–ø—ã—Ç–Ω–æ–≥–æ –ø—Ä–æ–¥–∞–≤—Ü–∞
- –£—á–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å–Ω–æ–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏
- –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π –∏ —Å–æ–º–Ω–µ–Ω–∏–π

## üìä –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

```
>>> –≠–¢–ê–ü 1: –•–æ—á—É –∫—É–ø–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è —Å–µ–º—å–∏
üöó –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: –•–æ—á—É –∫—É–ø–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è —Å–µ–º—å–∏
üè∑Ô∏è  –¢–µ–º–∞: –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è —Å–µ–º—å–∏
üîé –ü–æ–∏—Å–∫–æ–≤–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ: –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: 0.82)

üéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò:
   ‚Ä¢ –ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω: –î–∞
   ‚Ä¢ –¢–∏–ø –ø–æ–∏—Å–∫–∞: –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
   ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: 8

üìä –°–í–û–î–ö–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô:
   –ù–∞–π–¥–µ–Ω–æ 8 –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–ª—è —Å–µ–º—å–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫–∏ 
   –∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—ã —Å –ø—Ä–æ—Å—Ç–æ—Ä–Ω—ã–º —Å–∞–ª–æ–Ω–æ–º –∏ –±–æ–ª—å—à–∏–º –±–∞–≥–∞–∂–Ω–∏–∫–æ–º.

ü§î –£–¢–û–ß–ù–Ø–Æ–©–ò–ï –í–û–ü–†–û–°–´:
  1. –ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç –≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ?
     1. –î–æ 1.5 –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Ä—É–±–ª–µ–π
     2. –û–∫–æ–ª–æ 2-2.5 –º–∏–ª–ª–∏–æ–Ω–æ–≤
  2. –°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –æ–±—ã—á–Ω–æ –±—É–¥–µ—Ç –µ–∑–¥–∏—Ç—å –≤ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ?
     1. 2 –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ 2 –¥–µ—Ç–µ–π
     2. 3 –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ 1 —Ä–µ–±–µ–Ω–æ–∫
  3. –í–∞–∂–Ω–∞ –ª–∏ —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ—Å—Ç—å —Ä–∞—Å—Ö–æ–¥–∞ —Ç–æ–ø–ª–∏–≤–∞?
     1. –î–∞, –∏—â—É —ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
     2. –ì–ª–∞–≤–Ω–æ–µ - –∫–æ–º—Ñ–æ—Ä—Ç –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ –ø–æ–¥–±–∏—Ä–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –≤–µ—Å—Ç–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏! üöóüí®

–í–æ—Ç –ø–æ–ª–Ω–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –≤—Å–µ–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏:

## üèóÔ∏è –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Input Layer   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Context Manager ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Relation Analyzer‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Emotion Analyzer‚îÇ    ‚îÇ  Memory Manager  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Question Strategy‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Tone Adjuster  ‚îÇ    ‚îÇ Knowledge Integr.‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Question Generator
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇProactive Suggest‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÇ  Quality Metrics ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÇ Answer Generator ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Visualizer     ‚îÇ    ‚îÇ   Config Manager ‚îÇ    ‚îÇ  Output Layer    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ –ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

```python
from langchain.chains import LLMChain
from langchain.prompts import PromptTemplate
from langchain.chat_models import ChatOpenAI
from langchain.schema import BaseOutputParser
from typing import List, Dict, Any, Tuple, Optional
from dataclasses import dataclass
import os
import json
import re
from datetime import datetime
import time

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à API-–∫–ª—é—á OpenAI
os.environ["OPENAI_API_KEY"] = "–≤–∞—à_api_–∫–ª—é—á"

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
llm = ChatOpenAI(model="gpt-3.5-turbo", temperature=0.7)

### 1. üéõÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
@dataclass
class AgentConfig:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞"""
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
    relation_confidence_threshold: float = 0.7
    enable_emotion_analysis: bool = True
    use_context_compression: bool = True
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
    min_questions: int = 2
    max_questions: int = 4
    question_style: str = "neutral"  # neutral, friendly, professional
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–º—è—Ç–∏
    max_history_length: int = 50
    enable_memory_compression: bool = True
    
    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    enable_proactive_suggestions: bool = True
    enable_quality_metrics: bool = True
    enable_knowledge_integration: bool = True
    enable_dialogue_visualization: bool = True
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    context_levels: Dict = None
    
    def __post_init__(self):
        if self.context_levels is None:
            self.context_levels = {
                "recent": 6,      # –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                "topic": 10,      # –í—Å—è —Ç–µ–º–∞
                "session": 20,    # –í—Å—è —Å–µ—Å—Å–∏—è
                "summary": 3      # –°—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            }

### 2. üß† –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
class ContextManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω—è—Ö –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏"""
    
    def __init__(self, config: AgentConfig):
        self.config = config
        self.context_strategies = {
            "continuation": {
                "primary": "topic",
                "secondary": "recent",
                "depth": "deep",
                "compression": "moderate"
            },
            "clarification": {
                "primary": "recent", 
                "secondary": "topic",
                "depth": "focused",
                "compression": "light"
            },
            "new_topic": {
                "primary": "summary",
                "secondary": None,
                "depth": "shallow",
                "compression": "aggressive"
            },
            "topic_change": {
                "primary": "summary",
                "secondary": "recent",
                "depth": "medium",
                "compression": "moderate"
            }
        }
    
    def get_context_strategy(self, relation_type: str, confidence: float) -> Dict:
        """–í—ã–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–≤—è–∑–∏"""
        strategy = self.context_strategies.get(relation_type, self.context_strategies["new_topic"])
        
        # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        if confidence < 0.6:
            strategy = strategy.copy()
            strategy["depth"] = "shallow"
            strategy["compression"] = "aggressive"
        
        return strategy
    
    def prepare_context(self, history: 'DialogueHistory', strategy: Dict, current_topic: str) -> Dict[str, str]:
        """–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π"""
        contexts = {}
        
        # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        if strategy["primary"] == "topic" and current_topic:
            contexts["primary"] = history.get_topic_context(current_topic)
        elif strategy["primary"] == "recent":
            contexts["primary"] = history.get_recent_context(self.config.context_levels["recent"])
        elif strategy["primary"] == "summary":
            contexts["primary"] = history.get_summary_context()
        else:
            contexts["primary"] = history.get_recent_context(3)
        
        # –í—Ç–æ—Ä–∏—á–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        if strategy["secondary"]:
            if strategy["secondary"] == "topic" and current_topic:
                contexts["secondary"] = history.get_topic_context(current_topic)
            elif strategy["secondary"] == "recent":
                contexts["secondary"] = history.get_recent_context(4)
        
        return contexts

### 3. üíæ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
class MemoryManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –¥–∏–∞–ª–æ–≥–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–µ–π"""
    
    def __init__(self, max_messages=50):
        self.max_messages = max_messages
        self.message_scores = {}  # –û—Ü–µ–Ω–∫–∞ –≤–∞–∂–Ω–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        self.key_entities = set() # –ö–ª—é—á–µ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∞
        self.compression_count = 0
    
    def calculate_message_importance(self, message: Dict) -> float:
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤–∞–∂–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è"""
        score = 0.0
        
        # –§–∞–∫—Ç–æ—Ä—ã –≤–∞–∂–Ω–æ—Å—Ç–∏
        if message["role"] == "user":
            score += 0.3
        if message.get("questions_answers"):
            score += 0.4
        if len(message["content"]) > 100:  # –î–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Å—Ç–æ –≤–∞–∂–Ω–µ–µ
            score += 0.2
        if any(keyword in message["content"].lower() for keyword in ["–≤–∞–∂–Ω", "–∫–ª—é—á–µ–≤", "–æ—Å–Ω–æ–≤–Ω", "–≥–ª–∞–≤–Ω"]):
            score += 0.5
        
        # –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–º—É
        if message.get("topic"):
            score += 0.2
            
        return min(score, 1.0)
    
    def compress_history(self, history: List[Dict]) -> List[Dict]:
        """–°–∂–∏–º–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é, —Å–æ—Ö—Ä–∞–Ω—è—è –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        if len(history) <= self.max_messages:
            return history
        
        self.compression_count += 1
        print(f"üß† –°–∂–∞—Ç–∏–µ –ø–∞–º—è—Ç–∏ #{self.compression_count} ({len(history)} -> {self.max_messages} —Å–æ–æ–±—â–µ–Ω–∏–π)")
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏
        scored_history = []
        for i, msg in enumerate(history):
            importance = self.calculate_message_importance(msg)
            # –£—á–∏—Ç—ã–≤–∞–µ–º —Å–≤–µ–∂–µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π
            recency_bonus = (i / len(history)) * 0.3
            total_score = importance + recency_bonus
            scored_history.append((total_score, msg, i))
        
        # –û—Å—Ç–∞–≤–ª—è–µ–º —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        scored_history.sort(reverse=True)
        kept_messages = [msg for score, msg, idx in scored_history[:self.max_messages]]
        
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä—è–¥–æ–∫ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        kept_messages.sort(key=lambda x: x["timestamp"])
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
        self._update_key_entities(kept_messages)
        
        return kept_messages
    
    def _update_key_entities(self, messages: List[Dict]):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        entities = set()
        for msg in messages:
            content = msg["content"].lower()
            # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ NER)
            words = re.findall(r'\b[\w]{4,}\b', content)
            for word in words:
                if word not in ['—ç—Ç–æ—Ç', '—Ç–∞–∫–æ–π', '–∫–∞–∫–æ–π', '–∫–æ—Ç–æ—Ä—ã–π']:
                    entities.add(word)
        
        self.key_entities = entities

### 4. ‚ù§Ô∏è –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç
class EmotionAnalyzer:
    """–ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    def __init__(self):
        self.sentiment_prompt = PromptTemplate(
            input_variables=["query"],
            template="""
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ:
            1. –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è, –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è, —Å–º–µ—à–∞–Ω–Ω–∞—è)
            2. –£—Ä–æ–≤–µ–Ω—å —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ (–Ω–∏–∑–∫–∏–π, —Å—Ä–µ–¥–Ω–∏–π, –≤—ã—Å–æ–∫–∏–π)
            3. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–ø–æ–∫–æ–π–Ω–æ–µ, –≤–∑–≤–æ–ª–Ω–æ–≤–∞–Ω–Ω–æ–µ, —Ä–∞—Å—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ, —Ä–∞–¥–æ—Å—Ç–Ω–æ–µ)
            
            –ó–∞–ø—Ä–æ—Å: {query}
            
            –û—Ç–≤–µ—Ç –≤ JSON:
            {{
                "sentiment": "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è",
                "urgency": "—Å—Ä–µ–¥–Ω–∏–π", 
                "emotional_state": "—Å–ø–æ–∫–æ–π–Ω–æ–µ",
                "needs_empathy": false,
                "confidence": 0.85
            }}
            """
        )
        self.llm = llm
    
    def analyze_emotion(self, query: str) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É –∑–∞–ø—Ä–æ—Å–∞"""
        try:
            chain = LLMChain(llm=self.llm, prompt=self.sentiment_prompt)
            response = chain.run(query=query)
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                emotion_data = json.loads(json_match.group())
                
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –≤ —ç–º–ø–∞—Ç–∏–∏
                if emotion_data["sentiment"] == "–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è" or emotion_data["urgency"] == "–≤—ã—Å–æ–∫–∏–π":
                    emotion_data["needs_empathy"] = True
                
                return emotion_data
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —ç–º–æ—Ü–∏–π: {e}")
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return {
            "sentiment": "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è",
            "urgency": "—Å—Ä–µ–¥–Ω–∏–π",
            "emotional_state": "—Å–ø–æ–∫–æ–π–Ω–æ–µ",
            "needs_empathy": False,
            "confidence": 0.5
        }
    
    def adjust_tone_for_questions(self, questions: List[str], emotion_data: Dict, question_style: str = "neutral") -> List[str]:
        """–ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —Ç–æ–Ω –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–¥ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç"""
        adjusted_questions = []
        
        tone_prefixes = {
            "friendly": {
                "neutral": ["–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, ", "–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, ", "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, "],
                "positive": ["–ó–¥–æ—Ä–æ–≤–æ! ", "–û—Ç–ª–∏—á–Ω–æ! ", "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! "],
                "negative": ["–ü–æ–Ω–∏–º–∞—é, ", "–í–∏–∂—É, ", "–°–æ—á—É–≤—Å—Ç–≤—É—é, "]
            },
            "professional": {
                "neutral": ["–£—Ç–æ—á–Ω–∏—Ç–µ, ", "–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ, ", "–£–∫–∞–∂–∏—Ç–µ, "],
                "positive": ["–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ. ", "–û—Ç–ª–∏—á–Ω–æ. ", "–•–æ—Ä–æ—à–æ. "],
                "negative": ["–ü—Ä–∏–Ω–æ—à—É –∏–∑–≤–∏–Ω–µ–Ω–∏—è. ", "–ü–æ–Ω–∏–º–∞—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å. ", "–£—á—Ç–µ–º. "]
            },
            "neutral": {
                "neutral": ["", "", ""],
                "positive": ["", "", ""],
                "negative": ["", "", ""]
            }
        }
        
        prefixes = tone_prefixes.get(question_style, tone_prefixes["neutral"])
        sentiment_key = "positive" if emotion_data["sentiment"] == "–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è" else "negative" if emotion_data["sentiment"] == "–Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è" else "neutral"
        
        for i, question in enumerate(questions):
            prefix = prefixes[sentiment_key][i % len(prefixes[sentiment_key])]
            
            if emotion_data["needs_empathy"]:
                if sentiment_key == "negative":
                    question = f"{prefix}–ß—Ç–æ–±—ã –ø–æ–º–æ—á—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ, {question.lower()}"
                elif sentiment_key == "positive":
                    question = f"{prefix}{question}"
            
            if emotion_data["urgency"] == "–≤—ã—Å–æ–∫–∏–π":
                question = f"–°—Ä–æ—á–Ω–æ: {question}"
                
            adjusted_questions.append(question)
        
        return adjusted_questions

### 5. üîÆ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
class ProactiveAssistant:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏"""
    
    def __init__(self):
        self.suggestion_prompt = PromptTemplate(
            input_variables=["history", "current_topic", "user_interests"],
            template="""
            –ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ 2-3 –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞.
            
            –¢–ï–ö–£–©–ê–Ø –¢–ï–ú–ê: {current_topic}
            –ò–°–¢–û–†–ò–Ø: {history}
            –ò–ù–¢–ï–†–ï–°–´: {user_interests}
            
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ:
            - –ö–∞–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã —Ç–µ–º—ã –µ—â–µ –Ω–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã
            - –°–º–µ–∂–Ω—ã–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã
            - –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
            
            –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "suggestions": [
                    {{
                        "type": "—É–≥–ª—É–±–∏—Ç—å_—Ç–µ–º—É/—Ä–∞—Å—à–∏—Ä–∏—Ç—å_—Ñ–æ–∫—É—Å/–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ_–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ",
                        "description": "–¢–µ–∫—Å—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è",
                        "reasoning": "–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –ø–æ—á–µ–º—É —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ"
                    }}
                ]
            }}
            """
        )
        self.llm = llm
    
    def generate_proactive_suggestions(self, history: 'DialogueHistory', current_topic: str, user_interests: List[str]) -> List[Dict]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"""
        try:
            chain = LLMChain(llm=self.llm, prompt=self.suggestion_prompt)
            response = chain.run(
                history=history.get_recent_context(8),
                current_topic=current_topic,
                user_interests=", ".join(user_interests) if user_interests else "–µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã"
            )
            
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group())
                return result.get("suggestions", [])
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: {e}")
        
        return []

### 6. üìä –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏
class QualityMetrics:
    """–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞"""
    
    def __init__(self):
        self.metrics = {
            "relation_accuracy": [],
            "question_relevance": [],
            "response_times": [],
            "user_engagement": 0,
            "topic_coverage": {},
            "emotion_analysis": []
        }
        self.start_time = time.time()
    
    def log_interaction(self, relation_data: Dict, questions: List[str], response_time: float):
        """–õ–æ–≥–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è"""
        self.metrics["response_times"].append(response_time)
        self.metrics["user_engagement"] += 1
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤
        relevance_score = self._estimate_question_relevance(questions, relation_data)
        self.metrics["question_relevance"].append(relevance_score)
        
        # –õ–æ–≥–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
        if "emotion_data" in relation_data:
            self.metrics["emotion_analysis"].append(relation_data["emotion_data"])
    
    def _estimate_question_relevance(self, questions: List[str], relation_data: Dict) -> float:
        """–û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
        if not questions:
            return 0.0
        
        # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –≤–æ–ø—Ä–æ—Å—ã —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –µ—Å–ª–∏ –æ–Ω–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–∏–ø—É —Å–≤—è–∑–∏
        base_score = 0.7
        
        # –ë–æ–Ω—É—Å –∑–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤
        unique_stems = set()
        for q in questions:
            words = q.lower().split()[:3]  # –ü–µ—Ä–≤—ã–µ 3 —Å–ª–æ–≤–∞ –∫–∞–∫ –æ—Å–Ω–æ–≤–∞
            unique_stems.add(tuple(words))
        
        diversity_bonus = min(len(unique_stems) / len(questions), 0.3)
        
        return min(base_score + diversity_bonus, 1.0)
    
    def get_performance_summary(self) -> Dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
        if not self.metrics["response_times"]:
            return {"status": "No data yet"}
        
        return {
            "total_interactions": self.metrics["user_engagement"],
            "avg_response_time": sum(self.metrics["response_times"]) / len(self.metrics["response_times"]),
            "avg_question_relevance": sum(self.metrics["question_relevance"]) / len(self.metrics["question_relevance"]) if self.metrics["question_relevance"] else 0,
            "session_duration": time.time() - self.start_time
        }

### 7. üìö –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏
class KnowledgeIntegrator:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–Ω–µ—à–Ω–∏—Ö –∑–Ω–∞–Ω–∏–π –∏ —Ñ–∞–∫—Ç-—á–µ–∫–∏–Ω–≥"""
    
    def __init__(self):
        self.knowledge_sources = {
            "common_sense": "–ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è –æ –º–∏—Ä–µ",
            "domain_knowledge": "–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏",
            "user_preferences": "–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
        }
        self.domain_knowledge = {
            "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è": ["–±—é–¥–∂–µ—Ç", "—Å–µ–∑–æ–Ω", "—Å—Ç—Ä–∞–Ω—ã", "–≤–∏–∑–∞", "–ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ"],
            "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏": ["–±—é–¥–∂–µ—Ç", "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è", "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ", "—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏"],
            "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": ["—É—Ä–æ–≤–µ–Ω—å", "–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "—Ñ–æ—Ä–º–∞—Ç", "—Ü–µ–ª–∏"]
        }
    
    def enrich_with_knowledge(self, questions: List[str], topic: str, relation_type: str) -> List[str]:
        """–û–±–æ–≥–∞—â–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏"""
        enriched_questions = []
        
        domain_keywords = self._detect_domain(topic)
        
        for question in questions:
            enriched_question = question
            
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–º–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ
            if domain_keywords and self._requires_domain_knowledge(question, domain_keywords):
                if relation_type == "continuation":
                    enriched_question = f"–° —É—á–µ—Ç–æ–º –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π, {question.lower()}"
                elif relation_type == "new_topic":
                    enriched_question = f"–î–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, {question.lower()}"
            
            enriched_questions.append(enriched_question)
        
        return enriched_questions
    
    def _detect_domain(self, topic: str) -> List[str]:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ–º–µ–Ω –ø–æ —Ç–µ–º–µ"""
        topic_lower = topic.lower()
        for domain, keywords in self.domain_knowledge.items():
            if any(keyword in topic_lower for keyword in [domain] + keywords[:2]):
                return keywords
        return []
    
    def _requires_domain_knowledge(self, question: str, domain_keywords: List[str]) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç –ª–∏ –≤–æ–ø—Ä–æ—Å –¥–æ–º–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π"""
        question_lower = question.lower()
        return any(keyword in question_lower for keyword in domain_keywords[:3])

### 8. üé® –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞
class DialogueVisualizer:
    """–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏–∞–ª–æ–≥–∞ –∏ —Å–≤—è–∑–µ–π"""
    
    def create_dialogue_map(self, history: 'DialogueHistory') -> Dict:
        """–°–æ–∑–¥–∞–µ—Ç –∫–∞—Ä—Ç—É –¥–∏–∞–ª–æ–≥–∞ —Å —Å–≤—è–∑—è–º–∏ –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏"""
        
        dialogue_map = {
            "topics": [],
            "transitions": [],
            "key_moments": [],
            "conversation_flow": [],
            "timeline": []
        }
        
        # –ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏
        current_topic = None
        topic_start = 0
        
        for i, msg in enumerate(history.history):
            msg_topic = msg.get("topic", "–±–µ–∑ —Ç–µ–º—ã")
            
            # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç–µ–º
            if msg_topic != current_topic:
                if current_topic is not None:
                    dialogue_map["transitions"].append({
                        "from": current_topic,
                        "to": msg_topic,
                        "turn": i,
                        "type": "topic_change"
                    })
                
                current_topic = msg_topic
                topic_start = i
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–∞–π–º–ª–∞–π–Ω
            dialogue_map["timeline"].append({
                "turn": i,
                "role": msg["role"],
                "topic": msg_topic,
                "content_preview": msg["content"][:50] + "..."
            })
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
            if msg.get("questions_answers"):
                dialogue_map["key_moments"].append({
                    "turn": i,
                    "type": "clarification",
                    "topic": msg_topic,
                    "questions_count": len(msg["questions_answers"])
                })
        
        # –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã
        topics = {}
        for msg in history.history:
            topic = msg.get("topic")
            if topic:
                if topic not in topics:
                    topics[topic] = 0
                topics[topic] += 1
        
        dialogue_map["topics"] = [{"name": topic, "message_count": count} for topic, count in topics.items()]
        
        return dialogue_map
    
    def print_conversation_analysis(self, agent: 'ClarifyingAgent'):
        """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞"""
        dialogue_map = self.create_dialogue_map(agent.history)
        
        print(f"\n{'üìä'*20}")
        print(f"–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–ê")
        print(f"{'üìä'*20}")
        
        # –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        print(f"\nüìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
        print(f"   ‚Ä¢ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(agent.history.history)}")
        print(f"   ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–º: {len(dialogue_map['topics'])}")
        print(f"   ‚Ä¢ –ü–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏: {len(dialogue_map['transitions'])}")
        print(f"   ‚Ä¢ –ö–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤: {len(dialogue_map['key_moments'])}")
        
        # –ê–Ω–∞–ª–∏–∑ —Ç–µ–º
        print(f"\nüéØ –¢–ï–ú–´ –î–ò–ê–õ–û–ì–ê:")
        for topic_info in dialogue_map["topics"]:
            print(f"   ‚Ä¢ {topic_info['name']}: {topic_info['message_count']} —Å–æ–æ–±—â–µ–Ω–∏–π")
        
        # –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏
        if dialogue_map["transitions"]:
            print(f"\nüîÑ –ü–ï–†–ï–•–û–î–´ –ú–ï–ñ–î–£ –¢–ï–ú–ê–ú–ò:")
            for transition in dialogue_map["transitions"][-3:]:  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø–µ—Ä–µ—Ö–æ–¥–∞
                print(f"   ‚Ä¢ {transition['from']} ‚Üí {transition['to']} (—Ö–æ–¥ {transition['turn']})")
        
        # –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        if agent.quality_metrics:
            performance = agent.quality_metrics.get_performance_summary()
            print(f"\n‚ö° –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨:")
            print(f"   ‚Ä¢ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π: {performance['total_interactions']}")
            print(f"   ‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {performance['avg_response_time']:.2f}—Å")
            print(f"   ‚Ä¢ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤: {performance['avg_question_relevance']:.1%}")

### 9. üóÇÔ∏è –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏
class DialogueHistory:
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞"""
    
    def __init__(self):
        self.history = []
        self.current_topic = None
        self.topics = []
        self.user_interests = set()
    
    def add_message(self, role: str, content: Any, questions_answers: List[Dict] = None, topic: str = None, emotion_data: Dict = None):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        message = {
            "role": role,
            "content": content,
            "timestamp": len(self.history),
            "time": datetime.now().isoformat(),
            "questions_answers": questions_answers or [],
            "topic": topic or self.current_topic,
            "emotion_data": emotion_data
        }
        self.history.append(message)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞
        if topic:
            self.current_topic = topic
            if topic not in self.topics:
                self.topics.append(topic)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if role == "user":
            self._update_user_interests(content)
    
    def _update_user_interests(self, content: str):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        content_lower = content.lower()
        interest_keywords = {
            "–ø—É—Ç–µ—à–µ—Å—Ç–≤": "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è",
            "—Ç–µ—Ö–Ω–æ–ª–æ–≥": "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", 
            "–æ–±—Ä–∞–∑–æ–≤–∞–Ω": "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
            "—Ä–∞–±–æ—Ç": "–∫–∞—Ä—å–µ—Ä–∞",
            "—Ö–æ–±–±–∏": "—Ö–æ–±–±–∏",
            "—Å–ø–æ—Ä—Ç": "—Å–ø–æ—Ä—Ç",
            "–∏—Å–∫—É—Å—Å—Ç–≤": "–∏—Å–∫—É—Å—Å—Ç–≤–æ"
        }
        
        for keyword, interest in interest_keywords.items():
            if keyword in content_lower:
                self.user_interests.add(interest)
    
    def get_recent_context(self, max_messages: int = 6) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≤–∏–¥–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏"""
        recent = self.history[-max_messages:] if len(self.history) > max_messages else self.history
        context_lines = []
        
        for msg in recent:
            if msg["role"] == "user":
                context_lines.append(f"üë§: {msg['content']}")
            elif msg["role"] == "assistant":
                preview = msg['content'][:70] + "..." if len(msg['content']) > 70 else msg['content']
                context_lines.append(f"ü§ñ: {preview}")
        
        return "\n".join(context_lines)
    
    def get_topic_context(self, topic: str = None) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Ç–µ–º–µ"""
        target_topic = topic or self.current_topic
        if not target_topic:
            return self.get_recent_context()
        
        topic_messages = [msg for msg in self.history if msg.get("topic") == target_topic]
        context_lines = [f"–¢–µ–º–∞: {target_topic}"]
        
        for msg in topic_messages:
            role_icon = "üë§" if msg["role"] == "user" else "ü§ñ"
            context_lines.append(f"{role_icon}: {msg['content']}")
        
        return "\n".join(context_lines) if context_lines else "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ"
    
    def get_summary_context(self) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç"""
        if not self.history:
            return "–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç–∞"
        
        # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–º–∞—Ö
        recent = self.history[-3:] if len(self.history) >= 3 else self.history
        recent_context = "\n".join([f"{'üë§' if msg['role']=='user' else 'ü§ñ'}: {msg['content']}" for msg in recent])
        
        topics_info = f"–¢–µ–º—ã: {', '.join(self.topics[-3:])}" if self.topics else ""
        
        return f"{recent_context}\n\n{topics_info}"
    
    def get_already_covered_topics(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã –≤ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö"""
        covered_topics = []
        for msg in self.history:
            if msg["questions_answers"]:
                for qa in msg["questions_answers"]:
                    covered_topics.append(qa["question"])
        return covered_topics
    
    def detect_topic(self, query: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–º—É –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–º–æ—â—å—é LLM"""
        topic_prompt = PromptTemplate(
            input_variables=["query"],
            template="""
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–µ–º—É (1-3 —Å–ª–æ–≤–∞).
            –ë—É–¥—å—Ç–µ –∫—Ä–∞—Ç–∫–∏–º–∏ –∏ —Ç–æ—á–Ω—ã–º–∏.
            
            –ó–∞–ø—Ä–æ—Å: {query}
            
            –¢–µ–º–∞:
            """
        )
        topic_chain = LLMChain(llm=llm, prompt=topic_prompt)
        topic = topic_chain.run(query=query).strip()
        return topic

### 10. üîç –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (—É–ª—É—á—à–µ–Ω–Ω—ã–π)
class RelationAnalyzer:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞"""
    
    def __init__(self):
        self.llm = llm
    
    def analyze_relation(self, current_query: str, dialogue_history: str, previous_topics: List[str]) -> Tuple[bool, str, float]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π"""
        
        relation_prompt = PromptTemplate(
            input_variables=["current_query", "dialogue_history", "previous_topics"],
            template="""
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ, —Å–≤—è–∑–∞–Ω –ª–∏ —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞.
            
            –ü–†–ï–î–´–î–£–©–ê–Ø –ò–°–¢–û–†–ò–Ø:
            {dialogue_history}
            
            –ü–†–ï–î–´–î–£–©–ò–ï –¢–ï–ú–´: {previous_topics}
            
            –¢–ï–ö–£–©–ò–ô –ó–ê–ü–†–û–°: {current_query}
            
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ:
            1. –°–≤—è–∑–∞–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –¥–∏–∞–ª–æ–≥–æ–º (–¥–∞/–Ω–µ—Ç)
            2. –¢–∏–ø —Å–≤—è–∑–∏: –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ, —É—Ç–æ—á–Ω–µ–Ω–∏–µ, –Ω–æ–≤–∞—è —Ç–µ–º–∞, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
            3. –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (0.0-1.0)
            
            –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "is_related": true/false,
                "relation_type": "—Ç–∏–ø_—Å–≤—è–∑–∏",
                "confidence": 0.95,
                "reasoning": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ"
            }}
            """
        )
        
        try:
            relation_chain = LLMChain(llm=llm, prompt=relation_prompt)
            response = relation_chain.run(
                current_query=current_query,
                dialogue_history=dialogue_history if dialogue_history else "–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç–∞",
                previous_topics=", ".join(previous_topics) if previous_topics else "–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–µ–º"
            )
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group())
                return (
                    result.get("is_related", False),
                    result.get("relation_type", "unknown"),
                    result.get("confidence", 0.5)
                )
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏: {e}")
        
        # Fallback –∞–Ω–∞–ª–∏–∑
        return self._fallback_relation_analysis(current_query, previous_topics)
    
    def _fallback_relation_analysis(self, query: str, previous_topics: List[str]) -> Tuple[bool, str, float]:
        """–†–µ–∑–µ—Ä–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º"""
        query_lower = query.lower()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, —É–∫–∞–∑—ã–≤–∞—é—â–∏—Ö –Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
        continuation_words = ['—Ç–∞–∫–∂–µ', '–µ—â—ë', '–µ—â–µ', '–∫—Å—Ç–∞—Ç–∏', '–ø—Ä–æ–¥–æ–ª–∂–∞—è', '–¥–æ–±–∞–≤–ª—é', '–∫—Ä–æ–º–µ —Ç–æ–≥–æ']
        is_continuation = any(word in query_lower for word in continuation_words)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ–º—ã
        topic_mentioned = any(topic.lower() in query_lower for topic in previous_topics if len(topic) > 3)
        
        if is_continuation:
            return True, "continuation", 0.8
        elif topic_mentioned:
            return True, "clarification", 0.7
        else:
            return False, "new_topic", 0.6

### 11. üéØ –ì–ª–∞–≤–Ω—ã–π –∞–≥–µ–Ω—Ç (–ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
class ConfigurableClarifyingAgent:
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç —Å–æ –≤—Å–µ–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏"""
    
    def __init__(self, config: AgentConfig = None):
        self.config = config or AgentConfig()
        self.history = DialogueHistory()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        self.relation_analyzer = RelationAnalyzer()
        self.context_manager = ContextManager(self.config)
        self.memory_manager = MemoryManager(self.config.max_history_length) if self.config.use_context_compression else None
        self.emotion_analyzer = EmotionAnalyzer() if self.config.enable_emotion_analysis else None
        self.proactive_assistant = ProactiveAssistant() if self.config.enable_proactive_suggestions else None
        self.quality_metrics = QualityMetrics() if self.config.enable_quality_metrics else None
        self.knowledge_integrator = KnowledgeIntegrator() if self.config.enable_knowledge_integration else None
        self.visualizer = DialogueVisualizer() if self.config.enable_dialogue_visualization else None
        
        # –¶–µ–ø–æ—á–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ (–æ—Å—Ç–∞—é—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)
        self.question_chains = self._initialize_question_chains()
        self.answer_chain = self._initialize_answer_chain()
    
    def _initialize_question_chains(self) -> Dict[str, LLMChain]:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ü–µ–ø–æ—á–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤"""
        prompts = {
            "continuation": PromptTemplate(
                input_variables=["user_query", "primary_context", "covered_topics", "current_topic"],
                template="""
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é —Ç–µ–º—É –¥–∏–∞–ª–æ–≥–∞.

                –¢–ï–ö–£–©–ê–Ø –¢–ï–ú–ê: {current_topic}
                –ö–û–ù–¢–ï–ö–°–¢: {primary_context}

                –£–ñ–ï –ó–ê–¢–†–û–ù–£–¢–´–ï –¢–ï–ú–´: {covered_topics}

                –¢–ï–ö–£–©–ò–ô –ó–ê–ü–†–û–°: {user_query}

                –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ {min_questions}-{max_questions} —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ:
                - –£–≥–ª—É–±–ª—è—é—Ç —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
                - –ù–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è
                - –ü–æ–º–æ–≥–∞—é—Ç —Ä–∞–∑–≤–∏—Ç—å –¥–∏–∞–ª–æ–≥

                –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):
                """
            ),
            # ... –¥—Ä—É–≥–∏–µ –ø—Ä–æ–º–ø—Ç—ã (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
        }
        
        return {key: LLMChain(llm=llm, prompt=prompt, output_parser=QuestionOutputParser()) 
                for key, prompt in prompts.items()}
    
    def _initialize_answer_chain(self) -> LLMChain:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ü–µ–ø–æ—á–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤"""
        answer_prompt = PromptTemplate(
            input_variables=["question", "context", "relation_type"],
            template="""
            –£—á–∏—Ç—ã–≤–∞—è —Ç–∏–ø —Å–≤—è–∑–∏ ({relation_type}) –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ 2 —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

            –ö–û–ù–¢–ï–ö–°–¢: {context}
            –í–û–ü–†–û–°: {question}

            –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ 2 –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ:
            - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç–∏–ø—É —Å–≤—è–∑–∏: {relation_type}
            - –£—á–∏—Ç—ã–≤–∞—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞
            - –ö—Ä–∞—Ç–∫–∏ –∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã

            –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.

            –ì–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã:
            """
        )
        return LLMChain(llm=llm, prompt=answer_prompt, output_parser=AnswerOutputParser())
    
    def process_query(self, user_query: str) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ –≤—Å–µ–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏"""
        start_time = time.time()
        
        print(f"\n{'='*70}")
        print(f"üîç –ù–û–í–´–ô –ó–ê–ü–†–û–°: {user_query}")
        print(f"{'='*70}")
        
        # –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–º—ã
        query_topic = self.history.detect_topic(user_query)
        print(f"üè∑Ô∏è  –û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è —Ç–µ–º–∞: {query_topic}")
        
        # –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–π
        emotion_data = None
        if self.emotion_analyzer:
            emotion_data = self.emotion_analyzer.analyze_emotion(user_query)
            print(f"‚ù§Ô∏è  –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑: {emotion_data['sentiment']} ({emotion_data['emotional_state']})")
        
        # –®–∞–≥ 3: –ê–Ω–∞–ª–∏–∑ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
        dialogue_context = self.history.get_recent_context()
        previous_topics = self.history.topics
        
        is_related, relation_type, confidence = self.relation_analyzer.analyze_relation(
            user_query, dialogue_context, previous_topics
        )
        
        print(f"üîó –°–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å: {is_related} (—Ç–∏–ø: {relation_type}, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence:.2f})")
        
        # –®–∞–≥ 4: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        context_strategy = self.context_manager.get_context_strategy(relation_type, confidence)
        contexts = self.context_manager.prepare_context(self.history, context_strategy, 
                                                      self.history.current_topic)
        
        print(f"üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {context_strategy['primary']} ({context_strategy['depth']})")
        
        # –®–∞–≥ 5: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤
        questions = self._generate_questions(user_query, relation_type, contexts, query_topic)
        
        # –®–∞–≥ 6: –û–±–æ–≥–∞—â–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π
        if self.knowledge_integrator:
            questions = self.knowledge_integrator.enrich_with_knowledge(questions, query_topic, relation_type)
        
        # –®–∞–≥ 7: –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ç–æ–Ω–∞
        if self.emotion_analyzer and emotion_data:
            questions = self.emotion_analyzer.adjust_tone_for_questions(
                questions, emotion_data, self.config.question_style
            )
        
        print(f"\n‚ùì –£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã ({len(questions)}):")
        for i, q in enumerate(questions, 1):
            print(f"  {i}. {q}")
        
        # –®–∞–≥ 8: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
        results = []
        for question in questions:
            answers = self.answer_chain.run(
                question=question,
                context=contexts.get("primary", ""),
                relation_type=relation_type
            )
            results.append({
                "question": question,
                "hypothetical_answers": answers
            })
        
        # –®–∞–≥ 9: –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
        proactive_suggestions = []
        if self.proactive_assistant and confidence > 0.6:
            proactive_suggestions = self.proactive_assistant.generate_proactive_suggestions(
                self.history, query_topic, list(self.history.user_interests)
            )
        
        # –®–∞–≥ 10: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
        if not is_related or relation_type in ["new_topic", "topic_change"]:
            history_topic = query_topic
        else:
            history_topic = self.history.current_topic
        
        # –®–∞–≥ 11: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        self.history.add_message("user", user_query, topic=history_topic, emotion_data=emotion_data)
        self.history.add_message("assistant", 
                               f"–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (—Å–≤—è–∑—å: {relation_type})", 
                               results, 
                               topic=history_topic)
        
        # –®–∞–≥ 12: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é
        if self.memory_manager and len(self.history.history) > self.config.max_history_length:
            self.history.history = self.memory_manager.compress_history(self.history.history)
        
        # –®–∞–≥ 13: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
        response_time = time.time() - start_time
        if self.quality_metrics:
            relation_data = {
                "is_related": is_related,
                "relation_type": relation_type,
                "confidence": confidence,
                "emotion_data": emotion_data
            }
            self.quality_metrics.log_interaction(relation_data, questions, response_time)
        
        # –®–∞–≥ 14: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        result = {
            "user_query": user_query,
            "query_topic": query_topic,
            "is_related": is_related,
            "relation_type": relation_type,
            "confidence": confidence,
            "emotion_data": emotion_data,
            "clarifying_questions": results,
            "proactive_suggestions": proactive_suggestions,
            "response_time": response_time,
            "context_strategy": context_strategy,
            "history_length": len(self.history.history)
        }
        
        # –®–∞–≥ 15: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        self._display_interaction_result(result)
        
        return result
    
    def _generate_questions(self, user_query: str, relation_type: str, contexts: Dict, query_topic: str) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ —Å–≤—è–∑–∏"""
        chain_key = relation_type if relation_type in self.question_chains else "continuation"
        chain = self.question_chains[chain_key]
        
        chain_input = {
            "user_query": user_query,
            "primary_context": contexts.get("primary", ""),
            "covered_topics": ", ".join(self.history.get_already_covered_topics()),
            "current_topic": self.history.current_topic or query_topic,
            "min_questions": self.config.min_questions,
            "max_questions": self.config.max_questions
        }
        
        questions = chain.run(**chain_input)
        return questions[:self.config.max_questions]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    
    def _display_interaction_result(self, result: Dict):
        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è"""
        print(f"\nüéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø:")
        print(f"   ‚Ä¢ –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {result['response_time']:.2f}—Å")
        print(f"   ‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è: {result['context_strategy']['primary']}")
        print(f"   ‚Ä¢ –í–æ–ø—Ä–æ—Å–æ–≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {len(result['clarifying_questions'])}")
        
        if result['proactive_suggestions']:
            print(f"   ‚Ä¢ –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: {len(result['proactive_suggestions'])}")
            for i, suggestion in enumerate(result['proactive_suggestions'], 1):
                print(f"     {i}. [{suggestion['type']}] {suggestion['description']}")
        
        print(f"\nü§î –£–¢–û–ß–ù–Ø–Æ–©–ò–ï –í–û–ü–†–û–°–´:")
        for i, item in enumerate(result["clarifying_questions"], 1):
            print(f"  {i}. {item['question']}")
            for j, answer in enumerate(item['hypothetical_answers'], 1):
                print(f"     {j}. {answer}")
    
    def display_comprehensive_analysis(self):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞"""
        if self.visualizer:
            self.visualizer.print_conversation_analysis(self)
        
        if self.quality_metrics:
            performance = self.quality_metrics.get_performance_summary()
            print(f"\nüìà –ú–ï–¢–†–ò–ö–ò –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò:")
            for key, value in performance.items():
                print(f"   ‚Ä¢ {key}: {value}")

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã
class QuestionOutputParser(BaseOutputParser):
    def parse(self, text: str):
        questions = [line.strip() for line in text.split('\n') if line.strip()]
        clean_questions = [q.split('. ', 1)[-1] for q in questions]
        return clean_questions

class AnswerOutputParser(BaseOutputParser):
    def parse(self, text: str):
        answers = [line.strip() for line in text.split('\n') if line.strip()]
        clean_answers = [a.split(' ', 1)[-1] if a.startswith(('-', '*')) else a for a in answers]
        return clean_answers

### –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
def demo_enhanced_agent():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞"""
    
    # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    config = AgentConfig(
        enable_emotion_analysis=True,
        enable_proactive_suggestions=True,
        enable_quality_metrics=True,
        enable_knowledge_integration=True,
        enable_dialogue_visualization=True,
        question_style="friendly"
    )
    
    agent = ConfigurableClarifyingAgent(config)
    
    # –°–∏–º—É–ª—è—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
    scenarios = [
        "–•–æ—á—É —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤ –ï–≤—Ä–æ–ø—É —ç—Ç–∏–º –ª–µ—Ç–æ–º.",
        "–ö—Å—Ç–∞—Ç–∏, —è —Ç–∞–∫–∂–µ —Ö–æ—á—É –ø–æ—Å–µ—Ç–∏—Ç—å –º—É–∑–µ–∏ –∏ –≥–∞–ª–µ—Ä–µ–∏.",  # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
        "–ú–æ–π –±—é–¥–∂–µ—Ç –æ–∫–æ–ª–æ 2000 –µ–≤—Ä–æ –Ω–∞ –Ω–µ–¥–µ–ª—é.",  # –£—Ç–æ—á–Ω–µ–Ω–∏–µ
        "–ê –∫–∞–∫ –Ω–∞—Å—á–µ—Ç –≤–∏–∑–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–µ–∑–¥–∫–∏?",  # –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ–º—ã
        "–°–ø–∞—Å–∏–±–æ! –ö—Å—Ç–∞—Ç–∏, –º–Ω–µ –Ω—É–∂–Ω–æ –∫—É–ø–∏—Ç—å –Ω–æ–≤—ã–π –Ω–æ—É—Ç–±—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã.",  # –ù–æ–≤–∞—è —Ç–µ–º–∞
        "–ò—â—É —á—Ç–æ-—Ç–æ –º–æ—â–Ω–æ–µ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏–≥—Ä.",  # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–µ–º—ã
        "–í–æ–∑–≤—Ä–∞—â–∞—è—Å—å –∫ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—é, –∫–∞–∫–æ–π —Å–µ–∑–æ–Ω –ª—É—á—à–µ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è –ò—Ç–∞–ª–∏–∏?"  # –í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç–µ–º–µ
    ]
    
    print("üöÄ –ó–ê–ü–£–°–ö –£–õ–£–ß–®–ï–ù–ù–û–ì–û –ê–ì–ï–ù–¢–ê –° –ò–°–ö–£–°–°–¢–í–ï–ù–ù–´–ú –ò–ù–¢–ï–õ–õ–ï–ö–¢–û–ú")
    print("=" * 80)
    
    for i, query in enumerate(scenarios, 1):
        print(f"\n{'>>>'*10} –≠–¢–ê–ü {i} {'<<<'*10}")
        agent.process_query(query)
    
    # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    print(f"\n{'üîç'*20} –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó –î–ò–ê–õ–û–ì–ê {'üîç'*20}")
    agent.display_comprehensive_analysis()

if __name__ == "__main__":
    demo_enhanced_agent()
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- 11 –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –ì–∏–±–∫–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏

### 2. **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ —Ç–∏–ø—É —Å–≤—è–∑–∏ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 3. **–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç** 
- –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∏–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤
- –≠–º–ø–∞—Ç–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

### 4. **–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é –¥–∏–∞–ª–æ–≥–∞
- –í—ã—è–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –£–ø—Ä–µ–∂–¥–∞—é—â–∞—è –ø–æ–º–æ—â—å

### 5. **–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**
- –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏–∞–ª–æ–≥–∞

### 6. **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –¥–æ–º–µ–Ω

–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã, –∞ –≤–µ–¥–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π, –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–∑–∞–≤–∏—Å–∏–º—ã–π –¥–∏–∞–ª–æ–≥ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º! üöÄ

–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –†–µ–∞–ª–∏–∑—É—é –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —É–º–µ–µ—Ç –æ—Å–ª–∞–±–ª—è—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –ø–æ—Ö–æ–∂–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –ø–æ–º–æ—â—å—é LLM.

## üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –¥–ª—è –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞

```python
from langchain.chains import LLMChain
from langchain.prompts import PromptTemplate
from langchain.chat_models import ChatOpenAI
from typing import List, Dict, Any, Tuple, Optional
import json
import re
import time

class IntelligentCarSearcher:
    """–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Å –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤"""
    
    def __init__(self, car_database):
        self.car_database = car_database
        self.llm = llm
        
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –æ—Å–ª–∞–±–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Ç —Å–∞–º—ã—Ö –≥–∏–±–∫–∏—Ö –∫ —Å–∞–º—ã–º —Å—Ç—Ä–æ–≥–∏–º)
        self.relaxation_priority = [
            'color', 'features', 'transmission', 'fuel_type', 
            'max_price', 'min_year', 'category', 'brand'
        ]
        
        # –®–∞–±–ª–æ–Ω—ã –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        self.relaxation_templates = {
            'price': PromptTemplate(
                input_variables=["current_value", "direction"],
                template="""
                –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ü–µ–Ω—ã: {current_value}
                –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è: {direction}
                
                –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞.
                –ï—Å–ª–∏ direction='up', —É–≤–µ–ª–∏—á—å—Ç–µ —Ü–µ–Ω—É –Ω–∞ 15-25%
                –ï—Å–ª–∏ direction='down', —É–º–µ–Ω—å—à–∏—Ç–µ —Ü–µ–Ω—É –Ω–∞ 10-20%
                
                –û—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–º:
                """
            ),
            'year': PromptTemplate(
                input_variables=["current_value", "direction"],
                template="""
                –¢–µ–∫—É—â–∏–π –≥–æ–¥: {current_value}
                –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è: {direction}
                
                –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –Ω–æ–≤—ã–π –≥–æ–¥ –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞.
                –ï—Å–ª–∏ direction='down', —É–º–µ–Ω—å—à–∏—Ç–µ –≥–æ–¥ –Ω–∞ 1-3 –≥–æ–¥–∞
                
                –û—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–º:
                """
            ),
            'text': PromptTemplate(
                input_variables=["current_value", "field_name", "available_options"],
                template="""
                –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è {field_name}: {current_value}
                –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: {available_options}
                
                –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –ø–æ—Ö–æ–∂–∏–µ –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞.
                –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON: {{"alternatives": ["–≤–∞—Ä–∏–∞–Ω—Ç1", "–≤–∞—Ä–∏–∞–Ω—Ç2"]}}
                """
            )
        }
    
    def search_with_intelligence(self, initial_params: Dict, user_query: str, dialogue_context: str) -> Dict[str, Any]:
        """–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Å –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤"""
        print(f"üîç –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö: {initial_params}")
        
        # –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
        results = self.car_database.search(initial_params)
        
        if results:
            print("‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è")
            return {
                "success": True,
                "results": results,
                "search_strategy": "exact_match",
                "relaxation_steps": 0,
                "final_parameters": initial_params
            }
        
        print("‚ö†Ô∏è –¢–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç, –Ω–∞—á–∏–Ω–∞—é –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤...")
        
        # –û—Å–ª–∞–±–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        relaxed_results = self._relax_filters(initial_params, user_query, dialogue_context)
        
        if relaxed_results["success"]:
            return relaxed_results
        
        # –ï—Å–ª–∏ –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ –Ω–µ –ø–æ–º–æ–≥–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É
        print("üéØ –ê–∫—Ç–∏–≤–∏—Ä—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É...")
        return self._recommend_alternatives(initial_params, user_query, dialogue_context)
    
    def _relax_filters(self, initial_params: Dict, user_query: str, dialogue_context: str) -> Dict[str, Any]:
        """–ü–æ—ç—Ç–∞–ø–Ω–æ–µ –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤"""
        current_params = initial_params.copy()
        relaxation_steps = 0
        max_relaxation_steps = 5
        
        for step in range(max_relaxation_steps):
            print(f"üîÑ –®–∞–≥ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è {step + 1}")
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, –∫–∞–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –ª—É—á—à–µ –æ—Å–ª–∞–±–∏—Ç—å
            param_to_relax = self._choose_parameter_to_relax(current_params, user_query, dialogue_context)
            
            if not param_to_relax:
                print("‚ùå –ù–µ –æ—Å—Ç–∞–ª–æ—Å—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è")
                break
            
            # –û—Å–ª–∞–±–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
            relaxed_params = self._relax_parameter(current_params, param_to_relax, user_query)
            
            if relaxed_params == current_params:
                print(f"‚ö†Ô∏è –ü–∞—Ä–∞–º–µ—Ç—Ä {param_to_relax} –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å–ª–∞–±–ª–µ–Ω")
                continue
            
            current_params = relaxed_params
            relaxation_steps += 1
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –æ—Å–ª–∞–±–ª–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            results = self.car_database.search(current_params)
            
            if results:
                print(f"‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ {relaxation_steps} —à–∞–≥–æ–≤ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è")
                return {
                    "success": True,
                    "results": results,
                    "search_strategy": f"relaxed_{relaxation_steps}_steps",
                    "relaxation_steps": relaxation_steps,
                    "final_parameters": current_params,
                    "relaxed_parameter": param_to_relax
                }
        
        return {"success": False, "results": []}
    
    def _choose_parameter_to_relax(self, current_params: Dict, user_query: str, dialogue_context: str) -> Optional[str]:
        """–í—ã–±–∏—Ä–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–∞"""
        
        analysis_prompt = PromptTemplate(
            input_variables=["current_params", "user_query", "dialogue_context", "relaxation_priority"],
            template="""
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ, –∫–∞–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è 
            –º–æ–∂–Ω–æ –æ—Å–ª–∞–±–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –±–µ–∑ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É—â–µ—Ä–±–∞ –¥–ª—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∫–ª–∏–µ–Ω—Ç–∞.

            –¢–ï–ö–£–©–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´: {current_params}
            –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}
            –ö–û–ù–¢–ï–ö–°–¢: {dialogue_context}
            –ü–†–ò–û–†–ò–¢–ï–¢ –û–°–õ–ê–ë–õ–ï–ù–ò–Ø: {relaxation_priority}

            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ:
            1. –ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ (—è–≤–Ω–æ —É–∫–∞–∑–∞–Ω—ã –∫–∞–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)
            2. –ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —è–≤–ª—è—é—Ç—Å—è –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏
            3. –í –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ –æ—Å–ª–∞–±–ª—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ –Ω–∞–∏–º–µ–Ω—å—à–µ–π –≤–∞–∂–Ω–æ—Å—Ç–∏

            –í–µ—Ä–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è (brand, category, max_price, min_year, fuel_type, transmission, color, features)
            –∏–ª–∏ "none" –µ—Å–ª–∏ –æ—Å–ª–∞–±–ª—è—Ç—å –Ω–µ—á–µ–≥–æ.

            –ü–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è:
            """
        )
        
        try:
            chain = LLMChain(llm=self.llm, prompt=analysis_prompt)
            response = chain.run(
                current_params=json.dumps(current_params, ensure_ascii=False),
                user_query=user_query,
                dialogue_context=dialogue_context,
                relaxation_priority=", ".join(self.relaxation_priority)
            ).strip().lower()
            
            if response != "none" and response in current_params:
                print(f"üéØ LLM —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –æ—Å–ª–∞–±–∏—Ç—å: {response}")
                return response
            
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –æ—Å–ª–∞–±–ª–µ–Ω–∏—è: {e}")
        
        # Fallback: –æ—Å–ª–∞–±–ª—è–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        for param in self.relaxation_priority:
            if param in current_params:
                return param
        
        return None
    
    def _relax_parameter(self, params: Dict, param_name: str, user_query: str) -> Dict:
        """–û—Å–ª–∞–±–ª—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Å –ø–æ–º–æ—â—å—é LLM"""
        current_value = params[param_name]
        relaxed_params = params.copy()
        
        print(f"üõ†Ô∏è –û—Å–ª–∞–±–ª—è—é –ø–∞—Ä–∞–º–µ—Ç—Ä {param_name}: {current_value}")
        
        try:
            if param_name in ['max_price', 'min_price']:
                # –û—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ü–µ–Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                direction = 'up' if param_name == 'max_price' else 'down'
                new_value = self._relax_numeric_parameter(current_value, 'price', direction)
                if new_value:
                    relaxed_params[param_name] = new_value
            
            elif param_name == 'min_year':
                # –û—Å–ª–∞–±–ª–µ–Ω–∏–µ –≥–æ–¥–∞ –≤—ã–ø—É—Å–∫–∞
                new_value = self._relax_numeric_parameter(current_value, 'year', 'down')
                if new_value:
                    relaxed_params[param_name] = new_value
            
            elif param_name == 'brand':
                # –û—Å–ª–∞–±–ª–µ–Ω–∏–µ –º–∞—Ä–∫–∏ - –∏—â–µ–º –ø–æ—Ö–æ–∂–∏–µ –º–∞—Ä–∫–∏
                alternatives = self._find_similar_brands(current_value, user_query)
                if alternatives:
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –º–∞—Ä–∫—É
                    relaxed_params[param_name] = alternatives[0]
                    print(f"üîÄ –ó–∞–º–µ–Ω—è—é –º–∞—Ä–∫—É {current_value} –Ω–∞ {alternatives[0]}")
            
            elif param_name == 'category':
                # –û—Å–ª–∞–±–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                alternatives = self._find_similar_categories(current_value, user_query)
                if alternatives:
                    relaxed_params[param_name] = alternatives[0]
                    print(f"üîÄ –ó–∞–º–µ–Ω—è—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é {current_value} –Ω–∞ {alternatives[0]}")
            
            elif param_name in ['fuel_type', 'transmission']:
                # –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø—É —Ç–æ–ø–ª–∏–≤–∞ –∏ –ö–ü–ü
                del relaxed_params[param_name]
                print(f"üóëÔ∏è –£–¥–∞–ª—è—é —Ñ–∏–ª—å—Ç—Ä {param_name}")
            
            else:
                # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä
                del relaxed_params[param_name]
                print(f"üóëÔ∏è –£–¥–∞–ª—è—é —Ñ–∏–ª—å—Ç—Ä {param_name}")
                
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ {param_name}: {e}")
        
        return relaxed_params
    
    def _relax_numeric_parameter(self, current_value: Any, param_type: str, direction: str) -> Optional[Any]:
        """–û—Å–ª–∞–±–ª—è–µ—Ç —á–∏—Å–ª–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –ø–æ–º–æ—â—å—é LLM"""
        try:
            template = self.relaxation_templates.get(param_type, self.relaxation_templates['text'])
            chain = LLMChain(llm=self.llm, prompt=template)
            
            response = chain.run(
                current_value=current_value,
                direction=direction
            ).strip()
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ –∏–∑ –æ—Ç–≤–µ—Ç–∞
            numbers = re.findall(r'\d+', response)
            if numbers:
                new_value = int(numbers[0])
                print(f"üìä –û—Å–ª–∞–±–ª—è—é {param_type}: {current_value} -> {new_value}")
                return new_value
                
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: {e}")
        
        # Fallback: –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞
        if param_type == 'price' and direction == 'up':
            return int(current_value * 1.2)
        elif param_type == 'price' and direction == 'down':
            return int(current_value * 0.8)
        elif param_type == 'year' and direction == 'down':
            return current_value - 2
        
        return None
    
    def _find_similar_brands(self, brand: str, user_query: str) -> List[str]:
        """–ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –º–∞—Ä–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Å –ø–æ–º–æ—â—å—é LLM"""
        
        similar_brands_prompt = PromptTemplate(
            input_variables=["brand", "user_query", "available_brands"],
            template="""
            –ù–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–∫–∞–∑–∞–Ω–Ω–æ–π –º–∞—Ä–∫–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è, 
            –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –ø–æ—Ö–æ–∂–∏–µ –º–∞—Ä–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–¥–æ–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç—É.

            –ò–°–ö–û–ú–ê–Ø –ú–ê–†–ö–ê: {brand}
            –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}
            –î–û–°–¢–£–ü–ù–´–ï –ú–ê–†–ö–ò: {available_brands}

            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ:
            - –ö–ª–∞—Å—Å –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–∏ (–ø—Ä–µ–º–∏—É–º, –º–∞—Å—Å-–º–∞—Ä–∫–µ—Ç, –±—é–¥–∂–µ—Ç–Ω—ã–π)
            - –°—Ç–∏–ª—å –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –º–∞—Ä–∫–∏
            - –¶–µ–Ω–æ–≤–æ–π —Å–µ–≥–º–µ–Ω—Ç
            - –¶–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é

            –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ 3-5 –ø–æ—Ö–æ–∂–∏—Ö –º–∞—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ—Å—Ç–æ–π–Ω–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–æ–π.

            –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "similar_brands": ["–º–∞—Ä–∫–∞1", "–º–∞—Ä–∫–∞2", "–º–∞—Ä–∫–∞3"],
                "reasoning": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ"
            }}
            """
        )
        
        try:
            available_brands = self.car_database.get_available_brands()
            chain = LLMChain(llm=self.llm, prompt=similar_brands_prompt)
            response = chain.run(
                brand=brand,
                user_query=user_query,
                available_brands=", ".join(available_brands)
            )
            
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group())
                similar = result.get("similar_brands", [])
                # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä–∫–∏
                available_similar = [b for b in similar if b in available_brands]
                if available_similar:
                    print(f"üîç –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ö–æ–∂–∏–µ –º–∞—Ä–∫–∏: {available_similar}")
                    return available_similar
                    
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –º–∞—Ä–æ–∫: {e}")
        
        # Fallback: –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏
        brand_analogs = {
            "BMW": ["Audi", "Mercedes-Benz", "Lexus"],
            "Audi": ["BMW", "Mercedes-Benz", "Volvo"],
            "Mercedes-Benz": ["BMW", "Audi", "Lexus"],
            "Toyota": ["Honda", "Nissan", "Mazda"],
            "Honda": ["Toyota", "Nissan", "Mazda"],
            "Kia": ["Hyundai", "Renault", "Skoda"],
            "Hyundai": ["Kia", "Renault", "Skoda"],
            "Ford": ["Opel", "Volkswagen", "Peugeot"],
            "Volkswagen": ["Skoda", "Seat", "Ford"]
        }
        
        return brand_analogs.get(brand, [])
    
    def _find_similar_categories(self, category: str, user_query: str) -> List[str]:
        """–ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Ö–æ–∂–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫—É–∑–æ–≤–æ–≤ —Å –ø–æ–º–æ—â—å—é LLM"""
        
        similar_categories_prompt = PromptTemplate(
            input_variables=["category", "user_query", "available_categories"],
            template="""
            –ù–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è, 
            –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –ø–æ—Ö–æ–∂–∏–µ —Ç–∏–ø—ã –∫—É–∑–æ–≤–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø–æ–¥–æ–π—Ç–∏ –∫–ª–∏–µ–Ω—Ç—É.

            –ò–°–ö–û–ú–ê–Ø –ö–ê–¢–ï–ì–û–†–ò–Ø: {category}
            –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}
            –î–û–°–¢–£–ü–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò: {available_categories}

            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ:
            - –ü—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            - –í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ –∫–æ–º—Ñ–æ—Ä—Ç
            - –£–ø—Ä–∞–≤–ª—è–µ–º–æ—Å—Ç—å –∏ —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ—Å—Ç—å
            - –°—Ç–∏–ª—å –∏ –∏–º–∏–¥–∂

            –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ 2-3 –ø–æ—Ö–æ–∂–∏—Ö —Ç–∏–ø–∞ –∫—É–∑–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ—Å—Ç–æ–π–Ω–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–æ–π.

            –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "similar_categories": ["–∫–∞—Ç–µ–≥–æ—Ä–∏—è1", "–∫–∞—Ç–µ–≥–æ—Ä–∏—è2"],
                "reasoning": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ"
            }}
            """
        )
        
        try:
            available_categories = self.car_database.get_available_categories()
            chain = LLMChain(llm=self.llm, prompt=similar_categories_prompt)
            response = chain.run(
                category=category,
                user_query=user_query,
                available_categories=", ".join(available_categories)
            )
            
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group())
                similar = result.get("similar_categories", [])
                # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                available_similar = [c for c in similar if c in available_categories]
                if available_similar:
                    print(f"üîç –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ö–æ–∂–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {available_similar}")
                    return available_similar
                    
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: {e}")
        
        # Fallback: –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏
        category_analogs = {
            "—Å–µ–¥–∞–Ω": ["—É–Ω–∏–≤–µ—Ä—Å–∞–ª", "–ª–∏—Ñ—Ç–±–µ–∫", "—Ö—ç—Ç—á–±–µ–∫"],
            "–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫": ["–∫—Ä–æ—Å—Å–æ–≤–µ—Ä", "—É–Ω–∏–≤–µ—Ä—Å–∞–ª"],
            "–∫—Ä–æ—Å—Å–æ–≤–µ—Ä": ["–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫", "—É–Ω–∏–≤–µ—Ä—Å–∞–ª"],
            "—Ö—ç—Ç—á–±–µ–∫": ["–ª–∏—Ñ—Ç–±–µ–∫", "—É–Ω–∏–≤–µ—Ä—Å–∞–ª", "—Å–µ–¥–∞–Ω"],
            "—É–Ω–∏–≤–µ—Ä—Å–∞–ª": ["–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫", "–∫—Ä–æ—Å—Å–æ–≤–µ—Ä", "—Ö—ç—Ç—á–±–µ–∫"],
            "–ª–∏—Ñ—Ç–±–µ–∫": ["—Ö—ç—Ç—á–±–µ–∫", "—É–Ω–∏–≤–µ—Ä—Å–∞–ª", "—Å–µ–¥–∞–Ω"]
        }
        
        return category_analogs.get(category, [])
    
    def _recommend_alternatives(self, initial_params: Dict, user_query: str, dialogue_context: str) -> Dict[str, Any]:
        """–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–æ–≥–¥–∞ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"""
        
        recommendation_prompt = PromptTemplate(
            input_variables=["initial_params", "user_query", "dialogue_context", "available_cars"],
            template="""
            –í—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ–¥–±–æ—Ä—É –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π. –ö–ª–∏–µ–Ω—Ç—É –Ω–µ –ø–æ–¥–æ—à–ª–∏ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

            –ò–°–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´: {initial_params}
            –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}
            –ö–û–ù–¢–ï–ö–°–¢ –î–ò–ê–õ–û–ì–ê: {dialogue_context}
            –î–û–°–¢–£–ü–ù–´–ï –ê–í–¢–û–ú–û–ë–ò–õ–ò: {available_cars}

            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ:
            1. –ü–æ—á–µ–º—É –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (—Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã, –Ω–µ—Ä–µ–∞–ª—å–Ω—ã–µ –æ–∂–∏–¥–∞–Ω–∏—è)
            2. –ö–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
            3. –ö–∞–∫–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –±–ª–∏–∑–∫–∏ –∫ –∑–∞–ø—Ä–æ—Å—É

            –ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ 3 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
            - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞
            - –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –º–∞—Ä–æ–∫/–∫–∞—Ç–µ–≥–æ—Ä–∏–π
            - –ö–æ–º–ø—Ä–æ–º–∏—Å—Å—ã –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º

            –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "analysis": "–∞–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏",
                "recommendations": [
                    {{
                        "type": "–±—é–¥–∂–µ—Ç/–º–∞—Ä–∫–∞/–∫–∞—Ç–µ–≥–æ—Ä–∏—è/—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏",
                        "description": "—Ç–µ–∫—Å—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
                        "expected_benefit": "—á—Ç–æ —ç—Ç–æ –¥–∞—Å—Ç"
                    }}
                ],
                "closest_matches": [
                    {{
                        "car_id": "id –∞–≤—Ç–æ–º–æ–±–∏–ª—è",
                        "match_reason": "–ø–æ—á–µ–º—É —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω"
                    }}
                ]
            }}
            """
        )
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            all_cars = self.car_database.search({})
            sample_cars = all_cars[:10]  # –ë–µ—Ä–µ–º sample –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            
            chain = LLMChain(llm=self.llm, prompt=recommendation_prompt)
            response = chain.run(
                initial_params=json.dumps(initial_params, ensure_ascii=False),
                user_query=user_query,
                dialogue_context=dialogue_context,
                available_cars=json.dumps(sample_cars, ensure_ascii=False)
            )
            
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                recommendation = json.loads(json_match.group())
                
                # –ù–∞—Ö–æ–¥–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
                recommended_cars = []
                for match in recommendation.get("closest_matches", []):
                    car_id = match.get("car_id")
                    car = next((c for c in all_cars if c.get("id") == car_id), None)
                    if car:
                        recommended_cars.append(car)
                
                if recommended_cars:
                    return {
                        "success": True,
                        "results": recommended_cars,
                        "search_strategy": "recommendation_system",
                        "recommendation_analysis": recommendation,
                        "final_parameters": initial_params
                    }
                    
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã: {e}")
        
        # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª—É—á–∞–π–Ω—ã—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
        all_cars = self.car_database.search({})
        if all_cars:
            return {
                "success": True,
                "results": all_cars[:3],
                "search_strategy": "fallback_random",
                "final_parameters": {}
            }
        
        return {"success": False, "results": []}

class FuzzyQueryInterpreter:
    """–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä —Ä–∞–∑–º—ã—Ç—ã—Ö –∏ –Ω–µ—á–µ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    def __init__(self):
        self.llm = llm
        
        self.interpretation_prompt = PromptTemplate(
            input_variables=["user_query", "dialogue_context", "available_brands", "available_categories"],
            template="""
            –í—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞. –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–∑–º—ã—Ç—ã–π –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ 
            –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π.

            –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}
            –ö–û–ù–¢–ï–ö–°–¢ –î–ò–ê–õ–û–ì–ê: {dialogue_context}
            –î–û–°–¢–£–ü–ù–´–ï –ú–ê–†–ö–ò: {available_brands}
            –î–û–°–¢–£–ü–ù–´–ï –ö–ê–¢–ï–ì–û–†–ò–ò: {available_categories}

            –†–∞—Å–ø–æ–∑–Ω–∞–π—Ç–µ –≤ –∑–∞–ø—Ä–æ—Å–µ:
            - –ë—é–¥–∂–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (–¥–µ—à–µ–≤—ã–π, –¥–æ—Ä–æ–≥–æ–π, —ç–∫–æ–Ω–æ–º-–∫–ª–∞—Å—Å, –ø—Ä–µ–º–∏—É–º)
            - –¢–∏–ø –∞–≤—Ç–æ–º–æ–±–∏–ª—è (—Å–µ–º–µ–π–Ω—ã–π, –≥–æ—Ä–æ–¥—Å–∫–æ–π, –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π, –±–∏–∑–Ω–µ—Å-–∫–ª–∞—Å—Å)
            - –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–≥–æ—Ä–æ–¥, —Ç—Ä–∞—Å—Å–∞, –±–µ–∑–¥–æ—Ä–æ–∂—å–µ)
            - –ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (—ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π, –º–æ—â–Ω—ã–π, –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π, –Ω–∞–¥–µ–∂–Ω—ã–π)

            –ü—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.

            –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
            {{
                "interpreted_parameters": {{
                    "max_price": —á–∏—Å–ª–æ,
                    "category": "–∫–∞—Ç–µ–≥–æ—Ä–∏—è",
                    "fuel_type": "—Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞",
                    "keywords": "–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞"
                }},
                "confidence": 0.85,
                "reasoning": "–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏",
                "clarification_questions": [
                    "–≤–æ–ø—Ä–æ—Å –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è 1",
                    "–≤–æ–ø—Ä–æ—Å –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è 2"
                ]
            }}
            """
        )
    
    def interpret_fuzzy_query(self, user_query: str, dialogue_context: str, 
                            available_brands: List[str], available_categories: List[str]) -> Dict[str, Any]:
        """–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–º—ã—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"""
        
        print(f"üéØ –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É—é —Ä–∞–∑–º—ã—Ç—ã–π –∑–∞–ø—Ä–æ—Å: {user_query}")
        
        try:
            chain = LLMChain(llm=self.llm, prompt=self.interpretation_prompt)
            response = chain.run(
                user_query=user_query,
                dialogue_context=dialogue_context,
                available_brands=", ".join(available_brands),
                available_categories=", ".join(available_categories)
            )
            
            json_match = re.search(r'\{.*\}', response, re.DOTALL)
            if json_match:
                interpretation = json.loads(json_match.group())
                
                print(f"‚úÖ –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {interpretation.get('confidence', 0)})")
                return interpretation
                
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        
        # Fallback –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
        return {
            "interpreted_parameters": {},
            "confidence": 0.5,
            "reasoning": "–ù–µ —É–¥–∞–ª–æ—Å—å —Ç–æ—á–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å",
            "clarification_questions": [
                "–ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç –≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ?",
                "–î–ª—è –∫–∞–∫–∏—Ö —Ü–µ–ª–µ–π –Ω—É–∂–µ–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª—å?"
            ]
        }

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É

class EnhancedCarDealerDatabaseManager:
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ë–î —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–º –ø–æ–∏—Å–∫–æ–º"""
    
    def __init__(self, dealer_config: CarDealerConfig):
        self.config = dealer_config
        self.car_database = CarDatabase()
        self.intelligent_searcher = IntelligentCarSearcher(self.car_database)
        self.query_interpreter = FuzzyQueryInterpreter()
    
    def search(self, domain: str, parameters: Dict[str, Any], 
               user_query: str = "", dialogue_context: str = "") -> Dict[str, Any]:
        """–£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π"""
        
        if domain != "–∞–≤—Ç–æ–º–æ–±–∏–ª–∏":
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–æ–≤
            database = self.databases.get(domain)
            if database:
                results = database.search(parameters)
                return {
                    "success": True,
                    "results": results,
                    "search_strategy": "standard"
                }
            return {"success": False, "results": []}
        
        # –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
        return self.intelligent_searcher.search_with_intelligence(
            parameters, user_query, dialogue_context
        )
    
    def interpret_and_search(self, user_query: str, dialogue_context: str) -> Dict[str, Any]:
        """–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–º—ã—Ç—ã–π –∑–∞–ø—Ä–æ—Å –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫"""
        
        available_brands = self.car_database.get_available_brands()
        available_categories = self.car_database.get_available_categories()
        
        # –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        interpretation = self.query_interpreter.interpret_fuzzy_query(
            user_query, dialogue_context, available_brands, available_categories
        )
        
        parameters = interpretation.get("interpreted_parameters", {})
        confidence = interpretation.get("confidence", 0)
        
        print(f"üîç –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: {parameters} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence})")
        
        # –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        if confidence > 0.7:
            search_result = self.intelligent_searcher.search_with_intelligence(
                parameters, user_query, dialogue_context
            )
            
            search_result["interpretation"] = interpretation
            return search_result
        else:
            # –ï—Å–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∏–∑–∫–∞—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
            return {
                "success": False,
                "needs_clarification": True,
                "clarification_questions": interpretation.get("clarification_questions", []),
                "interpretation": interpretation
            }

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –≥–ª–∞–≤–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–º –ø–æ–∏—Å–∫–æ–º

class IntelligentCarDealerAssistant(CarDealerAssistant):
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–º –ø–æ–∏—Å–∫–æ–º"""
    
    def __init__(self, dealer_config: CarDealerConfig = None):
        super().__init__(dealer_config)
        
        # –ó–∞–º–µ–Ω—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –ë–î –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
        self.database_manager = EnhancedCarDealerDatabaseManager(dealer_config)
        
        print("üß† –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
    
    def process_query(self, user_query: str) -> Dict[str, Any]:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–º –ø–æ–∏—Å–∫–æ–º"""
        start_time = time.time()
        
        print(f"\n{'='*70}")
        print(f"üöó –ó–ê–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {user_query}")
        print(f"{'='*70}")
        
        # –ê–Ω–∞–ª–∏–∑ —Ç–µ–º—ã –∏ —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (–∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞)
        query_topic = self.history.detect_topic(user_query)
        print(f"üè∑Ô∏è  –¢–µ–º–∞: {query_topic}")
        
        dialogue_context = self.history.get_recent_context()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞
        is_fuzzy_query = self._is_fuzzy_query(user_query)
        
        search_performed = False
        search_results = None
        search_context = ""
        
        if is_fuzzy_query:
            print("üéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ä–∞–∑–º—ã—Ç—ã–π –∑–∞–ø—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É—é –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é...")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é
            search_response = self.database_manager.interpret_and_search(user_query, dialogue_context)
            
            if search_response.get("needs_clarification"):
                # –ó–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è
                clarification_questions = search_response.get("clarification_questions", [])
                
                print(f"‚ùì –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ ({len(clarification_questions)} –≤–æ–ø—Ä–æ—Å–æ–≤)")
                
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è
                results = []
                for question in clarification_questions:
                    answers = self._generate_clarification_answers(question, user_query)
                    results.append({
                        "question": question,
                        "hypothetical_answers": answers,
                        "type": "clarification"
                    })
                
                self._add_to_history(user_query, results, query_topic, 
                                   interpretation=search_response.get("interpretation"))
                
                return {
                    "user_query": user_query,
                    "query_topic": query_topic,
                    "needs_clarification": True,
                    "clarification_questions": results,
                    "interpretation": search_response.get("interpretation")
                }
            
            search_results = search_response
            search_performed = True
            
        else:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∞–Ω–∞–ª–∏–∑–æ–º –Ω–∞–º–µ—Ä–µ–Ω–∏—è
            available_brands = self.database_manager.car_database.get_available_brands()
            available_categories = self.database_manager.car_database.get_available_categories()
            
            search_intent = self.search_analyzer.analyze_search_intent(
                user_query, dialogue_context, self.history.current_topic or query_topic, available_categories
            )
            
            if search_intent["search_required"] and self.search_analyzer.should_perform_search(search_intent):
                # –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Å –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤
                search_results = self.database_manager.intelligent_searcher.search_with_intelligence(
                    search_intent["search_parameters"], user_query, dialogue_context
                )
                search_performed = True
        
        # –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é) –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –∫–ª–∞—Å—Å—É
        # ... (–ø—Ä–æ–ø—É—â–µ–Ω–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)
        
        response_time = time.time() - start_time
        
        result = {
            "user_query": user_query,
            "query_topic": query_topic,
            "search_performed": search_performed,
            "search_results": search_results,
            "response_time": response_time,
            "is_fuzzy_query": is_fuzzy_query
        }
        
        if search_performed and search_results:
            self._display_intelligent_search_result(result)
        
        return result
    
    def _is_fuzzy_query(self, user_query: str) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å —Ä–∞–∑–º—ã—Ç—ã–º"""
        fuzzy_indicators = [
            "–ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ", "—á—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—Ç–µ", "–∫–∞–∫–æ–π –≤—ã–±—Ä–∞—Ç—å", "–Ω–µ –∑–Ω–∞—é —á—Ç–æ –≤—ã–±—Ä–∞—Ç—å",
            "—Ö–æ—á—É –º–∞—à–∏–Ω—É", "–Ω—É–∂–Ω–∞ –º–∞—à–∏–Ω–∞", "–ø–æ–¥–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ", "–∫–∞–∫–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å",
            "–¥–ª—è —Å–µ–º—å–∏", "–¥–ª—è –≥–æ—Ä–æ–¥–∞", "–Ω–∞ —Ä–∞–±–æ—Ç—É", "–≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è",
            "–Ω–∞–¥–µ–∂–Ω—ã–π", "—ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π", "–∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π", "–ø—Ä–µ—Å—Ç–∏–∂–Ω—ã–π"
        ]
        
        query_lower = user_query.lower()
        return any(indicator in query_lower for indicator in fuzzy_indicators)
    
    def _generate_clarification_answers(self, question: str, user_query: str) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —É—Ç–æ—á–Ω–µ–Ω–∏—è"""
        
        answer_prompt = PromptTemplate(
            input_variables=["question", "user_query"],
            template="""
            –ù–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ 2 –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞ 
            –Ω–∞ —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ–¥–∞–≤—Ü–∞.

            –ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {user_query}
            –í–û–ü–†–û–° –ü–†–û–î–ê–í–¶–ê: {question}

            –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ:
            - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
            - –Ø–≤–ª—è—é—Ç—Å—è —Ç–∏–ø–∏—á–Ω—ã–º–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ—Å–∞–ª–æ–Ω–∞
            - –ü–æ–º–æ–≥–∞—é—Ç –ø—Ä–æ—è—Å–Ω–∏—Ç—å –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏

            –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.

            –û—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞:
            """
        )
        
        try:
            chain = LLMChain(llm=self.llm, prompt=answer_prompt)
            response = chain.run(question=question, user_query=user_query)
            
            answers = [line.strip() for line in response.split('\n') if line.strip()]
            return answers[:2]
        except:
            return ["–ù—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å...", "–î–∞–≤–∞–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –æ–±—Å—É–¥–∏–º –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã"]
    
    def _display_intelligent_search_result(self, result: Dict):
        """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞"""
        search_results = result["search_results"]
        
        print(f"\nüéØ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê:")
        print(f"   ‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∏—Å–∫–∞: {search_results.get('search_strategy', 'unknown')}")
        
        if search_results.get('relaxation_steps', 0) > 0:
            print(f"   ‚Ä¢ –®–∞–≥–æ–≤ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è: {search_results['relaxation_steps']}")
        
        if search_results.get('relaxed_parameter'):
            print(f"   ‚Ä¢ –û—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: {search_results['relaxed_parameter']}")
        
        if search_results.get('recommendation_analysis'):
            analysis = search_results['recommendation_analysis']
            print(f"\nüìä –ê–ù–ê–õ–ò–ó –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô:")
            print(f"   {analysis.get('analysis', '')}")
            
            for rec in analysis.get('recommendations', [])[:2]:
                print(f"   ‚Ä¢ {rec.get('type', '')}: {rec.get('description', '')}")
        
        if search_results["results"]:
            print(f"\nüöó –ù–ê–ô–î–ï–ù–ù–´–ï –í–ê–†–ò–ê–ù–¢–´ ({len(search_results['results'])}):")
            for i, car in enumerate(search_results["results"][:3], 1):
                price = f"{car['price']:,.0f} —Ä—É–±.".replace(',', ' ')
                print(f"   {i}. {car['brand']} {car['model']} - {price}")
                print(f"      {car['category']}, {car['fuel_type']}, {car.get('year', 'N/A')} –≥–æ–¥")

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

def demo_intelligent_search():
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞"""
    
    dealer_config = CarDealerConfig(
        enabled=True,
        auto_search_threshold=0.6,
        max_results=5
    )
    
    assistant = IntelligentCarDealerAssistant(dealer_config)
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    test_scenarios = [
        # –†–∞–∑–º—ã—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        "–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ —Ö–æ—Ä–æ—à–∏–π —Å–µ–º–µ–π–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å",
        "–•–æ—á—É –Ω–∞–¥–µ–∂–Ω—É—é –º–∞—à–∏–Ω—É –¥–ª—è –≥–æ—Ä–æ–¥–∞",
        "–ù—É–∂–µ–Ω —ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è –ø–æ–µ–∑–¥–æ–∫ –Ω–∞ —Ä–∞–±–æ—Ç—É",
        
        # –ó–∞–ø—Ä–æ—Å—ã —Å –∂–µ—Å—Ç–∫–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –Ω–µ –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π)
        "–ò—â—É BMW 2023 –≥–æ–¥–∞ –¥–æ 1 –º–∏–ª–ª–∏–æ–Ω–∞ —Ä—É–±–ª–µ–π",  # –°–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è —Ü–µ–Ω–∞ –¥–ª—è BMW
        "–•–æ—á—É —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª—å —Å –ø—Ä–æ–±–µ–≥–æ–º 0 –¥–æ 1.5 –º–ª–Ω",  # –ú–∞–ª–æ —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª–µ–π –≤ –±–∞–∑–µ
        "–ù—É–∂–µ–Ω Mercedes –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ 2024 –≥–æ–¥–∞",  # –°–ª–∏—à–∫–æ–º –Ω–æ–≤—ã–π –≥–æ–¥
        
        # –°–º–µ—à–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        "–ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç Toyota, –Ω–æÂèØ‰ª•ËÄÉËôë –¥—Ä—É–≥–∏–µ –º–∞—Ä–∫–∏",
        "–•–æ—á—É –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–æ 2 –º–ª–Ω, –º–æ–∂–Ω–æ –±/—É"
    ]
    
    print("üß† –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê")
    print("=" * 80)
    
    for i, query in enumerate(test_scenarios, 1):
        print(f"\n{'>>>'*10} –¢–ï–°–¢ {i} {'<<<'*10}")
        print(f"üìù –ó–ê–ü–†–û–°: {query}")
        
        result = assistant.process_query(query)
        
        # –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞
        if result.get("needs_clarification"):
            print("üîç –†–ï–ó–£–õ–¨–¢–ê–¢: –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ")
            for qa in result.get("clarification_questions", []):
                print(f"   ‚ùì {qa['question']}")
                for answer in qa['hypothetical_answers']:
                    print(f"      üí≠ {answer}")
        
        elif result.get("search_performed") and result["search_results"]:
            search_data = result["search_results"]
            if search_data["success"]:
                print(f"‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢: –ù–∞–π–¥–µ–Ω–æ {len(search_data['results'])} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤")
                print(f"   –°—Ç—Ä–∞—Ç–µ–≥–∏—è: {search_data.get('search_strategy', 'N/A')}")
            else:
                print("‚ùå –†–ï–ó–£–õ–¨–¢–ê–¢: –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        
        time.sleep(1)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    
    print(f"\n{'üìä'*20} –ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø {'üìä'*20}")
    
    # –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ–∏—Å–∫–∞
    strategies = {}
    for msg in assistant.history.history:
        if msg.get("search_results") and msg["search_results"].get("search_strategy"):
            strategy = msg["search_results"]["search_strategy"]
            strategies[strategy] = strategies.get(strategy, 0) + 1
    
    print("   –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–¢–†–ê–¢–ï–ì–ò–ô –ü–û–ò–°–ö–ê:")
    for strategy, count in strategies.items():
        print(f"   ‚Ä¢ {strategy}: {count} —Ä–∞–∑")

if __name__ == "__main__":
    demo_intelligent_search()
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

### 1. **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤**
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Å–ª–∞–±–ª–µ–Ω–∏—è**: —Ü–≤–µ—Ç ‚Üí —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ ‚Üí –ö–ü–ü ‚Üí —Ç–∏–ø —Ç–æ–ø–ª–∏–≤–∞ ‚Üí —Ü–µ–Ω–∞ ‚Üí –≥–æ–¥ ‚Üí –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí –º–∞—Ä–∫–∞
- **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ**: LLM –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç, –∫–∞–∫–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –≤–∞–∂–Ω–µ–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ü–æ—ç—Ç–∞–ø–Ω–æ–µ –æ—Å–ª–∞–±–ª–µ–Ω–∏–µ**: –º–∞–∫—Å–∏–º—É–º 5 —à–∞–≥–æ–≤ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞

### 2. **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–∞–∑–º—ã—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**
```python
# –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–∑–º—ã—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–Ω–∏–º–∞–µ—Ç:
"–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ —Ö–æ—Ä–æ—à–∏–π —Å–µ–º–µ–π–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å"
‚Üí –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –≤: {"category": "–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫", "max_price": 2500000, "keywords": "–≤–º–µ—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π"}

"–•–æ—á—É —ç–∫–æ–Ω–æ–º–∏—á–Ω—É—é –º–∞—à–∏–Ω—É –¥–ª—è –≥–æ—Ä–æ–¥–∞"  
‚Üí –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –≤: {"fuel_type": "–±–µ–Ω–∑–∏–Ω", "engine_volume": 1.6, "keywords": "—ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π, –º–∞–Ω–µ–≤—Ä–µ–Ω–Ω—ã–π"}
```

### 3. **–ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é LLM**
- **–ü–æ—Ö–æ–∂–∏–µ –º–∞—Ä–∫–∏**: BMW ‚Üí [Audi, Mercedes, Lexus]
- **–ü–æ—Ö–æ–∂–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏**: –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫ ‚Üí [–∫—Ä–æ—Å—Å–æ–≤–µ—Ä, —É–Ω–∏–≤–µ—Ä—Å–∞–ª]
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ö–ü–ü ‚Üí [—Ä–æ–±–æ—Ç, –≤–∞—Ä–∏–∞—Ç–æ—Ä]

### 4. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ç–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π**
```python
# –ö–æ–≥–¥–∞ —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç:
1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ (+20-30%)
2. –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –º–∞—Ä–æ–∫/–∫–∞—Ç–µ–≥–æ—Ä–∏–π  
3. –ö–æ–º–ø—Ä–æ–º–∏—Å—Å—ã –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º
4. –ë–ª–∏–∂–∞–π—à–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏
```

### 5. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∂–µ—Å—Ç–∫–æ—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**
–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã:
- **–ñ–µ—Å—Ç–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**: —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è ("–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ BMW")
- **–ì–∏–±–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**: –ø–æ–∂–µ–ª–∞–Ω–∏—è ("–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ö–ü–ü")

## üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã:

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–∞–∑–º—ã—Ç—ã–π –∑–∞–ø—Ä–æ—Å
```
üìù –ó–ê–ü–†–û–°: "–ü–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ —Ö–æ—Ä–æ—à–∏–π —Å–µ–º–µ–π–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å"

üéØ –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö:
   ‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è: recommendation_system
   ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: 3

üöó –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–ù–´–ï –í–ê–†–ò–ê–ù–¢–´:
   1. Toyota RAV4 - 2,800,000 —Ä—É–±. (–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫, –±–µ–Ω–∑–∏–Ω, –∞–≤—Ç–æ–º–∞—Ç)
   2. Kia Sportage - 2,200,000 —Ä—É–±. (–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫, –¥–∏–∑–µ–ª—å, –∞–≤—Ç–æ–º–∞—Ç) 
   3. Hyundai Santa Fe - 3,100,000 —Ä—É–±. (–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫, –±–µ–Ω–∑–∏–Ω, –∞–≤—Ç–æ–º–∞—Ç)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ñ–µ—Å—Ç–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
```
üìù –ó–ê–ü–†–û–°: "–ò—â—É BMW 2023 –≥–æ–¥–∞ –¥–æ 1 –º–∏–ª–ª–∏–æ–Ω–∞ —Ä—É–±–ª–µ–π"

üéØ –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö:
   ‚Ä¢ –¢–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç
   ‚Ä¢ –û—Å–ª–∞–±–ª—è—é –ø–∞—Ä–∞–º–µ—Ç—Ä: max_price (+20%)
   ‚Ä¢ –û—Å–ª–∞–±–ª—è—é –ø–∞—Ä–∞–º–µ—Ç—Ä: min_year (-2 –≥–æ–¥–∞)
   ‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è: relaxed_2_steps
   ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: 2

üöó –ù–ê–ô–î–ï–ù–ù–´–ï –í–ê–†–ò–ê–ù–¢–´:
   1. BMW 3 Series 2021 - 1,150,000 —Ä—É–±.
   2. Audi A4 2022 - 1,080,000 —Ä—É–±. (–ø–æ—Ö–æ–∂–∞—è –º–∞—Ä–∫–∞)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```
üìù –ó–ê–ü–†–û–°: "–•–æ—á—É –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –∏ —Å–µ–º—å–∏"

üîç –†–ï–ó–£–õ–¨–¢–ê–¢: –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ
   ‚ùì –ö–∞–∫–æ–π –∫–ª–∞—Å—Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç: –±–∏–∑–Ω–µ—Å-—Å–µ–¥–∞–Ω –∏–ª–∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫?
      üí≠ –°–∫–æ—Ä–µ–µ –±–∏–∑–Ω–µ—Å-—Å–µ–¥–∞–Ω –¥–ª—è –≤—Å—Ç—Ä–µ—á —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
      üí≠ –ù—É–∂–µ–Ω –≤–º–µ—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –¥–ª—è —Å–µ–º—å–∏ –∏ –ø–µ—Ä–µ–≤–æ–∑–æ–∫
   ‚ùì –ö–∞–∫–æ–π –±—é–¥–∂–µ—Ç –≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ?
      üí≠ –î–æ 3 –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Ä—É–±–ª–µ–π
      üí≠ –û–∫–æ–ª–æ 4-5 –º–∏–ª–ª–∏–æ–Ω–æ–≤
```

–≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –æ–Ω–∏ –≤—ã—Ä–∞–∂–µ–Ω—ã –Ω–µ—á–µ—Ç–∫–æ! üß†üöó