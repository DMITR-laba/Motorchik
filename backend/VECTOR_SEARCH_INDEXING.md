# –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –ë–î (PGEmbedding)

## –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏–∑ PostgreSQL –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –ë–î (PGEmbedding) –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞. –ö–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `car_id` –∏ `type`, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:**
   ```bash
   pip install langchain-community langchain-openai langchain-mistralai
   ```

2. **–ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL** —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º `pgvector`

3. **–ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏** (Mistral, OpenAI –∏–ª–∏ HuggingFace) –≤ `app/core/config.py`

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

```bash
cd backend
python index_cars_to_vector_db.py
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:

1. **–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏** –∏–∑ —Ç–∞–±–ª–∏—Ü `cars` –∏ `used_cars`
2. **–°–æ–∑–¥–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã LangChain** —Å:
   - –¢–µ–∫—Å—Ç–æ–≤—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–º–∞—Ä–∫–∞, –º–æ–¥–µ–ª—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏)
   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏:
     - `car_id` - ID –∞–≤—Ç–æ–º–æ–±–∏–ª—è (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ!)
     - `type` - –¢–∏–ø –∞–≤—Ç–æ–º–æ–±–∏–ª—è: `"car"` –¥–ª—è –Ω–æ–≤—ã—Ö, `"used_car"` –¥–ª—è –ø–æ–¥–µ—Ä–∂–∞–Ω–Ω—ã—Ö (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ!)
     - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: `mark`, `model`, `city`, `price`, `manufacture_year`, `body_type`, `fuel_type`, `gear_box_type`
3. **–ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã** –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é `cars_collection` –≤ PostgreSQL
4. **–°–æ–∑–¥–∞–µ—Ç HNSW –∏–Ω–¥–µ–∫—Å** –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

–ö–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:

```python
metadata = {
    "car_id": "123",  # üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: ID –∞–≤—Ç–æ–º–æ–±–∏–ª—è
    "type": "car",    # üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: "car" –∏–ª–∏ "used_car"
    "id": "123",      # –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    "mark": "BMW",
    "model": "X5",
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
}
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤** –≤ –ª–æ–≥–∞—Ö
2. **–ù–∞–ª–∏—á–∏–µ HNSW –∏–Ω–¥–µ–∫—Å–∞** (—Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
3. **–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫** —á–µ—Ä–µ–∑ API:

```python
from services.vector_search_service import VectorSearchService
from models import get_db

db = next(get_db())
vector_service = VectorSearchService(db_session=db)
results = await vector_service.similarity_search("BMW —Å–µ–¥–∞–Ω", k=5)

for doc, score in results:
    print(f"Car ID: {doc.metadata.get('car_id')}, Type: {doc.metadata.get('type')}, Score: {score}")
```

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Ä—è–¥–æ–∫:

1. **SQL Agent** - –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (PGEmbedding)** - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ (–µ—Å–ª–∏ SQL Agent –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è)
3. **Elasticsearch** - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback (–µ—Å–ª–∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è)

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–í `sql_agent_settings.json` –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

```json
{
    "vector_search_enabled": true,  // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
    "es_fallback_enabled": true    // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å Elasticsearch fallback
}
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: "PGEmbedding –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: `pip install langchain-community`

### –û—à–∏–±–∫–∞: "–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç car_id"
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –ë–î

### –û—à–∏–±–∫–∞: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏–∑ –ë–î"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `car_id` –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–º ID –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö `cars` –∏–ª–∏ `used_cars`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `type` –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É–∫–∞–∑–∞–Ω (`"car"` –∏–ª–∏ `"used_car"`)

## –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è

–î–ª—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π:

1. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```sql
   -- –í PostgreSQL
   DROP TABLE IF EXISTS langchain_pg_embedding;
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∑–∞–Ω–æ–≤–æ:
   ```bash
   python index_cars_to_vector_db.py
   ```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –±–∞—Ç—á–∞–º–∏ –ø–æ 100 —à—Ç—É–∫ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- HNSW –∏–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä–æ–≤ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–æ–¥–µ–ª–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

