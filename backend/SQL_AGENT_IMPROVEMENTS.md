# Улучшения SQL-агента

## Внесенные улучшения

### 1. ✅ Детальная схема базы данных
- Добавлены описания всех таблиц с пояснениями полей
- Автоматическое получение примеров данных (марки, города, типы кузова, топливо)
- Информация об индексации полей
- Описание связей между таблицами

### 2. ✅ Регистронезависимый поиск марок и городов
**Проблема:** Поиск по маркам типа "Toyota" не находил "TOYOTA" или "toyota"

**Решение:** В промпт добавлены инструкции всегда использовать `UPPER()` или `LOWER()`:
```sql
-- ✅ ПРАВИЛЬНО:
WHERE UPPER(mark) LIKE '%TOYOTA%'

-- ❌ НЕПРАВИЛЬНО:
WHERE mark = 'Toyota'
```

### 3. ✅ Обработка цен для SQLite
**Проблема:** Использование регулярных выражений в REPLACE() вызывало ошибки

**Решение:** 
- Инструкции использовать вложенные REPLACE() вместо regex
- Корректное преобразование типов с CAST()
- Всегда проверять наличие цены

```sql
-- ✅ ПРАВИЛЬНО:
CAST(REPLACE(REPLACE(REPLACE(price, ' ', ''), '₽', ''), ',', '.') AS REAL)

-- ❌ НЕПРАВИЛЬНО:
REPLACE(price, '[^0-9]', '')  -- SQLite не поддерживает regex
```

### 4. ✅ Обработка rate limits API
**Проблема:** При превышении лимита запросов API возвращал 429 ошибку

**Решение:**
- Добавлена логика retry с экспоненциальной задержкой
- До 3 попыток с увеличивающейся задержкой (1s, 2s, 4s)
- Автоматическое определение rate limit ошибок
- Логирование процесса retry

### 5. ✅ Улучшенный промпт для LLM
**Структура промпта:**
1. **Критические правила для SQLite** - ограничения и особенности
2. **Примеры правильных запросов** - шаблоны для различных случаев
3. **Детальная схема БД** - полная информация о таблицах и полях
4. **Примеры данных** - реальные значения из базы

**Основные разделы промпта:**
- Безопасность (только SELECT)
- SQLite ограничения
- Регистронезависимый поиск
- Работа с ценами
- Поиск по типам (КПП, топливо, кузов)
- Объединение таблиц
- Агрегация

### 6. ✅ Примеры данных в схеме
Схема теперь включает:
- Примеры марок автомобилей из базы
- Примеры городов
- Примеры типов кузова
- Примеры типов топлива

Это помогает LLM понимать реальные значения в базе.

## Ожидаемые результаты

После этих улучшений SQL-агент должен:
- ✅ Находить марки независимо от регистра (Toyota, TOYOTA, toyota)
- ✅ Корректно обрабатывать запросы на среднюю цену
- ✅ Устойчиво работать при rate limits API
- ✅ Генерировать более точные SQL запросы благодаря детальной схеме
- ✅ Правильно обрабатывать варианты написания (автомат/механика, бензин/дизель)

## Метрики для проверки

Протестировать улучшения на проблемных запросах:
1. "Покажи все марки автомобилей" - должен работать несмотря на rate limits
2. "Сколько автомобилей марки Toyota" - регистронезависимый поиск
3. "Какая средняя цена автомобилей" - корректная обработка цен
4. "Найди автомобили BMW" - регистронезависимый поиск

## Технические детали

### Retry логика:
```python
max_retries = 3
wait_time = retry_delay * (2 ** attempt)  # Экспоненциальная задержка
```

### Схема с примерами:
- Автоматическое получение DISTINCT значений из БД
- Кэширование не требуется - схема генерируется быстро
- Примеры обновляются при каждом запросе

### Валидация SQL:
- Проверка на запрещенные операции (DROP, DELETE, etc.)
- Проверка на regex в REPLACE (предупреждение в промпте)
- Только SELECT операции разрешены




