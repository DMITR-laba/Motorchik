# –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

**–î–∞—Ç–∞:** 2025-11-16  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠—Ç–∞–ø 1 –∑–∞–≤–µ—Ä—à–µ–Ω, –≠—Ç–∞–ø 2 –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

#### 1.1. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö UserMemory
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å `UserMemory` –≤ `backend/models/database.py`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ pgvector –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (1024 –∏–∑–º–µ—Ä–µ–Ω–∏—è)
- ‚úÖ –ü–æ–ª—è: user_id, memory_type, memory_text, embedding, metadata, confidence

#### 1.2. SQL –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ `001_create_user_memories.sql` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã user_memories
- ‚úÖ `002_fix_chat_message_chat_id.sql` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ nullable –≤ ChatMessage
- ‚úÖ –°–∫—Ä–∏–ø—Ç `apply_migrations.py` –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

#### 1.3. UnifiedMemoryService
- ‚úÖ –°–æ–∑–¥–∞–Ω `backend/services/unified_memory_service.py`
- ‚úÖ –ú–µ—Ç–æ–¥—ã:
  - `get_user_context()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `save_memory()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤ pgvector
  - `_get_user_preferences()` - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
  - `_get_mistral_embedding()` - —Å–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —á–µ—Ä–µ–∑ Mistral API
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Mistral API –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

#### 1.4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ChatMessage
- ‚úÖ –£–±—Ä–∞–Ω `nullable=True` —Å –ø–æ–ª—è `chat_id`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π

---

### –≠—Ç–∞–ø 2: –°–æ–∑–¥–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞

#### 2.1. UnifiedSearchService
- ‚úÖ –°–æ–∑–¥–∞–Ω `backend/services/unified_search_service.py`
- ‚úÖ –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫:
  - `_exact_search()` - —Ç–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Elasticsearch
  - `_semantic_search()` - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ pgvector
  - `_hybrid_car_search()` - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  - `_merge_search_results()` - –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–∏—Å–∫–∞

#### 2.2. CarDealerAgent
- ‚úÖ –°–æ–∑–¥–∞–Ω `backend/services/car_dealer_agent.py`
- ‚úÖ –ì—Ä–∞—Ñ —Å–æ—Å—Ç–æ—è–Ω–∏–π LangGraph:
  - `analyze_intent` - –∞–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
  - `extract_parameters` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
  - `search_cars` - –ø–æ–∏—Å–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
  - `search_knowledge` - –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
  - `sql_query` - SQL –∑–∞–ø—Ä–æ—Å—ã (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
  - `extract_preferences` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
  - `generate_response` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
  - `update_memory` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- ‚úÖ –£—Å–ª–æ–≤–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
- ‚úÖ Fallback –Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –±–µ–∑ –≥—Ä–∞—Ñ–∞

#### 2.3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SQL Agent
- ‚úÖ SQL Agent –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —É–∑–µ–ª `sql_query` –≤ –≥—Ä–∞—Ñ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### 2.4. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ API
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `/api/chat/message` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CarDealerAgent
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É (RAGService)
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å SQL Agent –æ—Ç–≤–µ—Ç–∞–º–∏

#### 2.5. –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω `backend/scripts/migrate_memories_from_qdrant.py`
- ‚úÖ –ü–µ—Ä–µ–Ω–æ—Å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏–∑ Qdrant –≤ PostgreSQL
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–æ–≤ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

---

## üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ

### –£–ª—É—á—à–µ–Ω–∏—è (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)

1. **ParameterExtractionService** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ LLM
2. **ProactiveSuggestionsService** - –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
3. **EntityExtractionService** - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ—Å–ª–µ –¥–∏–∞–ª–æ–≥–∞

---

## üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
cd backend
python scripts/apply_migrations.py
```

### 2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –∞–≥–µ–Ω—Ç
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É CarDealerAgent
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã

### 3. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```bash
python scripts/migrate_memories_from_qdrant.py
```

### 4. –£–ª—É—á—à–µ–Ω–∏—è (–ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
- –î–æ–±–∞–≤–∏—Ç—å ParameterExtractionService
- –î–æ–±–∞–≤–∏—Ç—å ProactiveSuggestionsService
- –£–ª—É—á—à–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM

---

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **LangGraph –∏–º–ø–æ—Ä—Ç** - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ª–∏–Ω—Ç–µ—Ä–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å—Ç—å fallback)
2. **–§–æ—Ä–º–∞—Ç –≤–µ–∫—Ç–æ—Ä–æ–≤** - –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å pgvector –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
3. **Async/sync –º–µ—Ç–æ–¥—ã** - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –º–µ—Ç–æ–¥—ã –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ—Ä–∞–±–æ—Ç–∫–∏

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–°–æ–∑–¥–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** 6
  - `unified_memory_service.py`
  - `unified_search_service.py`
  - `car_dealer_agent.py`
  - `001_create_user_memories.sql`
  - `002_fix_chat_message_chat_id.sql`
  - `migrate_memories_from_qdrant.py`
  - `apply_migrations.py`

- **–ò–∑–º–µ–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** 3
  - `models/database.py` (–¥–æ–±–∞–≤–ª–µ–Ω–∞ UserMemory, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω ChatMessage)
  - `app/api/chat.py` (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è CarDealerAgent)

- **–£–¥–∞–ª–µ–Ω–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:** 0 (–ø–æ–∫–∞, –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å Mem0/Qdrant)

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

–û—Å–Ω–æ–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞:
- ‚úÖ –ï–¥–∏–Ω—ã–π –∞–≥–µ–Ω—Ç (CarDealerAgent)
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–º—è—Ç—å (UnifiedMemoryService)
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ (UnifiedSearchService)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SQL Agent –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π API endpoint

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

